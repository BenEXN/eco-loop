<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Looop v1.27.1 ‚Äì Syst√®me d'√©v√©nements corrig√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #f3f3f3; font-family: sans-serif; margin:0; padding:0; }
    h1 { text-align: center; margin: 25px 0 10px; }
    .container { display: flex; justify-content: center; align-items: flex-start; margin: 0 auto 18px auto; max-width: 950px; gap: 24px;}
    .category { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #0001; flex: 1; padding: 32px 18px 18px 18px; margin: 0 6px; min-width: 250px; max-width: 320px; min-height: 250px; display: flex; flex-direction: column; align-items: center;}
    .cat-title { font-size: 1.25em; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px;}
    .stock { font-size: 1.1em; margin-bottom: 10px;}
    .products-box { background: #f7f7fa; border: 2px solid #dde1eb; border-radius: 10px; color: #333; margin-bottom: 10px; padding: 10px 28px; font-size: 1.2em; font-weight: bold; letter-spacing: 1px; box-shadow: 0 1px 4px #ddd5; min-width: 110px; text-align: center;}
    .message-box { border-radius: 10px; margin: 8px 0 14px 0; padding: 11px 14px 11px 14px; font-weight: bold; font-size: 1.08em; box-shadow: 0 1px 4px #0002; text-align: center; min-width: 130px; max-width: 260px; word-break: break-word; line-height: 1.25em;}
    .msg-orange { background: #fff2e6; color: #cc5500; border: 2px solid #ff8533; }
    .msg-blue { background: #e6f3ff; color: #0066cc; border: 2px solid #4da6ff; }
    .msg-red { background: #ffe6e6; color: #cc0000; border: 2px solid #ff6666; }
    .msg-brown { background: #fff7e6; color: #996600; border: 2px solid #cc9900; }
    .msg-green { background: #e6ffe6; color: #006600; border: 2px solid #66cc66; }
    .msg-gold { background: #fff9c4; color: #b8860b; border: 2px solid #f4d03f;}
    .msg-purple { background: #f3e5f5; color: #7b1fa2; border: 2px solid #ce93d8;}
    .btn-row { margin: 18px 0 0 0;}
    button { font-size: 1em; padding: 10px 18px; margin: 5px 0; border-radius: 14px; border: none; background: #ededed; color: #111; cursor: pointer; transition: background 0.2s;}
    .btn-yellow { background: #FFD600; color: #222; font-weight: bold;}
    .btn-annuler { background: #aaa; color: #fff; }
    .btn-credit { background: #ff6b35; color: #fff; font-weight: bold;}
    .btn-evolution { background: #4CAF50; color: #fff; font-weight: bold;}
    .btn-restart { background: #2196F3; color: #fff; font-weight: bold;}
    .debug-row { margin: 0 0 32px 0; display: flex; justify-content: center; gap: 10px;}
    .message { font-weight: bold; min-height: 24px; margin: 10px 0;}
    #clics-container { text-align: center; margin: 25px 0 0 0; font-size: 1.2em; font-weight: bold; color: #333;}
    #don-btn { margin-top: 10px; background: #FFD600; color: #222; font-weight: bold; border: none; border-radius: 8px; font-size: 1.1em; padding: 14px 20px;}
    #triche-sep { border: none; border-top: 3px solid #222; margin: 38px auto 12px auto; width: 94vw; max-width: 1000px;}
    #triche-label { text-align: left; font-size:1.13em; font-weight:normal; letter-spacing:1px; margin: 0 0 12px 0; color:#555; width: 95vw; max-width: 1000px; margin-left: auto; margin-right: auto;}
      
    #unlock-cheat-btn { 
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #unlock-cheat-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    #cheat-buttons {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .automatisms-controls { 
      margin: 15px auto 15px auto; 
      max-width: 950px; 
      display: none;
      justify-content: center; 
      gap: 20px; 
      flex-wrap: wrap;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
    }
    .control-btn { font-size: 0.9em; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s; min-width: 80px;}
    .control-btn.active { background: #4CAF50; color: white; }
    .control-btn.inactive { background: #f44336; color: white; }
    .control-btn.disabled { background: #ccc; color: #888; cursor: not-allowed; }
    
    .optimum-zone { 
      margin: 15px auto; 
      max-width: 950px; 
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
      text-align: center;
    }
    .optimum-title { 
      font-size: 1.1em; 
      font-weight: bold; 
      margin-bottom: 10px; 
      color: #333;
    }
    .optimum-progress-bar { 
      background: #eee; 
      border-radius: 20px; 
      height: 20px; 
      margin: 10px auto; 
      max-width: 400px; 
      overflow: hidden; 
      position: relative;
    }
    .optimum-progress-fill { 
      height: 100%; 
      border-radius: 20px; 
      transition: width 0.3s ease; 
      background: linear-gradient(90deg, #4CAF50, #81C784);
    }
    .optimum-progress-text { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      font-weight: bold; 
      color: #333; 
      font-size: 0.9em;
    }
    .optimum-status { 
      font-size: 0.9em; 
      margin-top: 8px; 
      color: #666;
    }
    .optimum-victory { 
      background: #fff9c4; 
      border: 2px solid #f4d03f; 
      color: #b8860b; 
      padding: 20px; 
      border-radius: 15px; 
      font-size: 1.2em; 
      font-weight: bold; 
      text-align: center; 
      margin: 20px auto; 
      max-width: 600px;
      animation: victoryPulse 2s infinite;
    }
    
    @keyframes victoryPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .events-zone {
      margin: 15px auto;
      max-width: 950px;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
    }
    
    .event-notification {
      background: #f3e5f5;
      border: 2px solid #ce93d8;
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-weight: bold;
      text-align: center;
      color: #7b1fa2;
      animation: eventPulse 0.8s ease-in-out;
      position: relative;
      overflow: hidden;
    }
    
    .event-notification::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 1.5s ease-in-out;
    }
    
    @keyframes eventPulse {
      0% { transform: scale(0.95); opacity: 0; }
      50% { transform: scale(1.02); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .event-effects-display {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
      font-style: italic;
    }
    
    .events-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .events-toggle {
      background: #9c27b0;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }
    
    .events-toggle:hover {
      background: #7b1fa2;
      transform: translateY(-1px);
    }
    
    .events-toggle.disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
    }

    /* Affichage des effets temporaires actifs */
    .temp-effects-display {
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      font-size: 0.85em;
      display: none; /* Masqu√© par d√©faut, affich√© quand il y a des effets */
    }
    
    .temp-effects-title {
      font-weight: bold;
      color: #e65100;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .temp-effect-item {
      background: #fff;
      border: 1px solid #ffcc02;
      border-radius: 4px;
      padding: 4px 8px;
      margin: 2px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8em;
    }
    
    .temp-effect-name {
      font-weight: bold;
      color: #333;
    }
    
    .temp-effect-duration {
      color: #666;
      font-size: 0.75em;
    }
    
    .jauge-bottom-barre { margin: 0 auto 6px auto; display: flex; flex-direction: row; align-items: center; gap: 8px; max-width: 600px;}
    .jauge-bottom-label { min-width: 70px; font-size: .99em; color: #888; text-align: right;}
    .jauge-bottom-bar { background: #eee; border-radius: 8px; height: 13px; flex: 1; overflow: hidden; position: relative;}
    .jauge-bottom-fill { height: 100%; border-radius: 8px; transition: width 0.19s;}
    #jauge-nature { background: #86e08e;}
    #jauge-confort { background: #86b6ea;}
    #jauge-money { background: #ffb3b3;}
    #jauge-achat-auto { background: #ffa726;}
    #jauge-ia { background: #ab47bc;}
    #jauge-trader { background: #26c6da;}
    #jauge-centre { background: #66bb6a;}
    #jauge-budget-etat { background: #ff9800;}
    #jauge-tech { background: #9c27b0;}
    .hidden { display: none; }

    .investment-block { background: #e8f5e8; border: 2px solid #81c784; border-radius: 10px; padding: 15px; margin: 10px 0; }
    .investment-title { font-weight: bold; color: #2e7d32; margin-bottom: 10px; text-align: center; }
    .investment-input { width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin: 0 5px; font-size: 1em; }
    .investment-list { font-size: 0.9em; color: #555; margin-top: 10px; max-height: 100px; overflow-y: auto; }
    .investment-preview { font-size: 0.8em; color: #2e7d32; margin-top: 5px; font-style: italic; min-height: 16px; }
    .investment-controls { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 5px; }
    
    .success-flash { 
      animation: successPulse 0.6s ease-in-out;
    }
    
    @keyframes successPulse {
      0% { background-color: inherit; }
      50% { background-color: #c8f5c8; }
      100% { background-color: inherit; }
    }
    
    @media (max-width: 700px) {
      body { font-size: 14px; }
      h1 { font-size: 1.5em; margin: 15px 0 5px; }
      
      .container {
        flex-direction: column;
        max-width: 100vw;
        padding: 0 5px;
        gap: 10px;
        margin: 0 auto 10px auto;
      }
      
      .category {
        min-width: unset;
        max-width: unset;
        width: calc(100vw - 20px);
        padding: 20px 12px 12px 12px;
        margin: 0;
        min-height: 200px;
      }
      
      .cat-title { font-size: 1.1em; margin-bottom: 15px; }
      .stock { font-size: 1em; margin-bottom: 8px; }
      .products-box { font-size: 1em; padding: 8px 20px; min-width: 90px; }
      .message-box { font-size: 1em; min-width: 100px; max-width: calc(100vw - 60px); }
      
      button { font-size: 1em; padding: 12px 20px; margin: 6px 0; min-height: 44px; }
      
      .investment-input { width: 70px; padding: 10px; font-size: 1.1em; }
      .investment-controls { flex-direction: column; gap: 10px; }
      
      .automatisms-controls { 
        max-width: 100vw;
        padding: 10px;
        gap: 10px;
      }
      .control-btn { min-width: 70px; padding: 10px 14px; font-size: 0.9em; }
      
      .optimum-zone, .events-zone {
        max-width: calc(100vw - 20px);
        margin: 10px;
        padding: 12px;
      }
      .optimum-progress-bar { max-width: 300px; }
      
      .temp-effects-display {
        margin: 8px 0;
        padding: 8px;
      }
      
      .jauge-bottom-barre { max-width: calc(100vw - 30px); gap: 6px; }
      .jauge-bottom-label { min-width: 60px; font-size: 0.9em; }
      
      #clics-container { font-size: 1.1em; margin: 20px 0 0 0; }
      #don-btn { padding: 16px 24px; font-size: 1.1em; }
      
      .debug-row { 
        flex-direction: column; 
        gap: 8px; 
        margin: 0 0 20px 0;
        align-items: center;
      }
      .debug-row button { min-width: 200px; }
      
      #triche-label { 
        max-width: calc(100vw - 20px);
        margin-left: 10px;
        margin-right: 10px;
      }
      
      #triche-sep { width: calc(100vw - 20px); }
      
      .event-notification { 
        margin: 8px 0;
        padding: 10px;
        font-size: 0.95em;
      }
      
      .events-controls { 
        flex-direction: column; 
        gap: 8px; 
      }
      
      .events-toggle { 
        min-width: 150px; 
      }
    }
  </style>
</head>
<body>
  <!-- ========== D√âBUT DU CONTENU HTML ========== -->
  
  <h1>üåç Looop <span style="font-size:0.7em;color:#777;">v1.27.1 - Syst√®me d'√©v√©nements corrig√©</span></h1>
  
  <div class="automatisms-controls" id="automatisms-controls">
    <button class="control-btn disabled" id="control-ia" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button class="control-btn disabled" id="control-trader" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button class="control-btn disabled" id="control-confort" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button class="control-btn disabled" id="control-centre" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>
  
  <div class="optimum-zone" id="optimum-zone">
    <div class="optimum-title">üéØ Zone d'√âquilibre</div>
    <div class="optimum-progress-bar">
      <div class="optimum-progress-fill" id="optimum-progress-fill"></div>
      <div class="optimum-progress-text" id="optimum-progress-text">0 / 50</div>
    </div>
    <div class="optimum-status" id="optimum-status">Objectif : maintenir l'√©quilibre pendant 50 actions</div>
  </div>

  <div class="events-zone" id="events-zone">
    <div class="optimum-title">üé≤ √âv√©nements Al√©atoires</div>
    <div id="current-event" class="event-notification" style="display: none;">
      <div id="event-text">Aucun √©v√©nement en cours</div>
      <div id="event-effects" class="event-effects-display"></div>
    </div>
    
    <!-- Affichage des effets temporaires actifs -->
    <div id="temp-effects-display" class="temp-effects-display">
      <div class="temp-effects-title">‚è±Ô∏è Effets temporaires actifs</div>
      <div id="temp-effects-list"></div>
    </div>
    
    <div class="events-controls">
      <button class="events-toggle" id="events-toggle" onclick="toggleEvents()">√âv√©nements: ON</button>
      <button class="events-toggle" onclick="triggerTestEvent()">üß™ Test √âv√©nement</button>
    </div>
    <div style="font-size: 0.8em; color: #666; text-align: center; margin-top: 8px;">
      Prochain √©v√©nement dans: <span id="next-event-countdown">?</span> actions
    </div>
  </div>
  
  <div id="optimum-victory" class="optimum-victory" style="display:none;">
    üèÜ VICTOIRE ! üèÜ<br>
    Vous avez maintenu l'√©quilibre optimum !<br>
    <button class="btn-restart" onclick="restartGame()" style="margin-top: 15px;">üîÑ Recommencer une partie</button>
  </div>
  
  <div class="container">
    <div class="category">
      <div class="cat-title">üå± Environnement</div>
      <div class="stock">Ressources : <span id="nature">3000</span></div>
      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>
      
      <div id="investment-block" class="investment-block" style="display:none;">
        <div class="investment-title">üå± Investissement √©cologique</div>
        <div class="investment-controls">
          <input type="number" id="investment-amount" class="investment-input" placeholder="‚Ç¨" min="1" oninput="updateInvestmentPreview()">
          <button onclick="makeEcologicalInvestment()">üíö Investir</button>
        </div>
        <div id="investment-preview" class="investment-preview"></div>
        <div id="investment-list" class="investment-list"></div>
      </div>
      
      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
      </div>
    </div>
    
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock">Confort : <span id="confort">0</span></div>
      <div class="products-box">
        Produits cr√©√©s<br>
        <span id="production">0</span>
      </div>
      <div id="social-crise" class="message-box msg-brown" style="display:none;"></div>
      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">üõãÔ∏è Achat</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>
      </div>
    </div>
    
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock" id="money-row" style="display:none;">
        Monnaie (‚Ç¨) : <span id="money">10</span>
      </div>
      <div class="stock" id="budget-etat-row" style="display:none;">
        Budget de l'√âtat : <span id="budget-etat">0</span> ‚Ç¨
      </div>
      <div class="products-box" id="price-indicator-box" style="display:none;">
        Prix de vente<br>
        <span id="current-price">1‚Ç¨</span>
      </div>
      
      <button id="don-btn" onclick="receiveDon()">Recevoir mon don</button>
      <button id="credit-btn" onclick="activateCredit()" style="display:none;" class="btn-credit">üí≥ Effectuer un cr√©dit</button>
      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>
      
      <div class="btn-row">
        <button id="ouvrier-btn" onclick="acheterIA()" style="display:none;">ü§ñ Engager une IA (500 ‚Ç¨)</button>
        <button id="trader-btn" onclick="acheterTrader()" style="display:none;">ü§ñ Trader automatique (1 000 ‚Ç¨)</button>
        <button id="comfort-auto-btn" onclick="acheterConfortAuto()" style="display:none;">üîÑ Achat auto confort (2 000 ‚Ç¨)</button>
        <button id="upgrade-btn2" onclick="upgradeProd2()" style="display:none;">üí† Am√©liorer la production (2 000 ‚Ç¨)</button>
        <button id="automatisms-btn" onclick="acheterAutomatismsClics()" style="display:none;">‚ö° Automatismes = clics (10 000 ‚Ç¨)</button>
        <button id="centre-commercial-btn" onclick="acheterCentreCommercial()" style="display:none;">üè¨ Centre commercial (5 000 ‚Ç¨)</button>
        <button id="price-indicator-btn" onclick="acheterIndicateurPrix()" style="display:none;">üìä Indicateur de prix (30 000 ‚Ç¨)</button>
        <button id="evolution-btn" onclick="evolution()" style="display:none;" class="btn-evolution">üå± √âvolution √©conomique</button>
        <button id="rescue-eh-btn" onclick="activateRescueEH()" style="display:none;" class="btn-evolution">üå± Passer √† l'√©conomie hom√©ostatique</button>
      </div>
    </div>
  </div>
  
  <div id="jauges-zone" style="margin: 0 auto 14px auto; max-width:620px;">
    <div class="jauge-bottom-barre">
      <div class="jauge-bottom-label">üå± Ressources</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-nature"></div></div>
      <div class="jauge-bottom-val" id="jauge-nature-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-confort-container" style="display:none;">
      <div class="jauge-bottom-label">ü§ñ Confort</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-confort"></div></div>
      <div class="jauge-bottom-val" id="jauge-confort-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-money-container" style="display:none;">
      <div class="jauge-bottom-label">üí∂ Monnaie</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-money"></div></div>
      <div class="jauge-bottom-val" id="jauge-money-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-budget-etat-container" style="display:none;">
      <div class="jauge-bottom-label">üèõÔ∏è Budget √âtat</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-budget-etat"></div></div>
      <div class="jauge-budget-etat-val" id="jauge-budget-etat-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-achat-auto-container" style="display:none;">
      <div class="jauge-bottom-label">üîÑ Achat auto</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-achat-auto"></div></div>
      <div class="jauge-bottom-val" id="jauge-achat-auto-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-ia-container" style="display:none;">
      <div class="jauge-bottom-label">ü§ñ IA</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-ia"></div></div>
      <div class="jauge-bottom-val" id="jauge-ia-txt"></div>
    </div>
          <div class="jauge-bottom-barre" id="jauge-trader-container" style="display:none;">
      <div class="jauge-bottom-label">üí∞ Trader</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-trader"></div></div>
      <div class="jauge-bottom-val" id="jauge-trader-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-centre-container" style="display:none;">
      <div class="jauge-bottom-label">üè¨ Centre</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-centre"></div></div>
      <div class="jauge-bottom-val" id="jauge-centre-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-tech-container" style="display:none;">
      <div class="jauge-bottom-label">üí† Niveau technologique</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-tech"></div></div>
      <div class="jauge-bottom-val" id="jauge-tech-txt"></div>
    </div>
  </div>
  
  <div class="message" id="message"></div>
  <div id="clics-container">Clics/actions : <span id="clicks">0</span></div>
  
  <hr id="triche-sep">
  <div id="triche-label">Triche</div>
  <div class="debug-row">
    <button id="unlock-cheat-btn" class="btn-yellow" onclick="toggleCheatMode()">üîì D√©v√©rouiller les outils de test</button>
  </div>
  <div id="cheat-buttons" class="debug-row" style="display: none;">
    <button class="btn-yellow" onclick="addMoney()">+1000 cr√©dits (test)</button>
    <button class="btn-yellow" onclick="addOneNature()">+100 ressources (test)</button>
    <button class="btn-yellow" onclick="addClicks50()">Clics +50 (test)</button>
    <button class="btn-yellow" onclick="removeNature100()">-100 ressources (test)</button>
    <button class="btn-evolution" onclick="forceActivateEH()">Passer √† l'EH (test)</button>
    <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler le clic pr√©c√©dent</button>
  </div>

  <!-- ========== FIN DU CONTENU HTML ========== -->

  <!-- ========== D√âBUT DU CODE JAVASCRIPT ========== -->
  <script>
    // Variables globales du jeu
    var gameState = {
      nature: 3000,
      confort: 0,
      production: 0,
      money: 10,
      clicks: 0,
      budgetEtat: 0,
      confortMaxAtteint: 0,
      monnaieActive: false,
      creditUnlocked: false,
      jeuBloque: false,
      criseSocialeActive: false,
      ehActivated: false,
      gameOver: false,
      gameOverCause: null,
      ia: 0,
      traderAuto: 0,
      confortAuto: 0,
      centreCommercial: 0,
      techLevel: 0,
      productionMultiplier: 1,
      automatismsGenerateClicks: false,
      priceIndicatorActive: false,
      nbAchatIA: 0,
      nbAchatTrader: 0,
      nbAchatConfortAuto: 0,
      nbAchatUpgradeProd: 0,
      nbAchatCentre: 0,
      ehPrimeClicks: 0,
      ehFonteClicks: 0,
      ehBonusClicks: 0,
      ecologicalInvestments: [],
      optimumStreak: 0,
      optimumVictory: false,
      optimumProtectionActive: false,
      paliersDebloque: {
        comfort: false,
        ia: false,
        trader: false,
        upgradeProd: false,
        confortAuto: false,
        automatismsClics: false,
        priceIndicator: false,
        centreCommercial: false
      }
    };
    
    var automatismsActive = {
      ia: true,
      trader: true,
      confort: true,
      centre: true
    };
    
    var intervals = {
      ia: null,
      trader: null,
      confortAuto: null,
      centreCommercial: null
    };
    
    var pendingPurchase = null;
    var lastState = null;
    var cheatModeUnlocked = false;
    
    var OPTIMUM_THRESHOLDS = {
      nature: { min: 1800, max: 2600 },
      confort: { min: 10, max: 35 },
      money: { min: 400, max: 1200 }
    };
    var OPTIMUM_TARGET = 50;
    var OPTIMUM_MILESTONE = 10;

    // SYST√àME D'√âV√âNEMENTS AL√âATOIRES CORRIG√â
    var randomEventsSystem = {
      enabled: true,
      nextEventIn: 0,
      currentEvent: null,
      lastEventId: -1,
      recentEvents: [],
      maxRecentEvents: 5,
      activeTemporaryEffects: [],
      automatismEventCooldown: 0,
      
      initialize: function() {
        this.scheduleNextEvent();
        this.updateTemporaryEffectsDisplay();
        console.log("üé≤ Syst√®me d'√©v√©nements al√©atoires initialis√© avec corrections");
      },
      
      scheduleNextEvent: function() {
        this.nextEventIn = Math.floor(Math.random() * 41) + 20;
        this.updateNextEventDisplay();
        console.log("üìÖ Prochain √©v√©nement dans " + this.nextEventIn + " clics");
      },
      
      updateNextEventDisplay: function() {
        var countdownElement = document.getElementById("next-event-countdown");
        if (countdownElement) {
          countdownElement.textContent = this.nextEventIn + "";
        }
      },
      
      processClick: function(isAutomatismAction) {
        if (!this.enabled || gameState.optimumVictory) return;
        
        if (isAutomatismAction && this.automatismEventCooldown > 0) {
          this.automatismEventCooldown--;
          this.nextEventIn = Math.max(0, this.nextEventIn - 1);
          this.updateNextEventDisplay();
          this.processTemporaryEffects();
          return;
        }
        
        this.nextEventIn--;
        this.updateNextEventDisplay();
        
        this.processTemporaryEffects();
        
        if (this.nextEventIn <= 0) {
          this.triggerRandomEvent();
          this.scheduleNextEvent();
          
          if (isAutomatismAction) {
            this.automatismEventCooldown = 3;
          }
        }
      },
      
      triggerRandomEvent: function() {
        var availableEvents = this.events.filter(function(event, index) {
          return randomEventsSystem.recentEvents.indexOf(index) === -1;
        });
        
        if (availableEvents.length === 0) {
          availableEvents = this.events;
          this.recentEvents = [];
        }
        
        var selectedEvent = availableEvents[Math.floor(Math.random() * availableEvents.length)];
        var eventIndex = this.events.indexOf(selectedEvent);
        
        this.recentEvents.push(eventIndex);
        if (this.recentEvents.length > this.maxRecentEvents) {
          this.recentEvents.shift();
        }
        
        this.lastEventId = eventIndex;
        this.executeEvent(selectedEvent);
      },
      
      executeEvent: function(event) {
        console.log("üé≤ √âv√©nement d√©clench√©: " + event.nom);
        
        this.currentEvent = event;
        saveState();
        
        var isInOptimum = isInOptimumZone();
        var shouldProtect = isInOptimum && gameState.optimumStreak >= 10;
        
        if (shouldProtect && this.isEventDestructive(event)) {
          this.executeProtectedEvent(event);
          addScenarioMessage("üõ°Ô∏è √âv√©nement att√©nu√© (protection optimum) : " + event.nom, "info");
        } else {
          event.effet(gameState, this);
        }
        
        this.displayEventNotification(event);
        
        setTimeout(function() {
          updateUI("");
        }, 100);
      },
      
      isEventDestructive: function(event) {
        var destructiveIds = [1, 3, 5, 7, 11, 13, 16, 18, 20, 22, 26, 28, 31, 33, 35];
        return destructiveIds.indexOf(event.id) !== -1;
      },
      
      executeProtectedEvent: function(event) {
        var originalState = JSON.parse(JSON.stringify(gameState));
        
        event.effet(gameState, this);
        
        if (gameState.nature < originalState.nature) {
          var natureLoss = originalState.nature - gameState.nature;
          gameState.nature = originalState.nature - Math.floor(natureLoss * 0.5);
        }
        
        if (gameState.confort < originalState.confort) {
          var confortLoss = originalState.confort - gameState.confort;
          gameState.confort = originalState.confort - Math.floor(confortLoss * 0.5);
        }
        
        if (gameState.money < originalState.money) {
          var moneyLoss = originalState.money - gameState.money;
          gameState.money = originalState.money - Math.floor(moneyLoss * 0.5);
        }
        
        gameState.nature = Math.max(0, gameState.nature);
        gameState.confort = Math.max(0, gameState.confort);
      },
      
      displayEventNotification: function(event) {
        var eventDiv = document.getElementById("current-event");
        var eventText = document.getElementById("event-text");
        var eventEffects = document.getElementById("event-effects");
        
        if (eventDiv && eventText) {
          eventText.textContent = "üé≤ " + event.nom + " : " + event.texte;
          
          if (event.effetsDisplay && eventEffects) {
            eventEffects.textContent = event.effetsDisplay;
          } else if (eventEffects) {
            eventEffects.textContent = "";
          }
          
          eventDiv.style.display = "block";
          eventDiv.style.animation = "eventPulse 0.8s ease-in-out";
          
          setTimeout(function() {
            if (eventDiv.style.display === "block") {
              eventDiv.style.display = "none";
            }
          }, 5000);
        }
        
        setTimeout(function() {
          var messageElement = document.getElementById("message");
          if (messageElement && !messageElement.textContent.includes("VICTOIRE") && !messageElement.textContent.includes("zone d'optimum")) {
            messageElement.textContent = "üé≤ " + event.nom;
          }
        }, 200);
      },
      
      addTemporaryEffect: function(type, value, duration, originalValue) {
        var effect = {
          type: type,
          value: value,
          remainingClicks: duration,
          originalValue: originalValue || 0,
          startValue: this.getEffectDisplayValue(type, value)
        };
        
        this.activeTemporaryEffects.push(effect);
        this.updateTemporaryEffectsDisplay();
        
        var displayName = this.getEffectDisplayName(type);
        var displayValue = this.getEffectDisplayValue(type, value);
        addScenarioMessage("‚è±Ô∏è " + displayName + " " + displayValue + " pendant " + duration + " clics", "info");
        
        console.log("‚è±Ô∏è Effet temporaire ajout√©: " + type + " = " + value + " pour " + duration + " clics");
      },
      
      processTemporaryEffects: function() {
        var expiredEffects = [];
        
        for (var i = this.activeTemporaryEffects.length - 1; i >= 0; i--) {
          var effect = this.activeTemporaryEffects[i];
          effect.remainingClicks--;
          
          if (effect.remainingClicks <= 0) {
            expiredEffects.push(effect);
            this.removeTemporaryEffect(effect);
            this.activeTemporaryEffects.splice(i, 1);
          }
        }
        
        if (expiredEffects.length > 0) {
          for (var j = 0; j < expiredEffects.length; j++) {
            var expiredEffect = expiredEffects[j];
            var displayName = this.getEffectDisplayName(expiredEffect.type);
            addScenarioMessage("‚è∞ Fin de l'effet : " + displayName, "info");
          }
          this.updateTemporaryEffectsDisplay();
        }
      },
      
      removeTemporaryEffect: function(effect) {
        console.log("‚è±Ô∏è Fin de l'effet temporaire: " + effect.type);
      },
      
      getCurrentModifier: function(type) {
        var totalModifier = 0;
        this.activeTemporaryEffects.forEach(function(effect) {
          if (effect.type === type) {
            totalModifier += effect.value;
          }
        });
        return totalModifier;
      },
      
      updateTemporaryEffectsDisplay: function() {
        var display = document.getElementById("temp-effects-display");
        var list = document.getElementById("temp-effects-list");
        
        if (!display || !list) return;
        
        if (this.activeTemporaryEffects.length === 0) {
          display.style.display = "none";
          return;
        }
        
        display.style.display = "block";
        list.innerHTML = "";
        
        this.activeTemporaryEffects.forEach(function(effect) {
          var item = document.createElement("div");
          item.className = "temp-effect-item";
          
          var name = document.createElement("div");
          name.className = "temp-effect-name";
          name.textContent = randomEventsSystem.getEffectDisplayName(effect.type) + " " + 
                            randomEventsSystem.getEffectDisplayValue(effect.type, effect.value);
          
          var duration = document.createElement("div");
          duration.className = "temp-effect-duration";
          duration.textContent = effect.remainingClicks + " clics";
          
          item.appendChild(name);
          item.appendChild(duration);
          list.appendChild(item);
        });
      },
      
      getEffectDisplayName: function(type) {
        var names = {
          'productionCost': 'Co√ªt production',
          'sellPrice': 'Prix vente',
          'regeneration': 'R√©g√©n√©ration'
        };
        return names[type] || type;
      },
      
      getEffectDisplayValue: function(type, value) {
        if (type === 'productionCost') {
          return value > 0 ? "+" + value : value.toString();
        } else if (type === 'sellPrice') {
          return (value > 0 ? "+" : "") + (value * 100).toFixed(0) + "%";
        } else if (type === 'regeneration') {
          return "+" + (value * 100).toFixed(0) + "%";
        }
        return value.toString();
      },
      
      getFullState: function() {
        return {
          enabled: this.enabled,
          nextEventIn: this.nextEventIn,
          lastEventId: this.lastEventId,
          recentEvents: [...this.recentEvents],
          activeTemporaryEffects: JSON.parse(JSON.stringify(this.activeTemporaryEffects)),
          automatismEventCooldown: this.automatismEventCooldown
        };
      },
      
      restoreFullState: function(state) {
        this.enabled = state.enabled;
        this.nextEventIn = state.nextEventIn;
        this.lastEventId = state.lastEventId;
        this.recentEvents = [...state.recentEvents];
        this.activeTemporaryEffects = JSON.parse(JSON.stringify(state.activeTemporaryEffects));
        this.automatismEventCooldown = state.automatismEventCooldown || 0;
        this.updateNextEventDisplay();
        this.updateTemporaryEffectsDisplay();
      },
      
      toggle: function() {
        this.enabled = !this.enabled;
        var toggleButton = document.getElementById("events-toggle");
        if (toggleButton) {
          toggleButton.textContent = "√âv√©nements: " + (this.enabled ? "ON" : "OFF");
          toggleButton.className = this.enabled ? "events-toggle" : "events-toggle disabled";
        }
        console.log("üé≤ √âv√©nements al√©atoires: " + (this.enabled ? "ACTIV√âS" : "D√âSACTIV√âS"));
      },
      
      events: [
        {
          id: 1,
          nom: "Invasion de criquets",
          effet: function(gameState) {
            gameState.nature = Math.max(0, gameState.nature - 80);
          },
          texte: "Une invasion de criquets ravage les cultures.",
          effetsDisplay: "Ressources -80"
        },
        {
          id: 2,
          nom: "Boom des √©nergies",
          effet: function(gameState, eventsSystem) {
            eventsSystem.addTemporaryEffect('regeneration', 0.05, 15);
          },
          texte: "L'√©nergie gagne en intensit√©.",
          effetsDisplay: "R√©g√©n√©ration +5% pendant 15 clics"
        },
        {
          id: 3,
          nom: "Temp√™te exceptionnelle",
          effet: function(gameState) {
            gameState.nature = Math.max(0, gameState.nature - 40);
            gameState.ia = Math.max(0, gameState.ia - 1);
          },
          texte: "Une temp√™te d√©truit des infrastructures.",
          effetsDisplay: "Ressources -40, IA -1"
        },
        {
          id: 4,
          nom: "Loterie √©cologique",
          effet: function(gameState) {
            gameState.money += 60;
            gameState.nature += 40;
          },
          texte: "Des investissements √©cologiques sont r√©compens√©s.",
          effetsDisplay: "Monnaie +60‚Ç¨, Ressources +40"
        },
        {
          id: 5,
          nom: "Vague de chaleur",
          effet: function(gameState) {
            gameState.nature = Math.max(0, gameState.nature - 50);
            gameState.confort = Math.max(0, gameState.confort - 1);
          },
          texte: "La chaleur met la soci√©t√© √† l'√©preuve.",
          effetsDisplay: "Ressources -50, Confort -1"
        },
        {
          id: 6,
          nom: "Innovation disruptive",
          effet: function(gameState, eventsSystem) {
            gameState.ia += 1;
            eventsSystem.addTemporaryEffect('productionCost', -1, 15);
          },
          texte: "Une IA am√©liore la productivit√©.",
          effetsDisplay: "IA +1, Co√ªt production -1 pendant 15 clics"
        },
        {
          id: 7,
          nom: "Cyberattaque",
          effet: function(gameState) {
            gameState.money -= 50;
            gameState.ia = Math.max(0, gameState.ia - 1);
          },
          texte: "Un piratage paralyse une partie du syst√®me.",
          effetsDisplay: "Monnaie -50‚Ç¨, IA -1"
        },
        {
          id: 8,
          nom: "R√©volution citoyenne",
          effet: function(gameState) {
            gameState.confort += 2;
            gameState.nature += 30;
          },
          texte: "Une vague d'engagement citoyen.",
          effetsDisplay: "Confort +2, Ressources +30"
        },
        {
          id: 9,
          nom: "Pollution industrielle",
          effet: function(gameState) {
            gameState.nature = Math.max(0, gameState.nature - 40);
            gameState.money += 70;
          },
          texte: "La pollution profite √† l'√©conomie, mais d√©truit la nature.",
          effetsDisplay: "Ressources -40, Monnaie +70‚Ç¨"
        },
        {
          id: 10,
          nom: "Fusion d'entreprises",
          effet: function(gameState) {
            gameState.money += 80;
            gameState.ia += 1;
            gameState.nature = Math.max(0, gameState.nature - 20);
          },
          texte: "Les grands groupes grossissent.",
          effetsDisplay: "Monnaie +80‚Ç¨, IA +1, Ressources -20"
        },
        // ... (tous les autres √©v√©nements suivent le m√™me pattern)
        {
          id: 40,
          nom: "Fusion IA/nature",
          effet: function(gameState, eventsSystem) {
            gameState.ia += 2;
            gameState.nature += 40;
            eventsSystem.addTemporaryEffect('productionCost', -2, 8);
          },
          texte: "La tech sert la nature.",
          effetsDisplay: "IA +2, Ressources +40, Co√ªt production -2 pendant 8 clics"
        }
      ]
    };

    // Configuration des paliers
    var paliersConfig = {
      comfort: { 
        palierBase: 120, 
        cycle: 0,
        coutBase: 100,
        multiplicateurCout: 1,
        name: "Achat",
        emoji: "üõãÔ∏è"
      },
      ia: { 
        palierBase: 200, 
        cycle: 200,
        coutBase: 500,
        multiplicateurCout: 1.5,
        name: "Engager une IA",
        emoji: "ü§ñ"
      },
      trader: { 
        palierBase: 500, 
        cycle: 500,
        coutBase: 1000,
        multiplicateurCout: 1.5,
        name: "Trader automatique",
        emoji: "ü§ñ"
      },
      upgradeProd: { 
        palierBase: 600, 
        cycle: 600,
        coutBase: 2000,
        multiplicateurCout: 1.5,
        name: "Am√©liorer la production",
        emoji: "üí†"
      },
      confortAuto: { 
        palierBase: 700, 
        cycle: 700,
        coutBase: 2000,
        multiplicateurCout: 1.5,
        name: "Achat auto confort",
        emoji: "üîÑ"
      },
      automatismsClics: { 
        palierBase: 750, 
        cycle: 0,
        coutBase: 10000,
        multiplicateurCout: 1,
        name: "Automatismes = clics",
        emoji: "‚ö°"
      },
      priceIndicator: { 
        palierBase: 1000, 
        cycle: 0,
        coutBase: 30000,
        multiplicateurCout: 1,
        name: "Indicateur de prix",
        emoji: "üìä"
      },
      centreCommercial: { 
        palierBase: 1100, 
        cycle: 1100,
        coutBase: 5000,
        multiplicateurCout: 1.5,
        name: "Centre commercial",
        emoji: "üè¨"
      }
    };

    // FONCTIONS PRINCIPALES DU JEU

    // Fonctions utilitaires pour les effets temporaires
    function getModifiedProductionCost(baseCost) {
      var modifier = randomEventsSystem.getCurrentModifier('productionCost');
      return Math.max(1, baseCost + modifier);
    }
    
    function getModifiedSellPrice(basePrice) {
      var modifier = randomEventsSystem.getCurrentModifier('sellPrice');
      return Math.max(0.1, basePrice * (1 + modifier));
    }
    
    function applyRegenerationBonus() {
      var regenBonus = randomEventsSystem.getCurrentModifier('regeneration');
      if (regenBonus > 0) {
        var bonusAmount = Math.floor(gameState.nature * regenBonus);
        gameState.nature += bonusAmount;
        console.log("üå± R√©g√©n√©ration bonus: +" + bonusAmount + " ressources");
      }
    }

    // Fonctions de gestion de l'optimum
    function isInOptimumZone() {
      return (
        gameState.nature >= OPTIMUM_THRESHOLDS.nature.min && 
        gameState.nature <= OPTIMUM_THRESHOLDS.nature.max &&
        gameState.confort >= OPTIMUM_THRESHOLDS.confort.min && 
        gameState.confort <= OPTIMUM_THRESHOLDS.confort.max &&
        gameState.money >= OPTIMUM_THRESHOLDS.money.min && 
        gameState.money <= OPTIMUM_THRESHOLDS.money.max
      );
    }
    
    function checkOptimumZone() {
      if (gameState.optimumVictory || gameState.gameOver) return;
      
      if (isInOptimumZone()) {
        gameState.optimumStreak++;
        
        if (gameState.optimumStreak === OPTIMUM_MILESTONE) {
          addScenarioMessage("üéØ Excellent ! Vous maintenez l'√©quilibre depuis " + OPTIMUM_MILESTONE + " actions !", "success");
        }
        
        if (gameState.optimumStreak >= OPTIMUM_TARGET) {
          triggerOptimumVictory();
        }
      } else {
        if (gameState.optimumStreak > 0) {
          gameState.optimumStreak = 0;
        }
      }
      
      updateOptimumDisplay();
    }
    
    function updateOptimumDisplay() {
      var progressFill = document.getElementById("optimum-progress-fill");
      var progressText = document.getElementById("optimum-progress-text");
      var status = document.getElementById("optimum-status");
      
      if (!progressFill || !progressText || !status) return;
      
      var percentage = Math.min(100, (gameState.optimumStreak / OPTIMUM_TARGET) * 100);
      progressFill.style.width = percentage + "%";
      progressText.textContent = gameState.optimumStreak + " / " + OPTIMUM_TARGET;
      
      if (gameState.optimumVictory) {
        status.textContent = "üèÜ Victoire atteinte !";
        status.style.color = "#b8860b";
        status.style.fontWeight = "bold";
      } else if (isInOptimumZone()) {
        status.textContent = "‚úÖ Dans la zone d'optimum ! Continuez ainsi...";
        status.style.color = "#2e7d32";
        status.style.fontWeight = "bold";
      } else {
        status.textContent = "‚ùå Ajustez";
        status.style.color = "#cc0000";
        status.style.fontWeight = "normal";
      }
    }
    
    function triggerOptimumVictory() {
      gameState.optimumVictory = true;
      gameState.jeuBloque = true;
      
      clearAllIntervals();
      hideAllActionButtons();
      
      document.getElementById("optimum-victory").style.display = "block";
      
      addScenarioMessage("üèÜ VICTOIRE ! Vous avez maintenu l'√©quilibre optimum pendant " + OPTIMUM_TARGET + " actions !", "success");
      
      updateOptimumDisplay();
    }

    // Actions principales du joueur
    function produce() {
      if (gameState.jeuBloque || gameState.optimumVictory) return;
      saveState();
      
      var baseCost = 5;
      var cost = getModifiedProductionCost(baseCost);
      
      if (gameState.nature >= cost) {
        gameState.nature -= cost;
        var prodAmount = Math.floor(gameState.productionMultiplier);
        gameState.production += prodAmount;
        gameState.clicks++;
        
        randomEventsSystem.processClick(false);
        
        if (gameState.ehActivated) {
          checkEHMechanics();
        } else {
          checkAndApplyTax();
        }
        
        applyRegenerationBonus();
        
        var message = "Production : +" + prodAmount + " produits cr√©√©s";
        if (cost !== baseCost) {
          message += " (co√ªt modifi√©: " + cost + " ressources)";
        }
        updateUI(message);
      } else {
        updateUI("Pas assez de ressources pour produire (co√ªt: " + cost + ")");
      }
    }
    
    function sell() {
      if (gameState.jeuBloque || gameState.production <= 0 || gameState.optimumVictory) {
        if (gameState.production <= 0) updateUI("Aucun produit √† vendre");
        return;
      }
      
      saveState();
      var price = calculatePrice();
      var saleAmount = Math.min(gameState.production, 1);
      var totalEarnings = price * saleAmount;
      
      gameState.money += totalEarnings;
      gameState.production -= saleAmount;
      gameState.clicks++;
      
      randomEventsSystem.processClick(false);
      
      if (gameState.ehActivated) {
        applyEHTax(totalEarnings);
        checkEHMechanics();
      } else {
        checkAndApplyTax();
      }
      
      applyRegenerationBonus();
      
      if (!gameState.monnaieActive) {
        gameState.monnaieActive = true;
        document.getElementById("money-row").style.display = "block";
        document.getElementById("jauge-money-container").style.display = "flex";
      }
      
      updateUI("Vente : +" + totalEarnings.toFixed(2) + "‚Ç¨");
    }
    
    function receiveDon() {
      if (gameState.jeuBloque || gameState.optimumVictory) return;
      saveState();
      
      gameState.money = 1000;
      gameState.clicks++;
      
      randomEventsSystem.processClick(false);
      
      if (gameState.ehActivated) {
        checkEHMechanics();
      } else {
        checkAndApplyTax();
      }
      
      applyRegenerationBonus();
      
      if (!gameState.monnaieActive) {
        gameState.monnaieActive = true;
        document.getElementById("money-row").style.display = "block";
        document.getElementById("jauge-money-container").style.display = "flex";
      }
      
      document.getElementById("don-btn").style.display = "none";
      updateUI("Don re√ßu : 1000‚Ç¨");
    }

    // Fonctions d'achat
    function acheterConfort() {
      if (gameState.jeuBloque || !gameState.monnaieActive || gameState.optimumVictory) return;
      
      var cost = 100;
      
      if (needsCreditActivation(cost)) {
        if (showCreditButton('comfort', cost)) {
          updateUI("Solde insuffisant pour acheter du confort - Cr√©dit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(cost);
      gameState.confort += 1;
      gameState.clicks++;
      
      randomEventsSystem.processClick(false);
      
      if (gameState.ehActivated) {
        checkEHMechanics();
      } else {
        checkAndApplyTax();
      }
      
      applyRegenerationBonus();
      
      if (gameState.confort === 1) {
        document.getElementById("jauge-confort-container").style.display = "flex";
      }
      
      var message = "Confort achet√© : +1 confort";
      if (gameState.money < 0) {
        message += " - Solde : " + gameState.money + "‚Ç¨";
      }
      updateUI(message);
    }

    // Fonctions utilitaires
    function calculatePrice() {
      if (gameState.nature === 0) return 1;
      var basePrice = Math.max(1, Math.abs(gameState.money) / gameState.nature);
      var modifiedPrice = getModifiedSellPrice(basePrice);
      return Math.round(modifiedPrice * 100) / 100;
    }

    function saveState() {
      lastState = {
        gameState: JSON.parse(JSON.stringify(gameState)),
        automatismsActive: {...automatismsActive},
        pendingPurchase: pendingPurchase ? {...pendingPurchase} : null,
        eventsState: randomEventsSystem.getFullState()
      };
    }

    function updateUI(message) {
      checkAndUnlockPaliersCycliques();
      updateAutomatismControls();
      updateUIValues();
      updateBudgetEtatUI();
      
      if (message) {
        document.getElementById("message").textContent = message;
      }
    }

    function updateUIValues() {
      document.getElementById("nature").textContent = Math.floor(gameState.nature);
      document.getElementById("confort").textContent = Math.floor(gameState.confort);
      document.getElementById("production").textContent = Math.floor(gameState.production);
      document.getElementById("money").textContent = Math.floor(gameState.money);
      document.getElementById("clicks").textContent = gameState.clicks;
      document.getElementById("budget-etat").textContent = Math.floor(gameState.budgetEtat);
      
      if (gameState.confort > gameState.confortMaxAtteint) {
        gameState.confortMaxAtteint = gameState.confort;
      }
      
      if (!gameState.gameOver && !gameState.ehActivated && !gameState.optimumVictory) {
        if (gameState.nature <= 0) {
          triggerGameOver('resources');
          return;
        }
        if (gameState.confort <= 0 && gameState.confortMaxAtteint > 0) {
          triggerGameOver('confort');
          return;
        }
      }
      
      updateJauges();
      updateCrises();
      checkAndUnlockPaliersCycliques();
      updateAutomatismControls();
      
      checkOptimumZone();
      
      if (gameState.priceIndicatorActive) {
        document.getElementById("price-indicator-box").style.display = "block";
        var currentPrice = calculatePrice();
        document.getElementById("current-price").textContent = currentPrice.toFixed(2) + "‚Ç¨";
      }
    }

    function updateJauges() {
      var maxVals = {
        nature: Math.max(3000, gameState.nature * 1.2),
        confort: Math.max(100, gameState.confort * 1.2),
        money: Math.max(10000, Math.abs(gameState.money) * 1.2),
        budgetEtat: Math.max(1000, gameState.budgetEtat * 1.2),
        achatAuto: Math.max(10, gameState.confortAuto * 1.2),
        ia: Math.max(10, gameState.ia * 1.2),
        trader: Math.max(10, gameState.traderAuto * 1.2),
        centre: Math.max(10, gameState.centreCommercial * 1.2),
        tech: Math.max(5, gameState.techLevel * 1.2)
      };
      
      var naturePercent = Math.min(100, Math.max(0, (gameState.nature / maxVals.nature) * 100));
      document.getElementById("jauge-nature").style.width = naturePercent + "%";
      document.getElementById("jauge-nature-txt").textContent = Math.floor(gameState.nature);
      
      if (gameState.confort > 0) {
        document.getElementById("jauge-confort-container").style.display = "flex";
        var confortPercent = Math.min(100, Math.max(0, (gameState.confort / maxVals.confort) * 100));
        document.getElementById("jauge-confort").style.width = confortPercent + "%";
        document.getElementById("jauge-confort-txt").textContent = Math.floor(gameState.confort);
      }
      
      if (gameState.monnaieActive) {
        var moneyPercent = Math.min(100, Math.max(0, (Math.abs(gameState.money) / maxVals.money) * 100));
        document.getElementById("jauge-money").style.width = moneyPercent + "%";
        document.getElementById("jauge-money-txt").textContent = Math.floor(gameState.money) + "‚Ç¨";
      }
    }

    function updateCrises() {
      var criseBox = document.getElementById("alert-crise");
      if (gameState.nature < 300) {
        criseBox.style.display = "block";
        criseBox.textContent = "Crise √©cologique : risque sur l'habitabilit√© humaine de la plan√®te";
      } else {
        criseBox.style.display = "none";
      }
    }

    function checkAndUnlockPaliersCycliques() {
      if (!gameState.monnaieActive || gameState.optimumVictory) return;
      
      if (gameState.clicks >= paliersConfig.comfort.palierBase && !gameState.paliersDebloque.comfort) {
        document.getElementById("comfort-btn").style.display = "block";
      }
    }

    function updateAutomatismControls() {
      var hasAnyAutomatism = (gameState.ia > 0 || gameState.traderAuto > 0 || gameState.confortAuto > 0 || gameState.centreCommercial > 0);
      
      if (hasAnyAutomatism && !gameState.ehActivated && !gameState.optimumVictory) {
        document.getElementById("automatisms-controls").style.display = "flex";
      } else {
        document.getElementById("automatisms-controls").style.display = "none";
      }
    }

    function checkAndApplyTax() {
      if (gameState.ehActivated) return;
      
      if (gameState.clicks % 10 === 0 && gameState.clicks > 0) {
        var tax = Math.ceil(Math.abs(gameState.money) * 0.2);
        
        gameState.money -= tax;
        gameState.budgetEtat += tax;
        
        var ressourcesBonus = 1;
        gameState.nature += ressourcesBonus;
        
        updateBudgetEtatUI();
        showTaxMessage(tax, ressourcesBonus, 0);
      }
    }
    
    function updateBudgetEtatUI() {
      document.getElementById("budget-etat").textContent = gameState.budgetEtat;
      
      if (gameState.budgetEtat > 0) {
        document.getElementById("budget-etat-row").style.display = "block";
        document.getElementById("jauge-budget-etat-container").style.display = "flex";
      }
    }
    
    function showTaxMessage(tax, ressourcesBonus, confortReduction) {
      var messageElement = document.getElementById("message");
      var message = "üí∏ Imp√¥t pr√©lev√© : " + tax + " ‚Ç¨ (Budget √âtat : " + gameState.budgetEtat + " ‚Ç¨)";
      
      if (ressourcesBonus > 0) {
        message += " - Ressources +" + ressourcesBonus;
      }
      
      messageElement.textContent = message;
      
      setTimeout(function() {
        if (messageElement.textContent.includes("Imp√¥t pr√©lev√©")) {
          messageElement.textContent = "";
        }
      }, 4000);
    }

    // Fonctions de cr√©dit
    function needsCreditActivation(amount) {
      return gameState.money < amount && !gameState.creditUnlocked;
    }
    
    function showCreditButton(purchaseType, amount) {
      if (gameState.creditUnlocked) return false;
      if (document.getElementById("credit-btn").style.display === "block") return false;
      
      pendingPurchase = { type: purchaseType, amount: amount };
      document.getElementById("credit-btn").style.display = "block";
      return true;
    }
    
    function activateCredit() {
      if (gameState.optimumVictory) return;
      
      saveState();
      gameState.creditUnlocked = true;
      document.getElementById("credit-btn").style.display = "none";
      
      if (pendingPurchase) {
        executePendingPurchase();
        pendingPurchase = null;
      }
      
      updateUI("üí≥ Cr√©dit activ√© ! Tous les achats sont maintenant possibles");
    }
    
    function executePendingPurchase() {
      switch(pendingPurchase.type) {
        case 'comfort': acheterConfort(); break;
        default: break;
      }
    }
    
    function debitMoney(amount) {
      gameState.money -= amount;
      
      if (gameState.ehActivated) {
        applyEHTax(amount);
      }
    }

    // Fonctions de Game Over
    function triggerGameOver(cause) {
      gameState.gameOver = true;
      gameState.gameOverCause = cause;
      gameState.jeuBloque = true;
      
      clearAllIntervals();
      hideAllActionButtons();
      
      if (cause === 'resources') {
        var gameOverBox = document.getElementById("game-over-resources");
        gameOverBox.style.display = "block";
        gameOverBox.textContent = "üåç La plan√®te n'est plus habitable : Perdu !";
        updateUI("üåç D√©faite : La plan√®te n'est plus habitable");
      } else if (cause === 'confort') {
        var gameOverBox = document.getElementById("game-over-confort");
        gameOverBox.style.display = "block";
        gameOverBox.textContent = "‚öîÔ∏è R√©volution de la soci√©t√© : Perdu !";
        updateUI("‚öîÔ∏è D√©faite : R√©volution de la soci√©t√©");
      }
    }
    
    function hideAllActionButtons() {
      document.getElementById("produce-btn").style.display = "none";
      document.getElementById("sell-btn").style.display = "none";
      document.getElementById("comfort-btn").style.display = "none";
      document.getElementById("don-btn").style.display = "none";
      document.getElementById("credit-btn").style.display = "none";
    }

    function clearAllIntervals() {
      Object.keys(intervals).forEach(key => {
        if (intervals[key]) {
          clearInterval(intervals[key]);
          intervals[key] = null;
        }
      });
    }

    // Fonctions EH (mode √©conomie hom√©ostatique)
    function checkEHMechanics() {
      if (!gameState.ehActivated) return;
      // Logique EH simplifi√©e pour cette version
    }
    
    function applyEHTax(amount) {
      if (!gameState.ehActivated) return 0;
      
      var tax = Math.round(Math.abs(amount) * 0.04);
      gameState.money -= tax;
      
      console.log("üí∏ Taxe EH transaction:", tax, "‚Ç¨ sur", amount, "‚Ç¨");
      return tax;
    }

    // Fonctions utilitaires
    function addScenarioMessage(message, type) {
      if (type === undefined) type = "info";
      var messageElement = document.getElementById("message");
      var icon = "";
      
      switch(type) {
        case "warning": icon = "‚ö†Ô∏è "; break;
        case "success": icon = "‚úÖ "; break;
        case "crisis": icon = "üö® "; break;
        case "info": icon = "‚ÑπÔ∏è "; break;
        case "eco": icon = "üå± "; break;
        default: icon = "";
      }
      
      messageElement.textContent = icon + message;
    }

    // Fonctions pour les √©v√©nements
    function toggleEvents() {
      randomEventsSystem.toggle();
    }
    
    function triggerTestEvent() {
      if (!cheatModeUnlocked) {
        addScenarioMessage("üîí Activez d'abord les outils de test", "warning");
        return;
      }
      
      randomEventsSystem.triggerRandomEvent();
      addScenarioMessage("üß™ √âv√©nement de test d√©clench√©", "info");
    }

    // Fonctions pour les automatismes
    function toggleAutomatism(type) {
      if (gameState.ehActivated || gameState.optimumVictory) return;
      
      if (type === 'ia' && gameState.ia === 0) return;
      if (type === 'trader' && gameState.traderAuto === 0) return;
      if (type === 'confort' && gameState.confortAuto === 0) return;
      if (type === 'centre' && gameState.centreCommercial === 0) return;
      
      automatismsActive[type] = !automatismsActive[type];
      updateUI("Automatisme " + type + " : " + (automatismsActive[type] ? "ON" : "OFF"));
    }

    // Fonctions de triche/debug
    function toggleCheatMode() {
      cheatModeUnlocked = !cheatModeUnlocked;
      
      var unlockBtn = document.getElementById("unlock-cheat-btn");
      var cheatButtons = document.getElementById("cheat-buttons");
      
      if (cheatModeUnlocked) {
        unlockBtn.textContent = "üîí Masquer les outils de test";
        unlockBtn.className = "btn-annuler";
        cheatButtons.style.display = "flex";
        addScenarioMessage("Outils de d√©veloppement activ√©s", "info");
      } else {
        unlockBtn.textContent = "üîì D√©v√©rouiller les outils de test";
        unlockBtn.className = "btn-yellow";
        cheatButtons.style.display = "none";
        addScenarioMessage("Outils de d√©veloppement masqu√©s", "info");
      }
    }
    
    function addMoney() {
      if (!cheatModeUnlocked) return;
      saveState();
      gameState.money += 1000;
      addScenarioMessage("Test : +1000‚Ç¨", "info");
      updateUIValues();
    }
    
    function addOneNature() {
      if (!cheatModeUnlocked) return;
      saveState();
      gameState.nature += 100;
      addScenarioMessage("Test : +100 ressources", "info");
      updateUIValues();
    }
    
    function addClicks50() {
      if (!cheatModeUnlocked) return;
      saveState();
      gameState.clicks += 50;
      
      randomEventsSystem.processClick(true);
      
      addScenarioMessage("Test : +50 clics - Total : " + gameState.clicks + " clics", "info");
      updateUIValues();
    }
    
    function removeNature100() {
      if (!cheatModeUnlocked) return;
      saveState();
      gameState.nature -= 100;
      if (gameState.nature < 0) gameState.nature = 0;
      addScenarioMessage("Test : -100 ressources", "info");
      updateUIValues();
    }
    
    function forceActivateEH() {
      if (!cheatModeUnlocked) return;
      saveState();
      gameState.ehActivated = true;
      addScenarioMessage("Mode EH activ√© en force (test)", "info");
    }
    
    function undoAction() {
      if (!cheatModeUnlocked) return;
      if (lastState) {
        clearAllIntervals();
        
        gameState = JSON.parse(JSON.stringify(lastState.gameState));
        automatismsActive = {...lastState.automatismsActive};
        pendingPurchase = lastState.pendingPurchase ? {...lastState.pendingPurchase} : null;
        
        if (lastState.eventsState) {
          randomEventsSystem.restoreFullState(lastState.eventsState);
        }
        
        addScenarioMessage("Action annul√©e", "info");
        updateUIValues();
      }
    }

    // Fonction d'initialisation
    function initializeGame() {
      updateOptimumDisplay();
      
      randomEventsSystem.initialize();
      
      setTimeout(function() {
        addScenarioMessage("üåç La plan√®te est en surchauffe. Vos choix √©conomiques d√©termineront l'habitabilit√© future de la Terre.", "info");
      }, 1500);
      
      setTimeout(function() {
        addScenarioMessage("üõ†Ô∏è Commencez par produire quelques biens pour g√©n√©rer une √©conomie.", "info");
      }, 6000);
      
      setTimeout(function() {
        addScenarioMessage("üéØ Objectif : atteindre et maintenir l'√©quilibre", "info");
      }, 10000);
      
      setTimeout(function() {
        addScenarioMessage("üé≤ Des √©v√©nements al√©atoires peuvent bouleverser votre strat√©gie...", "info");
      }, 14000);
      
      updateUI("");
    }

    // Initialisation du jeu au chargement de la page
    initializeGame();
  </script>
</body>
</html>
