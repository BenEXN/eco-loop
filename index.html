<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Looop v1.27.2 ‚Äì Interface naturelle et √©pur√©e</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #f3f3f3; font-family: sans-serif; margin:0; padding:0; }
    h1 { text-align: center; margin: 25px 0 10px; }
    .container { display: flex; justify-content: center; align-items: flex-start; margin: 0 auto 18px auto; max-width: 950px; gap: 24px;}
    .category { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #0001; flex: 1; padding: 32px 18px 18px 18px; margin: 0 6px; min-width: 250px; max-width: 320px; min-height: 250px; display: flex; flex-direction: column; align-items: center;}
    .cat-title { font-size: 1.25em; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px;}
    .stock { font-size: 1.1em; margin-bottom: 10px;}
    .products-box { background: #f7f7fa; border: 2px solid #dde1eb; border-radius: 10px; color: #333; margin-bottom: 10px; padding: 10px 28px; font-size: 1.2em; font-weight: bold; letter-spacing: 1px; box-shadow: 0 1px 4px #ddd5; min-width: 110px; text-align: center;}
    .message-box { border-radius: 10px; margin: 8px 0 14px 0; padding: 11px 14px 11px 14px; font-weight: bold; font-size: 1.08em; box-shadow: 0 1px 4px #0002; text-align: center; min-width: 130px; max-width: 260px; word-break: break-word; line-height: 1.25em;}
    .msg-orange { background: #fff2e6; color: #cc5500; border: 2px solid #ff8533; }
    .msg-blue { background: #e6f3ff; color: #0066cc; border: 2px solid #4da6ff; }
    .msg-red { background: #ffe6e6; color: #cc0000; border: 2px solid #ff6666; }
    .msg-brown { background: #fff7e6; color: #996600; border: 2px solid #cc9900; }
    .msg-green { background: #e6ffe6; color: #006600; border: 2px solid #66cc66; }
    .msg-gold { background: #fff9c4; color: #b8860b; border: 2px solid #f4d03f;}
    .msg-natural { background: #f0f8f0; color: #2e7d32; border: 2px solid #81c784;}
    .btn-row { margin: 18px 0 0 0;}
    button { font-size: 1em; padding: 10px 18px; margin: 5px 0; border-radius: 14px; border: none; background: #ededed; color: #111; cursor: pointer; transition: background 0.2s;}
    .btn-yellow { background: #FFD600; color: #222; font-weight: bold;}
    .btn-annuler { background: #aaa; color: #fff; }
    .btn-credit { background: #ff6b35; color: #fff; font-weight: bold;}
    .btn-evolution { background: #4CAF50; color: #fff; font-weight: bold;}
    .btn-restart { background: #2196F3; color: #fff; font-weight: bold;}
    .debug-row { margin: 0 0 32px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;}
    .message { font-weight: bold; min-height: 24px; margin: 10px 0;}
    #clics-container { text-align: center; margin: 25px 0 0 0; font-size: 1.2em; font-weight: bold; color: #333;}
    #don-btn { margin-top: 10px; background: #FFD600; color: #222; font-weight: bold; border: none; border-radius: 8px; font-size: 1.1em; padding: 14px 20px;}
    #triche-sep { border: none; border-top: 3px solid #222; margin: 38px auto 12px auto; width: 94vw; max-width: 1000px;}
    #triche-label { text-align: left; font-size:1.13em; font-weight:normal; letter-spacing:1px; margin: 0 0 12px 0; color:#555; width: 95vw; max-width: 1000px; margin-left: auto; margin-right: auto;}
      
    #unlock-cheat-btn { 
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #unlock-cheat-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    #cheat-buttons {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .automatisms-controls { 
      margin: 15px auto 15px auto; 
      max-width: 950px; 
      display: none;
      justify-content: center; 
      gap: 20px; 
      flex-wrap: wrap;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
    }
    .control-btn { font-size: 0.9em; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s; min-width: 80px;}
    .control-btn.active { background: #4CAF50; color: white; }
    .control-btn.inactive { background: #f44336; color: white; }
    .control-btn.disabled { background: #ccc; color: #888; cursor: not-allowed; }
    
    .optimum-zone { 
      margin: 15px auto; 
      max-width: 950px; 
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
      text-align: center;
    }
    .optimum-title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #333; }
    .optimum-progress-bar { background: #eee; border-radius: 20px; height: 20px; margin: 10px auto; max-width: 400px; overflow: hidden; position: relative; }
    .optimum-progress-fill { height: 100%; border-radius: 20px; transition: width 0.3s ease; background: linear-gradient(90deg, #4CAF50, #81C784); }
    .optimum-progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #333; font-size: 0.9em; }
    .optimum-status { font-size: 0.9em; margin-top: 8px; color: #666; }
    .optimum-victory { 
      background: #fff9c4; border: 2px solid #f4d03f; color: #b8860b; padding: 20px; border-radius: 15px; font-size: 1.2em; font-weight: bold; text-align: center; margin: 20px auto; max-width: 600px; animation: victoryPulse 2s infinite;
    }
    @keyframes victoryPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .events-zone { margin: 15px auto; max-width: 950px; padding: 15px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; }
    .event-notification { background: #f0f8f0; border: 2px solid #81c784; border-radius: 10px; padding: 12px; margin: 10px 0; font-weight: bold; text-align: center; color: #2e7d32; animation: eventPulse 0.8s ease-in-out; position: relative; overflow: hidden; }
    .event-notification::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 1.5s ease-in-out; }
    @keyframes eventPulse { 0% { transform: scale(0.95); opacity: 0; } 50% { transform: scale(1.02); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
    .event-effects-display { font-size: 0.85em; color: #666; margin-top: 5px; font-style: italic; }

    .temp-effects-display { background: #f5f7f5; border: 2px solid #81c784; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85em; display: none; }
    .temp-effects-title { font-weight: bold; color: #2e7d32; margin-bottom: 8px; text-align: center; }
    .temp-effect-item { background: #fff; border: 1px solid #a5d6a7; border-radius: 4px; padding: 4px 8px; margin: 2px 0; display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; }
    .temp-effect-name { font-weight: bold; color: #333; }
    .temp-effect-duration { color: #666; font-size: 0.75em; }
    
    .jauge-bottom-barre { margin: 0 auto 6px auto; display: flex; flex-direction: row; align-items: center; gap: 8px; max-width: 600px;}
    .jauge-bottom-label { min-width: 70px; font-size: .99em; color: #888; text-align: right;}
    .jauge-bottom-bar { background: #eee; border-radius: 8px; height: 13px; flex: 1; overflow: hidden; position: relative;}
    .jauge-bottom-fill { height: 100%; border-radius: 8px; transition: width 0.19s;}
    #jauge-nature { background: #86e08e;}
    #jauge-confort { background: #86b6ea;}
    #jauge-money { background: #ffb3b3;}
    #jauge-achat-auto { background: #ffa726;}
    #jauge-ia { background: #ab47bc;}
    #jauge-trader { background: #26c6da;}
    #jauge-centre { background: #66bb6a;}
    #jauge-budget-etat { background: #ff9800;}
    #jauge-tech { background: #9c27b0;}
    .hidden { display: none; }

    .investment-block { background: #e8f5e8; border: 2px solid #81c784; border-radius: 10px; padding: 15px; margin: 10px 0; }
    .investment-title { font-weight: bold; color: #2e7d32; margin-bottom: 10px; text-align: center; }
    .investment-input { width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin: 0 5px; font-size: 1em; }
    .investment-list { font-size: 0.9em; color: #555; margin-top: 10px; max-height: 100px; overflow-y: auto; }
    .investment-preview { font-size: 0.8em; color: #2e7d32; margin-top: 5px; font-style: italic; min-height: 16px; }
    .investment-controls { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 5px; }
    
    .success-flash { animation: successPulse 0.6s ease-in-out; }
    @keyframes successPulse { 0% { background-color: inherit; } 50% { background-color: #c8f5c8; } 100% { background-color: inherit; } }
    
    @media (max-width: 700px) {
      body { font-size: 14px; }
      h1 { font-size: 1.5em; margin: 15px 0 5px; }
      .container { flex-direction: column; max-width: 100vw; padding: 0 5px; gap: 10px; margin: 0 auto 10px auto; }
      .category { min-width: unset; max-width: unset; width: calc(100vw - 20px); padding: 20px 12px 12px 12px; margin: 0; min-height: 200px; }
      .cat-title { font-size: 1.1em; margin-bottom: 15px; }
      .stock { font-size: 1em; margin-bottom: 8px; }
      .products-box { font-size: 1em; padding: 8px 20px; min-width: 90px; }
      .message-box { font-size: 1em; min-width: 100px; max-width: calc(100vw - 60px); }
      button { font-size: 1em; padding: 12px 20px; margin: 6px 0; min-height: 44px; }
      .investment-input { width: 70px; padding: 10px; font-size: 1.1em; }
      .investment-controls { flex-direction: column; gap: 10px; }
      .automatisms-controls { max-width: 100vw; padding: 10px; gap: 10px; }
      .control-btn { min-width: 70px; padding: 10px 14px; font-size: 0.9em; }
      .optimum-zone, .events-zone { max-width: calc(100vw - 20px); margin: 10px; padding: 12px; }
      .optimum-progress-bar { max-width: 300px; }
      .temp-effects-display { margin: 8px 0; padding: 8px; }
      .jauge-bottom-barre { max-width: calc(100vw - 30px); gap: 6px; }
      .jauge-bottom-label { min-width: 60px; font-size: 0.9em; }
      #clics-container { font-size: 1.1em; margin: 20px 0 0 0; }
      #don-btn { padding: 16px 24px; font-size: 1.1em; }
      .debug-row { flex-direction: column; gap: 8px; margin: 0 0 20px 0; align-items: center; }
      .debug-row button { min-width: 200px; }
      #triche-label { max-width: calc(100vw - 20px); margin-left: 10px; margin-right: 10px; }
      #triche-sep { width: calc(100vw - 20px); }
      .event-notification { margin: 8px 0; padding: 10px; font-size: 0.95em; }
    }
  </style>
</head>
<body>
  
  <h1>üåç Looop <span style="font-size:0.7em;color:#777;">v1.27.2 - Interface naturelle et √©pur√©e</span></h1>
  
  <div class="automatisms-controls" id="automatisms-controls">
    <button class="control-btn disabled" id="control-ia" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button class="control-btn disabled" id="control-trader" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button class="control-btn disabled" id="control-confort" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button class="control-btn disabled" id="control-centre" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>
  
  <div class="optimum-zone" id="optimum-zone">
    <div class="optimum-title">üéØ Zone d'√âquilibre</div>
    <div class="optimum-progress-bar">
      <div class="optimum-progress-fill" id="optimum-progress-fill"></div>
      <div class="optimum-progress-text" id="optimum-progress-text">0 / 50</div>
    </div>
    <div class="optimum-status" id="optimum-status">Objectif : maintenir l'√©quilibre pendant 50 actions</div>
  </div>

  <div class="events-zone" id="events-zone">
    <div class="optimum-title">üåø √âv√©nements Al√©atoires</div>
    <div id="current-event" class="event-notification" style="display: none;">
      <div id="event-text">Aucun √©v√©nement en cours</div>
      <div id="event-effects" class="event-effects-display"></div>
    </div>
    
    <div id="temp-effects-display" class="temp-effects-display">
      <div class="temp-effects-title">‚è±Ô∏è Effets temporaires actifs</div>
      <div id="temp-effects-list"></div>
    </div>
  </div>
  
  <div id="optimum-victory" class="optimum-victory" style="display:none;">
    üèÜ VICTOIRE ! üèÜ<br>
    Vous avez maintenu l'√©quilibre optimum !<br>
    <button class="btn-restart" onclick="restartGame()" style="margin-top: 15px;">üîÑ Recommencer une partie</button>
  </div>
  
  <div class="container">
    <div class="category">
      <div class="cat-title">üå± Environnement</div>
      <div class="stock">Ressources : <span id="nature">3000</span></div>
      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>
      
      <div id="investment-block" class="investment-block" style="display:none;">
        <div class="investment-title">üå± Investissement √©cologique</div>
        <div class="investment-controls">
          <input type="number" id="investment-amount" class="investment-input" placeholder="‚Ç¨" min="1" oninput="updateInvestmentPreview()">
          <button onclick="makeEcologicalInvestment()">üíö Investir</button>
        </div>
        <div id="investment-preview" class="investment-preview"></div>
        <div id="investment-list" class="investment-list"></div>
      </div>
      
      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
      </div>
    </div>
    
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock">Confort : <span id="confort">0</span></div>
      <div class="products-box">
        Produits cr√©√©s<br>
        <span id="production">0</span>
      </div>
      <div id="social-crise" class="message-box msg-brown" style="display:none;"></div>
      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">üõãÔ∏è Achat</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>
      </div>
    </div>
    
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock" id="money-row" style="display:none;">
        Monnaie (‚Ç¨) : <span id="money">10</span>
      </div>
      <div class="stock" id="budget-etat-row" style="display:none;">
        Budget de l'√âtat : <span id="budget-etat">0</span> ‚Ç¨
      </div>
      <div class="products-box" id="price-indicator-box" style="display:none;">
        Prix de vente<br>
        <span id="current-price">1‚Ç¨</span>
      </div>
      
      <button id="don-btn" onclick="receiveDon()">Recevoir mon don</button>
      <button id="credit-btn" onclick="activateCredit()" style="display:none;" class="btn-credit">üí≥ Effectuer un cr√©dit</button>
      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>
      
      <div class="btn-row">
        <button id="ouvrier-btn" onclick="acheterIA()" style="display:none;">ü§ñ Engager une IA (500 ‚Ç¨)</button>
        <button id="trader-btn" onclick="acheterTrader()" style="display:none;">ü§ñ Trader automatique (1 000 ‚Ç¨)</button>
        <button id="comfort-auto-btn" onclick="acheterConfortAuto()" style="display:none;">üîÑ Achat auto confort (2 000 ‚Ç¨)</button>
        <button id="upgrade-btn2" onclick="upgradeProd2()" style="display:none;">üí† Am√©liorer la production (2 000 ‚Ç¨)</button>
        <button id="automatisms-btn" onclick="acheterAutomatismsClics()" style="display:none;">‚ö° Automatismes = clics (10 000 ‚Ç¨)</button>
        <button id="centre-commercial-btn" onclick="acheterCentreCommercial()" style="display:none;">üè¨ Centre commercial (5 000 ‚Ç¨)</button>
        <button id="price-indicator-btn" onclick="acheterIndicateurPrix()" style="display:none;">üìä Indicateur de prix (30 000 ‚Ç¨)</button>
        <button id="evolution-btn" onclick="evolution()" style="display:none;" class="btn-evolution">üå± √âvolution √©conomique</button>
        <button id="rescue-eh-btn" onclick="activateRescueEH()" style="display:none;" class="btn-evolution">üå± Passer √† l'√©conomie hom√©ostatique</button>
      </div>
    </div>
  </div>
  
  <div id="jauges-zone" style="margin: 0 auto 14px auto; max-width:620px;">
    <div class="jauge-bottom-barre">
      <div class="jauge-bottom-label">üå± Ressources</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-nature"></div></div>
      <div class="jauge-bottom-val" id="jauge-nature-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-confort-container" style="display:none;">
      <div class="jauge-bottom-label">ü§ñ Confort</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-confort"></div></div>
      <div class="jauge-bottom-val" id="jauge-confort-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-money-container" style="display:none;">
      <div class="jauge-bottom-label">üí∂ Monnaie</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-money"></div></div>
      <div class="jauge-bottom-val" id="jauge-money-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-budget-etat-container" style="display:none;">
      <div class="jauge-bottom-label">üèõÔ∏è Budget √âtat</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-budget-etat"></div></div>
      <div class="jauge-budget-etat-val" id="jauge-budget-etat-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-achat-auto-container" style="display:none;">
      <div class="jauge-bottom-label">üîÑ Achat auto</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-achat-auto"></div></div>
      <div class="jauge-bottom-val" id="jauge-achat-auto-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-ia-container" style="display:none;">
      <div class="jauge-bottom-label">ü§ñ IA</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-ia"></div></div>
      <div class="jauge-bottom-val" id="jauge-ia-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-trader-container" style="display:none;">
      <div class="jauge-bottom-label">üí∞ Trader</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-trader"></div></div>
      <div class="jauge-bottom-val" id="jauge-trader-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-centre-container" style="display:none;">
      <div class="jauge-bottom-label">üè¨ Centre</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-centre"></div></div>
      <div class="jauge-bottom-val" id="jauge-centre-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-tech-container" style="display:none;">
      <div class="jauge-bottom-label">üí† Niveau technologique</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-tech"></div></div>
      <div class="jauge-bottom-val" id="jauge-tech-txt"></div>
    </div>
  </div>
  
  <div class="message" id="message"></div>
  <div id="clics-container">Clics/actions : <span id="clicks">0</span></div>
  
  <hr id="triche-sep">
  <div id="triche-label">Triche</div>
  <div class="debug-row">
    <button id="unlock-cheat-btn" class="btn-yellow" onclick="toggleCheatMode()">üîì D√©v√©rouiller les outils de test</button>
  </div>
  <div id="cheat-buttons" class="debug-row" style="display: none;">
    <button class="btn-yellow" onclick="addMoney()">+1000 cr√©dits (test)</button>
    <button class="btn-yellow" onclick="addOneNature()">+100 ressources (test)</button>
    <button class="btn-yellow" onclick="addClicks50()">Clics +50 (test)</button>
    <button class="btn-yellow" onclick="removeNature100()">-100 ressources (test)</button>
    <button class="btn-evolution" onclick="forceActivateEH()">Passer √† l'EH (test)</button>
    <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler le clic pr√©c√©dent</button>
    <button class="btn-yellow" onclick="toggleEvents()">üé≤ √âv√©nements: ON/OFF</button>
    <button class="btn-yellow" onclick="triggerTestEvent()">üß™ Test √âv√©nement</button>
  </div>

  <script>
    var gameState = {
      nature: 3000,
      confort: 0,
      production: 0,
      money: 10,
      clicks: 0,
      budgetEtat: 0,
      confortMaxAtteint: 0,
      monnaieActive: false,
      creditUnlocked: false,
      jeuBloque: false,
      criseSocialeActive: false,
      ehActivated: false,
      gameOver: false,
      gameOverCause: null,
      ia: 0,
      traderAuto: 0,
      confortAuto: 0,
      centreCommercial: 0,
      techLevel: 0,
      productionMultiplier: 1,
      automatismsGenerateClicks: false,
      priceIndicatorActive: false,
      nbAchatIA: 0,
      nbAchatTrader: 0,
      nbAchatConfortAuto: 0,
      nbAchatUpgradeProd: 0,
      nbAchatCentre: 0,
      ehPrimeClicks: 0,
      ehFonteClicks: 0,
      ehBonusClicks: 0,
      ecologicalInvestments: [],
      optimumStreak: 0,
      optimumVictory: false,
      optimumProtectionActive: false,
      paliersDebloque: {
        comfort: false,
        ia: false,
        trader: false,
        upgradeProd: false,
        confortAuto: false,
        automatismsClics: false,
        priceIndicator: false,
        centreCommercial: false
      }
    };
    
    var automatismsActive = {
      ia: true,
      trader: true,
      confort: true,
      centre: true
    };
    
    var intervals = {
      ia: null,
      trader: null,
      confortAuto: null,
      centreCommercial: null
    };
    
    var pendingPurchase = null;
    var lastState = null;
    var cheatModeUnlocked = false;
    
    var OPTIMUM_THRESHOLDS = {
      nature: { min: 1800, max: 2600 },
      confort: { min: 10, max: 35 },
      money: { min: 400, max: 1200 }
    };
    var OPTIMUM_TARGET = 50;
    var OPTIMUM_MILESTONE = 10;

    var randomEventsSystem = {
      enabled: true,
      nextEventIn: 0,
      currentEvent: null,
      lastEventId: -1,
      recentEvents: [],
      maxRecentEvents: 5,
      activeTemporaryEffects: [],
      automatismEventCooldown: 0,
      
      initialize: function() {
        this.scheduleNextEvent();
        this.updateTemporaryEffectsDisplay();
        console.log("üé≤ Syst√®me d'√©v√©nements al√©atoires initialis√© avec corrections");
      },
      
      scheduleNextEvent: function() {
        this.nextEventIn = Math.floor(Math.random() * 41) + 20; // 20‚Äì60
        console.log("üìÖ Prochain √©v√©nement dans " + this.nextEventIn + " clics");
      },
      
      processClick: function(isAutomatismAction) {
        if (!this.enabled || gameState.optimumVictory) return;
        
        if (isAutomatismAction && this.automatismEventCooldown > 0) {
          this.automatismEventCooldown--;
          this.nextEventIn = Math.max(0, this.nextEventIn - 1);
          this.processTemporaryEffects();
          return;
        }
        
        this.nextEventIn--;
        this.processTemporaryEffects();
        
        if (this.nextEventIn <= 0) {
          this.triggerRandomEvent();
          this.scheduleNextEvent();
          
          if (isAutomatismAction) {
            this.automatismEventCooldown = 3;
          }
        }
      },
      
      triggerRandomEvent: function() {
        var availableEvents = this.events.filter(function(event, index) {
          return randomEventsSystem.recentEvents.indexOf(index) === -1;
        });
        
        if (availableEvents.length === 0) {
          availableEvents = this.events;
          this.recentEvents = [];
        }
        
        var selectedEvent = availableEvents[Math.floor(Math.random() * availableEvents.length)];
        var eventIndex = this.events.indexOf(selectedEvent);
        
        this.recentEvents.push(eventIndex);
        if (this.recentEvents.length > this.maxRecentEvents) {
          this.recentEvents.shift();
        }
        
        this.lastEventId = eventIndex;
        this.executeEvent(selectedEvent);
      },
      
      executeEvent: function(event) {
        console.log("üé≤ √âv√©nement d√©clench√©: " + event.nom);
        
        this.currentEvent = event;
        saveState();
        
        var isInOptimum = isInOptimumZone();
        var shouldProtect = isInOptimum && gameState.optimumStreak >= 10;
        
        if (shouldProtect && this.isEventDestructive(event)) {
          this.executeProtectedEvent(event);
          addScenarioMessage("üõ°Ô∏è √âv√©nement att√©nu√© (protection optimum) : " + event.nom, "info");
        } else {
          // Effet standard
          event.effet(gameState, this);
        }
        
        this.displayEventNotification(event);
        
        setTimeout(function() {
          updateUI("");
        }, 100);
      },
      
      isEventDestructive: function(event) {
        // Liste indicative ‚Äì on marque destructif si l'effet retire nature/confort/argent/IA
        var destructiveIds = [1,3,5,7,9,11,12,13,16,18,20,21,22,24,26,28,30,31,33,34,35,39,42,43,45,46,48,50];
        return destructiveIds.indexOf(event.id) !== -1;
      },
      
      executeProtectedEvent: function(event) {
        var originalState = JSON.parse(JSON.stringify(gameState));
        event.effet(gameState, this);
        
        if (gameState.nature < originalState.nature) {
          var natureLoss = originalState.nature - gameState.nature;
          gameState.nature = originalState.nature - Math.floor(natureLoss * 0.5);
        }
        if (gameState.confort < originalState.confort) {
          var confortLoss = originalState.confort - gameState.confort;
          gameState.confort = originalState.confort - Math.floor(confortLoss * 0.5);
        }
        if (gameState.money < originalState.money) {
          var moneyLoss = originalState.money - gameState.money;
          gameState.money = originalState.money - Math.floor(moneyLoss * 0.5);
        }
        gameState.nature = Math.max(0, gameState.nature);
        gameState.confort = Math.max(0, gameState.confort);
      },
      
      displayEventNotification: function(event) {
        var eventDiv = document.getElementById("current-event");
        var eventText = document.getElementById("event-text");
        var eventEffects = document.getElementById("event-effects");
        
        if (eventDiv && eventText) {
          eventText.textContent = "üåø " + event.nom + " : " + event.texte;
          if (event.effetsDisplay && eventEffects) {
            eventEffects.textContent = event.effetsDisplay;
          } else if (eventEffects) {
            eventEffects.textContent = "";
          }
          eventDiv.style.display = "block";
          eventDiv.style.animation = "eventPulse 0.8s ease-in-out";
          setTimeout(function() {
            if (eventDiv.style.display === "block") eventDiv.style.display = "none";
          }, 5000);
        }
        setTimeout(function() {
          var messageElement = document.getElementById("message");
          if (messageElement && !messageElement.textContent.includes("VICTOIRE") && !messageElement.textContent.includes("zone d'optimum")) {
            messageElement.textContent = "üåø " + event.nom;
          }
        }, 200);
      },
      
      addTemporaryEffect: function(type, value, duration, originalValue) {
        var effect = {
          type: type,
          value: value,
          remainingClicks: duration,
          originalValue: originalValue || 0,
          startValue: this.getEffectDisplayValue(type, value)
        };
        this.activeTemporaryEffects.push(effect);
        this.updateTemporaryEffectsDisplay();
        var displayName = this.getEffectDisplayName(type);
        var displayValue = this.getEffectDisplayValue(type, value);
        addScenarioMessage("‚è±Ô∏è " + displayName + " " + displayValue + " pendant " + duration + " clics", "info");
        console.log("‚è±Ô∏è Effet temporaire ajout√©: " + type + " = " + value + " pour " + duration + " clics");
      },
      
      processTemporaryEffects: function() {
        var expiredEffects = [];
        for (var i = this.activeTemporaryEffects.length - 1; i >= 0; i--) {
          var effect = this.activeTemporaryEffects[i];
          effect.remainingClicks--;
          if (effect.remainingClicks <= 0) {
            expiredEffects.push(effect);
            this.removeTemporaryEffect(effect);
            this.activeTemporaryEffects.splice(i, 1);
          }
        }
        if (expiredEffects.length > 0) {
          for (var j = 0; j < expiredEffects.length; j++) {
            var expiredEffect = expiredEffects[j];
            var displayName = this.getEffectDisplayName(expiredEffect.type);
            addScenarioMessage("‚è∞ Fin de l'effet : " + displayName, "info");
          }
          this.updateTemporaryEffectsDisplay();
        }
      },
      
      removeTemporaryEffect: function(effect) { /* visuel d√©j√† g√©r√© */ },
      
      getCurrentModifier: function(type) {
        var totalModifier = 0;
        this.activeTemporaryEffects.forEach(function(effect) {
          if (effect.type === type) totalModifier += effect.value;
        });
        return totalModifier;
      },
      
      updateTemporaryEffectsDisplay: function() {
        var display = document.getElementById("temp-effects-display");
        var list = document.getElementById("temp-effects-list");
        if (!display || !list) return;
        if (this.activeTemporaryEffects.length === 0) { display.style.display = "none"; return; }
        display.style.display = "block";
        list.innerHTML = "";
        this.activeTemporaryEffects.forEach(function(effect) {
          var item = document.createElement("div");
          item.className = "temp-effect-item";
          var name = document.createElement("div");
          name.className = "temp-effect-name";
          name.textContent = randomEventsSystem.getEffectDisplayName(effect.type) + " " + 
                             randomEventsSystem.getEffectDisplayValue(effect.type, effect.value);
          var duration = document.createElement("div");
          duration.className = "temp-effect-duration";
          duration.textContent = effect.remainingClicks + " clics";
          item.appendChild(name);
          item.appendChild(duration);
          list.appendChild(item);
        });
      },
      
      getEffectDisplayName: function(type) {
        var names = { 'productionCost': 'Co√ªt production', 'sellPrice': 'Prix vente', 'regeneration': 'R√©g√©n√©ration' };
        return names[type] || type;
      },
      
      getEffectDisplayValue: function(type, value) {
        if (type === 'productionCost') return value > 0 ? "+" + value : value.toString();
        if (type === 'sellPrice')     return (value > 0 ? "+" : "") + (value * 100).toFixed(0) + "%";
        if (type === 'regeneration')  return "+" + (value * 100).toFixed(0) + "%";
        return value.toString();
      },
      
      getFullState: function() {
        return {
          enabled: this.enabled,
          nextEventIn: this.nextEventIn,
          lastEventId: this.lastEventId,
          recentEvents: [...this.recentEvents],
          activeTemporaryEffects: JSON.parse(JSON.stringify(this.activeTemporaryEffects)),
          automatismEventCooldown: this.automatismEventCooldown
        };
      },
      
      restoreFullState: function(state) {
        this.enabled = state.enabled;
        this.nextEventIn = state.nextEventIn;
        this.lastEventId = state.lastEventId;
        this.recentEvents = [...state.recentEvents];
        this.activeTemporaryEffects = JSON.parse(JSON.stringify(state.activeTemporaryEffects));
        this.automatismEventCooldown = state.automatismEventCooldown || 0;
        this.updateTemporaryEffectsDisplay();
      },
      
      toggle: function() {
        this.enabled = !this.enabled;
        console.log("üé≤ √âv√©nements al√©atoires: " + (this.enabled ? "ACTIV√âS" : "D√âSACTIV√âS"));
        addScenarioMessage("üé≤ √âv√©nements al√©atoires: " + (this.enabled ? "ACTIV√âS" : "D√âSACTIV√âS"), "info");
      },
      
      // ===================== √âV√âNEMENTS (160 entr√©es) =====================
      events: [
        // 1‚Äì50 fournis
        { id: 1, nom: "Invasion de criquets", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 80); }, texte: "Une invasion de criquets ravage les cultures.", effetsDisplay: "Ressources -80" },
        { id: 2, nom: "Boom des √©nergies", effet: function(gs,es){ es.addTemporaryEffect('regeneration', 0.05, 15); }, texte: "L‚Äô√©nergie gagne en intensit√©.", effetsDisplay: "R√©g√©n√©ration +5% pendant 15 clics" },
        { id: 3, nom: "Temp√™te exceptionnelle", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 40); gs.ia = Math.max(0, gs.ia - 1); }, texte: "Une temp√™te d√©truit des infrastructures.", effetsDisplay: "Ressources -40, IA -1" },
        { id: 4, nom: "Loterie √©cologique", effet: function(gs){ gs.money += 60; gs.nature += 40; }, texte: "Des investissements √©cologiques sont r√©compens√©s.", effetsDisplay: "Monnaie +60‚Ç¨, Ressources +40" },
        { id: 5, nom: "Vague de chaleur", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 50); gs.confort = Math.max(0, gs.confort - 1); }, texte: "La chaleur met la soci√©t√© √† l‚Äô√©preuve.", effetsDisplay: "Ressources -50, Confort -1" },
        { id: 6, nom: "Innovation disruptive", effet: function(gs,es){ gs.ia += 1; es.addTemporaryEffect('productionCost', -1, 15); }, texte: "Une IA am√©liore la productivit√©.", effetsDisplay: "IA +1, Co√ªt production -1 (15 clics)" },
        { id: 7, nom: "Cyberattaque", effet: function(gs){ gs.money -= 50; gs.ia = Math.max(0, gs.ia - 1); }, texte: "Un piratage paralyse une partie du syst√®me.", effetsDisplay: "Monnaie -50, IA -1" },
        { id: 8, nom: "R√©volution citoyenne", effet: function(gs){ gs.confort += 2; gs.nature += 30; }, texte: "Une vague d‚Äôengagement citoyen.", effetsDisplay: "Confort +2, Ressources +30" },
        { id: 9, nom: "Pollution industrielle", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 40); gs.money += 70; }, texte: "La pollution profite √† l‚Äô√©conomie, mais d√©truit la nature.", effetsDisplay: "Ressources -40, Monnaie +70" },
        { id:10, nom: "Fusion d‚Äôentreprises", effet: function(gs){ gs.money += 80; gs.ia += 1; gs.nature = Math.max(0, gs.nature - 20); }, texte: "Les grands groupes grossissent.", effetsDisplay: "Monnaie +80, IA +1, Ressources -20" },
        { id:11, nom: "Nouvelle maladie", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 50); }, texte: "Une maladie r√©duit la biodiversit√©.", effetsDisplay: "Ressources -50" },
        { id:12, nom: "Boycott citoyen", effet: function(gs,es){ gs.money -= 60; es.addTemporaryEffect('productionCost', -2, 8); }, texte: "La soci√©t√© boycotte une multinationale.", effetsDisplay: "Monnaie -60, Co√ªt prod -2 (8 clics)" },
        { id:13, nom: "Gr√®ve g√©n√©rale", effet: function(gs){ gs.ia = Math.max(0, gs.ia - 2); gs.money -= 100; }, texte: "Les travailleurs arr√™tent tout.", effetsDisplay: "IA -2, Monnaie -100" },
        { id:14, nom: "Don international", effet: function(gs){ gs.money += 100; gs.nature += 50; }, texte: "Un pays voisin vous aide.", effetsDisplay: "Monnaie +100, Ressources +50" },
        { id:15, nom: "Avanc√©e m√©dicale", effet: function(gs,es){ gs.confort += 2; es.addTemporaryEffect('productionCost', -1, 10); }, texte: "Un vaccin r√©volutionne la soci√©t√©.", effetsDisplay: "Confort +2, Co√ªt prod -1 (10 clics)" },
        { id:16, nom: "D√©ficit public", effet: function(gs){ gs.money -= 120; }, texte: "Les caisses de l‚Äô√âtat sont vides.", effetsDisplay: "Monnaie -120" },
        { id:17, nom: "Accord de paix", effet: function(gs){ gs.confort += 2; gs.money += 30; }, texte: "La paix g√©n√®re du bien-√™tre.", effetsDisplay: "Confort +2, Monnaie +30" },
        { id:18, nom: "S√®cheresse", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 60); }, texte: "La s√©cheresse √©puise la terre.", effetsDisplay: "Ressources -60" },
        { id:19, nom: "Festival local", effet: function(gs){ gs.confort += 2; gs.money += 20; }, texte: "L‚Äô√©v√©nement dynamise la soci√©t√©.", effetsDisplay: "Confort +2, Monnaie +20" },
        { id:20, nom: "R√©volte sociale", effet: function(gs,es){ gs.confort = Math.max(0, gs.confort - 3); es.addTemporaryEffect('productionCost', +2, 10); }, texte: "Le m√©contentement gronde.", effetsDisplay: "Confort -3, Co√ªt prod +2 (10 clics)" },
        { id:21, nom: "Programme de reforestation", effet: function(gs){ gs.nature += 70; gs.money -= 40; }, texte: "Des arbres sont plant√©s partout.", effetsDisplay: "Ressources +70, Monnaie -40" },
        { id:22, nom: "Inondation", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 80); gs.money -= 30; }, texte: "Les eaux d√©vastent le territoire.", effetsDisplay: "Ressources -80, Monnaie -30" },
        { id:23, nom: "Cyberd√©fense efficace", effet: function(gs,es){ gs.money += 40; es.addTemporaryEffect('productionCost', -1, 10); }, texte: "Le syst√®me repousse une attaque.", effetsDisplay: "Monnaie +40, Co√ªt prod -1 (10 clics)" },
        { id:24, nom: "Echec d‚Äôinnovation", effet: function(gs){ gs.ia = Math.max(0, gs.ia - 1); }, texte: "Une technologie prometteuse √©choue.", effetsDisplay: "IA -1" },
        { id:25, nom: "Programme alimentaire", effet: function(gs){ gs.nature += 50; gs.money -= 30; }, texte: "Une aide nourrit la population.", effetsDisplay: "Ressources +50, Monnaie -30" },
        { id:26, nom: "Inflation", effet: function(gs,es){ gs.money -= 40; es.addTemporaryEffect('sellPrice', -0.2, 10); }, texte: "Les prix grimpent.", effetsDisplay: "Monnaie -40, Prix vente -20% (10 clics)" },
        { id:27, nom: "√ânergie abondante", effet: function(gs){ gs.nature += 40; gs.money += 60; }, texte: "L‚Äô√©nergie coule √† flots.", effetsDisplay: "Ressources +40, Monnaie +60" },
        { id:28, nom: "Bulle sp√©culative", effet: function(gs){ gs.money += 80; gs.ia = Math.max(0, gs.ia - 2); }, texte: "La sp√©culation fait perdre la raison.", effetsDisplay: "Monnaie +80, IA -2" },
        { id:29, nom: "D√©croissance volontaire", effet: function(gs,es){ gs.confort = Math.max(0, gs.confort - 1); es.addTemporaryEffect('productionCost', -2, 10); }, texte: "La soci√©t√© choisit la sobri√©t√©.", effetsDisplay: "Confort -1, Co√ªt prod -2 (10 clics)" },
        { id:30, nom: "Gr√®ve sectorielle", effet: function(gs,es){ gs.ia = Math.max(0, gs.ia - 1); es.addTemporaryEffect('productionCost', +1, 10); }, texte: "Un secteur entier cesse le travail.", effetsDisplay: "IA -1, Co√ªt prod +1 (10 clics)" },
        { id:31, nom: "Pollution de l‚Äôair", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 30); gs.confort = Math.max(0, gs.confort - 1); }, texte: "L‚Äôair devient irrespirable.", effetsDisplay: "Ressources -30, Confort -1" },
        { id:32, nom: "√âcole verte", effet: function(gs){ gs.ia += 1; gs.nature += 30; }, texte: "L‚Äô√©ducation pr√©pare l‚Äôavenir.", effetsDisplay: "IA +1, Ressources +30" },
        { id:33, nom: "Embargo commercial", effet: function(gs){ gs.money -= 80; gs.nature = Math.max(0, gs.nature - 30); }, texte: "Le commerce s‚Äôeffondre.", effetsDisplay: "Monnaie -80, Ressources -30" },
        { id:34, nom: "Panne majeure", effet: function(gs){ gs.ia = Math.max(0, gs.ia - 2); }, texte: "Un bug informatique paralyse l‚Äôactivit√©.", effetsDisplay: "IA -2" },
        { id:35, nom: "Famine", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 70); }, texte: "Les r√©coltes √©chouent.", effetsDisplay: "Ressources -70" },
        { id:36, nom: "F√™te nationale", effet: function(gs){ gs.confort += 3; gs.money += 30; }, texte: "Le pays c√©l√®bre son identit√©.", effetsDisplay: "Confort +3, Monnaie +30" },
        { id:37, nom: "Don priv√©", effet: function(gs){ gs.money += 60; }, texte: "Un m√©c√®ne soutient la soci√©t√©.", effetsDisplay: "Monnaie +60" },
        { id:38, nom: "Festival √©cologique", effet: function(gs){ gs.confort += 1; gs.nature += 40; }, texte: "L‚Äô√©cologie est c√©l√©br√©e.", effetsDisplay: "Confort +1, Ressources +40" },
        { id:39, nom: "Gel agricole", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 30); }, texte: "Un froid anormal g√®le les r√©coltes.", effetsDisplay: "Ressources -30" },
        { id:40, nom: "Fusion IA/nature", effet: function(gs,es){ gs.ia += 2; gs.nature += 40; es.addTemporaryEffect('productionCost', -2, 8); }, texte: "La tech sert la nature.", effetsDisplay: "IA +2, Ressources +40, Co√ªt prod -2 (8 clics)" },
        { id:41, nom: "Subvention verte", effet: function(gs){ gs.money += 50; gs.nature += 20; }, texte: "Le gouvernement soutient l‚Äô√©cologie.", effetsDisplay: "Monnaie +50, Ressources +20" },
        { id:42, nom: "Pollution plastique", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 40); gs.money -= 30; }, texte: "La pollution envahit les mers.", effetsDisplay: "Ressources -40, Monnaie -30" },
        { id:43, nom: "Carence √©nerg√©tique", effet: function(gs,es){ gs.nature = Math.max(0, gs.nature - 30); es.addTemporaryEffect('productionCost', +1, 10); }, texte: "La soci√©t√© manque d‚Äô√©nergie.", effetsDisplay: "Ressources -30, Co√ªt prod +1 (10 clics)" },
        { id:44, nom: "Festival des savoir-faire", effet: function(gs,es){ gs.confort += 1; es.addTemporaryEffect('productionCost', -1, 5); }, texte: "Les anciens transmettent leur savoir.", effetsDisplay: "Confort +1, Co√ªt prod -1 (5 clics)" },
        { id:45, nom: "Gr√®ve IA", effet: function(gs){ gs.ia = Math.max(0, gs.ia - 1); }, texte: "Les IA r√©clament une pause.", effetsDisplay: "IA -1" },
        { id:46, nom: "Boom d√©mographique", effet: function(gs,es){ gs.confort += 1; es.addTemporaryEffect('productionCost', +2, 10); }, texte: "La population explose.", effetsDisplay: "Confort +1, Co√ªt prod +2 (10 clics)" },
        { id:47, nom: "Investissement √©cologique public", effet: function(gs){ gs.money -= 40; gs.nature += 30; }, texte: "Des fonds publics soutiennent la r√©g√©n√©ration.", effetsDisplay: "Monnaie -40, Ressources +30" },
        { id:48, nom: "Vague d‚Äô√©migration", effet: function(gs){ gs.confort = Math.max(0, gs.confort - 2); gs.money -= 30; }, texte: "Des habitants quittent la r√©gion.", effetsDisplay: "Confort -2, Monnaie -30" },
        { id:49, nom: "Innovation sociale", effet: function(gs,es){ gs.confort += 2; es.addTemporaryEffect('productionCost', -1, 10); }, texte: "Des innovations renforcent le lien social.", effetsDisplay: "Confort +2, Co√ªt prod -1 (10 clics)" },
        { id:50, nom: "Canicule extr√™me", effet: function(gs){ gs.nature = Math.max(0, gs.nature - 60); gs.confort = Math.max(0, gs.confort - 2); }, texte: "La chaleur bat des records.", effetsDisplay: "Ressources -60, Confort -2" },

        // 51‚Äì120 placeholders (√† compl√©ter)
        // ‚Äî effets neutres pour garder le syst√®me 100% op√©rationnel ‚Äî
        //    Remplacer chaque entr√©e par l‚Äôeffet/texte r√©el quand tu me les fournis.
        //    Je laisse des libell√©s clairs pour les rep√©rer vite.
        //    Exemple : id 51
        { id: 51, nom: "√âv√©nement #51 (√† compl√©ter)", effet: function(gs){}, texte: "√âv√©nement √† compl√©ter.", effetsDisplay: "" },
      ].concat(
        // G√©n√©ration programmatique des placeholders 52‚Äì120
        Array.from({length: 120-51}, (_,k)=>({
          id: 52 + k,
          nom: "√âv√©nement #"+(52+k)+" (√† compl√©ter)",
          effet: function(gs){ /* neutre */ },
          texte: "√âv√©nement √† compl√©ter.",
          effetsDisplay: ""
        }))
      ).concat([
        // 121‚Äì130 fournis
        { id:121, nom:"D√©fi Z√©ro D√©chet", effet:function(gs,es){ gs.nature += 40; es.addTemporaryEffect('productionCost', -1, 10); }, texte:"La population s‚Äôengage dans la r√©duction des d√©chets.", effetsDisplay:"Ressources +40, Co√ªt prod -1 (10 clics)" },
        { id:122, nom:"Vacances d‚Äôhiver r√©ussies", effet:function(gs){ gs.confort += 3; gs.money += 50; }, texte:"Un tourisme durable profite √† tous.", effetsDisplay:"Confort +3, Monnaie +50" },
        { id:123, nom:"Innovation low-tech partag√©e", effet:function(gs){ gs.ia += 1; gs.nature += 15; }, texte:"Une innovation sobre est partag√©e librement.", effetsDisplay:"IA +1, Ressources +15" },
        { id:124, nom:"Retour de la biodiversit√©", effet:function(gs,es){ gs.nature += 80; es.addTemporaryEffect('regeneration', 0.10, 10); }, texte:"Des esp√®ces r√©apparaissent, la nature reprend ses droits.", effetsDisplay:"Ressources +80, R√©g√©n√©ration +10% (10 clics)" },
        { id:125, nom:"Micro-fermes urbaines", effet:function(gs){ gs.nature += 20; gs.money += 30; }, texte:"L‚Äôagriculture urbaine se d√©veloppe.", effetsDisplay:"Ressources +20, Monnaie +30" },
        { id:126, nom:"Gratuit√© des transports", effet:function(gs,es){ gs.confort += 2; es.addTemporaryEffect('productionCost', -1, 10); }, texte:"Les transports collectifs deviennent gratuits.", effetsDisplay:"Confort +2, Co√ªt prod -1 (10 clics)" },
        { id:127, nom:"R√©parabilit√© accrue", effet:function(gs,es){ es.addTemporaryEffect('productionCost', -2, 15); }, texte:"L‚Äô√©conomie circulaire progresse.", effetsDisplay:"Co√ªt prod -2 (15 clics)" },
        { id:128, nom:"Caf√© citoyen", effet:function(gs){ gs.confort += 2; }, texte:"Des lieux d‚Äô√©change dynamisent la soci√©t√©.", effetsDisplay:"Confort +2" },
        { id:129, nom:"Festival interg√©n√©rationnel", effet:function(gs){ gs.confort += 2; gs.nature += 20; }, texte:"La solidarit√© s‚Äôenracine.", effetsDisplay:"Confort +2, Ressources +20" },
        { id:130, nom:"Accord de paix r√©gionale", effet:function(gs){ gs.confort += 3; gs.money += 50; }, texte:"Un conflit latent est r√©solu.", effetsDisplay:"Confort +3, Monnaie +50" },

        // 131‚Äì157 placeholders (√† compl√©ter)
        { id:131, nom:"√âv√©nement #131 (√† compl√©ter)", effet:function(gs){}, texte:"√âv√©nement √† compl√©ter.", effetsDisplay:"" },
      ]).concat(
        Array.from({length: 157-131}, (_,k)=>({
          id: 132 + k,
          nom: "√âv√©nement #"+(132+k)+" (√† compl√©ter)",
          effet: function(gs){ /* neutre */ },
          texte: "√âv√©nement √† compl√©ter.",
          effetsDisplay: ""
        }))
      ).concat([
        // 158‚Äì160 fournis
        { id:158, nom:"Coop√©ration internationale", effet:function(gs){ gs.money += 100; gs.ia += 2; gs.nature += 50; gs.confort = Math.max(0, gs.confort - 2); }, texte:"Des tensions internes subsistent.", effetsDisplay:"Monnaie +100, IA +2, Ressources +50, Confort -2" },
        { id:159, nom:"Effondrement d‚Äôun secteur fossile", effet:function(gs){ gs.nature += 60; gs.money -= 80; }, texte:"Transition difficile.", effetsDisplay:"Ressources +60, Monnaie -80" },
        { id:160, nom:"Apparition d‚Äôune intelligence collective", effet:function(gs,es){ gs.ia += 2; es.addTemporaryEffect('productionCost', -1, 10); }, texte:"Le collectif prend le relais de la technologie.", effetsDisplay:"IA +2, Co√ªt prod -1 (10 clics)" }
      ])
      // =================== FIN LISTE √âV√âNEMENTS ===================
    };

    var paliersConfig = {
      comfort: { 
        palierBase: 120, 
        cycle: 0,
        coutBase: 100,
        multiplicateurCout: 1,
        name: "Achat",
        emoji: "üõãÔ∏è"
      }
    };

    function getModifiedProductionCost(baseCost) {
      var modifier = randomEventsSystem.getCurrentModifier('productionCost');
      return Math.max(1, baseCost + modifier);
    }
    
    function getModifiedSellPrice(basePrice) {
      var modifier = randomEventsSystem.getCurrentModifier('sellPrice');
      return Math.max(0.1, basePrice * (1 + modifier));
    }
    
    function applyRegenerationBonus() {
      var regenBonus = randomEventsSystem.getCurrentModifier('regeneration');
      if (regenBonus > 0) {
        var bonusAmount = Math.floor(gameState.nature * regenBonus);
        gameState.nature += bonusAmount;
        console.log("üå± R√©g√©n√©ration bonus: +" + bonusAmount + " ressources");
      }
    }

    function isInOptimumZone() {
      return (
        gameState.nature >= OPTIMUM_THRESHOLDS.nature.min && 
        gameState.nature <= OPTIMUM_THRESHOLDS.nature.max &&
        gameState.confort >= OPTIMUM_THRESHOLDS.confort.min && 
        gameState.confort <= OPTIMUM_THRESHOLDS.confort.max &&
        gameState.money >= OPTIMUM_THRESHOLDS.money.min && 
        gameState.money <= OPTIMUM_THRESHOLDS.money.max
      );
    }
    
    function checkOptimumZone() {
      if (gameState.optimumVictory || gameState.gameOver) return;
      if (isInOptimumZone()) {
        gameState.optimumStreak++;
        if (gameState.optimumStreak === OPTIMUM_MILESTONE) {
          addScenarioMessage("üéØ Excellent ! Vous maintenez l'√©quilibre depuis " + OPTIMUM_MILESTONE + " actions !", "success");
        }
        if (gameState.optimumStreak >= OPTIMUM_TARGET) {
          triggerOptimumVictory();
        }
      } else {
        if (gameState.optimumStreak > 0) gameState.optimumStreak = 0;
      }
      updateOptimumDisplay();
    }
    
    function updateOptimumDisplay() {
      var progressFill = document.getElementById("optimum-progress-fill");
      var progressText = document.getElementById("optimum-progress-text");
      var status = document.getElementById("optimum-status");
      if (!progressFill || !progressText || !status) return;
      var percentage = Math.min(100, (gameState.optimumStreak / OPTIMUM_TARGET) * 100);
      progressFill.style.width = percentage + "%";
      progressText.textContent = gameState.optimumStreak + " / " + OPTIMUM_TARGET;
      if (gameState.optimumVictory) {
        status.textContent = "üèÜ Victoire atteinte !";
        status.style.color = "#b8860b"; status.style.fontWeight = "bold";
      } else if (isInOptimumZone()) {
        status.textContent = "‚úÖ Dans la zone d'optimum ! Continuez ainsi...";
        status.style.color = "#2e7d32"; status.style.fontWeight = "bold";
      } else {
        status.textContent = "‚ùå Ajustez";
        status.style.color = "#cc0000"; status.style.fontWeight = "normal";
      }
    }
    
    function triggerOptimumVictory() {
      gameState.optimumVictory = true;
      gameState.jeuBloque = true;
      clearAllIntervals();
      hideAllActionButtons();
      document.getElementById("optimum-victory").style.display = "block";
      addScenarioMessage("üèÜ VICTOIRE ! Vous avez maintenu l'√©quilibre optimum pendant " + OPTIMUM_TARGET + " actions !", "success");
      updateOptimumDisplay();
    }

    function produce() {
      if (gameState.jeuBloque || gameState.optimumVictory) return;
      saveState();
      var baseCost = 5;
      var cost = getModifiedProductionCost(baseCost);
      if (gameState.nature >= cost) {
        gameState.nature -= cost;
        var prodAmount = Math.floor(gameState.productionMultiplier);
        gameState.production += prodAmount;
        gameState.clicks++;
        randomEventsSystem.processClick(false);
        if (gameState.ehActivated) { checkEHMechanics(); } else { checkAndApplyTax(); }
        applyRegenerationBonus();
        var message = "Production : +" + prodAmount + " produits cr√©√©s";
        if (cost !== baseCost) message += " (co√ªt modifi√©: " + cost + " ressources)";
        updateUI(message);
      } else {
        updateUI("Pas assez de ressources pour produire (co√ªt: " + cost + ")");
      }
    }
    
    function sell() {
      if (gameState.jeuBloque || gameState.production <= 0 || gameState.optimumVictory) {
        if (gameState.production <= 0) updateUI("Aucun produit √† vendre");
        return;
      }
      saveState();
      var price = calculatePrice();
      var saleAmount = Math.min(gameState.production, 1);
      var totalEarnings = price * saleAmount;
      gameState.money += totalEarnings;
      gameState.production -= saleAmount;
      gameState.clicks++;
      randomEventsSystem.processClick(false);
      if (gameState.ehActivated) { applyEHTax(totalEarnings); checkEHMechanics(); } else { checkAndApplyTax(); }
      applyRegenerationBonus();
      if (!gameState.monnaieActive) {
        gameState.monnaieActive = true;
        document.getElementById("money-row").style.display = "block";
        document.getElementById("jauge-money-container").style.display = "flex";
      }
      updateUI("Vente : +" + totalEarnings.toFixed(2) + "‚Ç¨");
    }
    
    function receiveDon() {
      if (gameState.jeuBloque || gameState.optimumVictory) return;
      saveState();
      gameState.money = 1000;
      gameState.clicks++;
      randomEventsSystem.processClick(false);
      if (gameState.ehActivated) { checkEHMechanics(); } else { checkAndApplyTax(); }
      applyRegenerationBonus();
      if (!gameState.monnaieActive) {
        gameState.monnaieActive = true;
        document.getElementById("money-row").style.display = "block";
        document.getElementById("jauge-money-container").style.display = "flex";
      }
      document.getElementById("don-btn").style.display = "none";
      updateUI("Don re√ßu : 1000‚Ç¨");
    }

    function acheterConfort() {
      if (gameState.jeuBloque || !gameState.monnaieActive || gameState.optimumVictory) return;
      var cost = 100;
      if (needsCreditActivation(cost)) {
        if (showCreditButton('comfort', cost)) { updateUI("Solde insuffisant pour acheter du confort - Cr√©dit disponible"); return; }
      }
      saveState();
      debitMoney(cost);
      gameState.confort += 1;
      gameState.clicks++;
      randomEventsSystem.processClick(false);
      if (gameState.ehActivated) { checkEHMechanics(); } else { checkAndApplyTax(); }
      applyRegenerationBonus();
      if (gameState.confort === 1) document.getElementById("jauge-confort-container").style.display = "flex";
      var message = "Confort achet√© : +1 confort";
      if (gameState.money < 0) message += " - Solde : " + gameState.money + "‚Ç¨";
      updateUI(message);
    }

    function calculatePrice() {
      if (gameState.nature === 0) return 1;
      var basePrice = Math.max(1, Math.abs(gameState.money) / gameState.nature);
      var modifiedPrice = getModifiedSellPrice(basePrice);
      return Math.round(modifiedPrice * 100) / 100;
    }

    function saveState() {
      lastState = {
        gameState: JSON.parse(JSON.stringify(gameState)),
        automatismsActive: {...automatismsActive},
        pendingPurchase: pendingPurchase ? {...pendingPurchase} : null,
        eventsState: randomEventsSystem.getFullState()
      };
    }

    function updateUI(message) {
      checkAndUnlockPaliersCycliques();
      updateAutomatismControls();
      updateUIValues();
      updateBudgetEtatUI();
      if (message) document.getElementById("message").textContent = message;
    }

    function updateUIValues() {
      document.getElementById("nature").textContent = Math.floor(gameState.nature);
      document.getElementById("confort").textContent = Math.floor(gameState.confort);
      document.getElementById("production").textContent = Math.floor(gameState.production);
      document.getElementById("money").textContent = Math.floor(gameState.money);
      document.getElementById("clicks").textContent = gameState.clicks;
      document.getElementById("budget-etat").textContent = Math.floor(gameState.budgetEtat);
      if (gameState.confort > gameState.confortMaxAtteint) gameState.confortMaxAtteint = gameState.confort;
      if (!gameState.gameOver && !gameState.ehActivated && !gameState.optimumVictory) {
        if (gameState.nature <= 0) { triggerGameOver('resources'); return; }
        if (gameState.confort <= 0 && gameState.confortMaxAtteint > 0) { triggerGameOver('confort'); return; }
      }
      updateJauges();
      updateCrises();
      checkAndUnlockPaliersCycliques();
      updateAutomatismControls();
      checkOptimumZone();
      if (gameState.priceIndicatorActive) {
        document.getElementById("price-indicator-box").style.display = "block";
        var currentPrice = calculatePrice();
        document.getElementById("current-price").textContent = currentPrice.toFixed(2) + "‚Ç¨";
      }
    }

    function updateJauges() {
      var maxVals = {
        nature: Math.max(3000, gameState.nature * 1.2),
        confort: Math.max(100, gameState.confort * 1.2),
        money: Math.max(10000, Math.abs(gameState.money) * 1.2)
      };
      var naturePercent = Math.min(100, Math.max(0, (gameState.nature / maxVals.nature) * 100));
      document.getElementById("jauge-nature").style.width = naturePercent + "%";
      document.getElementById("jauge-nature-txt").textContent = Math.floor(gameState.nature);
      if (gameState.confort > 0) {
        document.getElementById("jauge-confort-container").style.display = "flex";
        var confortPercent = Math.min(100, Math.max(0, (gameState.confort / maxVals.confort) * 100));
        document.getElementById("jauge-confort").style.width = confortPercent + "%";
        document.getElementById("jauge-confort-txt").textContent = Math.floor(gameState.confort);
      }
      if (gameState.monnaieActive) {
        var moneyPercent = Math.min(100, Math.max(0, (Math.abs(gameState.money) / maxVals.money) * 100));
        document.getElementById("jauge-money").style.width = moneyPercent + "%";
        document.getElementById("jauge-money-txt").textContent = Math.floor(gameState.money) + "‚Ç¨";
      }
    }

    function updateCrises() {
      var criseBox = document.getElementById("alert-crise");
      if (gameState.nature < 300) {
        criseBox.style.display = "block";
        criseBox.textContent = "Crise √©cologique : risque sur l'habitabilit√© humaine de la plan√®te";
      } else {
        criseBox.style.display = "none";
      }
    }

    // === CORRECTION : d√©blocage IA/Trader bas√© sur CLICS (cyclique) ===
    function nextPalierClicks(type) {
      if (type === 'ia') return 200 * (gameState.nbAchatIA + 1);     // 200, 400, 600, ...
      else if (type === 'trader') return 500 * (gameState.nbAchatTrader + 1); // 500, 1000, ...
      return Infinity;
    }

    function checkAndUnlockPaliersCycliques() {
      if (!gameState.monnaieActive || gameState.optimumVictory) return;
      // Confort (inchang√©)
      if (gameState.clicks >= paliersConfig.comfort.palierBase && !gameState.paliersDebloque.comfort) {
        gameState.paliersDebloque.comfort = true;
        document.getElementById("comfort-btn").style.display = "block";
        addScenarioMessage("üõãÔ∏è Nouveau : Achat de confort disponible !", "info");
      }
      // IA par CLICS
      var iaBtn = document.getElementById("ouvrier-btn");
      var iaPalier = nextPalierClicks('ia');
      if (gameState.clicks >= iaPalier && iaBtn.style.display !== "block") {
        iaBtn.style.display = "block";
        iaBtn.textContent = "ü§ñ Engager une IA (500 ‚Ç¨)";
        addScenarioMessage("ü§ñ Nouveau : Engagement d'IA disponible !", "info");
      }
      // Trader par CLICS
      var traderBtn = document.getElementById("trader-btn");
      var traderPalier = nextPalierClicks('trader');
      if (gameState.clicks >= traderPalier && traderBtn.style.display !== "block") {
        traderBtn.style.display = "block";
        traderBtn.textContent = "ü§ñ Trader automatique (1 000 ‚Ç¨)";
        addScenarioMessage("üí∞ Nouveau : Trader automatique disponible !", "info");
      }
      // Autres paliers (inchang√©s)
      if (gameState.money >= 2000 && !gameState.paliersDebloque.upgradeProd) {
        gameState.paliersDebloque.upgradeProd = true;
        document.getElementById("upgrade-btn2").style.display = "block";
        addScenarioMessage("üí† Nouveau : Am√©lioration de production disponible !", "info");
      }
      if (gameState.money >= 2000 && gameState.ia >= 1 && !gameState.paliersDebloque.confortAuto) {
        gameState.paliersDebloque.confortAuto = true;
        document.getElementById("comfort-auto-btn").style.display = "block";
        addScenarioMessage("üîÑ Nouveau : Achat automatique de confort disponible !", "info");
      }
      if (gameState.money >= 5000 && !gameState.paliersDebloque.centreCommercial) {
        gameState.paliersDebloque.centreCommercial = true;
        document.getElementById("centre-commercial-btn").style.display = "block";
        addScenarioMessage("üè¨ Nouveau : Centre commercial disponible !", "info");
      }
      if (gameState.money >= 10000 && gameState.ia >= 2 && !gameState.paliersDebloque.automatismsClics) {
        gameState.paliersDebloque.automatismsClics = true;
        document.getElementById("automatisms-btn").style.display = "block";
        addScenarioMessage("‚ö° Nouveau : Automatismes = clics disponible !", "info");
      }
      if (gameState.money >= 30000 && !gameState.paliersDebloque.priceIndicator) {
        gameState.paliersDebloque.priceIndicator = true;
        document.getElementById("price-indicator-btn").style.display = "block";
        addScenarioMessage("üìä Nouveau : Indicateur de prix disponible !", "info");
      }
      if (gameState.money >= 50000 && gameState.techLevel >= 3) {
        document.getElementById("evolution-btn").style.display = "block";
      }
      if ((gameState.nature <= 50 || gameState.confort <= 1) && gameState.money >= 100000) {
        document.getElementById("rescue-eh-btn").style.display = "block";
      }
    }
    // === FIN CORRECTION ===

    function updateAutomatismControls() {
      var controlsDiv = document.getElementById("automatisms-controls");
      var hasAutomatisms = gameState.ia > 0 || gameState.traderAuto > 0 || gameState.confortAuto > 0 || gameState.centreCommercial > 0;
      if (hasAutomatisms) {
        controlsDiv.style.display = "flex";
        updateControlButton("ia", gameState.ia > 0);
        updateControlButton("trader", gameState.traderAuto > 0);
        updateControlButton("confort", gameState.confortAuto > 0);
        updateControlButton("centre", gameState.centreCommercial > 0);
      } else {
        controlsDiv.style.display = "none";
      }
    }
    
    function updateControlButton(type, available) {
      var btn = document.getElementById("control-" + type);
      if (!btn) return;
      if (!available) { btn.className = "control-btn disabled"; btn.textContent = getControlButtonText(type) + ": OFF"; return; }
      if (automatismsActive[type]) { btn.className = "control-btn active"; btn.textContent = getControlButtonText(type) + ": ON"; }
      else { btn.className = "control-btn inactive"; btn.textContent = getControlButtonText(type) + ": OFF"; }
    }
    
    function getControlButtonText(type) {
      var texts = { ia: "ü§ñ IA", trader: "üí∞ Trader", confort: "üõãÔ∏è Confort", centre: "üè¨ Centre" };
      return texts[type] || type;
    }

    function updateBudgetEtatUI() {
      if (gameState.budgetEtat > 0) {
        document.getElementById("budget-etat-row").style.display = "block";
        document.getElementById("jauge-budget-etat-container").style.display = "flex";
        var maxBudget = Math.max(1000, gameState.budgetEtat * 1.2);
        var budgetPercent = Math.min(100, (gameState.budgetEtat / maxBudget) * 100);
        document.getElementById("jauge-budget-etat").style.width = budgetPercent + "%";
        document.getElementById("jauge-budget-etat-txt").textContent = Math.floor(gameState.budgetEtat) + "‚Ç¨";
      }
    }

    function triggerGameOver(cause) {
      gameState.gameOver = true;
      gameState.gameOverCause = cause;
      gameState.jeuBloque = true;
      clearAllIntervals();
      hideAllActionButtons();
      if (cause === 'resources') {
        var gameOverDiv = document.getElementById("game-over-resources");
        gameOverDiv.style.display = "block";
        gameOverDiv.innerHTML = "GAME OVER<br>√âpuisement des ressources naturelles<br><button class=\"btn-restart\" onclick=\"restartGame()\">üîÑ Recommencer</button>";
      } else if (cause === 'confort') {
        var gameOverDiv = document.getElementById("game-over-confort");
        gameOverDiv.style.display = "block";
        gameOverDiv.innerHTML = "GAME OVER<br>Effondrement du confort social<br><button class=\"btn-restart\" onclick=\"restartGame()\">üîÑ Recommencer</button>";
      }
    }

    function clearAllIntervals() {
      Object.keys(intervals).forEach(function(key) {
        if (intervals[key]) { clearInterval(intervals[key]); intervals[key] = null; }
      });
    }

    function hideAllActionButtons() {
      var buttons = ["produce-btn", "sell-btn", "comfort-btn", "don-btn", "credit-btn", 
                     "ouvrier-btn", "trader-btn", "comfort-auto-btn", "upgrade-btn2",
                     "automatisms-btn", "centre-commercial-btn", "price-indicator-btn",
                     "evolution-btn", "rescue-eh-btn"];
      buttons.forEach(function(buttonId) {
        var btn = document.getElementById(buttonId);
        if (btn) btn.style.display = "none";
      });
    }

    function restartGame() { location.reload(); }

    // Fonctions n√©cessaires manquantes
    function needsCreditActivation(cost) { return gameState.money < cost && !gameState.creditUnlocked; }
    function showCreditButton(type, cost) {
      gameState.creditUnlocked = true;
      pendingPurchase = { type: type, cost: cost };
      document.getElementById("credit-btn").style.display = "block";
      return true;
    }
    function debitMoney(amount) { gameState.money -= amount; }
    function activateCredit() {
      if (!pendingPurchase) return;
      saveState();
      var type = pendingPurchase.type;
      var cost = pendingPurchase.cost;
      gameState.money -= cost;
      if (type === 'comfort') { gameState.confort += 1; }
      gameState.clicks++;
      pendingPurchase = null;
      document.getElementById("credit-btn").style.display = "none";
      updateUI("Cr√©dit activ√© : " + type + " achet√© √† cr√©dit");
    }
    
    function checkAndApplyTax() {
      if (gameState.money > 2000) {
        var tax = Math.floor(gameState.money * 0.02);
        gameState.money -= tax;
        gameState.budgetEtat += tax;
      }
    }
    
    function applyEHTax(earnings) { var tax = Math.floor(earnings * 0.1); gameState.budgetEtat += tax; }
    function checkEHMechanics() {
      if (gameState.ehActivated) {
        gameState.ehBonusClicks++;
        if (gameState.ehBonusClicks % 5 === 0) { gameState.nature += Math.floor(gameState.nature * 0.02); }
      }
    }

    // Fonctions d‚Äôachat des am√©liorations
    function acheterIA() {
      if (gameState.jeuBloque || gameState.money < 500 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 500;
      gameState.ia += 1;
      gameState.clicks++;
      gameState.nbAchatIA++;
      document.getElementById("ouvrier-btn").style.display = "none";
      startAutomatism('ia');
      randomEventsSystem.processClick(false);
      checkAndApplyTax();
      applyRegenerationBonus();
      updateUI("IA engag√©e : +1 IA automatique");
    }
    
    function acheterTrader() {
      if (gameState.jeuBloque || gameState.money < 1000 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 1000;
      gameState.traderAuto += 1;
      gameState.clicks++;
      gameState.nbAchatTrader++;
      document.getElementById("trader-btn").style.display = "none";
      startAutomatism('trader');
      randomEventsSystem.processClick(false);
      checkAndApplyTax();
      applyRegenerationBonus();
      updateUI("Trader engag√© : +1 trader automatique");
    }
    
    function acheterConfortAuto() {
      if (gameState.jeuBloque || gameState.money < 2000 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 2000;
      gameState.confortAuto += 1;
      gameState.clicks++;
      gameState.nbAchatConfortAuto++;
      startAutomatism('confortAuto');
      randomEventsSystem.processClick(false);
      checkAndApplyTax();
      applyRegenerationBonus();
      updateUI("Achat automatique de confort activ√©");
    }
    
    function upgradeProd2() {
      if (gameState.jeuBloque || gameState.money < 2000 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 2000;
      gameState.productionMultiplier += 0.5;
      gameState.techLevel += 1;
      gameState.clicks++;
      gameState.nbAchatUpgradeProd++;
      randomEventsSystem.processClick(false);
      checkAndApplyTax();
      applyRegenerationBonus();
      updateUI("Production am√©lior√©e : x" + gameState.productionMultiplier.toFixed(1));
    }
    
    function acheterCentreCommercial() {
      if (gameState.jeuBloque || gameState.money < 5000 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 5000;
      gameState.centreCommercial += 1;
      gameState.clicks++;
      gameState.nbAchatCentre++;
      startAutomatism('centreCommercial');
      randomEventsSystem.processClick(false);
      checkAndApplyTax();
      applyRegenerationBonus();
      updateUI("Centre commercial construit");
    }
    
    function acheterAutomatismsClics() {
      if (gameState.jeuBloque || gameState.money < 10000 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 10000;
      gameState.automatismsGenerateClicks = true;
      gameState.clicks++;
      randomEventsSystem.processClick(false);
      checkAndApplyTax();
      applyRegenerationBonus();
      updateUI("Automatismes = clics activ√©");
    }
    
    function acheterIndicateurPrix() {
      if (gameState.jeuBloque || gameState.money < 30000 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 30000;
      gameState.priceIndicatorActive = true;
      gameState.clicks++;
      randomEventsSystem.processClick(false);
      checkAndApplyTax();
      applyRegenerationBonus();
      updateUI("Indicateur de prix activ√©");
    }
    
    function evolution() {
      if (gameState.jeuBloque || gameState.money < 50000 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 50000;
      gameState.ehActivated = true;
      gameState.clicks++;
      document.getElementById("eh-msg").style.display = "block";
      document.getElementById("eh-msg").textContent = "√âvolution vers l'√©conomie hom√©ostatique activ√©e !";
      randomEventsSystem.processClick(false);
      applyRegenerationBonus();
      updateUI("√âvolution √©conomique activ√©e");
    }
    
    function activateRescueEH() {
      if (gameState.jeuBloque || gameState.money < 100000 || gameState.optimumVictory) return;
      saveState();
      gameState.money -= 100000;
      gameState.ehActivated = true;
      gameState.clicks++;
      gameState.nature = Math.max(1000, gameState.nature);
      gameState.confort = Math.max(10, gameState.confort);
      document.getElementById("eh-success").style.display = "block";
      document.getElementById("eh-success").textContent = "√âconomie hom√©ostatique de sauvetage activ√©e !";
      randomEventsSystem.processClick(false);
      applyRegenerationBonus();
      updateUI("Mode sauvetage EH activ√©");
    }

    // Gestion des automatismes
    function startAutomatism(type) {
      if (intervals[type]) clearInterval(intervals[type]);
      var delay = getAutomatismDelay(type);
      intervals[type] = setInterval(function() {
        if (!automatismsActive[type] || gameState.jeuBloque || gameState.optimumVictory) return;
        executeAutomatism(type);
        if (gameState.automatismsGenerateClicks) {
          gameState.clicks++;
          randomEventsSystem.processClick(true);
        }
      }, delay);
    }
    
    function getAutomatismDelay(type) {
      var delays = { ia: 3000, trader: 4000, confortAuto: 5000, centreCommercial: 6000 };
      return delays[type] || 3000;
    }
    
    function executeAutomatism(type) {
      switch(type) {
        case 'ia':
          if (gameState.nature >= 5) { gameState.nature -= 5; gameState.production += gameState.productionMultiplier; }
          break;
        case 'trader':
          if (gameState.production >= 1) { var price = calculatePrice(); gameState.money += price; gameState.production -= 1; }
          break;
        case 'confortAuto':
          if (gameState.money >= 100) { gameState.money -= 100; gameState.confort += 1; }
          break;
        case 'centreCommercial':
          gameState.money += Math.floor(gameState.confort * 0.5);
          break;
      }
      setTimeout(updateUI, 100);
    }
    
    function toggleAutomatism(type) {
      var available = false;
      switch(type) {
        case 'ia': available = gameState.ia > 0; break;
        case 'trader': available = gameState.traderAuto > 0; break;
        case 'confort': available = gameState.confortAuto > 0; break;
        case 'centre': available = gameState.centreCommercial > 0; break;
      }
      if (!available) return;
      automatismsActive[type] = !automatismsActive[type];
      updateAutomatismControls();
    }

    // Fonctions utilitaires
    function addScenarioMessage(message, type) {
      var messageEl = document.getElementById("message");
      if (messageEl && !messageEl.textContent.includes("VICTOIRE")) {
        messageEl.textContent = message;
      }
    }

    // Fonctions de triche
    function toggleCheatMode() {
      cheatModeUnlocked = !cheatModeUnlocked;
      var cheatButtons = document.getElementById("cheat-buttons");
      var unlockBtn = document.getElementById("unlock-cheat-btn");
      if (cheatModeUnlocked) { cheatButtons.style.display = "flex"; unlockBtn.textContent = "üîí Masquer les outils de test"; }
      else { cheatButtons.style.display = "none"; unlockBtn.textContent = "üîì D√©v√©rouiller les outils de test"; }
    }
    function addMoney() {
      gameState.money += 1000;
      if (!gameState.monnaieActive) {
        gameState.monnaieActive = true;
        document.getElementById("money-row").style.display = "block";
        document.getElementById("jauge-money-container").style.display = "flex";
      }
      updateUI("Test : +1000‚Ç¨");
    }
    function addOneNature() { gameState.nature += 100; updateUI("Test : +100 ressources"); }
    function addClicks50() { gameState.clicks += 50; updateUI("Test : +50 clics"); }
    function removeNature100() { gameState.nature = Math.max(0, gameState.nature - 100); updateUI("Test : -100 ressources"); }
    function forceActivateEH() {
      gameState.ehActivated = true; gameState.gameOver = false; gameState.jeuBloque = false;
      document.getElementById("eh-msg").style.display = "block";
      document.getElementById("eh-msg").textContent = "EH forc√©e activ√©e (test)";
      updateUI("Test : EH activ√©e");
    }
    function undoAction() {
      if (lastState) {
        gameState = JSON.parse(JSON.stringify(lastState.gameState));
        automatismsActive = {...lastState.automatismsActive};
        pendingPurchase = lastState.pendingPurchase ? {...lastState.pendingPurchase} : null;
        randomEventsSystem.restoreFullState(lastState.eventsState);
        updateUI("Action annul√©e");
      }
    }
    function toggleEvents() { randomEventsSystem.toggle(); }
    function triggerTestEvent() {
      if (randomEventsSystem.events.length > 0) {
        var testEvent = randomEventsSystem.events[Math.floor(Math.random() * randomEventsSystem.events.length)];
        randomEventsSystem.executeEvent(testEvent);
        updateUI("Test : √©v√©nement d√©clench√© - " + testEvent.nom);
      }
    }

    // Initialisation du jeu
    window.onload = function() {
      randomEventsSystem.initialize();
      updateUI("Jeu initialis√© - Cliquez sur Produire pour commencer");
      updateOptimumDisplay();
      console.log("üåç Looop v1.27.2 - Jeu initialis√©");
    };
  </script>

</body>
</html>
