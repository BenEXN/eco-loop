<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Looop v1.11.1 ‚Äì Usines, March√©s, Indicateur, Automatisme & Cubes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #f3f3f3; font-family: sans-serif; margin:0; padding:0; }
    h1 { text-align: center; margin: 25px 0 10px; }
    .container { display: flex; justify-content: center; align-items: flex-start; margin: 0 auto 18px auto; max-width: 950px; gap: 24px;}
    .category { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #0001; flex: 1; padding: 32px 18px 18px 18px; margin: 0 6px; min-width: 250px; max-width: 320px; min-height: 250px; display: flex; flex-direction: column; align-items: center;}
    .cat-title { font-size: 1.25em; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px;}
    .stock { font-size: 1.1em; margin-bottom: 10px;}
    .products-box { background: #f7f7fa; border: 2px solid #dde1eb; border-radius: 10px; color: #333; margin-bottom: 10px; padding: 10px 28px; font-size: 1.2em; font-weight: bold; letter-spacing: 1px; box-shadow: 0 1px 4px #ddd5; min-width: 110px; text-align: center;}
    .message-box { border-radius: 10px; margin: 8px 0 14px 0; padding: 11px 14px 11px 14px; font-weight: bold; font-size: 1.08em; box-shadow: 0 1px 4px #0002; text-align: center; min-width: 130px; max-width: 260px; word-break: break-word; line-height: 1.25em;}
    .msg-orange { background: #ffe9cf; color: #d2691e; border: 2px solid #f5c387;}
    .msg-blue { background: #e7f4ff; color: #0978c6; border: 2px solid #7cc8fa;}
    .msg-red { background: #ffe3e3; color: #c00; border: 2px solid #e48888;}
    .msg-brown { background: #fff4d6; color: #be8c00; border: 2px solid #e2c071;}
    .btn-row { margin: 18px 0 0 0;}
    button { font-size: 1em; padding: 10px 18px; margin: 5px 0; border-radius: 14px; border: none; background: #ededed; color: #111; cursor: pointer; transition: background 0.2s;}
    button:disabled { opacity: 0.5; background: #ededed; color: #bbb; cursor: not-allowed;}
    .btn-prodauto { background: #094075; color: #fff; font-weight: bold; border-radius: 8px;}
    .btn-prodauto.on { background: #094075; color: #fff; }
    .btn-venteauto { background: #f9c9e6; color: #a52b74; font-weight: bold; margin-right: 10px; border-radius: 8px;}
    .btn-venteauto.on { background: #ea6bbd; color: #fff;}
    .btn-primary { background: #2976d9; color: #fff; font-weight: bold; }
    .btn-yellow { background: #FFD600; color: #222; font-weight: bold;}
    .btn-green  { background: #4fd860; color: #fff; font-weight: bold;}
    .btn-annuler { background: #aaa; color: #fff; }
    .debug-row { margin: 0 0 32px 0; display: flex; justify-content: center; gap: 10px;}
    .message { font-weight: bold; min-height: 24px; margin: 10px 0;}
    #prodauto-row { width:100%; display:flex; justify-content: center; align-items: center; gap:12px; margin: 26px 0 18px 0;}
    #prodauto-wrapper, #venteauto-wrapper { display: flex; }
    @media (max-width: 900px) { #prodauto-row { margin: 16px 0 10px 0;} }
    #clics-container { text-align: center; margin: 25px 0 0 0; font-size: 1.2em; font-weight: bold; color: #333;}
    #revolution { color: #b10000; font-size: 1.1em; text-transform: uppercase;}
    #tech-level, #ia-info { font-size:1em; color:#2980b9; margin-bottom: 0; font-weight: normal;}
    #venteauto-info { font-size: 1.03em; color: #ea6bbd; margin: 2px 0 0 0; font-weight: normal;}
    #triche-sep { border: none; border-top: 3px solid #222; margin: 38px auto 12px auto; width: 94vw; max-width: 1000px;}
    #triche-label { text-align: left; font-size:1.13em; font-weight:normal; letter-spacing:1px; margin: 0 0 12px 0; color:#111; width: 95vw; max-width: 1000px; margin-left: auto; margin-right: auto;}
    #don-btn { margin-top: 10px; background: #FFD600; color: #222; font-weight: bold; border: none; border-radius: 8px; font-size: 1.1em; padding: 14px 20px; box-shadow: 0 1px 8px #fffdbe99;}
    .jauge-bottom-barre { margin: 0 auto 6px auto; display: flex; flex-direction: row; align-items: center; gap: 8px; max-width: 600px;}
    .jauge-bottom-label { min-width: 70px; font-size: .99em; color: #888; text-align: right;}
    .jauge-bottom-bar { background: #eee; border-radius: 8px; height: 13px; flex: 1; overflow: hidden; position: relative;}
    .jauge-bottom-fill { height: 100%; border-radius: 8px; transition: width 0.19s;}
    #jauge-nature { background: #86e08e;}
    #jauge-confort { background: #86b6ea;}
    #jauge-money { background: #ffb3b3;}
    #jauge-ia { background: #094075;}
    #jauge-tech { background: #ba9afc;}
    #jauge-venteauto { background: #fd90d9;}
    #jauge-taux { background: #9b59b6;}
    #jauge-budget { background: #f9e79f;}
    .btn-bercy { background: #f39c12; color: #fff; font-weight: bold; border-radius: 8px; margin-left: 10px; padding: 6px 12px; font-size: 0.9em;}
    .btn-bercy.on { background: #f39c12; color: #fff; }
    .btn-bercy.off { background: #bdc3c7; color: #7f8c8d; }
    .btn-negocier { background: #9b59b6; color: #fff; font-weight: bold; border-radius: 8px; opacity: 0.6; font-size: 1em; position: relative;}
    .btn-negocier.active { background: #9b59b6; color: #fff; opacity: 1;}
    #negocier-cost { display: block; font-size: 0.89em; opacity: 0.82; line-height: 1.1em; font-weight: normal; color: #e4d9fa;}
    #taux-info { font-size: 1.03em; color: #9b59b6; margin: 2px 0 0 0; font-weight: normal;}
    .jauge-bottom-val { font-size: .97em; color: #666; min-width: 60px; text-align: left; padding-left: 4px; }
    /* --- Cubes --- */
    #cube-zone { width: 470px; height: 150px; margin: 18px auto 8px auto; background: #f9f9f9; border: 2.5px dashed #ddd; border-radius: 18px; display: flex; align-items: flex-end; justify-content: flex-start; flex-wrap: wrap; min-height: 120px; min-width: 320px; box-sizing: border-box;}
    .cube { width: 40px; height: 40px; background: #8bbafe; border-radius: 8px; margin: 8px 8px 8px 0; box-shadow: 0 1px 6px #0002; cursor: grab; transition: background 0.2s;}
    .cube.selected { border: 3px solid #333; }
    .color-picker { margin: 8px 12px 2px 0; border-radius: 7px; border: 1.5px solid #ccc; padding: 4px 8px;}
    @media (max-width: 700px) {
      #cube-zone { min-width: 98vw; width: 98vw; }
      .cube { width: 32px; height: 32px;}
    }
  </style>
</head>
<body>
  <h1>üåç Looop <span style="font-size:0.7em;color:#777;">v1.11.0</span></h1>
  <div class="container">
    <div class="category">
      <div class="cat-title">üå± Environnement</div>
      <div class="stock">Ressources : <span id="nature">300</span></div>
      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>
      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
      </div>
    </div>
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock">Confort : <span id="confort">0</span></div>
      <div class="products-box">
        Produits cr√©√©s<br>
        <span id="production">0</span>
      </div>
      <div class="stock" id="tech-level"></div>
      <div class="stock" id="ia-info"></div>
      <div id="venteauto-info"></div>
      <div id="social-crise" class="message-box msg-brown" style="display:none;"></div>
      <div class="btn-row">
        <button id="sell-btn" onclick="sell()">üí∂ Vente</button>
      </div>
    </div>
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock" id="money-row" style="display:none;">
        Monnaie (‚Ç¨) : <span id="money">10</span>
      </div>
      <div id="taux-info" style="display:none;"></div>
      <button id="don-btn" onclick="receiveDon()">Recevoir mon don</button>
      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div class="btn-row">
        <button id="ouvrier-btn" onclick="acheterIA()">ü§ñ Engager une IA (500 ‚Ç¨)</button>
        <button id="trading-btn" class="btn-trading" onclick="acheterTrader()">üè™ Acheter un trader auto (1000 ‚Ç¨)</button>
        <button id="upgrade-btn2" onclick="upgradeProd2()">üí† Am√©liorer la production (2 000 ‚Ç¨)</button>
        <button id="negocier-btn" class="btn-negocier" onclick="negocierTaux()" style="display:none;">
          üìâ N√©gocier son taux d'int√©r√™t
          <span id="negocier-cost"></span>
        </button>
        <button id="evolution-btn" onclick="evolution()" style="display:none;">üå± √âvolution √©conomique</button>
        <!-- Nouveaux boutons paliers -->
        <button id="usine-btn" style="display:none;" onclick="acheterUsine()">üè≠ Cr√©er une usine (20‚ÄØ000 ‚Ç¨)</button>
        <button id="marche-btn" style="display:none;" onclick="acheterMarche()">üíπ Ouvrir un march√© trading (20‚ÄØ000 ‚Ç¨)</button>
        <button id="prix-btn" style="display:none;" onclick="acheterIndicateurPrix()">üìä Activer indicateur prix (30‚ÄØ000 ‚Ç¨)</button>
        <button id="auto-btn" style="display:none;" onclick="acheterAutomatisme()">‚öôÔ∏è Comptabiliser automatismes (10‚ÄØ000 ‚Ç¨)</button>
      </div>
      <div id="prix-indic" style="display:none; margin-top:10px; font-size:1.13em; font-weight:bold; color:#d24e40;"></div>
    </div>
  </div>
  <div id="prodauto-row">
    <div id="venteauto-wrapper" style="display:none;">
      <button id="venteauto-btn" class="btn-venteauto">Vente auto : ON</button>
    </div>
    <div id="prodauto-wrapper" style="display:none;">
      <button id="prodauto-btn" class="btn-prodauto on">Production auto : ON</button>
    </div>
  </div>
  <!-- Jauges sobres + JAUGE VENTES AUTO - Affichage conditionnel -->
  <div style="margin: 0 auto 14px auto; max-width:620px;">
    <div class="jauge-bottom-barre">
      <div class="jauge-bottom-label">üå± Ressources</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-nature"></div></div>
      <div class="jauge-bottom-val" id="jauge-nature-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-confort-container" style="display:none;">
      <div class="jauge-bottom-label">ü§ñ Confort</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-confort"></div></div>
      <div class="jauge-bottom-val" id="jauge-confort-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-money-container" style="display:none;">
      <div class="jauge-bottom-label">üí∂ Monnaie</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-money"></div></div>
      <div class="jauge-bottom-val" id="jauge-money-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-budget-container" style="display:none;">
      <div class="jauge-bottom-label">üí∂ Budget √âtat</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-budget"></div></div>
      <div class="jauge-bottom-val" id="jauge-budget-txt"></div>
      <button id="bercy-btn" class="btn-bercy on">üí∂ Imp√¥t ON</button>
    </div>
    <div class="jauge-bottom-barre" id="jauge-taux-container" style="display:none;">
      <div class="jauge-bottom-label">üìâ Taux int√©r√™t</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-taux"></div></div>
      <div class="jauge-bottom-val" id="jauge-taux-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-ia-container" style="display:none;">
      <div class="jauge-bottom-label">ü§ñ IA</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-ia"></div></div>
      <div class="jauge-bottom-val" id="jauge-ia-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-venteauto-container" style="display:none;">
      <div class="jauge-bottom-label">üè™ Vente auto</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-venteauto"></div></div>
      <div class="jauge-bottom-val" id="jauge-venteauto-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-tech-container" style="display:none;">
      <div class="jauge-bottom-label">üß™ Technologie</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-tech"></div></div>
      <div class="jauge-bottom-val" id="jauge-tech-txt"></div>
    </div>
  </div>
  <!-- ==== ZONE DES CUBES ==== -->
  <div id="cube-zone"></div>
  <div id="color-btns" style="display:none; text-align:center; margin:14px 0;"></div>
  <div id="move-btns" style="display:none; text-align:center; margin-bottom:8px;"></div>
  <!-- ========================= -->
  <div id="clics-container">Clics/actions : <span id="clicks">0</span></div>
  <hr id="triche-sep">
  <div id="triche-label">Triche</div>
  <div class="debug-row">
    <button class="btn-yellow" id="test-btn" onclick="addMoney()">+1000 cr√©dits (test)</button>
    <button class="btn-yellow" id="plus1-btn" onclick="addOneNature()">+1 ressource</button>
    <button class="btn-yellow" id="test-clics-btn" onclick="addClicks50()">Clics +50 (test)</button>
    <button class="btn-yellow" id="test-vente-btn" onclick="addVentes50()">Ventes +50 (test)</button>
    <button class="btn-annuler" id="undo-btn" onclick="undoAction()">‚è™ Annuler le clic pr√©c√©dent</button>
  </div>
  <script>
    // --- VARIABLES GLOBALES ---
    let nature = 300, confort = 0, production = 0, money = 10, clicks = 0;
    let prodCost = 5, techLevel = 0;
    let upgradeCount = 0;
    let upgradeAvailable = false;
    let lastUpgradePalier = 0;
    let lastCrisisResource = 20, criseSocialeActive = false, jeuBloque = false, lastState = null;
    let monnaieActive = false;
    let ia = 0, prixIA = 500;
    let iaProdTimer = null, iaProdOn = true;
    let venteAutoActive = true;
    let venteAutoCount = 0;
    let venteAutoTimers = [];
    // Palier Usine / March√© / Indicateur / Auto
    let usineActive = false, marcheActive = false, prixActive = false, autoActive = false;
    let nbUsines = 0, nbMarches = 0;
    // Indicateur de prix
    let indicPrixActif = false;
    // Automatisme clique
    let autoClicActive = false;
    // Taux d'int√©r√™t (n√©gociable)
    let tauxInteret = 5;
    let clicksEnDette = 0;
    let premierPrelevement = false;
    let nbNegociations = 0;
    let lastNegociationClick = 0;
    const maxNegociations = 5, delaiNegociation = 200;
    // Taxe √âtat
    let budgetEtat = 0;
    let taxeActive = true;
    let clicksTaxe = 0;
    let taxeActivee = false;
    // --- CUBES ---
    let ventesTotales = 0, cubes = [], cubeColors = ['#8bbafe','#86e08e','#ffd600','#ea6bbd','#f39c12','#ba9afc','#fd90d9','#aaa','#c00','#444'], currentCubeColor = 0, selectedCube = null;

    // --- FONCTIONS PRINCIPALES ---
    function updateButtons() {
      // IA (250 clics)
      const ouvrierBtn = document.getElementById("ouvrier-btn");
      if (monnaieActive && clicks >= 250) { ouvrierBtn.style.display = "inline-block"; ouvrierBtn.disabled = jeuBloque; }
      else { ouvrierBtn.style.display = "none"; }
      // Trader (500 clics)
      const tradingBtn = document.getElementById("trading-btn");
      if (monnaieActive && clicks >= 500) { tradingBtn.style.display = "inline-block"; tradingBtn.disabled = jeuBloque; }
      else { tradingBtn.style.display = "none"; }
      // Am√©lioration techno
      const currentPalier = Math.floor(clicks / 600);
      if (monnaieActive && currentPalier > lastUpgradePalier && upgradeCount < 3 && clicks >= 600) { upgradeAvailable = true; }
      else { upgradeAvailable = false; }
      const upgradeBtn = document.getElementById("upgrade-btn2");
      if (upgradeAvailable && upgradeCount < 3) { upgradeBtn.style.display = "inline-block"; upgradeBtn.disabled = jeuBloque; }
      else { upgradeBtn.style.display = "none"; }
      // Evolution
      const evolutionBtn = document.getElementById("evolution-btn");
      evolutionBtn.style.display = (monnaieActive && nature <= 5 && !jeuBloque) ? "inline-block" : "none";
      // N√©gociation taux (filigrane violet, co√ªt affich√©)
      const negocierBtn = document.getElementById("negocier-btn");
      const negociable = (premierPrelevement && clicks - lastNegociationClick >= delaiNegociation && nbNegociations < maxNegociations && confort >= Math.floor(confort / 3) && clicks >= 200);
      if (premierPrelevement) {
        negocierBtn.style.display = "inline-block";
        negocierBtn.disabled = !negociable || jeuBloque;
        negocierBtn.className = "btn-negocier" + (negociable && !jeuBloque ? " active" : "");
        const cost = Math.floor(confort / 3);
        document.getElementById("negocier-cost").textContent = negociable && cost > 0 ? `Co√ªt : -${cost} confort` : "";
      } else {
        negocierBtn.style.display = "none";
        document.getElementById("negocier-cost").textContent = "";
      }
      // Boutons usines, march√©s, indicateur, automatisme
      document.getElementById("usine-btn").style.display = (clicks >= 1500 && !usineActive) ? "inline-block" : "none";
      document.getElementById("marche-btn").style.display = (clicks >= 1600 && !marcheActive) ? "inline-block" : "none";
      document.getElementById("prix-btn").style.display = (clicks >= 1000 && !prixActive) ? "inline-block" : "none";
      document.getElementById("auto-btn").style.display = (clicks >= 750 && !autoActive) ? "inline-block" : "none";
    }

    function updateJauges() {
      const maxNature = 300, maxConfort = 100, maxMoney = 5000, maxIA = 10, maxTech = 99, maxVenteAuto = 10, maxBudget = Math.max(1000, budgetEtat);
      document.getElementById("jauge-nature").style.width = (100 * Math.max(0, Math.min(nature, maxNature)) / maxNature) + "%";
      document.getElementById("jauge-nature-txt").textContent = nature + " / " + maxNature;
      const confortContainer = document.getElementById("jauge-confort-container");
      if (confort > 0 || production < maxConfort) {
        confortContainer.style.display = "flex";
        document.getElementById("jauge-confort").style.width = (100 * Math.max(0, Math.min(confort, maxConfort)) / maxConfort) + "%";
        document.getElementById("jauge-confort-txt").textContent = confort + " / " + maxConfort;
      }
      const moneyContainer = document.getElementById("jauge-money-container");
      if (monnaieActive) {
        moneyContainer.style.display = "flex";
        const moneyPercent = Math.max(0, Math.min(100, (money + 1000) / (maxMoney + 1000) * 100));
        document.getElementById("jauge-money").style.width = moneyPercent + "%";
        document.getElementById("jauge-money-txt").textContent = money + " ‚Ç¨" + (money < 0 ? " (dette)" : "");
      }
      // Budget √âtat
      const budgetContainer = document.getElementById("jauge-budget-container");
      const bercyBtn = document.getElementById("bercy-btn");
      if (taxeActivee) {
        budgetContainer.style.display = "flex";
        document.getElementById("jauge-budget").style.width = (100 * Math.max(0, Math.min(budgetEtat, maxBudget)) / maxBudget) + "%";
        document.getElementById("jauge-budget-txt").textContent = budgetEtat + " ‚Ç¨";
        bercyBtn.style.display = "inline-block";
        bercyBtn.textContent = "üí∂ Imp√¥t " + (taxeActive ? "ON" : "OFF");
        bercyBtn.className = "btn-bercy " + (taxeActive ? "on" : "off");
      } else {
        budgetContainer.style.display = "none";
      }
      const tauxContainer = document.getElementById("jauge-taux-container");
      if (monnaieActive && money < 0) {
        tauxContainer.style.display = "flex";
        document.getElementById("jauge-taux").style.width = tauxInteret + "%";
        document.getElementById("jauge-taux-txt").textContent = tauxInteret + " %";
      } else {
        tauxContainer.style.display = "none";
      }
      const iaContainer = document.getElementById("jauge-ia-container");
      if (ia > 0) {
        iaContainer.style.display = "flex";
        document.getElementById("jauge-ia").style.width = (100 * Math.max(0, Math.min(ia, maxIA)) / maxIA) + "%";
        document.getElementById("jauge-ia-txt").textContent = ia + " IA";
      }
      const venteautoContainer = document.getElementById("jauge-venteauto-container");
      if (venteAutoCount > 0) {
        venteautoContainer.style.display = "flex";
        document.getElementById("jauge-venteauto").style.width = (100 * Math.max(0, Math.min(venteAutoCount, maxVenteAuto)) / maxVenteAuto) + "%";
        document.getElementById("jauge-venteauto-txt").textContent = venteAutoCount + " actives";
      }
      const techContainer = document.getElementById("jauge-tech-container");
      if (techLevel > 0) {
        techContainer.style.display = "flex";
        document.getElementById("jauge-tech").style.width = (100 * Math.max(0, Math.min(techLevel, maxTech)) / maxTech) + "%";
        document.getElementById("jauge-tech-txt").textContent = "Niv. " + techLevel;
      }
    }

    function updatePrixIndic() {
      if (indicPrixActif) {
        let n = Math.abs(money);
        let r = Math.max(1, nature);
        let prix = Math.ceil(n / r);
        document.getElementById("prix-indic").style.display = "block";
        document.getElementById("prix-indic").textContent = "Indicateur de prix : " + prix + " ‚Ç¨ / ressource";
      } else {
        document.getElementById("prix-indic").style.display = "none";
      }
    }

    function updateUI(message = "") {
      document.getElementById("nature").textContent = nature;
      document.getElementById("confort").textContent = confort;
      document.getElementById("production").textContent = production;
      document.getElementById("tech-level").textContent = techLevel > 0 ? "Niveau technologique : " + techLevel : "";
      document.getElementById("clicks").textContent = clicks;
      document.getElementById("ia-info").textContent = ia > 0 ? "IA : " + ia + " (production automatique)" : "";
      const tauxInfo = document.getElementById("taux-info");
      if (monnaieActive && money < 0) {
        tauxInfo.style.display = "block";
        tauxInfo.textContent = `Taux d'int√©r√™t : ${tauxInteret} %`;
      } else {
        tauxInfo.style.display = "none";
      }
      const venteautoInfo = document.getElementById("venteauto-info");
      if (venteAutoCount > 0) {
        venteautoInfo.textContent = `Vente : ${venteAutoCount} (vente automatique)`;
        venteautoInfo.style.display = "block";
      } else {
        venteautoInfo.textContent = "";
        venteautoInfo.style.display = "none";
      }
      document.getElementById("money-row").style.display = monnaieActive ? "block" : "none";
      document.getElementById("don-btn").style.display = monnaieActive ? "none" : "inline-block";
      if (monnaieActive) document.getElementById("money").textContent = money;
      document.getElementById("produce-btn").disabled = (!monnaieActive || nature < prodCost || jeuBloque);
      document.getElementById("sell-btn").disabled = (!monnaieActive || production < 1 || jeuBloque);
      document.getElementById("test-btn").disabled = !monnaieActive || jeuBloque;
      document.getElementById("plus1-btn").disabled = !monnaieActive || jeuBloque;
      document.getElementById("test-clics-btn").disabled = !monnaieActive || jeuBloque;
      document.getElementById("undo-btn").disabled = jeuBloque;
      document.getElementById("test-vente-btn").disabled = jeuBloque;
      document.getElementById("message").textContent = message;
      const criseBox = document.getElementById("alert-crise");
      if (nature < 20) {
        criseBox.style.display = "block";
        criseBox.textContent = "Crise √©cologique : risque sur l'habitabilit√© humaine de la plan√®te ‚Äì perte de confort";
      } else {
        criseBox.style.display = "none";
      }
      const ehBox = document.getElementById("eh-msg");
      if (monnaieActive && nature <= 5) {
        ehBox.style.display = "block";
        ehBox.textContent = "Une √©volution est possible : passer √† l'√©conomie hom√©ostatique (EH)";
      } else {
        ehBox.style.display = "none";
      }
      const socialBox = document.getElementById("social-crise");
      const revolutionBox = document.getElementById("revolution");
      if (confort > 5) criseSocialeActive = true;
      if (criseSocialeActive && !jeuBloque) {
        if (confort > 0 && confort < 5) {
          socialBox.style.display = "block";
          socialBox.textContent = "Crise sociale ‚Äì risque de r√©volution";
        } else {
          socialBox.style.display = "none";
        }
        if (confort === 0) {
          revolutionBox.style.display = "block";
          revolutionBox.textContent = "R√âVOLUTION ‚Äì FIN DE JEU";
          jeuBloque = true;
        } else {
          revolutionBox.style.display = "none";
        }
      } else {
        socialBox.style.display = "none";
        revolutionBox.style.display = "none";
      }
      updateJauges();
      updatePrixIndic();
      updateButtons();
      renderCubes();
    }

    // --- NOUVELLES FONCTIONS DE PALIER ---
    function acheterUsine() {
      if (money < 20000) { updateUI("Pas assez de monnaie‚ÄØ!"); return; }
      money -= 20000; usineActive = true; nbUsines += 1;
      updateUI("Usine construite¬†! La production manuelle/auto est multipli√©e par 10.");
    }
    function acheterMarche() {
      if (money < 20000) { updateUI("Pas assez de monnaie‚ÄØ!"); return; }
      money -= 20000; marcheActive = true; nbMarches += 1;
      updateUI("March√© trading ouvert¬†! La vente manuelle/auto est multipli√©e par 10.");
    }
    function acheterIndicateurPrix() {
      if (money < 30000) { updateUI("Pas assez de monnaie‚ÄØ!"); return; }
      money -= 30000; prixActive = true; indicPrixActif = true;
      updateUI("Indicateur de prix activ√© !");
    }
    function acheterAutomatisme() {
      if (money < 10000) { updateUI("Pas assez de monnaie‚ÄØ!"); return; }
      money -= 10000; autoActive = true; autoClicActive = true;
      updateUI("Tous les automatismes sont maintenant comptabilis√©s comme des clics/actions !");
    }

    // --- CUBES ---
    function renderCubes() {
      let zone = document.getElementById("cube-zone");
      zone.innerHTML = "";
      cubes.forEach((cube, i) => {
        let el = document.createElement("div");
        el.className = "cube" + (i === selectedCube ? " selected" : "");
        el.style.background = cubeColors[cube.color];
        el.title = "Cube #" + (i+1);
        el.onclick = () => { selectedCube = i; showColorBtns(); showMoveBtns(); renderCubes(); };
        zone.appendChild(el);
      });
    }
    function showColorBtns() {
      let btns = document.getElementById("color-btns");
      if (selectedCube === null) { btns.style.display = "none"; return; }
      btns.innerHTML = "Choisir couleur¬†: ";
      cubeColors.forEach((col, i) => {
        let b = document.createElement("button");
        b.className = "color-picker";
        b.style.background = col; b.onclick = () => { cubes[selectedCube].color = i; renderCubes(); };
        btns.appendChild(b);
      });
      btns.style.display = "inline-block";
    }
    function showMoveBtns() {
      let btns = document.getElementById("move-btns");
      if (selectedCube === null) { btns.style.display = "none"; return; }
      btns.innerHTML = "";
      let left = document.createElement("button");
      left.textContent = "‚¨ÖÔ∏è";
      left.onclick = () => { if (selectedCube > 0) { let c = cubes.splice(selectedCube,1)[0]; cubes.splice(selectedCube-1,0,c); selectedCube--; renderCubes(); } };
      let right = document.createElement("button");
      right.textContent = "‚û°Ô∏è";
      right.onclick = () => { if (selectedCube < cubes.length-1) { let c = cubes.splice(selectedCube,1)[0]; cubes.splice(selectedCube+1,0,c); selectedCube++; renderCubes(); } };
      btns.appendChild(left); btns.appendChild(right);
      btns.style.display = "inline-block";
    }

    // --- PALIER : Ajout Cube, couleur, placement ---
    function tryAddCube() {
      let nb = Math.floor(confort/100);
      while (cubes.length < nb) { cubes.push({color: currentCubeColor}); }
      renderCubes();
    }
    function tryCubeColor() {
      if (ventesTotales < 100) return;
      showColorBtns();
    }
    function tryCubeMove() {
      if (Math.abs(money) < 1000) return;
      showMoveBtns();
    }

    // --- ACTIONS JEU ---
    function produce() {
      if (jeuBloque || !monnaieActive || nature < prodCost) return;
      saveState();
      let mult = usineActive ? 10 : 1;
      nature -= prodCost*mult;
      production += 1*mult;
      money -= 1*mult;
      clicks++;
      if (autoClicActive) clicks++; //¬†Automatisme
      tryAddCube();
      const taxePrelevee = gererTaxeEtat();
      if (!taxePrelevee) { gererInterets(); updateUI(""); }
    }
    function sell() {
      if (jeuBloque || !monnaieActive || production < 1) return;
      saveState();
      let mult = marcheActive ? 10 : 1;
      production -= 1*mult;
      money += 2*mult;
      confort += 1*mult;
      ventesTotales += 1*mult;
      clicks++;
      if (autoClicActive) clicks++;
      tryCubeColor();
      const taxePrelevee = gererTaxeEtat();
      if (!taxePrelevee) { gererInterets(); updateUI(""); }
    }
    function receiveDon() { if (monnaieActive) return; saveState(); monnaieActive = true; updateUI("Vous avez re√ßu votre don initial de monnaie (‚Ç¨)¬†!"); }
    function evolution() { if (jeuBloque || !monnaieActive) return; saveState(); updateUI("‚ö° Passage √† l'√©conomie hom√©ostatique¬†: nouvelle phase √† venir¬†!"); }

    // --- USINE, MARCHE, PRIX, AUTO (affichage permanent apr√®s achat, r√©apparition au palier si consomm√©)
    // --> Voir updateButtons

    // --- Debug et annulation ---
    function addMoney() { if (jeuBloque || !monnaieActive) return; saveState(); money += 1000; updateUI("Test : +1000 cr√©dits !"); }
    function addOneNature() { if (jeuBloque || !monnaieActive) return; saveState(); nature += 1; updateUI("+1 ressource ajout√©e !"); }
    function addClicks50() { if (jeuBloque || !monnaieActive) return; saveState(); clicks += 50; updateUI("Test : +50 clics !"); }
    function addVentes50() { if (jeuBloque || !monnaieActive) return; saveState(); ventesTotales += 50; updateUI("Test : +50 ventes !"); tryCubeColor(); }
    function saveState() {
      lastState = JSON.stringify({
        nature, confort, production, money, clicks, prodCost, techLevel,
        upgradeAvailable, upgradeCount, lastUpgradePalier, lastCrisisResource, criseSocialeActive, jeuBloque, monnaieActive, ia,
        venteAutoActive, iaProdOn, venteAutoCount, tauxInteret, clicksEnDette,
        premierPrelevement, nbNegociations, lastNegociationClick, budgetEtat, taxeActive, clicksTaxe, taxeActivee,
        usineActive, marcheActive, prixActive, autoActive, nbUsines, nbMarches, indicPrixActif, autoClicActive,
        ventesTotales, cubes: JSON.parse(JSON.stringify(cubes)), selectedCube
      });
    }
    function undoAction() {
      if (lastState && !jeuBloque) {
        let s = JSON.parse(lastState);
        Object.assign(window, s);
        if (ia > 0) manageIAProduction();
        startAllVenteAuto();
        updateUI("Derni√®re action annul√©e !");
      }
    }

    // --- IMP√îT (Taxe Etat) ---
    function gererTaxeEtat() {
      if (monnaieActive) {
        clicksTaxe++;
        if (clicksTaxe % 20 === 0 && taxeActive) {
          const taxe = Math.round(money * 0.2);
          money -= taxe;
          budgetEtat += Math.abs(taxe);
          nature += 1;
          confort += 1;
          if (!taxeActivee) taxeActivee = true;
          updateUI("La collectivit√© vous remercie. (Taxe pr√©lev√©e : " + taxe + "‚ÄØ‚Ç¨) (+1 ressource, +1 confort)");
          return true;
        }
      }
      return false;
    }
    // --- INTERETS SUR DETTE ---
    function gererInterets() {
      if (money < 0) {
        clicksEnDette++;
        if (clicksEnDette % 10 === 0) {
          const interets = Math.ceil(Math.abs(money) * tauxInteret / 100);
          money -= interets;
          if (!premierPrelevement) premierPrelevement = true;
          updateUI(`Int√©r√™ts pr√©lev√©s : ${interets} ‚Ç¨ (dette : ${money} ‚Ç¨)`);
        }
      } else {
        if (clicksEnDette > 0) { clicksEnDette = 0; premierPrelevement = false; }
      }
    }
    // --- NEGOCIATION TAUX INTERET ---
    function negocierTaux() {
      const negociable = (premierPrelevement && clicks - lastNegociationClick >= delaiNegociation && nbNegociations < maxNegociations && confort >= Math.floor(confort / 3) && clicks >= 200);
      const cost = Math.floor(confort / 3);
      if (!negociable || jeuBloque) return;
      if (cost <= 0 || tauxInteret <= 0) return;
      saveState();
      confort -= cost;
      tauxInteret = Math.max(0, tauxInteret - 1);
      lastNegociationClick = clicks;
      nbNegociations++;
      updateUI(`N√©gociation r√©ussie : taux r√©duit √† ${tauxInteret} % (co√ªt : -${cost} confort)`);
    }

    // --- FONCTIONS ACHATS (inchang√©) ---
    function upgradeProd2() {
      if (jeuBloque || !monnaieActive || !upgradeAvailable) return;
      saveState();
      money -= 2000;
      prodCost = Math.max(1, prodCost - 1);
      techLevel += 1;
      upgradeCount += 1;
      lastUpgradePalier = Math.floor(clicks / 600);
      gererInterets();
      updateUI("Am√©lioration de la production activ√©e ! (co√ªt r√©duit √† " + prodCost + ")" + (money < 0 ? " - Dette cr√©√©e" : ""));
    }
    function acheterIA() {
      if (jeuBloque || !monnaieActive) return;
      saveState();
      money -= prixIA;
      ia++;
      gererInterets();
      updateUI("IA engag√©e !" + (money < 0 ? " (√† cr√©dit si n√©cessaire)" : ""));
      manageIAProduction();
    }
    function acheterTrader() {
      if (jeuBloque || !monnaieActive) return;
      saveState();
      money -= 1000;
      venteAutoCount += 1;
      startAllVenteAuto();
      gererInterets();
      updateUI("Trader auto ajout√© !" + (money < 0 ? " (√† cr√©dit si n√©cessaire)" : ""));
    }
    // --- Automatismes prod/vente ---
    document.getElementById("venteauto-btn").onclick = function() {
      venteAutoActive = !venteAutoActive;
      if (venteAutoActive) startAllVenteAuto();
      else stopAllVenteAuto();
      updateUI();
    };
    document.getElementById("prodauto-btn").onclick = function() {
      iaProdOn = !iaProdOn;
      manageIAProduction();
      updateUI();
    };
    document.getElementById("bercy-btn").onclick = function() {
      taxeActive = !taxeActive;
      updateUI();
    };

    // --- Automatismes timers
    function startAllVenteAuto() {
      stopAllVenteAuto();
      if (venteAutoActive) {
        for (let i = 0; i < venteAutoCount; i++) {
          venteAutoTimers[i] = setInterval(() => {
            if (jeuBloque || !monnaieActive || !venteAutoActive) return;
            if (production >= 1) {
              saveState();
              let mult = marcheActive ? 10 : 1;
              production -= 1*mult;
              money += 2*mult;
              confort += 1*mult;
              ventesTotales += 1*mult;
              if (autoClicActive) clicks++;
              tryCubeColor();
              updateUI();
            }
          }, 10000);
        }
      }
    }
    function stopAllVenteAuto() { for (let i = 0; i < venteAutoTimers.length; i++) clearInterval(venteAutoTimers[i]); venteAutoTimers = []; }
    function manageIAProduction() {
      if (iaProdTimer) clearInterval(iaProdTimer);
      if (ia > 0 && iaProdOn) {
        iaProdTimer = setInterval(() => {
          if (jeuBloque || !monnaieActive || ia === 0 || !iaProdOn) return;
          for (let i = 0; i < ia; i++) {
            let mult = usineActive ? 10 : 1;
            if (nature >= prodCost*mult) { nature -= prodCost*mult; production += 1*mult; money -= 1*mult; }
            if (autoClicActive) clicks++;
            tryAddCube();
          }
          updateUI();
        }, 5000);
      }
    }

    // --- INIT ---
    function initGame() {
      updateUI("Bienvenue dans Looop ! Cliquez sur 'Recevoir mon don' pour commencer.");
      if (ia > 0) manageIAProduction();
      if (venteAutoCount > 0) startAllVenteAuto();
    }
    document.addEventListener('DOMContentLoaded', function() { initGame(); });
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initGame); else initGame();
  </script>
</body>
</html>

