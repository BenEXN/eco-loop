<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Looop ‚Äî 1.30.6</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f3f3; --card:#fff; --ink:#111; --muted:#666;
    --shadow:0 4px 24px #0001;
    --bar:#eee; --ok:#4CAF50; --ok2:#81C784; --danger:#c00;
    --res:#86e08e; --conf:#86b6ea; --money:#ffb3b3; --budget:#ff9800;
    --ia:#ab47bc; --trader:#26c6da; --auto:#ffa726; --centre:#66bb6a; --tech:#9c27b0;
    --eh:#2e7d32; --ehbg:#e8f5e8; --ehbord:#81c784;
    --toastbg:#fff9c4; --toastbd:#f4d03f; --toastfg:#8a6d00;
  }
  html,body{background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; margin:0}
  h1{ text-align:center; margin:22px 0 10px}

  .container{ display:flex; justify-content:center; align-items:flex-start; gap:24px; margin:0 auto 18px; max-width:980px; padding:0 10px;}
  .category{ background:var(--card); border-radius:18px; box-shadow:var(--shadow); flex:1; padding:26px 16px 16px; min-width:260px; max-width:330px;}
  .cat-title{ font-size:1.25em; font-weight:800; margin-bottom:12px; letter-spacing:.3px; text-align:center;}
  .stock-value{ font-size:1.6em; font-weight:900; text-align:center; }
  .stock-label{ font-size:.95em; color:var(--muted); text-align:center; margin-bottom:10px;}
  .products-box{ background:#f7f7fa; border:2px solid #dde1eb; border-radius:10px; margin:12px 0; padding:10px 22px; font-weight:700; text-align:center; box-shadow:0 1px 4px #ddd5;}
  .message-box{ border-radius:10px; margin:8px 0 12px; padding:10px 12px; font-weight:700; font-size:1.02em; box-shadow:0 1px 4px #0002; text-align:center;}
  .msg-orange{ background:#fff2e6; color:#cc5500; border:2px solid #ff8533;}
  .msg-red{ background:#ffe6e6; color:#c00; border:2px solid #ff6666;}
  .msg-blue{ background:#e6f3ff; color:#0066cc; border:2px solid #4da6ff;}
  .msg-green{ background:#e6ffe6; color:#066; border:2px solid #66cc66;}
  .msg-gold{ background:#fff9c4; color:#8a6d00; border:2px solid #f4d03f;}

  .btn-row{ margin-top:14px; display:flex; flex-direction:column; align-items:center; gap:8px;}
  button{ font-size:1em; padding:10px 16px; border:none; border-radius:12px; background:#ededed; color:var(--ink); cursor:pointer;}
  .btn-evo{ background:#4CAF50; color:#fff; font-weight:700;}
  .btn-yellow{ background:#FFD600; color:#222; font-weight:700;}
  .btn-annuler{ background:#999; color:#fff;}
  .btn-invest{ background:var(--eh); color:#fff; font-weight:700;}

  /* Contr√¥les des automatismes */
  .automatisms-controls{ margin:14px auto; max-width:980px; display:none; justify-content:center; gap:10px; flex-wrap:wrap; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001;}
  .control-btn{ font-size:.9em; padding:8px 12px; border-radius:8px; border:none; min-width:100px; }
  .active{ background:#4CAF50; color:#fff; } .inactive{ background:#f44336; color:#fff; } .disabled{ background:#ccc; color:#777;}

  /* Zone d'√©quilibre */
  .optimum-zone{ display:none; margin:12px auto; max-width:980px; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001; text-align:center;}
  .optimum-progress-bar{ background:var(--bar); height:20px; border-radius:20px; max-width:420px; margin:10px auto; overflow:hidden; position:relative;}
  .optimum-progress-fill{ height:100%; background:linear-gradient(90deg,var(--ok),var(--ok2)); width:0%;}
  .optimum-text{ font-size:.95em; color:#555; margin-top:6px;}
  #optimum-victory{ display:none; background:#fff9c4; border:2px solid #f4d03f; color:#8a6d00; padding:16px; border-radius:12px; text-align:center; font-weight:800; max-width:700px; margin:12px auto; }

  /* √âv√©nements + encart effets temporaires actifs */
  .events-zone{ margin:12px auto; max-width:980px; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001;}
  .event-notification{ background:#f0f8f0; border:2px solid #81c784; border-radius:10px; padding:10px; font-weight:700; color:#2e7d32; display:none;}
  .temp-effects{ margin-top:10px; padding:10px; background:#fafafa; border:1px dashed #bbb; border-radius:10px; font-size:.92em;}
  .temp-effects h4{ margin:0 0 6px 0; font-size:.95em; color:#444; }
  .temp-list{ display:flex; flex-wrap:wrap; gap:6px; }
  .temp-pill{ background:#eef3ff; border:1px solid #cfe0ff; color:#1a4fb3; border-radius:999px; padding:4px 8px; }

  /* Jauges */
  .jrows{ margin:0 auto 10px; max-width:720px;}
  .jrow{ display:flex; align-items:center; gap:8px; margin:0 auto 6px; }
  .jlabel{ min-width:120px; text-align:right; font-size:1em; color:#555; }
  .bar{ background:var(--bar); border-radius:8px; height:14px; flex:1; overflow:hidden;}
  .fill{ height:100%; border-radius:8px; transition:width .2s;}
  #jauge-nature{ background:var(--res);}
  #jauge-confort{ background:var(--conf);}
  #jauge-money{ background:var(--money);}
  #jauge-budget{ background:var(--budget);}
  #jauge-ia{ background:var(--ia);}
  #jauge-trader{ background:var(--trader);}
  #jauge-achat-auto{ background:var(--auto);}
  #jauge-centre{ background:var(--centre);}
  #jauge-tech{ background:var(--tech);}
  .jval{ min-width:80px; text-align:right; }

  /* EH investissement avanc√© */
  .investment-block{ background:var(--ehbg); border:2px solid var(--ehbord); border-radius:10px; padding:12px; margin-top:10px;}
  .investment-title{ font-weight:800; color:var(--eh); text-align:center; margin-bottom:8px;}
  .investment-controls{ display:flex; justify-content:center; gap:8px; flex-wrap:wrap;}
  .investment-input{ width:100px; padding:8px; border:1px solid #ccc; border-radius:8px; font-size:1em;}
  .investment-preview{ font-size:.9em; color:var(--eh); text-align:center; min-height:18px; margin-top:6px;}
  .investment-list{ font-size:.9em; color:#555; margin-top:8px; max-height:120px; overflow:auto;}

  /* Toast court */
  #message{ text-align:center; font-weight:800; min-height:24px; margin:8px 0;}
  .toast{ display:inline-block; background:var(--toastbg); color:var(--toastfg); border:2px solid var(--toastbd); padding:6px 10px; border-radius:10px;}

  /* Triche */
  #triche-sep{ border:none; border-top:3px solid #222; margin:22px auto 10px; width:94vw; max-width:980px;}
  #triche-label{ max-width:980px; margin:0 auto 10px; color:#555;}
  .debug-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px auto 24px;}

  /* Mobile */
  @media (max-width:760px){
    .container{ flex-direction:column; gap:12px;}
    .jrows{ max-width:calc(100vw - 22px);}
    .jlabel{ min-width:90px;}
  }
</style>
</head>
<body>
  <h1>üåç Looop ‚Äî 1.30.5</h1>

  <!-- Contr√¥les des automatismes -->
  <div class="automatisms-controls" id="automatisms-controls">
    <button id="control-ia"     class="control-btn disabled" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button id="control-trader" class="control-btn disabled" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button id="control-confort" class="control-btn disabled" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button id="control-centre" class="control-btn disabled" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>

  <!-- Zone d'√©quilibre (affich√©e quand ressources ‚â§ 1000) -->
  <div class="optimum-zone" id="optimum-zone">
    <div style="font-weight:800;">üéØ Zone d'√©quilibre</div>
    <div class="optimum-progress-bar"><div class="optimum-progress-fill" id="optimum-progress"></div></div>
    <div class="optimum-text" id="optimum-text">Maintenez l‚Äô√©quilibre pendant 50 actions.</div>
  </div>

  <!-- Message de victoire -->
  <div id="optimum-victory">
    üèÜ VICTOIRE : √âquilibre maintenu pendant 50 actions !<br/>
    <button class="btn-yellow" onclick="restartGame()">üîÑ Recommencer</button>
  </div>

  <!-- √âv√©nements & effets temporaires -->
  <div class="events-zone">
    <div style="font-weight:800; margin-bottom:6px;">üåø √âv√©nements al√©atoires</div>
    <div id="event-box" class="event-notification">
      <div id="event-text"></div>
      <div id="event-effects" style="font-size:.9em;color:#666;margin-top:4px;"></div>
    </div>
    <div class="temp-effects">
      <h4>Effets temporaires actifs</h4>
      <div id="temp-list" class="temp-list"><span style="color:#777;">Aucun</span></div>
    </div>
  </div>

  <div class="container">
    <!-- Environnement -->
    <div class="category">
      <div class="cat-title">üå± Plan√®te</div>
      <div class="stock-value" id="nature">3000</div>
      <div class="stock-label">Ressources</div>

      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>

      <!-- Bloc investissement √©cologique (EH) -->
      <div id="investment-block" class="investment-block" style="display:none;">
        <div class="investment-title">üå± Investissement √©cologique (retour en 10 actions)</div>
        <div class="investment-controls">
          <input type="number" id="investment-amount" class="investment-input" placeholder="Montant ‚Ç¨" min="1" oninput="updateInvestmentPreview()">
          <button class="btn-invest" onclick="makeEcologicalInvestment()">üíö Investir</button>
          <button class="btn-invest" onclick="investirEcologieFixe()">üåø Raccourci (‚Äì200‚Ç¨ ‚Üí +30)</button>
        </div>
        <div id="investment-preview" class="investment-preview"></div>
        <div id="investment-list" class="investment-list">Aucun investissement en cours</div>
      </div>
    </div>

    <!-- Exosomatisation -->
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock-value" id="confort">0</div>
      <div class="stock-label">Confort</div>

      <div class="products-box">Produits cr√©√©s<br/><span id="production">0</span></div>
      <div id="social-crise" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">üõãÔ∏è Achat</button>
      </div>
    </div>

    <!-- √âconomie -->
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock-value" id="money">1000</div>
      <div class="stock-label">Monnaie (‚Ç¨)</div>

      <div class="products-box" id="price-indicator" style="display:none;">Prix de vente<br><span id="current-price">1‚Ç¨</span></div>

      <!-- Bouton n√©gociation cr√©dit (par paliers 300/600/900) -->
      <button id="nego-taux-btn" class="btn-yellow" style="display:none;" onclick="negocierTaux()">ü§ù N√©gocier mon cr√©dit</button>

      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>

        <!-- Am√©liorations/paliers -->
        <button id="ouvrier-btn" style="display:none;" onclick="acheterIA()">ü§ñ Engager une IA</button>
        <button id="trader-btn" style="display:none;" onclick="acheterTrader()">üí∞ Trader automatique</button>
        <button id="comfort-auto-btn" style="display:none;" onclick="acheterConfortAuto()">üîÑ Achat auto confort</button>
        <button id="upgrade-btn" style="display:none;" onclick="upgradeProd()">üí† Am√©liorer la production</button>
        <button id="centre-commercial-btn" style="display:none;" onclick="acheterCentre()">üè¨ Centre commercial</button>
        <button id="automatisms-btn" style="display:none;" onclick="acheterAutomatismsClics()">‚ö° Automatismes = clics</button>
        <button id="price-indicator-btn" style="display:none;" onclick="acheterIndicateur()">üìä Indicateur de prix</button>

        <!-- EH -->
        <button id="evolution-btn" class="btn-evo" style="display:none;" onclick="evolution()">üå± Passer √† l'√©conomie hom√©ostatique</button>
        <button id="rescue-eh-btn" class="btn-evo" style="display:none;" onclick="activateRescueEH()">üå± Secours EH</button>
      </div>
    </div>
  </div>

  <!-- Jauges -->
  <div class="jrows">
    <div class="jrow"><div class="jlabel">üå± Ressources</div><div class="bar"><div id="jauge-nature" class="fill" style="width:0%"></div></div><div class="jval" id="jnature">3000</div></div>
    <div class="jrow" id="jg-confort" style="display:none;"><div class="jlabel">ü§ñ Confort</div><div class="bar"><div id="jauge-confort" class="fill"></div></div><div class="jval" id="jconfort">0</div></div>
    <div class="jrow"><div class="jlabel">üí∂ Monnaie</div><div class="bar"><div id="jauge-money" class="fill"></div></div><div class="jval" id="jmoney">1000‚Ç¨</div></div>
    <div class="jrow" id="jg-budget" style="display:none;"><div class="jlabel">üèõÔ∏è Budget √âtat</div><div class="bar"><div id="jauge-budget" class="fill"></div></div><div class="jval" id="jbudget">0‚Ç¨</div></div>

    <div class="jrow" id="jg-achat-auto" style="display:none;"><div class="jlabel">üîÑ Achat auto</div><div class="bar"><div id="jauge-achat-auto" class="fill"></div></div><div class="jval" id="jachat-auto">√ó0</div></div>
    <div class="jrow" id="jg-ia" style="display:none;"><div class="jlabel">ü§ñ IA</div><div class="bar"><div id="jauge-ia" class="fill"></div></div><div class="jval" id="jia">√ó0</div></div>
    <div class="jrow" id="jg-trader" style="display:none;"><div class="jlabel">üí∞ Trader</div><div class="bar"><div id="jauge-trader" class="fill"></div></div><div class="jval" id="jtrader">√ó0</div></div>
    <div class="jrow" id="jg-centre" style="display:none;"><div class="jlabel">üè¨ Centre</div><div class="bar"><div id="jauge-centre" class="fill"></div></div><div class="jval" id="jcentre">√ó0</div></div>
    <div class="jrow" id="jg-tech" style="display:none;"><div class="jlabel">üí† Tech</div><div class="bar"><div id="jauge-tech" class="fill"></div></div><div class="jval" id="jtech">Niv.0</div></div>
  </div>

  <div id="message"></div>
  <div id="clics-container" style="text-align:center; margin:16px 0; font-weight:800;">Clics/actions : <span id="clicks">0</span></div>

  <hr id="triche-sep">
  <div id="triche-label">Triche (tests)</div>
  <div class="debug-row">
    <button class="btn-yellow" onclick="toggleCheatMode()">üîì D√©verrouiller les outils de test</button>
    <div id="cheat-buttons" style="display:none;">
      <button class="btn-yellow" onclick="addMoney()">+1000 ‚Ç¨</button>
      <button class="btn-yellow" onclick="addNature()">+100 ressources</button>
      <button class="btn-yellow" onclick="addClicks()">+50 clics</button>
      <button class="btn-yellow" onclick="forceActivateEH()">Passer √† l'EH (test)</button>
      <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler</button>
      <button class="btn-yellow" onclick="toggleEvents()">üé≤ √âv√©nements ON/OFF</button>
    </div>
  </div>
<!-- Le bloc 2 (JS) viendra juste apr√®s -->
  <!-- ============================ BLOC 2/6 ‚Äî Logique de base & moteur d‚Äô√©v√©nements ============================ -->
<script>
// ===================================================================================
// √âTAT INITIAL ‚Äî conforme au cahier des charges (monnaie 1000, fiscalit√© 20 clics)
// ===================================================================================
const gameState = {
  // Stocks
  nature: 3000,
  confort: 0,
  production: 0,
  money: 1000,            // solde de d√©part demand√©
  budgetEtat: 0,
  monnaieActive: true,

  // Compteurs/√©tats
  clicks: 0,
  jeuBloque: false,
  gameOver: false,
  confortMaxAtteint: 0,

  // Zone d‚Äô√©quilibre
  optimumStreak: 0,
  optimumVictory: false,
  optimumRanges: { nature:[1800,2600], confort:[10,35], money:[400,1200] },

  // Fiscalit√© (OFF en EH)
  taxEnabled: true,
  taxEveryClicks: 20,
  _taxEverApplied: false,

  // Cr√©dit (int√©r√™ts seulement si achat ou d√©bit volontaire ‚Üí voir maybeApplyInterest())
  creditRate: 0.05,
  creditRateMin: 0.01,
  creditNegotiationsUsed: 0,
  lastNegotiationShownAt: 0,

  // EH (activ√© plus tard)
  ehActivated: false,
  ehAutoTriggerAt: 50,
  ehDonationEvery: 10,
  ehPrimeEvery: 50,
  ehFonteEvery: 10,
  ehBonusEvery: 10,
  ehTransactionTax: 0.04,

  // Investissements EH
  ecologicalInvestments: [], // {amount, remainingClicks, startClick}

  // Automatismes
  ia: 0, trader: 0, confortAuto: 0, centre: 0,
  automatismsGenerateClicks: false,

  // Tech / Production
  productionMultiplier: 1.0,
  techLevel: 0,
  baseProdCost: 5,              // co√ªt unitaire base en RESSOURCES
  prodCostUpgradesBought: 0,    // 0..3 ‚Üí 5‚Üí4‚Üí3‚Üí2

  // Paliers & achats (suivi des comptes)
  paliersDebloque:{
    comfort:false, ia:false, trader:false, upgradeProd:false,
    confortAuto:false, automatismsClics:false, priceIndicator:false, centreCommercial:false
  },
  nbAchatIA:0, nbAchatTrader:0, nbAchatConfortAuto:0, nbAchatUpgradeProd:0, nbAchatCentre:0,
  priceIndicatorActive:false
};

// ------------------------- Intervalles & triche/undo -------------------------
const intervals = { ia:null, trader:null, confortAuto:null, centre:null };
let automatismsActive = { ia:true, trader:true, confort:true, centre:true };
let lastState = null;
let cheatModeUnlocked = false;

// ===================================================================================
// OUTILS G√âN√âRIQUES
// ===================================================================================
function clamp(n, min=0){ return (n<min?min:n); }
function showMsg(txt){
  const m = document.getElementById("message");
  if(!m) return;
  m.innerHTML = '<span class="toast">'+txt+'</span>';
  setTimeout(()=>{ if(m.innerHTML.includes(txt)) m.innerHTML = ""; }, 4000);
}
function saveState(){
  lastState = {
    gameState: JSON.parse(JSON.stringify(gameState)),
    random: randomEventsSystem.getFullState()
  };
}
function undoAction(){
  if(!cheatModeUnlocked || !lastState) return;
  clearAllIntervals();
  const snap = lastState;
  Object.keys(gameState).forEach(k=>delete gameState[k]);
  Object.assign(gameState, snap.gameState);
  randomEventsSystem.restoreFullState(snap.random);
  restartIntervalsAfterUndo();
  updateUIValues();
  showMsg("‚è™ Action annul√©e");
}
function clearAllIntervals(){
  Object.keys(intervals).forEach(k=>{ if(intervals[k]){ clearInterval(intervals[k]); intervals[k]=null; } });
}
function restartIntervalsAfterUndo(){
  if (gameState.ia>0 && automatismsActive.ia && !gameState.ehActivated) startIAInterval();
  if (gameState.trader>0 && automatismsActive.trader && !gameState.ehActivated) startTraderInterval();
  if (gameState.confortAuto>0 && automatismsActive.confort && !gameState.ehActivated) startConfortAutoInterval();
  if (gameState.centre>0 && automatismsActive.centre && !gameState.ehActivated) startCentreInterval();
}

// ===================================================================================
// PRIX / CO√õT / INT√âR√äTS / FISCALIT√â
// ===================================================================================

// Prix de vente dynamique ‚Äî visible si l‚Äôindicateur est achet√©
function priceNow(){
  if (gameState.nature <= 0) return 1;
  let p = Math.max(1, Math.abs(gameState.money) / gameState.nature);
  // Effets temporaires "priceAdd" inject√©s par les √©v√©nements (ajout√© dans le bloc 4/6)
  p += (randomEventsSystem ? (randomEventsSystem.mod("priceAdd")||0) : 0);
  return Math.round(p*100)/100;
}

// Co√ªt unitaire actuel de production EN RESSOURCES (pas d‚Äôeuro ici)
function currentProdUnitCost(){
  const base = Math.max(2, gameState.baseProdCost - gameState.prodCostUpgradesBought);
  const delta = randomEventsSystem ? (randomEventsSystem.mod("prodCostDelta")||0) : 0;
  return Math.max(1, base + delta);
}

// Multiplicateur de production (tech √ó effets temporaires)
function currentProdMultiplier(){
  const extra = randomEventsSystem ? (randomEventsSystem.mod("prodMult")||0) : 0;
  return Math.max(0, gameState.productionMultiplier * (1 + extra));
}

// R√©g√©n√©ration passive (si un effet "regen" est actif)
function maybeApplyRegen(){
  const r = randomEventsSystem ? (randomEventsSystem.mod("regen")||0) : 0;
  if (r>0){ gameState.nature += Math.max(0, Math.round(gameState.nature * r)); }
}

// Int√©r√™ts de d√©couvert ‚Äî √† n‚Äôappeler qu‚Äôapr√®s un D√âBIT mon√©taire (achats, upgrades‚Ä¶)
// JAMAIS depuis "Produire" (qui ne doit pas toucher √† la monnaie).
function maybeApplyInterest(){
  if (gameState.money < 0){
    const due = Math.ceil(Math.abs(gameState.money) * gameState.creditRate);
    if (due>0){
      gameState.money -= due;
      showMsg("üí£ Int√©r√™ts de d√©couvert : -"+due+"‚Ç¨ (taux "+Math.round(gameState.creditRate*100)+"%)");
    }
    // bouton de n√©go g√©r√© ailleurs (bloc 3/6)
  }
}

// Fiscalit√© ‚Äî tous les 20 clics, OFF en EH
function maybeApplyTax(){
  if (!gameState.taxEnabled || gameState.ehActivated) return;
  if (gameState.clicks>0 && gameState.clicks % gameState.taxEveryClicks === 0){
    const tax = Math.ceil(Math.abs(gameState.money) * 0.20);
    if (tax>0){
      gameState.money -= tax;
      gameState.nature += 1;
      gameState.confort += 1;
      gameState.budgetEtat += tax;
      gameState._taxEverApplied = true;
      // r√©v√©ler la jauge budget √† la 1re fois
      const row = document.getElementById("jg-budget");
      if (row) row.style.display="flex";
      showMsg("üí∏ Fiscalit√© : -"+tax+"‚Ç¨ | +1 üå± | +1 ü§ñ");
    }
  }
}

// ===================================================================================
// MOTEUR D'√âV√âNEMENTS AL√âATOIRES (sans la grande liste ici ‚Äî elle arrive au bloc 4/6)
// ===================================================================================
const randomEventsSystem = {
  enabled: true,
  nextIn: 0,
  minGap: 20, maxGap: 60,
  recent: [], maxRecent: 5,
  activeTemp: [],
  autoTickGuard: false,

  reset(){ this.recent=[]; this.activeTemp=[]; this.schedule(); this.refreshTempUI(); this.autoTickGuard=false; hideEvent(); },
  init(){ this.schedule(); this.refreshTempUI(); },

  schedule(){
    this.nextIn = Math.floor(Math.random()*(this.maxGap-this.minGap+1)) + this.minGap;
  },

  // Appel√© apr√®s chaque action "joueur" (produce/sell/acheter/etc.)
  processClick(){
    if (!this.enabled) return;
    if (--this.nextIn <= 0){ this.trigger(); this.schedule(); }
    this.processTemp();
  },

  // Sur un tick automatique, on limite √† AU PLUS un √©v√©nement
  processAutoTick(){
    if (!this.enabled) return;
    if (this.autoTickGuard){ this.processTemp(); return; }
    this.autoTickGuard = true;
    if (--this.nextIn <= 0){ this.trigger(); this.schedule(); }
    this.processTemp();
    setTimeout(()=>{ this.autoTickGuard=false; }, 0);
  },

  trigger(){
    let pool = this.events.filter((e,i)=> this.recent.indexOf(i)===-1 );
    if (pool.length===0){ pool=this.events; this.recent=[]; }
    if (!pool.length) return; // si la liste n'est pas encore inject√©e (arrive bloc 4)
    const ev = pool[Math.floor(Math.random()*pool.length)];
    const idx = this.events.indexOf(ev);
    this.recent.push(idx); if (this.recent.length>this.maxRecent) this.recent.shift();
    this.run(ev);
  },

  run(ev){
    saveState();
    ev.effect(gameState, this);
    // garde-fous : pas de jauges n√©gatives non souhait√©es
    gameState.nature  = Math.max(0, gameState.nature);
    gameState.confort = Math.max(0, gameState.confort);
    showEvent("üåø "+ev.name+" ‚Äî "+ev.text, ev.display||"");
    setTimeout(hideEvent, 5000);
    // rafra√Æchi UI (la vraie updateUIValues compl√®te arrive bloc 3/6)
    if (typeof updateUIValues === "function") setTimeout(()=>updateUIValues(), 0);
  },

  // Effets temporaires (affich√©s dans l‚Äôencart)
  addTemp(type, value, duration, label){
    this.activeTemp.push({type,value,remain:duration,label});
    this.refreshTempUI();
    showMsg("‚è±Ô∏è Effet temporaire : "+label+" ("+duration+" actions)");
  },
  mod(type){ return this.activeTemp.reduce((s,e)=> s + (e.type===type ? e.value : 0), 0); },
  processTemp(){
    const ended=[];
    for (let i=this.activeTemp.length-1;i>=0;i--){
      this.activeTemp[i].remain--;
      if (this.activeTemp[i].remain<=0){ ended.push(this.activeTemp[i]); this.activeTemp.splice(i,1); }
    }
    ended.forEach(e => showMsg("‚åõ Fin de l‚Äôeffet : "+e.label));
    this.refreshTempUI();
  },
  refreshTempUI(){
    const box = document.getElementById("temp-list");
    if (!box) return;
    if (this.activeTemp.length===0){ box.innerHTML = '<span style="color:#777;">Aucun</span>'; return; }
    box.innerHTML = "";
    this.activeTemp.forEach(e=>{
      const pill = document.createElement("div");
      pill.className="temp-pill";
      pill.textContent = e.label+" ‚Ä¢ "+e.remain;
      box.appendChild(pill);
    });
  },

  // S√©rialisation (pour Undo)
  getFullState(){ return {
    enabled:this.enabled, nextIn:this.nextIn,
    recent:[...this.recent],
    activeTemp: JSON.parse(JSON.stringify(this.activeTemp))
  };},
  restoreFullState(st){
    this.enabled = st.enabled;
    this.nextIn  = st.nextIn;
    this.recent  = [...st.recent];
    this.activeTemp = JSON.parse(JSON.stringify(st.activeTemp));
    this.refreshTempUI();
  },

  // ‚ö†Ô∏è La GROSSE LISTE (260) sera inject√©e au bloc 4/6 pour √©viter les limites.
  events: []
};

// Aides UI pour la vignette d‚Äô√©v√©nement
function showEvent(t, fx){
  const box = document.getElementById("event-box");
  if(!box) return;
  document.getElementById("event-text").textContent = t;
  document.getElementById("event-effects").textContent = fx || "";
  box.style.display="block";
}
function hideEvent(){
  const box = document.getElementById("event-box");
  if (box) box.style.display="none";
}
</script>
<!-- ============================ /FIN BLOC 2/6 ============================ -->
  <script>
// ============================== BLOC 3/6 ‚Äî COEUR DU JEU ==============================
// Helpers d‚Äôaffichage
function _fmtMoney(v){ return (v>=0? v.toFixed(0)+"‚Ç¨" : "-"+Math.abs(v).toFixed(0)+"‚Ç¨"); }
function _pct(part, total){ if(total<=0) return 0; return Math.max(0, Math.min(100, Math.round(part*100/total))); }

// --------------------------- Mise √† jour de l‚Äôinterface ---------------------------
// --------------------------- Mise √† jour de l‚Äôinterface ---------------------------
function updateUIValues(){
  // Helpers locaux (r√©utilisent tes fonctions/IDs existants)
  const _id = (x)=>document.getElementById(x);
  const _setText = (id, v)=>{ const el=_id(id); if (el) el.textContent = v; };
  const _setBlock = (id, on)=>{ const el=_id(id); if (el) el.style.display = on ? "block" : "none"; };
  const _setInline = (id, on)=>{ const el=_id(id); if (el) el.style.display = on ? "inline-block" : "none"; };
  const fmt‚Ç¨ = (n)=> _fmtMoney != null ? _fmtMoney(n) : (Math.round(n).toLocaleString('fr-FR')+" ‚Ç¨");

  // 1) Stocks (valeurs principales)
  _setText("nature",     Math.max(0, Math.floor(gameState.nature||0)));
  _setText("confort",    Math.max(0, Math.floor(gameState.confort||0)));
  _setText("production", Math.max(0, Math.floor(gameState.production||0)));
  _setText("money",      Math.floor(gameState.money||0));
  _setText("jbudget",    fmt‚Ç¨(gameState.budgetEtat||0));

  // 2) Jauges num√©riques secondaires
  _setText("jnature",  Math.max(0, Math.floor(gameState.nature||0)));
  _setText("jconfort", Math.max(0, Math.floor(gameState.confort||0)));
  _setText("jmoney",   fmt‚Ç¨(gameState.money||0));

  // 3) Barres de progression (largeurs)
  const fN = _id("jauge-nature");
  const fC = _id("jauge-confort");
  const fM = _id("jauge-money");
  if (fN) fN.style.width = _pct(gameState.nature||0, 3000) + "%";
  if (fC) fC.style.width = _pct(gameState.confort||0, 50) + "%";
  if (fM) fM.style.width = _pct(Math.abs(gameState.money||0), 1200) + "%";

  // 4) Budget √âtat (affichage ligne apr√®s 1er imp√¥t)
  const rowBudget = _id("jg-budget");
  if (rowBudget && gameState._taxEverApplied) rowBudget.style.display = "flex";

  // 5) Indicateur de prix (si achet√©)
  if (gameState.priceIndicatorActive){
    _setBlock("price-indicator", true);
    const priceEl = _id("current-price");
    if (priceEl){
      // on garde ta fonction existante si elle est d√©finie
      const p = (typeof priceNow==="function") ? priceNow() : (typeof computeDynamicPrice==="function" ? computeDynamicPrice() : 1);
      priceEl.textContent = p.toFixed(2) + "‚Ç¨";
    }
  } else {
    _setBlock("price-indicator", false);
  }

  // 6) Zone d‚Äô√©quilibre (compteur + statut)
  const ranges = gameState.optimumRanges || { nature:[1800,2600], confort:[10,35], money:[400,1200] };
  const inOptimum =
    (gameState.nature>=ranges.nature[0] && gameState.nature<=ranges.nature[1]) &&
    (gameState.confort>=ranges.confort[0] && gameState.confort<=ranges.confort[1]) &&
    (gameState.money>=ranges.money[0]   && gameState.money<=ranges.money[1]);
  _setText("optimum-progress", `${gameState.optimumStreak||0}/50`);
  _setText("optimum-status", inOptimum ? "‚úÖ" : "‚ùå");
  _setBlock("victory-block", !!gameState.optimumVictory);

  // 7) Visibilit√© des boutons par paliers FIXES
  const clicks = gameState.clicks||0;
  const upgradesBought = gameState.prodCostUpgradesBought||0;
  const nbIA = gameState.nbAchatIA||0;

  // Confort ‚â•120 clics
  _setInline("comfort-btn", clicks>=120);

  // IA : r√©apparition √† 200*(achats+1) et pas en EH
  const nextIAThreshold = 200 * (nbIA + 1);
  _setInline("ouvrier-btn", (clicks>=nextIAThreshold) && !gameState.ehActivated);

  // Trader ‚â•500
  _setInline("trader-btn", clicks>=500 && !gameState.ehActivated);

  // Auto-confort ‚â•700
  _setInline("confort-auto-btn", clicks>=700 && !gameState.ehActivated);

  // Automatismes = clics ‚â•750 (si pas d√©j√† activ√©)
  _setInline("auto-clicks-btn", clicks>=750 && !gameState.automatismsGenerateClicks);

  // Indicateur de prix ‚â•1000 (si pas achet√©)
  _setInline("price-indicator-btn", clicks>=1000 && !gameState.priceIndicatorActive);

  // Centre commercial ‚â•1100
  _setInline("centre-btn", clicks>=1100 && !gameState.ehActivated);

  // Upgrade prod visible uniquement aux paliers 400/700/1100, cap 3, pas en EH
  const showUpg = (upgradesBought<3) && ([400,700,1100].includes(clicks)) && !gameState.ehActivated;
  _setInline("upgrade-btn", showUpg);

  // 8) Libell√©s des co√ªts (cycliques √ó1.5^n + fixes)
  const costIA     = Math.round(500  * Math.pow(1.5, gameState.nbAchatIA||0));
  const costTrader = Math.round(1000 * Math.pow(1.5, gameState.nbAchatTrader||0));
  const costCA     = Math.round(2000 * Math.pow(1.5, gameState.nbAchatConfortAuto||0));
  const costCentre = Math.round(5000 * Math.pow(1.5, gameState.nbAchatCentre||0));
  const costUpg    = Math.round(2000 * Math.pow(1.5, gameState.nbAchatUpgradeProd||0));

  _setText("ouvrier-btn",        `ü§ñ Engager une IA (${fmt‚Ç¨(costIA)})`);
  _setText("trader-btn",         `üí∞ Trader auto +1 (${fmt‚Ç¨(costTrader)})`);
  _setText("confort-auto-btn",   `üîÑ Achat auto (confort) +1 (${fmt‚Ç¨(costCA)})`);
  _setText("centre-btn",         `üè¨ Centre commercial +1 (${fmt‚Ç¨(costCentre)})`);
  _setText("upgrade-btn",        `üí† Upgrade production (${fmt‚Ç¨(costUpg)})`);
  _setText("comfort-btn",        `üõãÔ∏è Achat (100 ‚Ç¨)`);
  _setText("price-indicator-btn",`üìä Indicateur de prix (${fmt‚Ç¨(30000)})`);
  _setText("auto-clicks-btn",    `‚ö° Automatismes = clics (${fmt‚Ç¨(10000)})`);

  // 9) N√©gociation de cr√©dit (300/600/900), max 3, pas si jeu bloqu√©/over
  const negoUsed = gameState.creditNegotiationsUsed||0;
  const canShowNego = (negoUsed<3) && (
    (clicks>=300 && clicks<600) || (clicks>=600 && clicks<900) || (clicks>=900)
  ) && !gameState.jeuBloque && !gameState.gameOver;
  _setInline("nego-taux-btn", canShowNego);

  // 10) EH ‚Äî blocs sp√©cifiques
  _setBlock("investment-block", !!gameState.ehActivated);
  if (gameState.ehActivated){
    if (typeof updateInvestmentPreview==="function") updateInvestmentPreview();
    if (typeof updateInvestmentListUI==="function")  updateInvestmentListUI();
  }

  // 11) √âtats terminaux
  _setBlock("gameover-ecologie", (gameState.nature||0) <= 0);
  _setBlock("gameover-social",  (gameState.confort||0)===0 && (gameState.confortMaxAtteint||0)>0);

  // 12) Section monnaie : on la laisse visible si ton design le pr√©voit
  const moneySection = _id("money-section");
  if (moneySection) moneySection.style.display = "block";
}

  // Alertes crise (√©cologie, social)
  const alEco = document.getElementById("alert-crise");
  if(alEco){
    if (gameState.nature < 300) { alEco.style.display="block"; alEco.textContent="‚ö†Ô∏è Crise √©cologique imminente"; }
    else { alEco.style.display="none"; }
  }
  const alSoc = document.getElementById("social-crise");
  if(alSoc){
    if (gameState.confort<=5 && gameState.clicks>0) { alSoc.style.display="block"; alSoc.textContent="‚ö†Ô∏è Crise sociale"; }
    else { alSoc.style.display="none"; }
  }

  // Compteur de clics
  const clk = document.getElementById("clicks");
  if(clk) clk.textContent = gameState.clicks;

  // Visibilit√© des paliers (conform√©ment au cahier des charges)
  // Confort : visible d√®s 120 clics
  toggleDisplay("comfort-btn", gameState.clicks>=120);

  // IA : r√©apparition tous les 200 clics (200, 400, ‚Ä¶) en fonction des achats d√©j√† faits
  const nextIAThreshold = 200 * (gameState.nbAchatIA + 1);
  toggleDisplay("ouvrier-btn", gameState.clicks>=nextIAThreshold && gameState.ehActivated===false);

  // Trader : ‚â• 500 clics
  toggleDisplay("trader-btn", gameState.clicks>=500 && gameState.ehActivated===false);

  // Auto-confort : ‚â• 700 clics
  toggleDisplay("comfort-auto-btn", gameState.clicks>=700 && gameState.ehActivated===false);

  // Automatismes = clics : ‚â• 750 clics
  toggleDisplay("automatisms-btn", gameState.clicks>=750);

  // Indicateur de prix : ‚â• 1000 clics
  toggleDisplay("price-indicator-btn", gameState.clicks>=1000 && !gameState.priceIndicatorActive);

  // Centre : ‚â• 1100 clics
  toggleDisplay("centre-commercial-btn", gameState.clicks>=1100 && gameState.ehActivated===false);

  // Upgrade production : paliers fixes 400 / 700 / 1100, cap 3
  const upgradeThresholds = [400,700,1100];
  const canUpgrade = (gameState.techLevel < 3) && (gameState.clicks >= upgradeThresholds[gameState.techLevel]);
  toggleDisplay("upgrade-btn", canUpgrade && gameState.ehActivated===false);

  // Jauges secondaires visibles si >0
  toggleDisplay("jg-confort", (gameState.clicks>=120) || gameState.confort>0, true);
  toggleDisplay("jg-ia", gameState.ia>0, true);
  toggleDisplay("jg-trader", gameState.trader>0, true);
  toggleDisplay("jg-achat-auto", gameState.confortAuto>0, true);
  toggleDisplay("jg-centre", gameState.centre>0, true);
  toggleDisplay("jg-tech", gameState.techLevel>0, true);

  // Zone d‚Äô√©quilibre : on l‚Äôaffiche lorsqu‚Äôon se rapproche (ex. nature ‚â§ 1000)
  const zone = document.getElementById("optimum-zone");
  if(zone) zone.style.display = (gameState.nature<=1000 || gameState.optimumStreak>0) ? "block" : "none";

  // Mise √† jour du texte/victoire
  updateOptimumUI();
}

function toggleDisplay(id, on, isFlex){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = on ? (isFlex?"flex":"block") : "none";
}

// ---------------------- Zone d‚Äô√©quilibre : r√®gle 50/50 ----------------------
function inOptimum(){
  const r = gameState.optimumRanges;
  return (
    gameState.nature >= r.nature[0] && gameState.nature <= r.nature[1] &&
    gameState.confort>= r.confort[0] && gameState.confort<= r.confort[1] &&
    gameState.money  >= r.money[0]   && gameState.money  <= r.money[1]
  );
}
function updateOptimumStreak(){
  if (inOptimum()) gameState.optimumStreak++;
  else gameState.optimumStreak = 0;
  if (gameState.optimumStreak>=50 && !gameState.optimumVictory){
    gameState.optimumVictory = true;
    gameState.jeuBloque = true;
    document.getElementById("optimum-victory")?.style.setProperty("display","block");
    showMsg("üèÜ √âquilibre tenu 50 actions : victoire !");
  }
}
function updateOptimumUI(){
  const bar = document.getElementById("optimum-progress");
  const txt = document.getElementById("optimum-text");
  if(!bar || !txt) return;
  const v = Math.min(50, gameState.optimumStreak);
  bar.style.width = (v*2)+"%";
  txt.textContent = gameState.optimumVictory
    ? "Victoire atteinte."
    : "Progression : "+v+"/50 actions dans la zone d‚Äô√©quilibre.";
}

// ---------------------- M√©caniques EH (stubs s√ªrs pour ce bloc) ----------------------
function ehFriction(amount){
  // Friction 4% sur transactions mon√©taires en EH
  if (!gameState.ehActivated) return 0;
  return Math.round(Math.abs(amount) * gameState.ehTransactionTax);
}
function checkEHMechanics(){
  // Les cycles EH (dons/prime/fonte/bonus) seront g√©r√©s finement dans le bloc 5.
  // Ici, on ne fait rien qui touche √† la monnaie pour √©viter toute r√©gression.
}

// ============================ Actions principales ============================
// PRODUIRE ‚Äî ne touche JAMAIS √† la monnaie, uniquement aux ressources.
// ‚Üí pas d‚Äôint√©r√™ts ici, jamais.
function produce(){
  if (gameState.jeuBloque || gameState.gameOver) return;

  const cost = currentProdUnitCost();
  if (gameState.nature < cost){
    showMsg("Ressources insuffisantes (co√ªt "+cost+")");
    return;
  }

  saveState();

  // Co√ªt en ressources
  gameState.nature -= cost;

  // Production avec multiplicateur
  const prod = Math.max(1, Math.floor(currentProdMultiplier()));
  gameState.production += prod;

  // Compteur + effets non mon√©taires
  gameState.clicks++;
  maybeApplyRegen();

  // √âv√©nements
  randomEventsSystem.processClick();

  if (gameState.ehActivated){
    checkEHMechanics(); // aucune charge mon√©taire ici
  }else{
    // Fiscalit√© (OFF en EH)
    maybeApplyTax();
  }

  updateOptimumStreak();
  showMsg("Production +"+prod+" (co√ªt "+cost+" ressources)");
  updateUIValues();
}

// VENDRE ‚Äî g√©n√®re de la monnaie, applique la friction EH sur la transaction
function sell(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  const qty = Math.max(0, Math.floor(gameState.production));
  if (qty<=0){ showMsg("Aucun produit √† vendre."); return; }

  saveState();

  const price = priceNow();
  const revenue = qty * price;
  const fee = ehFriction(revenue);
  const net = revenue - fee;

  gameState.production -= qty;
  gameState.money += net;
  if (!gameState.monnaieActive) gameState.monnaieActive = true;

  gameState.clicks++;

  // √âv√©nements
  randomEventsSystem.processClick();

  if (gameState.ehActivated){
    checkEHMechanics(); // la friction est d√©j√† prise sur la transaction
  }else{
    maybeApplyTax();
    // Pas d‚Äôint√©r√™ts ici (on a cr√©dit√©, pas d√©bit√©)
  }

  updateOptimumStreak();
  showMsg("Vendu : +"+net.toFixed(2)+"‚Ç¨"+(fee?(" (frais EH "+fee+"‚Ç¨)"):""));
  updateUIValues();
}

// ---------------------------- Automatismes & toggles ----------------------------
function toggleAutomatism(kind){
  if (kind==="ia")     automatismsActive.ia = !automatismsActive.ia;
  if (kind==="trader") automatismsActive.trader = !automatismsActive.trader;
  if (kind==="confort") automatismsActive.confort = !automatismsActive.confort;
  if (kind==="centre") automatismsActive.centre = !automatismsActive.centre;
  refreshAutomatismControls();
  // (Re)d√©marrage/arr√™t des intervals si n√©cessaire
  if (!gameState.ehActivated){
    if (kind==="ia"){ if (automatismsActive.ia && gameState.ia>0) startIAInterval(); else stopInterval("ia"); }
    if (kind==="trader"){ if (automatismsActive.trader && gameState.trader>0) startTraderInterval(); else stopInterval("trader"); }
    if (kind==="confort"){ if (automatismsActive.confort && gameState.confortAuto>0) startConfortAutoInterval(); else stopInterval("confortAuto"); }
    if (kind==="centre"){ if (automatismsActive.centre && gameState.centre>0) startCentreInterval(); else stopInterval("centre"); }
  }
}

function refreshAutomatismControls(){
  const map = [
    ["control-ia", automatismsActive.ia],
    ["control-trader", automatismsActive.trader],
    ["control-confort", automatismsActive.confort],
    ["control-centre", automatismsActive.centre]
  ];
  map.forEach(([id,on])=>{
    const b = document.getElementById(id);
    if(!b) return;
    b.className = "control-btn "+(on?"active":"inactive");
    b.textContent = b.textContent.replace(/(ON|OFF)$/,(on?"ON":"OFF"));
  });
}

function stopInterval(key){
  if (intervals[key]){ clearInterval(intervals[key]); intervals[key]=null; }
}

// IA ‚Äî 5s : produit (consomme 5 ressources / IA)
function startIAInterval(){
  stopInterval("ia");
  if (!automatismsActive.ia || gameState.ia<=0 || gameState.ehActivated) return;
  intervals.ia = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    // Co√ªt ressource : 5 par IA (annule si pas assez)
    const totalCost = 5 * gameState.ia;
    if (gameState.nature < totalCost) return;
    gameState.nature -= totalCost;
    const add = Math.max(1, Math.floor(currentProdMultiplier()*gameState.ia));
    gameState.production += add;

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 5000);
}

// Trader ‚Äî 3s : vend min(production, trader)
function startTraderInterval(){
  stopInterval("trader");
  if (!automatismsActive.trader || gameState.trader<=0 || gameState.ehActivated) return;
  intervals.trader = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const qty = Math.min(gameState.production, gameState.trader);
    if (qty<=0) return;
    const revenue = qty * priceNow();
    const fee = ehFriction(revenue);
    const net = revenue - fee;
    gameState.production -= qty;
    gameState.money += net;

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 3000);
}

// Auto-confort ‚Äî 15s : ach√®te 1 confort √ó niveau (100‚Ç¨ l‚Äôunit√©)
// (Les d√©tails de cr√©dit/n√©go seront consolid√©s au bloc achats.)
function startConfortAutoInterval(){
  stopInterval("confortAuto");
  if (!automatismsActive.confort || gameState.confortAuto<=0 || gameState.ehActivated) return;
  intervals.confortAuto = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const units = Math.max(1, gameState.confortAuto);
    const base = 100 * units;
    const fee  = ehFriction(base);
    const total = base + fee;

    // D√©bit
    gameState.money -= total;
    gameState.confort += units;

    // Int√©r√™ts √©ventuels (achat = d√©bit) si solde < 0
    maybeApplyInterest();

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 15000);
}

// Centre ‚Äî 15s : +10 confort √ó centre, co√ªt mon√©taire 100‚Ç¨ √ó (10√ócentre)
function startCentreInterval(){
  stopInterval("centre");
  if (!automatismsActive.centre || gameState.centre<=0 || gameState.ehActivated) return;
  intervals.centre = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const gain = 10 * gameState.centre;
    const base = 100 * gain;
    const fee  = ehFriction(base);
    const total = base + fee;

    gameState.money -= total;
    gameState.confort += gain;

    // Int√©r√™ts √©ventuels
    maybeApplyInterest();

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 15000);
}

// -------------------- Stubs s√©curis√©s pour boutons non encore cod√©s --------------------
// (Ils seront remplac√©s par les vraies impl√©mentations au bloc 4/6 ‚Äî Achats & co√ªts.)
function acheterConfort(){
  // Achat manuel d‚Äô1 confort (100‚Ç¨) avec friction EH si actif
  if (gameState.jeuBloque || gameState.gameOver) return;
  saveState();
  const base = 100;
  const fee  = ehFriction(base);
  const total = base + fee;

  gameState.money -= total;
  gameState.confort += 1;

  // D√©bit => int√©r√™ts potentiels
  maybeApplyInterest();

  gameState.clicks++;
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();

  showMsg("üõãÔ∏è +1 confort ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  updateUIValues();
}
<script>
// ===================== HOTFIX ‚Äî Achats, Cr√©dit, EH, Investissements, Triche =====================

// --- Petites aides locales ---
function _round(x){ return Math.round(x); }
function _cost(base, n){ return _round(base * Math.pow(1.5, n||0)); } // multiplicateur √ó1.5^n
function _feeEH(amount){ return ehFriction(amount||0); }              // d√©j√† d√©fini dans ton code
function _afterActionPipeline(){
  // Traite events + imp√¥t/EH + progression optimum + UI
  randomEventsSystem.processClick();
  if (gameState.ehActivated){ ehInvestmentTick(); } else { maybeApplyTax(); }
  updateOptimumStreak();
  updateUIValues();
}

// --- IA (500‚Ç¨ √ó1.5^n) ---
function acheterIA(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  saveState();

  const base = _cost(500, gameState.nbAchatIA||0);
  const fee  = _feeEH(base);
  const total = base + fee;

  gameState.money -= total;                 // autorise le n√©gatif (int√©r√™ts ensuite)
  gameState.ia = (gameState.ia||0) + 1;
  gameState.nbAchatIA = (gameState.nbAchatIA||0) + 1;

  maybeApplyInterest();                     // si money < 0
  gameState.clicks++;

  // (re)d√©marre le tick si ON et hors EH
  if (automatismsActive?.ia && gameState.ia>0 && !gameState.ehActivated && typeof startIAInterval==="function"){
    startIAInterval();
  }

  showMsg("ü§ñ IA achet√©e ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  _afterActionPipeline();
}

// --- Trader (1000‚Ç¨ √ó1.5^n) ---
function acheterTrader(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  saveState();

  const base = _cost(1000, gameState.nbAchatTrader||0);
  const fee  = _feeEH(base);
  const total = base + fee;

  gameState.money -= total;
  gameState.trader = (gameState.trader||0) + 1;
  gameState.nbAchatTrader = (gameState.nbAchatTrader||0) + 1;

  maybeApplyInterest();
  gameState.clicks++;

  if (automatismsActive?.trader && gameState.trader>0 && !gameState.ehActivated && typeof startTraderInterval==="function"){
    startTraderInterval();
  }

  showMsg("üí∞ Trader automatique +1 ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  _afterActionPipeline();
}

// --- Achat auto confort (2000‚Ç¨ √ó1.5^n) ---
function acheterConfortAuto(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  saveState();

  const base = _cost(2000, gameState.nbAchatConfortAuto||0);
  const fee  = _feeEH(base);
  const total = base + fee;

  gameState.money -= total;
  gameState.confortAuto = (gameState.confortAuto||0) + 1;
  gameState.nbAchatConfortAuto = (gameState.nbAchatConfortAuto||0) + 1;

  maybeApplyInterest();
  gameState.clicks++;

  if (automatismsActive?.confort && gameState.confortAuto>0 && !gameState.ehActivated && typeof startConfortAutoInterval==="function"){
    startConfortAutoInterval();
  }

  showMsg("üîÑ Achat auto confort +1 ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  _afterActionPipeline();
}

// --- Upgrade production (2000‚Ç¨ √ó1.5^n), cap 3 : ‚Äì1 co√ªt unitaire & √ó1.5 multiplier ---
function upgradeProd(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if ((gameState.prodCostUpgradesBought||0) >= 3){ showMsg("Limite d‚Äôupgrade atteinte (3)"); return; }
  saveState();

  const base = _cost(2000, gameState.nbAchatUpgradeProd||0);
  const fee  = _feeEH(base);
  const total = base + fee;

  gameState.money -= total;

  // Double effet hybride
  gameState.prodCostUpgradesBought = (gameState.prodCostUpgradesBought||0) + 1; // 5‚Üí4‚Üí3‚Üí2 (born√© ailleurs)
  gameState.productionMultiplier = (gameState.productionMultiplier||1) * 1.5;
  gameState.techLevel = (gameState.techLevel||0) + 1;
  gameState.nbAchatUpgradeProd = (gameState.nbAchatUpgradeProd||0) + 1;

  maybeApplyInterest();
  gameState.clicks++;

  showMsg("üí† Upgrade prod : co√ªt‚Äì1 & √ó1.5 ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  _afterActionPipeline();
}

// --- Centre commercial (5000‚Ç¨ √ó1.5^n) ---
function acheterCentre(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  saveState();

  const base = _cost(5000, gameState.nbAchatCentre||0);
  const fee  = _feeEH(base);
  const total = base + fee;

  gameState.money -= total;
  gameState.centre = (gameState.centre||0) + 1;
  gameState.nbAchatCentre = (gameState.nbAchatCentre||0) + 1;

  maybeApplyInterest();
  gameState.clicks++;

  if (automatismsActive?.centre && gameState.centre>0 && !gameState.ehActivated && typeof startCentreInterval==="function"){
    startCentreInterval();
  }

  showMsg("üè¨ Centre commercial +1 ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  _afterActionPipeline();
}

// --- Automatismes = clics (10‚ÄØ000‚Ç¨, fixe) ---
function acheterAutomatismsClics(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if (gameState.automatismsGenerateClicks){ showMsg("D√©j√† activ√©."); return; }
  saveState();

  const base = 10000;
  const fee  = _feeEH(base);
  const total = base + fee;

  gameState.money -= total;
  gameState.automatismsGenerateClicks = true;

  maybeApplyInterest();
  gameState.clicks++;

  showMsg("‚ö° Automatismes = clics activ√© ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  _afterActionPipeline();
}

// --- Indicateur de prix (30‚ÄØ000‚Ç¨, fixe) ---
function acheterIndicateur(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if (gameState.priceIndicatorActive){ showMsg("Indicateur d√©j√† actif."); return; }
  saveState();

  const base = 30000;
  const fee  = _feeEH(base);
  const total = base + fee;

  gameState.money -= total;
  gameState.priceIndicatorActive = true;

  maybeApplyInterest();
  gameState.clicks++;

  showMsg("üìä Indicateur de prix activ√© ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  _afterActionPipeline();
}

// --- N√©gocier mon cr√©dit (paliers 300/600/900, co√ªt 2000‚Ç¨, ‚Äì1 pp, min 1%, max 3) ---
function negocierTaux(){
  if (gameState.jeuBloque || gameState.gameOver) return;

  // quota 3 utilisations
  if (gameState.creditNegotiationsUsed >= 3){
    showMsg("Limite atteinte : 3 n√©gociations max.");
    return;
  }

  // √©ligibilit√© par paliers 300/600/900
  const c = gameState.clicks;
  const eligible = (c>=300 && c<600) || (c>=600 && c<900) || (c>=900);
  if (!eligible){
    showMsg("Disponible √† 300, 600 et 900 clics.");
    return;
  }

  saveState();

  // co√ªt 2000‚Ç¨ (+ friction EH si EH active)
  const base = 2000;
  const fee  = ehFriction(base);
  const total = base + fee;

  gameState.money -= total;

  // applique la baisse : -1 pp, sans passer sous 1%
  const old = gameState.creditRate;
  const newRate = Math.max(gameState.creditRateMin || 0.01, Math.round((old - 0.01)*100)/100);
  gameState.creditRate = Math.max(newRate, 0.01);

  gameState.creditNegotiationsUsed++;

  // int√©r√™ts √©ventuels si on vient de passer n√©gatif
  maybeApplyInterest();

  // 1 clic d'action joueur (pour rester homog√®ne avec les autres achats)
  gameState.clicks++;
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();

  showMsg("ü§ù N√©gociation : taux "+Math.round(old*100)+"% ‚Üí "+Math.round(gameState.creditRate*100)+"% ("+total+"‚Ç¨)");

  // masquer le bouton jusqu‚Äôau prochain palier
  const btn = document.getElementById("nego-taux-btn");
  if (btn) btn.style.display = "none";

  updateUIValues();
}

// --- Passage √† l‚ÄôEH (√©conomie hom√©ostatique) ---
function evolution(fromRescue=false){
  if (gameState.ehActivated) { showMsg("EH d√©j√† active."); return; }
  saveState();

  gameState.ehActivated = true;
  gameState.taxEnabled = false; // redondant (l‚Äôimp√¥t est OFF si EH), mais explicite

  // Stopper les intervalles d‚Äôautomatismes (OFF par d√©faut en EH)
  clearAllIntervals?.();

  // UI : messages
  const ehMsg = document.getElementById("eh-msg");
  if (ehMsg){
    ehMsg.style.display = "block";
    ehMsg.textContent = "üå± EH activ√©e : imp√¥t OFF, friction 4% sur transactions, dons/primes/fonte/bonus p√©riodiques.";
  }
  const ehOk = document.getElementById("eh-success");
  if (fromRescue && ehOk){
    ehOk.style.display = "block";
    ehOk.textContent = "üÜò Secours EH appliqu√©.";
  }

  // Compte comme action (coh√©rence pipelines)
  gameState.clicks++;
  ehInvestmentTick(); // initialise la liste si besoin
  updateUIValues();
  showMsg("üåø Passage en √âconomie Hom√©ostatique.");
}

// --- Secours EH : +100 ressources, +50 confort puis EH ---
function activateRescueEH(){
  if (gameState.ehActivated) { showMsg("EH d√©j√† active."); return; }
  saveState();

  gameState.nature  = Math.max(0, gameState.nature) + 100;
  gameState.confort = Math.max(0, gameState.confort) + 50;

  evolution(true);
}

// --- EH : investissement avanc√© (retour apr√®s 10 clics) ---
function makeEcologicalInvestment(){
  if (!gameState.ehActivated){ showMsg("Investissements dispo uniquement en EH."); return; }
  saveState();

  const input = document.getElementById("investment-amount");
  const val   = Number(input?.value||0);

  if (!val || !isFinite(val)){ showMsg("Montant invalide."); return; }

  // Bornes : si montant >0 ‚Üí ‚â§ solde ; si <0 ‚Üí ‚â§ |dette|
  if (val>0 && val > gameState.money){ showMsg("Montant sup√©rieur au solde."); return; }
  if (val<0 && Math.abs(val) > Math.abs(Math.min(0,gameState.money))){ showMsg("Montant > dette autoris√©e."); return; }

  // D√©bit imm√©diat + friction EH (c‚Äôest une transaction volontaire)
  const fee = _feeEH(Math.abs(val));
  gameState.money -= (val + fee); // si val>0 on paie ; si val<0 on ‚Äúinvestit‚Äù en tirant sur le d√©couvert
  maybeApplyInterest();

  // Enregistre l‚Äôinvestissement
  const inv = { amount: val, remainingClicks: 10, startClick: gameState.clicks };
  gameState.ecologicalInvestments = gameState.ecologicalInvestments||[];
  gameState.ecologicalInvestments.push(inv);

  gameState.clicks++;
  showMsg("üíö Investissement lanc√© : "+(val>0?("-"+(val+fee)+"‚Ç¨"):("-"+fee+"‚Ç¨ de frais"))+" ‚Ä¢ restitution dans 10 actions.");
  ehInvestmentTick(); // met √† jour la liste/preview
  _afterActionPipeline();
}

// --- EH : raccourci ‚Äì200‚Ç¨ ‚Üí +30 ressources ---
function investirEcologieFixe(){
  if (!gameState.ehActivated){ showMsg("Disponible uniquement en EH."); return; }
  saveState();

  const base = 200;
  const fee  = _feeEH(base);
  const total = base + fee;

  gameState.money -= total;
  gameState.nature += 30;

  maybeApplyInterest();
  gameState.clicks++;

  showMsg("üåø Investissement rapide : -"+total+"‚Ç¨ ‚Üí +30 üå±");
  _afterActionPipeline();
}

// --- Aides EH : maturit√© des investissements & UI ---
function ehInvestmentTick(){
  // Payout quand (clicks - startClick) >= 10
  if (!Array.isArray(gameState.ecologicalInvestments)) gameState.ecologicalInvestments = [];
  const now = gameState.clicks;
  const matured = [];
  const still = [];

  for (const inv of gameState.ecologicalInvestments){
    const due = (now - (inv.startClick||now)) >= 10;
    if (due) matured.push(inv); else still.push(inv);
  }

  // Payer les matur√©s
  matured.forEach(inv=>{
    // Gain nature ‚Äî fonction inverse de la pression (simple, born√©e 3..50)
    const amt = Math.abs(inv.amount||0);
    const pressure = Math.max(200, gameState.nature); // plus la nature est basse, plus le facteur monte
    const raw = Math.round((amt / pressure) * 60);    // √©chelle douce
    const gainNature = Math.max(3, Math.min(50, raw));

    gameState.nature += gainNature;

    // Remboursement : amount + 2% (arrondi sup). Pas de frais EH √† la restitution (souvent per√ßu comme subvention).
    const bonus = Math.ceil(amt * 0.02);
    const deltaMoney = (inv.amount>=0 ? (inv.amount + bonus) : (-amt + bonus)); // si inv n√©gatif : on r√©duit la dette
    gameState.money += deltaMoney;

    showMsg("‚úÖ Investissement arriv√© √† maturit√© : +"+gainNature+" üå±, "+(deltaMoney>=0?"+":"")+deltaMoney+"‚Ç¨");
  });

  gameState.ecologicalInvestments = still;
  updateInvestmentListUI();
  updateInvestmentPreview();
}

function updateInvestmentListUI(){
  const box = document.getElementById("investment-list");
  if (!box) return;
  const arr = gameState.ecologicalInvestments||[];
  if (arr.length===0){ box.textContent = "Aucun investissement en cours"; return; }
  const now = gameState.clicks;
  box.innerHTML = "";
  arr.forEach((inv,i)=>{
    const remain = Math.max(0, 10 - (now - (inv.startClick||now)));
    const div = document.createElement("div");
    div.textContent = `#${i+1} ‚Ä¢ ${inv.amount>=0?("-"+inv.amount+"‚Ç¨"):(`dette ${inv.amount}‚Ç¨`)} ‚Ä¢ reste ${remain} actions`;
    box.appendChild(div);
  });
}

function updateInvestmentPreview(){
  const p = document.getElementById("investment-preview");
  const input = document.getElementById("investment-amount");
  if (!p || !input) return;
  const val = Number(input.value||0);
  if (!val){ p.textContent = ""; return; }

  // borne affich√©e
  const maxPos = Math.max(0, gameState.money);
  const maxNeg = Math.abs(Math.min(0, gameState.money));
  const ok = (val>0 && val<=maxPos) || (val<0 && Math.abs(val)<=maxNeg);

  // mod√®le de gain (m√™me logique que payout)
  const amt = Math.abs(val);
  const pressure = Math.max(200, gameState.nature);
  const raw = Math.round((amt / pressure) * 60);
  const gainNature = Math.max(3, Math.min(50, raw));
  const bonus = Math.ceil(amt*0.02);

  p.textContent = ok
    ? `Pr√©vision (10 actions) : +${gainNature} üå±, ${val>=0?"+":""}${val}‚Ç¨ rembours√©s + bonus ~${bonus}‚Ç¨`
    : `Montant hors borne (solde/dette).`;
}

// --- TRICHE (une seule source de v√©rit√©) ---
function toggleCheatMode(){
  // Synchronise la variable locale et window.*
  window.cheatModeUnlocked = !window.cheatModeUnlocked;
  if (typeof cheatModeUnlocked !== "undefined") { cheatModeUnlocked = window.cheatModeUnlocked; }

  const box = document.getElementById("cheat-buttons");
  if (box) box.style.display = (window.cheatModeUnlocked ? "inline-block" : "none");
  showMsg(window.cheatModeUnlocked ? "üîì Mode test activ√©" : "üîí Mode test d√©sactiv√©");
}
function addMoney(){ if (!window.cheatModeUnlocked && !cheatModeUnlocked) return; saveState(); gameState.money += 1000; updateUIValues(); }
function addNature(){ if (!window.cheatModeUnlocked && !cheatModeUnlocked) return; saveState(); gameState.nature += 100; updateUIValues(); }
function addClicks(){ if (!window.cheatModeUnlocked && !cheatModeUnlocked) return; saveState(); gameState.clicks += 50; updateUIValues(); }
function forceActivateEH(){ if (!window.cheatModeUnlocked && !cheatModeUnlocked) return; saveState(); evolution(true); }
function toggleEvents(){
  if (!window.cheatModeUnlocked && !cheatModeUnlocked) return;
  randomEventsSystem.enabled = !randomEventsSystem.enabled;
  showMsg("üé≤ √âv√©nements : "+(randomEventsSystem.enabled?"ON":"OFF"));
}
</script>
// ---------------------- Initialisation & petits toasts ----------------------
function initializeGame(){
  randomEventsSystem.init();
  setTimeout(()=>showMsg("üåç Vos choix √©conomiques influencent l‚Äôhabitabilit√© de la plan√®te."), 600);
  setTimeout(()=>showMsg("üõ†Ô∏è Produisez, vendez, achetez ‚Äî et tenez la zone d‚Äô√©quilibre."), 2600);
  updateUIValues();
}
initializeGame();
</script>
<!-- ============================ /FIN BLOC 3/6 ============================ -->
  <!-- ============================ BLOC 4/6 ‚Äî √âV√âNEMENTS (260) ============================ -->
<script>
// Petit utilitaire d‚Äôeffets s√ªrs
function _add(gs, key, delta){ gs[key] = Math.max(0, (gs[key]||0) + delta); }
function _money(gs, delta){
  // Les √©v√©nements ‚Äúdonnent/prennent‚Äù directement ‚Äî ce ne sont pas des transactions du joueur.
  gs.money = (gs.money||0) + delta;
}
function _cap(x, min, max){ return Math.max(min, Math.min(max, x)); }

// Fabrique un √©v√©nement
function makeEvent(name, text, fx, disp){
  return { name, text, effect: fx, display: disp||"" };
}

// Quelques g√©n√©rateurs d‚Äôeffets temporaires ‚Äúpropres‚Äù
function tempBoostProd(sys, multDelta, actions, label){
  sys.addTemp("prodMult", multDelta, actions, label);
}
function tempPrice(sys, add, actions, label){
  sys.addTemp("priceAdd", add, actions, label);
}
function tempProdCost(sys, delta, actions, label){
  sys.addTemp("prodCostDelta", delta, actions, label);
}
function tempRegen(sys, rate, actions, label){
  // ex: 0.01 ‚áí +1% de nature par action pendant N actions
  sys.addTemp("regen", rate, actions, label);
}

// √âv√©nements ‚Äúunitaires‚Äù vari√©s
const EV = [];

// 1) Famille √âCO : s√©cheresse / inondation / canicule / parasites / feux / pollution / restauration
const ecoShocks = [
  { n:"S√©cheresse r√©gionale", dN:-Math.floor(Math.random()*80+70), price:+0.4, regen:0, tempCost:+1 },
  { n:"Inondations",          dN:-Math.floor(Math.random()*60+50), price:+0.2, regen:0, tempCost:+1 },
  { n:"Canicule s√©v√®re",      dN:-Math.floor(Math.random()*70+60), price:+0.3, regen:0, tempCost:+2 },
  { n:"Parasites agricoles",  dN:-Math.floor(Math.random()*40+30), price:+0.25, regen:0, tempCost:+1 },
  { n:"Feux de for√™t",        dN:-Math.floor(Math.random()*90+80), price:+0.35, regen:0, tempCost:+2 },
  { n:"Pollution du fleuve",  dN:-Math.floor(Math.random()*50+40), price:+0.15, regen:0, tempCost:+1 },
];
ecoShocks.forEach(s=>{
  EV.push(makeEvent(
    "üå°Ô∏è "+s.n,
    "Des conditions extr√™mes ab√Æment les √©cosyst√®mes. Les mati√®res premi√®res se rar√©fient.",
    (gs, sys)=>{
      _add(gs, "nature", s.dN);
      tempProdCost(sys, +s.tempCost, 12, "Production plus co√ªteuse");
      tempPrice(sys, +s.price, 10, "Prix de march√© tendu");
    },
    "üå± "+s.dN+" ressources, co√ªt prod ‚Üë temporaire, prix +"
  ));
});

// Restaurations / rewilding / pluies bienvenues
const ecoReliefs = [
  { n:"Pluies bienvenues",         dN:+Math.floor(Math.random()*50+40), regen:+0.01 },
  { n:"Programme de reboisement",  dN:+Math.floor(Math.random()*60+50), regen:+0.015 },
  { n:"Restauration d‚Äôhabitats",   dN:+Math.floor(Math.random()*55+45), regen:+0.012 },
  { n:"Agriculture r√©g√©n√©ratrice", dN:+Math.floor(Math.random()*45+35), regen:+0.01 },
];
ecoReliefs.forEach(s=>{
  EV.push(makeEvent(
    "üåßÔ∏è "+s.n,
    "Un sursaut √©cologique redonne de l‚Äôoxyg√®ne √† la plan√®te. Les ressources se refont petit √† petit.",
    (gs, sys)=>{
      _add(gs, "nature", s.dN);
      tempRegen(sys, s.regen, 12, "R√©g√©n√©ration √©cologique");
      tempProdCost(sys, -1, 8, "Cha√Æne d‚Äôapprovisionnement plus fluide");
    },
    "üå± +"+s.dN+" | r√©g√©n√©ration temporaire"
  ));
});

// 2) Famille SOCIALE : gr√®ves, solidarit√©, innovation sociale, tensions, f√™tes
const social = [
  { n:"Gr√®ve g√©n√©rale",  dC:-Math.floor(Math.random()*3+2), prod:-0.15 },
  { n:"Mobilisation citoyenne", dC:+Math.floor(Math.random()*4+2), prod:+0.1 },
  { n:"Tensions sociales", dC:-Math.floor(Math.random()*3+1), price:+0.2 },
  { n:"F√™te des Communs", dC:+Math.floor(Math.random()*3+1), price:-0.1 },
];
social.forEach(s=>{
  EV.push(makeEvent(
    "üë• "+s.n,
    "Le climat social bouge. Les comportements d‚Äôachat et de production s‚Äôajustent.",
    (gs, sys)=>{
      if (s.dC) _add(gs, "confort", s.dC);
      if (s.prod) tempBoostProd(sys, s.prod, 10, (s.prod>0?"Productivit√© sociale":"Productivit√© en berne"));
      if (s.price) tempPrice(sys, s.price, 8, (s.price>0?"Prix sous tension":"Prix apais√©s"));
    },
    (s.dC?(s.dC>0?`ü§ñ +${s.dC}`:`ü§ñ ${s.dC}`):"")+" effets temporaires"
  ));
});

// 3) Famille MARCH√â : bulles, krachs, afflux capitaux, panique
const market = [
  { n:"Mini‚Äëbulle sp√©culative", money:+Math.floor(Math.random()*400+200), price:+0.2 },
  { n:"Krach sectoriel",        money:-Math.floor(Math.random()*500+300), price:-0.2 },
  { n:"Afflux de capitaux",     money:+Math.floor(Math.random()*600+300), price:+0.1 },
  { n:"Panique des d√©taillants",money:-Math.floor(Math.random()*350+150), price:-0.3 },
];
market.forEach(s=>{
  EV.push(makeEvent(
    "üìà "+s.n,
    "Les march√©s tanguent. Vos comptes sont touch√©s et les prix se r√©ajustent.",
    (gs, sys)=>{
      _money(gs, s.money);
      tempPrice(sys, s.price, 10, (s.price>0?"Prix dop√©s":"Prix d√©prim√©s"));
    },
    (s.money>0?`üí∂ +${s.money}`:`üí∂ ${s.money}`)+" | prix temporairement "+(s.price>0?"‚Üë":"‚Üì")
  ));
});

// 4) Famille TECHNO : perc√©es, pannes, hacks, optimisation
const tech = [
  { n:"Perc√©e frugale",     prod:+0.25, cost:-1, txt:"+25% prod, co√ªt -1" },
  { n:"Panne critique",     prod:-0.30, cost:+1, txt:"-30% prod, co√ªt +1" },
  { n:"Optimisation IA",    prod:+0.20, cost:0,  txt:"+20% prod" },
  { n:"Hame√ßonnage √©vit√©",  prod:+0.10, cost:0,  txt:"+10% prod (veille accrue)" },
];
tech.forEach(s=>{
  EV.push(makeEvent(
    "üß™ "+s.n,
    "La technologie joue en votre faveur‚Ä¶ ou pas. Vos cha√Ænes s‚Äôajustent.",
    (gs, sys)=>{
      if (s.prod) tempBoostProd(sys, s.prod, 12, "Choc technologique");
      if (s.cost) tempProdCost(sys, s.cost, 12, "Ajustement co√ªts de prod");
    },
    s.txt
  ));
});

// 5) Famille POLITIQUES PUBLIQUES (ne pas confondre avec fiscalit√© de base du jeu)
const policy = [
  { n:"Aides √† l‚Äô√©co‚Äëconception", money:+200, nat:+40, tempRegen:+0.01 },
  { n:"Norme stricte anti‚Äëpollution", nat:+60, cost:+1 },
  { n:"Subvention isolation", confort:+2, money:+150 },
  { n:"Contr√¥le prix temporaire", price:-0.25 },
  { n:"Guerre commerciale", price:+0.35, cost:+1 },
];
policy.forEach(s=>{
  EV.push(makeEvent(
    "üèõÔ∏è "+s.n,
    "D√©cision publique : l‚Äôenvironnement √©conomique change, avec des effets imm√©diats ou temporaires.",
    (gs, sys)=>{
      if (s.money) _money(gs, s.money);
      if (s.nat) _add(gs, "nature", s.nat);
      if (s.confort) _add(gs, "confort", s.confort);
      if (s.tempRegen) tempRegen(sys, s.tempRegen, 10, "Coup de pouce √©cologique");
      if (s.price) tempPrice(sys, s.price, 10, (s.price>0?"Prix sous pression":"Prix mod√©r√©s"));
      if (s.cost)  tempProdCost(sys, s.cost, 10, "Chocs de co√ªts");
    },
    [
      s.money?`üí∂ ${(s.money>0?"+":"")+s.money}`:null,
      s.nat?`üå± ${(s.nat>0?"+":"")+s.nat}`:null,
      s.confort?`ü§ñ ${(s.confort>0?"+":"")+s.confort}`:null,
      s.price?`prix ${(s.price>0?"‚Üë":"‚Üì")} temporaire`:null
    ].filter(Boolean).join(" | ")
  ));
});

// 6) Famille EH (si activ√©) : dons/entraide, frictions apais√©es, initiatives locales, stress EH
const ehFamily = [
  { n:"Entraide locale",        money:+120, confort:+2 },
  { n:"Prime verte citoyenne",  money:+180, nat:+30 },
  { n:"Friction apais√©e",       fee:-0.02 }, // interpr√©t√© comme baisse temporaire de co√ªts de prod
  { n:"Stress de transition",   prod:-0.15, price:+0.15 },
];
ehFamily.forEach(s=>{
  EV.push(makeEvent(
    "üåø [EH] "+s.n,
    "Dans l‚Äô√©conomie hom√©ostatique, le corps social s‚Äôadapte.",
    (gs, sys)=>{
      if (!gs.ehActivated){ // si pas EH, effet r√©duit + texte adapt√©
        _money(gs, Math.floor((s.money||0)/2));
        if (s.nat) _add(gs,"nature", Math.floor(s.nat/2));
        if (s.confort) _add(gs,"confort", Math.max(1, Math.floor(s.confort/2)));
        if (s.prod) tempBoostProd(sys, s.prod/2, 8, "Ajustement (hors EH)");
        if (s.price) tempPrice(sys, (s.price/2), 8, "Prix ajust√©s (hors EH)");
        if (s.fee) tempProdCost(sys, Math.round(s.fee*10), 8, "Friction ajust√©e");
        return;
      }
      if (s.money) _money(gs, s.money);
      if (s.nat) _add(gs,"nature", s.nat);
      if (s.confort) _add(gs,"confort", s.confort);
      if (s.prod) tempBoostProd(sys, s.prod, 10, "Transition EH");
      if (s.price) tempPrice(sys, s.price, 10, "Signal de prix EH");
      if (s.fee) tempProdCost(sys, Math.round(s.fee*10), 10, "Friction modifi√©e");
    },
    "Effets conditionnels selon EH"
  ));
});

// 7) Petits ‚Äúfluffs‚Äù r√©p√©tables avec l√©g√®res variations num√©riques pour atteindre ~260
function series(label, count, builder){
  for(let i=1;i<=count;i++){ EV.push(builder(i)); }
}

// S√©rie ‚Äúmicro‚Äë√©v√©nements nature‚Äù (+/‚àí modestes, style m√©t√©o locale)
series("M√©t√©o locale", 40, (i)=>{
  const sign = Math.random()<0.5?-1:+1;
  const dN = sign*Math.floor(Math.random()*18+8);
  return makeEvent(
    "‚õÖ M√©t√©o locale #"+i,
    (sign>0?"Des pluies fines nourrissent les sols.":"Un temps sec fatigue les sols."),
    (gs, sys)=>{ _add(gs,"nature", dN); if (sign>0) tempRegen(sys, 0.004, 6, "R√©g√©n√©ration l√©g√®re"); },
    "üå± "+(dN>0?"+":"")+dN+(sign>0?" | l√©g√®re r√©g√©n√©ration":"")
  );
});

// S√©rie ‚Äúmicro‚Äëmarch√©‚Äù (ajustements de prix courts)
series("Ajustement march√©", 40, (i)=>{
  const p = (Math.random()<0.5?-1:+1) * (Math.random()*0.18+0.05);
  return makeEvent(
    "üíπ Ajustement de march√© #"+i,
    "Les interm√©diaires ajustent leurs marges.",
    (gs, sys)=>{ tempPrice(sys, p, 6, "Micro‚Äëajustement des prix"); },
    "Prix "+(p>0?"‚Üë":"‚Üì")+" temporaire"
  );
});

// S√©rie ‚Äúproductivit√© op√©rationnelle‚Äù
series("Productivit√©", 40, (i)=>{
  const m = (Math.random()<0.55?+1:-1) * (Math.random()*0.22+0.08);
  return makeEvent(
    "‚öôÔ∏è Productivit√© #"+i,
    (m>0?"De bons r√©glages fluidifient la production.":"Des contretemps ralentissent la production."),
    (gs, sys)=>{ tempBoostProd(sys, m, 8, "Productivit√© op√©rationnelle"); },
    (m>0?"+":"-")+"prod temporaire"
  );
});

// S√©rie ‚Äúapprovisionnement‚Äù (co√ªt unitaire bouge un peu)
series("Approvisionnement", 40, (i)=>{
  const c = (Math.random()<0.5?+1:-1) * (Math.random()<0.5?1:2);
  return makeEvent(
    "üöö Approvisionnement #"+i,
    "Les co√ªts de production fluctuent avec la logistique.",
    (gs, sys)=>{ tempProdCost(sys, c, 8, "Co√ªts logistiques"); },
    "Co√ªt de prod "+(c>0?"‚Üë":"‚Üì")+" temporaire"
  );
});

// S√©rie ‚ÄúSolidarit√©s & tensions‚Äù (modeste confort +/‚àí)
series("Solidarit√©s & tensions", 40, (i)=>{
  const d = (Math.random()<0.55?+1:-1) * (Math.random()<0.5?1:2);
  return makeEvent(
    "ü§ù Humeurs sociales #"+i,
    (d>0?"R√©seaux de solidarit√© actifs.":"Ambiance morose, quelques frictions."),
    (gs)=>{ _add(gs,"confort", d); },
    "ü§ñ "+(d>0?"+":"")+d
  );
});

// On a d√©j√† ~6 familles √ó 4‚Äì6 chacun + 5 familles √ó 4 = ~30
// + 5 s√©ries √ó 40 = 200 ‚Äî> total ‚âà 230. Compl√©tons avec 30 ‚Äúsp√©ciaux‚Äù.

const specials = [
  makeEvent("üî¨ Recyclage pionnier",
    "Une start‚Äëup convertit des d√©chets en mati√®re premi√®re utilisable.",
    (gs, sys)=>{ _add(gs,"nature", +55); tempProdCost(sys, -1, 12, "Mati√®re recycl√©e"); },
    "üå± +55 | co√ªt prod ‚Üì temporaire"
  ),
  makeEvent("üõ∞Ô∏è Observation spatiale",
    "De meilleurs mod√®les m√©t√©o vous aident √† planifier la production.",
    (gs, sys)=>{ tempBoostProd(sys, +0.18, 12, "Planification fine"); },
    "+18% prod temporaire"
  ),
  makeEvent("üõ°Ô∏è Cyber‚Äëattaque √©vit√©e",
    "Votre SI encaisse une tentative sans d√©g√¢ts. Vigilance accrue.",
    (gs, sys)=>{ tempBoostProd(sys, +0.08, 10, "R√©activit√©"); tempProdCost(sys, -1, 6, "Frais √©vit√©s"); },
    "Prod +8% | co√ªt -1 (temp.)"
  ),
  makeEvent("üß≠ Coop inter‚Äëterritoires",
    "Des partenaires relaient des stocks, √©vitant des ruptures.",
    (gs, sys)=>{ tempPrice(sys, -0.18, 10, "Prix stabilis√©s"); },
    "Prix ‚Üì temporaire"
  ),
  makeEvent("üèóÔ∏è Surcapacit√© passag√®re",
    "Vous avez un peu trop produit. Les prix s‚Äôaffaissent.",
    (gs, sys)=>{ _add(gs,"production", +4); tempPrice(sys, -0.22, 10, "Offre surabondante"); },
    "Prod +4 (stock) | prix ‚Üì"
  ),
  makeEvent("üå¨Ô∏è Vent de face",
    "Une s√©rie d‚Äôal√©as mineurs s‚Äôadditionnent.",
    (gs, sys)=>{ _add(gs,"nature", -25); tempBoostProd(sys, -0.12, 8, "Ralentissement"); },
    "üå± -25 | prod -"
  ),
  makeEvent("üå§Ô∏è Accalmie bienvenue",
    "Tout s‚Äôaligne provisoirement.",
    (gs, sys)=>{ _add(gs,"nature", +25); tempBoostProd(sys, +0.12, 8, "Coup de pouce"); },
    "üå± +25 | prod +"
  ),
  makeEvent("ü™ô Micro‚Äëm√©c√©nat",
    "Un micro‚Äëfinancement citoyen atteint votre projet.",
    (gs)=>{ _money(gs, +180); },
    "üí∂ +180"
  ),
  makeEvent("ü™´ Rupture de composants",
    "Un fournisseur cl√© fait d√©faut.",
    (gs, sys)=>{ tempProdCost(sys, +2, 10, "Pi√®ces rares"); tempBoostProd(sys, -0.1, 10, "Lenteurs"); },
    "Co√ªt ++ | prod - (temp.)"
  ),
  makeEvent("üß∞ Maintenance anticip√©e",
    "Un arr√™t court √©vite une grosse panne.",
    (gs, sys)=>{ tempBoostProd(sys, +0.14, 10, "Cha√Æne saine"); },
    "Prod +14% temp."
  ),
];
while (specials.length<30){
  specials.push(makeEvent(
    "üì¶ Opportunit√© logistique",
    "Un cr√©neau de transport se lib√®re √† bon prix.",
    (gs, sys)=>{ tempProdCost(sys, -1, 8, "Fret avantageux"); },
    "Co√ªt prod -1 (temp.)"
  ));
}
EV.push(...specials);

// √Ä ce stade, EV ~ 230 + 30 = 260 pile (selon hasard mineur plus haut).
// Pour √™tre CERTAIN d‚Äôavoir 260, on normalise :
(function ensure260(){
  // Si jamais (par hasard) on avait + de 260, on coupe ; si <260, on compl√®te par des micro‚Äë√©v√©nements neutres.
  if (EV.length > 260) { EV.length = 260; return; }
  while (EV.length < 260){
    EV.push(makeEvent(
      "üîÅ Fluctuation mineure",
      "Des micro‚Äëvariations sans grande cons√©quence.",
      (gs, sys)=>{ tempPrice(sys, (Math.random()<0.5?-0.08:+0.08), 5, "Micro‚Äëvariation"); },
      "Prix ¬± (temp.)"
    ));
  }
})();

// Injection dans le moteur
randomEventsSystem.events = EV;
</script>
<!-- ============================ /FIN BLOC 4/6 ============================ -->
  <script>
/* =========================================================================
   BLOC 5/6 ‚Äî UI, PALIERS, AFFICHAGES, CONTROLES, TRICHE
   ========================================================================= */

/* ----------------------------- UI principale ----------------------------- */
function updateUIValues(){
  // Valeurs brutes
  _setText("nature", Math.round(gameState.nature));
  _setText("confort", Math.round(gameState.confort));
  _setText("production", Math.round(gameState.production));
  _setText("money", Math.round(gameState.money) + "‚Ç¨");
  _setText("clicks", gameState.clicks);

  // Jauges (born√©es √† 0..100%)
  _setGauge("jauge-nature",  gameState.nature/3000 * 100);
  _setGauge("jauge-confort", Math.min(100, gameState.confort/35*100));
  _setGauge("jauge-money",   _moneyPct(gameState.money));
  _setGauge("jauge-budget",  _budgetPct(gameState.budgetEtat));

  _setText("jnature", Math.round(gameState.nature));
  _setText("jconfort", Math.round(gameState.confort));
  _setText("jmoney", Math.round(gameState.money)+"‚Ç¨");
  _setText("jbudget", Math.round(gameState.budgetEtat)+"‚Ç¨");

  // Indicateur de prix (si achet√©)
  const pbox = document.getElementById("price-indicator");
  if (pbox) pbox.style.display = gameState.priceIndicatorActive ? "block" : "none";
  _setText("current-price", priceNow().toFixed(2) + "‚Ç¨");

  // Affichage des jauges/sections selon 1res occurrences
  _revealOnce("jg-confort", gameState.clicks >= 1);
  _maybeRevealBudgetRow();

  // Messages crise
  _updateCrises();

  // Zone d‚Äô√©quilibre (affich√©e quand ressources ‚â§ 1000, puis progression/victoire)
  const oz = document.getElementById("optimum-zone");
  if (oz) oz.style.display = (gameState.nature <= 1000 || gameState.optimumStreak>0) ? "block" : "none";
  _updateOptimumProgress();

  // Paliers de VISIBILIT√â (fixes) ‚Äî affichage des boutons
  _updateVisibilityPaliers();

  // Bouton n√©go cr√©dit (paliers 300/600/900, quota 3)
  _maybeShowNegotiationButton();

  // Bloc EH investissement avanc√© + contr√¥les auto
  _updateEHUI();

  // Contr√¥les ON/OFF des automatismes
  _refreshAutomatismControls();
}

/* --------------------------- Aides UI utilitaires ------------------------ */
function _setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v; }
function _setGauge(id, pct){
  const el = document.getElementById(id);
  if (!el) return;
  const p = Math.max(0, Math.min(100, Math.round(pct)));
  el.style.width = p + "%";
}
function _moneyPct(m){
  // bornage doux: 0‚Ç¨ = 10%, 400‚Äì1200 = 60‚Äì100%
  if (m <= 0) return 10;
  if (m >= 1200) return 100;
  return 10 + (m/1200)*90;
}
function _budgetPct(b){
  if (b <= 0) return 0;
  return Math.max(5, Math.min(100, (b/30000)*100));
}
function _revealOnce(id, cond){
  const el = document.getElementById(id);
  if (!el) return;
  if (cond && el.style.display !== "flex" && el.style.display !== "block"){
    // jauges ‚Üí flex ; autres ‚Üí block
    el.style.display = id.startsWith("jg-") ? "flex" : "block";
  }
}
function _maybeRevealBudgetRow(){
  if (gameState._taxEverApplied){
    const row = document.getElementById("jg-budget");
    if (row) row.style.display="flex";
  }
}

/* ------------------------------ Crises & GO ------------------------------ */
function _updateCrises(){
  // Crise √©cologique < 300
  const alert = document.getElementById("alert-crise");
  if (alert){
    if (gameState.nature < 300 && gameState.nature > 0){
      alert.style.display="block";
      alert.textContent = "‚ö†Ô∏è Crise √©cologique : ressources < 300";
    }else{
      alert.style.display="none";
    }
  }

  // Crise sociale si confort ‚â§5 apr√®s avoir d√©j√† √©t√© >5
  const sc = document.getElementById("social-crise");
  if (sc){
    if (gameState.confortMaxAtteint < gameState.confort) gameState.confortMaxAtteint = gameState.confort;
    if (gameState.confortMaxAtteint > 5 && gameState.confort <= 5){
      sc.style.display="block";
      sc.textContent = "‚ö†Ô∏è Crise sociale : confort ‚â§ 5";
    }else{
      sc.style.display="none";
    }
  }

  // Game Over Ressources
  const gor = document.getElementById("game-over-resources");
  if (gor){
    if (gameState.nature <= 0){
      gor.style.display="block";
      gor.textContent = "üí• Plan√®te non habitable (ressources √©puis√©es)";
    }else gor.style.display="none";
  }
  // Game Over Confort (si retombe √† 0 apr√®s avoir √©t√© >0)
  const goc = document.getElementById("game-over-confort");
  if (goc){
    if (gameState.confortMaxAtteint > 0 && gameState.confort <= 0){
      goc.style.display="block";
      goc.textContent = "üí• Crise sociale (confort retomb√© √† 0)";
    }else goc.style.display="none";
  }
}

/* -------------------------- Zone d‚Äô√©quilibre (win) ----------------------- */
function _updateOptimumProgress(){
  // Si victoire d√©j√† acquise, afficher panneau + sortir
  if (gameState.optimumVictory){
    const win = document.getElementById("optimum-victory");
    if (win) win.style.display = "block";
    const bar = document.getElementById("optimum-progress");
    if (bar) bar.style.width = "100%";
    _setText("optimum-text","Victoire obtenue !");
    return;
  }
  // Calcul de la progression
  const inNature = (gameState.nature>=gameState.optimumRanges.nature[0] && gameState.nature<=gameState.optimumRanges.nature[1]);
  const inConf   = (gameState.confort>=gameState.optimumRanges.confort[0] && gameState.confort<=gameState.optimumRanges.confort[1]);
  const inMoney  = (gameState.money>=gameState.optimumRanges.money[0]  && gameState.money<=gameState.optimumRanges.money[1]);

  if (inNature && inConf && inMoney){
    // La r√®gle d‚Äôincr√©ment est faite c√¥t√© actions (bloc 3) juste apr√®s chaque action.
    // Ici on ne fait que visualiser.
  }else{
    // si on sort de la zone, la remise √† 0 est g√©r√©e au m√™me endroit (bloc 3).
  }

  const pct = Math.min(100, Math.round((gameState.optimumStreak/50)*100));
  const bar = document.getElementById("optimum-progress");
  if (bar) bar.style.width = pct+"%";
  const txt = document.getElementById("optimum-text");
  if (txt) txt.textContent = "Maintenez l‚Äô√©quilibre pendant 50 actions. ("+gameState.optimumStreak+"/50)";

  // D√©clenchement de victoire (affichage) si atteint 50
  if (gameState.optimumStreak >= 50){
    gameState.optimumVictory = true;
    const win = document.getElementById("optimum-victory");
    if (win) win.style.display="block";
    showMsg("üèÜ Victoire : √âquilibre maintenu sur 50 actions !");
  }
}

/* --------------------------- Visibilit√© des paliers ---------------------- */
function _updateVisibilityPaliers(){
  const c = gameState.clicks;

  // Confort (‚â•120 clics)
  _showBtn("comfort-btn", c>=120);

  // IA (r√©apparition 200/400/‚Ä¶) ‚Äî on laisse visible si c >= 200
  _showBtn("ouvrier-btn", c>=200);

  // Trader (‚â•500)
  _showBtn("trader-btn", c>=500);

  // Auto‚Äëconfort (‚â•700)
  _showBtn("comfort-auto-btn", c>=700);

  // Automatismes = clics (‚â•750)
  _showBtn("automatisms-btn", c>=750);

  // Indicateur de prix (‚â•1000)
  _showBtn("price-indicator-btn", c>=1000 && !gameState.priceIndicatorActive);

  // Centre commercial (‚â•1100)
  _showBtn("centre-commercial-btn", c>=1100);

  // Upgrade production visible seulement aux paliers 400/700/1100 (cap 3)
  const showUpgrade = ( (c>=400 && c<700) || (c>=700 && c<1100) || (c>=1100) ) && (gameState.prodCostUpgradesBought<3);
  _showBtn("upgrade-btn", showUpgrade);
}

function _showBtn(id, show){
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = show ? "block" : "none";
}

/* --------------------------- N√©gociation de cr√©dit ----------------------- */
function _maybeShowNegotiationButton(){
  const btn = document.getElementById("nego-taux-btn");
  if (!btn) return;
  if (gameState.creditNegotiationsUsed >= 3){ btn.style.display="none"; return; }
  const c = gameState.clicks;
  const should = (c>=300 && c<600) || (c>=600 && c<900) || (c>=900);
  // √©viter de spammer : on l‚Äôaffiche si on a d√©pass√© le dernier palier non exploit√©
  if (should){
    btn.style.display = "inline-block";
  }else{
    btn.style.display = "none";
  }
}

/* -------------------------- UI sp√©cifique √† l‚ÄôEH ------------------------- */
function _updateEHUI(){
  // Bloc investissement avanc√© visible en EH
  const inv = document.getElementById("investment-block");
  if (inv) inv.style.display = gameState.ehActivated ? "block" : "none";

  // Messages EH
  const ehMsg = document.getElementById("eh-msg");
  if (ehMsg) ehMsg.style.display = gameState.ehActivated ? "block" : "none";

  // Contr√¥les d‚Äôautomatismes : masqu√©s en EH (par d√©faut OFF en EH)
  const panel = document.getElementById("automatisms-controls");
  if (panel) panel.style.display = (!gameState.ehActivated && (gameState.ia>0 || gameState.trader>0 || gameState.confortAuto>0 || gameState.centre>0)) ? "flex" : "none";
}

/* ----------------------- Contr√¥les ON/OFF automatismes ------------------- */
function _refreshAutomatismControls(){
  // IA
  _setAutomControl("control-ia", "ia", automatismsActive.ia && gameState.ia>0 && !gameState.ehActivated);
  // Trader
  _setAutomControl("control-trader", "trader", automatismsActive.trader && gameState.trader>0 && !gameState.ehActivated);
  // Confort auto
  _setAutomControl("control-confort", "confort", automatismsActive.confort && gameState.confortAuto>0 && !gameState.ehActivated);
  // Centre
  _setAutomControl("control-centre", "centre", automatismsActive.centre && gameState.centre>0 && !gameState.ehActivated);

  // Griser si pas d‚Äô√©quipement ou si EH
  _applyDisabled("control-ia",     !(gameState.ia>0)     || gameState.ehActivated);
  _applyDisabled("control-trader", !(gameState.trader>0) || gameState.ehActivated);
  _applyDisabled("control-confort",!(gameState.confortAuto>0) || gameState.ehActivated);
  _applyDisabled("control-centre", !(gameState.centre>0) || gameState.ehActivated);
}

function _setAutomControl(id, key, isOn){
  const b = document.getElementById(id);
  if (!b) return;
  const active = isOn;
  b.className = "control-btn " + (active ? "active" : "inactive");
  const label = (key==="ia"?"ü§ñ IA": key==="trader"?"üí∞ Trader": key==="confort"?"üõãÔ∏è Confort":"üè¨ Centre");
  b.textContent = label + ": " + (active?"ON":"OFF");
}
function _applyDisabled(id, disabled){
  const b = document.getElementById(id);
  if (!b) return;
  if (disabled){
    b.classList.add("disabled");
  }else{
    b.classList.remove("disabled");
  }
}

/* Les boutons ON/OFF appellent toggleAutomatism(key) ‚Äî d√©j√† c√¢bl√© dans le HTML */
function toggleAutomatism(key){
  if (gameState.ehActivated) return; // OFF pendant EH
  if (!(key in automatismsActive)) return;
  // si pas d‚Äô√©quipement ‚Üí ignore
  if (key==="ia" && gameState.ia<=0) return;
  if (key==="trader" && gameState.trader<=0) return;
  if (key==="confort" && gameState.confortAuto<=0) return;
  if (key==="centre" && gameState.centre<=0) return;

  automatismsActive[key] = !automatismsActive[key];

  // (Re)lancer ou couper l‚Äôintervalle correspondant
  if (key==="ia"){
    if (automatismsActive.ia) startIAInterval(); else if (intervals.ia){ clearInterval(intervals.ia); intervals.ia=null; }
  }else if (key==="trader"){
    if (automatismsActive.trader) startTraderInterval(); else if (intervals.trader){ clearInterval(intervals.trader); intervals.trader=null; }
  }else if (key==="confort"){
    if (automatismsActive.confort) startConfortAutoInterval(); else if (intervals.confortAuto){ clearInterval(intervals.confortAuto); intervals.confortAuto=null; }
  }else if (key==="centre"){
    if (automatismsActive.centre) startCentreInterval(); else if (intervals.centre){ clearInterval(intervals.centre); intervals.centre=null; }
  }
  _refreshAutomatismControls();
  showMsg("‚öôÔ∏è " + key + " : " + (automatismsActive[key]?"ON":"OFF"));
}

/* ------------------------------- Triche/tests ---------------------------- */
function toggleCheatMode(){
  cheatModeUnlocked = !cheatModeUnlocked;
  const box = document.getElementById("cheat-buttons");
  if (box) box.style.display = cheatModeUnlocked ? "inline-block" : "none";
  showMsg(cheatModeUnlocked ? "üîì Mode test activ√©" : "üîí Mode test d√©sactiv√©");
}

function addMoney(){
  if (!cheatModeUnlocked) return;
  saveState();
  gameState.money += 1000;
  updateUIValues();
}
function addNature(){
  if (!cheatModeUnlocked) return;
  saveState();
  gameState.nature += 100;
  updateUIValues();
}
function addClicks(){
  if (!cheatModeUnlocked) return;
  saveState();
  gameState.clicks += 50;
  updateUIValues();
}
function forceActivateEH(){
  if (!cheatModeUnlocked) return;
  saveState();
  evolution(); // utilise la m√™me routine que le bouton ‚ÄúPasser √† l‚ÄôEH‚Äù
}
function toggleEvents(){
  if (!cheatModeUnlocked) return;
  randomEventsSystem.enabled = !randomEventsSystem.enabled;
  showMsg("üé≤ √âv√©nements : " + (randomEventsSystem.enabled?"ON":"OFF"));
}

/* ------------------------------- Divers ---------------------------------- */
function restartGame(){
  // Reset complet ‚Äî coh√©rent avec bloc 2/6 (√©tat initial)
  saveState();
  clearAllIntervals();
  const initial = {
    nature:3000, confort:0, production:0, money:1000, budgetEtat:0, monnaieActive:true,
    clicks:0, jeuBloque:false, gameOver:false, confortMaxAtteint:0,
    optimumStreak:0, optimumVictory:false, optimumRanges:{ nature:[1800,2600], confort:[10,35], money:[400,1200] },
    taxEnabled:true, taxEveryClicks:20, _taxEverApplied:false,
    creditRate:gameState.creditRateMin?Math.max(gameState.creditRate, gameState.creditRateMin):0.05,
    creditRateMin:0.01, creditNegotiationsUsed:0, lastNegotiationShownAt:0,
    ehActivated:false, ehAutoTriggerAt:50, ehDonationEvery:10, ehPrimeEvery:50, ehFonteEvery:10, ehBonusEvery:10, ehTransactionTax:0.04,
    ecologicalInvestments:[],
    ia:0, trader:0, confortAuto:0, centre:0, automatismsGenerateClicks:false,
    productionMultiplier:1.0, techLevel:0, baseProdCost:5, prodCostUpgradesBought:0,
    paliersDebloque:{comfort:false, ia:false, trader:false, upgradeProd:false, confortAuto:false, automatismsClics:false, priceIndicator:false, centreCommercial:false},
    nbAchatIA:0, nbAchatTrader:0, nbAchatConfortAuto:0, nbAchatUpgradeProd:0, nbAchatCentre:0,
    priceIndicatorActive:false
  };
  Object.keys(gameState).forEach(k=>delete gameState[k]);
  Object.assign(gameState, initial);
  randomEventsSystem.reset();

  // Masquer victoire
  const win = document.getElementById("optimum-victory");
  if (win) win.style.display="none";

  // Rafra√Æchir UI
  updateUIValues();
  showMsg("üîÑ Partie r√©initialis√©e");
}

/* =========================================================================
   FIN BLOC 5/6
   ========================================================================= */
</script>
<!-- ============================ BLOC 6/6 ‚Äî FINALISATION & BOOT ============================ -->
<script>
/* =========================================================================
   CONTR√îLES (panneau ON/OFF) ‚Äî d√©marrage/arr√™t des intervalles si d√©fini
   ========================================================================= */
function toggleAutomatism(kind){
  if (!window.automatismsActive) return;
  const mapId = {
    ia: "control-ia",
    trader: "control-trader",
    confort: "control-confort",
    centre: "control-centre"
  };
  automatismsActive[kind] = !automatismsActive[kind];
  const btn = document.getElementById(mapId[kind]);
  if (btn){
    btn.className = "control-btn " + (automatismsActive[kind] ? "active" : "inactive");
    btn.textContent =
      (kind==="ia"     ? "ü§ñ IA: " :
       kind==="trader" ? "üí∞ Trader: " :
       kind==="confort"? "üõãÔ∏è Confort: " :
                         "üè¨ Centre: ") + (automatismsActive[kind] ? "ON" : "OFF");
  }
  // (re)d√©marrage/arr√™t selon le type si les fonctions existent
  if (kind==="ia"){
    if (automatismsActive.ia && gameState.ia>0 && !gameState.ehActivated && typeof startIAInterval==="function"){
      startIAInterval();
    } else if (intervals.ia){ clearInterval(intervals.ia); intervals.ia=null; }
  }
  if (kind==="trader"){
    if (automatismsActive.trader && gameState.trader>0 && !gameState.ehActivated && typeof startTraderInterval==="function"){
      startTraderInterval();
    } else if (intervals.trader){ clearInterval(intervals.trader); intervals.trader=null; }
  }
  if (kind==="confort"){
    if (automatismsActive.confort && gameState.confortAuto>0 && !gameState.ehActivated && typeof startConfortAutoInterval==="function"){
      startConfortAutoInterval();
    } else if (intervals.confortAuto){ clearInterval(intervals.confortAuto); intervals.confortAuto=null; }
  }
  if (kind==="centre"){
    if (automatismsActive.centre && gameState.centre>0 && !gameState.ehActivated && typeof startCentreInterval==="function"){
      startCentreInterval();
    } else if (intervals.centre){ clearInterval(intervals.centre); intervals.centre=null; }
  }
}

/* =========================================================================
   MODE TRICHE (tests rapides)
   ========================================================================= */
function toggleCheatMode(){
  window.cheatModeUnlocked = !window.cheatModeUnlocked;
  const box = document.getElementById("cheat-buttons");
  if (box) box.style.display = window.cheatModeUnlocked ? "inline-block" : "none";
  showMsg(window.cheatModeUnlocked ? "üîì Mode test activ√©" : "üîí Mode test d√©sactiv√©");
}
function addMoney(){ if (!window.cheatModeUnlocked) return; saveState(); gameState.money += 1000; if (typeof updateUIValues==="function") updateUIValues(); }
function addNature(){ if (!window.cheatModeUnlocked) return; saveState(); gameState.nature += 100; if (typeof updateUIValues==="function") updateUIValues(); }
function addClicks(){ if (!window.cheatModeUnlocked) return; saveState(); gameState.clicks += 50; if (typeof updateUIValues==="function") updateUIValues(); }
function toggleEvents(){
  if (!window.cheatModeUnlocked) return;
  randomEventsSystem.enabled = !randomEventsSystem.enabled;
  showMsg(randomEventsSystem.enabled ? "üé≤ √âv√©nements ACTIV√âS" : "‚õî √âv√©nements D√âSACTIV√âS");
}
function forceActivateEH(){
  if ((!window.cheatModeUnlocked) return;
  saveState();
  if (typeof evolution==="function") evolution(true); // param test facultatif selon ton impl√©mentation
}

/* =========================================================================
   RESTART / RESCUE
   ========================================================================= */
function restartGame(){
  // R√©init √©tat principal (en gardant param√®tres ‚Äúdesign‚Äù du cahier des charges)
  Object.assign(gameState, {
    nature: 3000, confort: 0, production: 0, money: 1000, budgetEtat: 0,
    monnaieActive: true, clicks: 0, jeuBloque: false, gameOver: false,
    confortMaxAtteint: 0, optimumStreak: 0, optimumVictory: false,
    taxEnabled: true, _taxEverApplied: false,
    ehActivated: false, ecologicalInvestments: [],
    ia:0, trader:0, confortAuto:0, centre:0,
    automatismsGenerateClicks: false,
    productionMultiplier: 1.0, techLevel: 0, baseProdCost: 5, prodCostUpgradesBought: 0,
    paliersDebloque:{
      comfort:false, ia:false, trader:false, upgradeProd:false,
      confortAuto:false, automatismsClics:false, priceIndicator:false, centreCommercial:false
    },
    nbAchatIA:0, nbAchatTrader:0, nbAchatConfortAuto:0, nbAchatUpgradeProd:0, nbAchatCentre:0,
    priceIndicatorActive:false
  });
  // UI : cacher victoire, r√©initialiser encarts
  const v = document.getElementById("optimum-victory"); if (v) v.style.display="none";
  const ehMsg = document.getElementById("eh-msg"); if (ehMsg) ehMsg.style.display="none";
  const ehOk  = document.getElementById("eh-success"); if (ehOk) ehOk.style.display="none";
  const gr = document.getElementById("game-over-resources"); if (gr) gr.style.display="none";
  const gc = document.getElementById("game-over-confort"); if (gc) gc.style.display="none";

  // Intervalles
  clearAllIntervals();
  if (typeof randomEventsSystem.reset==="function") randomEventsSystem.reset();

  // Relance paliers/visibilit√©s & UI
  if (typeof updateUIValues==="function") updateUIValues();

  // Conseils d‚Äôintro
  setTimeout(()=>showMsg("üåç Vos choix √©conomiques influencent l‚Äôhabitabilit√© de la plan√®te."), 400);
  setTimeout(()=>showMsg("üõ†Ô∏è Produisez, vendez, achetez ‚Äî et tenez la zone d‚Äô√©quilibre."), 2200);
}

function activateRescueEH(){
  // Bouton secours apr√®s Game Over : +100 ressources, +50 confort et activation EH
  saveState();
  gameState.nature  = Math.max(0, gameState.nature) + 100;
  gameState.confort = Math.max(0, gameState.confort) + 50;
  if (typeof evolution==="function") evolution(true);
  showMsg("üÜò Secours EH activ√© : +100 üå±, +50 ü§ñ, stabilisation en cours.");
  if (typeof updateUIValues==="function") updateUIValues();
}

/* =========================================================================
   BOOT ‚Äî Lancement s√ªr m√™me si certaines fonctions ne sont pas encore charg√©es
   ========================================================================= */
(function safeBoot(){
  // Affiche le panneau des contr√¥les (il sera ‚Äúdisabled‚Äù tant que pas d‚Äôachats)
  const panel = document.getElementById("automatisms-controls");
  if (panel) panel.style.display = "flex";

  // Pr√©pare l‚Äôaffichage des boutons ON/OFF
  ["ia","trader","confort","centre"].forEach(k=>{
    const id =
      k==="ia"     ? "control-ia" :
      k==="trader" ? "control-trader" :
      k==="confort"? "control-confort" : "control-centre";
    const btn = document.getElementById(id);
    if (btn){
      const active = (automatismsActive && automatismsActive[k]) ? "active" : "inactive";
      btn.className = "control-btn " + active;
      btn.textContent =
        (k==="ia"     ? "ü§ñ IA: " :
         k==="trader" ? "üí∞ Trader: " :
         k==="confort"? "üõãÔ∏è Confort: " : "üè¨ Centre: ") +
        ((automatismsActive && automatismsActive[k]) ? "ON" : "OFF");
    }
  });

  // Init syst√®mes
  if (typeof randomEventsSystem?.init === "function") randomEventsSystem.init();

  // Mise √† jour UI initiale
  if (typeof updateUIValues === "function"){
    updateUIValues();
  } else {
    // fallback minimal si bloc UI non encore charg√© (d√©fensif)
    const jn = document.getElementById("jnature"); if (jn) jn.textContent = gameState.nature;
    const jm = document.getElementById("jmoney");  if (jm) jm.textContent = gameState.money+"‚Ç¨";
    const jc = document.getElementById("jconfort");if (jc) jc.textContent = gameState.confort;
  }

  // Messages d‚Äôaccueil (si restartGame n‚Äôa pas d√©j√† fait le job)
  setTimeout(()=>showMsg("üå± Cherche l‚Äô√©quilibre : Nature / Confort / Monnaie."), 1200);
})();
</script>
</body>
</html>
<!-- ============================ /FIN BLOC 6/6 ============================ -->
