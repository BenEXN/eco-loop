<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Looop ‚Äî 1.31 -  a reprendre</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f3f3; --card:#fff; --ink:#111; --muted:#666;
    --shadow:0 4px 24px #0001;
    --bar:#eee; --ok:#4CAF50; --ok2:#81C784; --danger:#c00;
    --res:#86e08e; --conf:#86b6ea; --money:#ffb3b3; --budget:#ff9800;
    --ia:#ab47bc; --trader:#26c6da; --auto:#ffa726; --centre:#66bb6a; --tech:#9c27b0;
    --eh:#2e7d32; --ehbg:#e8f5e8; --ehbord:#81c784;
    --toastbg:#fff9c4; --toastbd:#f4d03f; --toastfg:#8a6d00;
  }
  html,body{background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; margin:0}
  h1{ text-align:center; margin:22px 0 10px}

  .container{ display:flex; justify-content:center; align-items:flex-start; gap:24px; margin:0 auto 18px; max-width:980px; padding:0 10px;}
  .category{ background:var(--card); border-radius:18px; box-shadow:var(--shadow); flex:1; padding:26px 16px 16px; min-width:260px; max-width:330px;}
  .cat-title{ font-size:1.25em; font-weight:800; margin-bottom:12px; letter-spacing:.3px; text-align:center;}
  .stock-value{ font-size:1.6em; font-weight:900; text-align:center; }
  .stock-label{ font-size:.95em; color:var(--muted); text-align:center; margin-bottom:10px;}
  .products-box{ background:#f7f7fa; border:2px solid #dde1eb; border-radius:10px; margin:12px 0; padding:10px 22px; font-weight:700; text-align:center; box-shadow:0 1px 4px #ddd5;}
  .message-box{ border-radius:10px; margin:8px 0 12px; padding:10px 12px; font-weight:700; font-size:1.02em; box-shadow:0 1px 4px #0002; text-align:center;}
  .msg-orange{ background:#fff2e6; color:#cc5500; border:2px solid #ff8533;}
  .msg-red{ background:#ffe6e6; color:#c00; border:2px solid #ff6666;}
  .msg-blue{ background:#e6f3ff; color:#0066cc; border:2px solid #4da6ff;}
  .msg-green{ background:#e6ffe6; color:#066; border:2px solid #66cc66;}
  .msg-gold{ background:#fff9c4; color:#8a6d00; border:2px solid #f4d03f;}

  .btn-row{ margin-top:14px; display:flex; flex-direction:column; align-items:center; gap:8px;}
  button{ font-size:1em; padding:10px 16px; border:none; border-radius:12px; background:#ededed; color:var(--ink); cursor:pointer;}
  .btn-evo{ background:#4CAF50; color:#fff; font-weight:700;}
  .btn-yellow{ background:#FFD600; color:#222; font-weight:700;}
  .btn-annuler{ background:#999; color:#fff;}
  .btn-invest{ background:var(--eh); color:#fff; font-weight:700;}

  /* Contr√¥les des automatismes */
  .automatisms-controls{ margin:14px auto; max-width:980px; display:none; justify-content:center; gap:10px; flex-wrap:wrap; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001;}
  .control-btn{ font-size:.9em; padding:8px 12px; border-radius:8px; border:none; min-width:100px; }
  .active{ background:#4CAF50; color:#fff; } .inactive{ background:#f44336; color:#fff; } .disabled{ background:#ccc; color:#777;}

  /* Zone d'√©quilibre */
  .optimum-zone{ display:none; margin:12px auto; max-width:980px; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001; text-align:center;}
  .optimum-progress-bar{ background:var(--bar); height:20px; border-radius:20px; max-width:420px; margin:10px auto; overflow:hidden; position:relative;}
  .optimum-progress-fill{ height:100%; background:linear-gradient(90deg,var(--ok),var(--ok2)); width:0%;}
  .optimum-text{ font-size:.95em; color:#555; margin-top:6px;}
  #optimum-victory{ display:none; background:#fff9c4; border:2px solid #f4d03f; color:#8a6d00; padding:16px; border-radius:12px; text-align:center; font-weight:800; max-width:700px; margin:12px auto; }

  /* √âv√©nements + encart effets temporaires actifs */
  .events-zone{ margin:12px auto; max-width:980px; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001;}
  .event-notification{ background:#f0f8f0; border:2px solid #81c784; border-radius:10px; padding:10px; font-weight:700; color:#2e7d32; display:none;}
  .temp-effects{ margin-top:10px; padding:10px; background:#fafafa; border:1px dashed #bbb; border-radius:10px; font-size:.92em;}
  .temp-effects h4{ margin:0 0 6px 0; font-size:.95em; color:#444; }
  .temp-list{ display:flex; flex-wrap:wrap; gap:6px; }
  .temp-pill{ background:#eef3ff; border:1px solid #cfe0ff; color:#1a4fb3; border-radius:999px; padding:4px 8px; }

  /* Jauges */
  .jrows{ margin:0 auto 10px; max-width:720px;}
  .jrow{ display:flex; align-items:center; gap:8px; margin:0 auto 6px; }
  .jlabel{ min-width:120px; text-align:right; font-size:1em; color:#555; }
  .bar{ background:var(--bar); border-radius:8px; height:14px; flex:1; overflow:hidden;}
  .fill{ height:100%; border-radius:8px; transition:width .2s;}
  #jauge-nature{ background:var(--res);}
  #jauge-confort{ background:var(--conf);}
  #jauge-money{ background:var(--money);}
  #jauge-budget{ background:var(--budget);}
  #jauge-ia{ background:var(--ia);}
  #jauge-trader{ background:var(--trader);}
  #jauge-achat-auto{ background:var(--auto);}
  #jauge-centre{ background:var(--centre);}
  #jauge-tech{ background:var(--tech);}
  .jval{ min-width:80px; text-align:right; }

  /* EH investissement avanc√© */
  .investment-block{ background:var(--ehbg); border:2px solid var(--ehbord); border-radius:10px; padding:12px; margin-top:10px;}
  .investment-title{ font-weight:800; color:var(--eh); text-align:center; margin-bottom:8px;}
  .investment-controls{ display:flex; justify-content:center; gap:8px; flex-wrap:wrap;}
  .investment-input{ width:100px; padding:8px; border:1px solid #ccc; border-radius:8px; font-size:1em;}
  .investment-preview{ font-size:.9em; color:var(--eh); text-align:center; min-height:18px; margin-top:6px;}
  .investment-list{ font-size:.9em; color:#555; margin-top:8px; max-height:120px; overflow:auto;}

  /* Toast court */
  #message{ text-align:center; font-weight:800; min-height:24px; margin:8px 0;}
  .toast{ display:inline-block; background:var(--toastbg); color:var(--toastfg); border:2px solid var(--toastbd); padding:6px 10px; border-radius:10px;}

  /* Triche */
  #triche-sep{ border:none; border-top:3px solid #222; margin:22px auto 10px; width:94vw; max-width:980px;}
  #triche-label{ max-width:980px; margin:0 auto 10px; color:#555;}
  .debug-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px auto 24px;}

  /* Mobile */
  @media (max-width:760px){
    .container{ flex-direction:column; gap:12px;}
    .jrows{ max-width:calc(100vw - 22px);}
    .jlabel{ min-width:90px;}
  }
</style>
</head>
<body>
  <h1>üåç Looop ‚Äî 1.30.5</h1>

  <!-- Contr√¥les des automatismes -->
  <div class="automatisms-controls" id="automatisms-controls">
    <button id="control-ia"     class="control-btn disabled" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button id="control-trader" class="control-btn disabled" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button id="control-confort" class="control-btn disabled" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button id="control-centre" class="control-btn disabled" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>

  <!-- Zone d'√©quilibre (affich√©e quand ressources ‚â§ 1000) -->
  <div class="optimum-zone" id="optimum-zone">
    <div style="font-weight:800;">üéØ Zone d'√©quilibre</div>
    <div class="optimum-progress-bar"><div class="optimum-progress-fill" id="optimum-progress"></div></div>
    <div class="optimum-text" id="optimum-text">Maintenez l'√©quilibre pendant 50 actions.</div>
  </div>

  <!-- Message de victoire -->
  <div id="optimum-victory">
    üèÜ VICTOIRE : √âquilibre maintenu pendant 50 actions !<br/>
    <button class="btn-yellow" onclick="restartGame()">üîÑ Recommencer</button>
  </div>

  <!-- √âv√©nements & effets temporaires -->
  <div class="events-zone">
    <div style="font-weight:800; margin-bottom:6px;">üåø √âv√©nements al√©atoires</div>
    <div id="event-box" class="event-notification">
      <div id="event-text"></div>
      <div id="event-effects" style="font-size:.9em;color:#666;margin-top:4px;"></div>
    </div>
    <div class="temp-effects">
      <h4>Effets temporaires actifs</h4>
      <div id="temp-list" class="temp-list"><span style="color:#777;">Aucun</span></div>
    </div>
  </div>

  <div class="container">
    <!-- Environnement -->
    <div class="category">
      <div class="cat-title">üå± Plan√®te</div>
      <div class="stock-value" id="nature">3000</div>
      <div class="stock-label">Ressources</div>

      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>

      <!-- Bloc investissement √©cologique (EH) -->
      <div id="investment-block" class="investment-block" style="display:none;">
        <div class="investment-title">üå± Investissement √©cologique (retour en 10 actions)</div>
        <div class="investment-controls">
          <input type="number" id="investment-amount" class="investment-input" placeholder="Montant ‚Ç¨" min="1" oninput="updateInvestmentPreview()">
          <button class="btn-invest" onclick="makeEcologicalInvestment()">üíö Investir</button>
          <button class="btn-invest" onclick="investirEcologieFixe()">üåø Raccourci (‚àí200‚Ç¨ ‚Üí +30)</button>
        </div>
        <div id="investment-preview" class="investment-preview"></div>
        <div id="investment-list" class="investment-list">Aucun investissement en cours</div>
      </div>
    </div>

    <!-- Exosomatisation -->
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock-value" id="confort">0</div>
      <div class="stock-label">Confort</div>

      <div class="products-box">Produits cr√©√©s<br/><span id="production">0</span></div>
      <div id="social-crise" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">üõãÔ∏è Achat (100 ‚Ç¨)</button>
      </div>
    </div>

    <!-- √âconomie -->
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock-value" id="money">1000</div>
      <div class="stock-label">Monnaie (‚Ç¨)</div>

      <div class="products-box" id="price-indicator" style="display:none;">Prix de vente<br><span id="current-price">1‚Ç¨</span></div>

      <!-- Bouton n√©gociation cr√©dit (par paliers 300/600/900) -->
      <button id="nego-taux-btn" class="btn-yellow" style="display:none;" onclick="negocierTaux()">ü§ù N√©gocier mon cr√©dit</button>

      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>

        <!-- Am√©liorations/paliers -->
        <button id="ouvrier-btn" style="display:none;" onclick="acheterIA()">ü§ñ Engager une IA</button>
        <button id="trader-btn" style="display:none;" onclick="acheterTrader()">üí∞ Trader automatique</button>
        <button id="comfort-auto-btn" style="display:none;" onclick="acheterConfortAuto()">üîÑ Achat auto confort</button>
        <button id="upgrade-btn" style="display:none;" onclick="upgradeProd()">üè† Am√©liorer la production</button>
        <button id="centre-commercial-btn" style="display:none;" onclick="acheterCentre()">üè¨ Centre commercial</button>
        <button id="automatisms-btn" style="display:none;" onclick="acheterAutomatismsClics()">‚ö° Automatismes = clics</button>
        <button id="price-indicator-btn" style="display:none;" onclick="acheterIndicateur()">üìä Indicateur de prix</button>

        <!-- EH -->
        <button id="evolution-btn" class="btn-evo" style="display:none;" onclick="evolution()">üå± Passer √† l'√©conomie hom√©ostatique</button>
        <button id="rescue-eh-btn" class="btn-evo" style="display:none;" onclick="activateRescueEH()">üå± Secours EH</button>
      </div>
    </div>
  </div>

  <!-- Jauges -->
  <div class="jrows">
    <div class="jrow"><div class="jlabel">üå± Ressources</div><div class="bar"><div id="jauge-nature" class="fill" style="width:0%"></div></div><div class="jval" id="jnature">3000</div></div>
    <div class="jrow" id="jg-confort" style="display:none;"><div class="jlabel">ü§ñ Confort</div><div class="bar"><div id="jauge-confort" class="fill"></div></div><div class="jval" id="jconfort">0</div></div>
    <div class="jrow"><div class="jlabel">üí∂ Monnaie</div><div class="bar"><div id="jauge-money" class="fill"></div></div><div class="jval" id="jmoney">1000‚Ç¨</div></div>
    <div class="jrow" id="jg-budget" style="display:none;"><div class="jlabel">üõèÔ∏è Budget √âtat</div><div class="bar"><div id="jauge-budget" class="fill"></div></div><div class="jval" id="jbudget">0‚Ç¨</div></div>

    <div class="jrow" id="jg-achat-auto" style="display:none;"><div class="jlabel">üîÑ Achat auto</div><div class="bar"><div id="jauge-achat-auto" class="fill"></div></div><div class="jval" id="jachat-auto">√ó0</div></div>
    <div class="jrow" id="jg-ia" style="display:none;"><div class="jlabel">ü§ñ IA</div><div class="bar"><div id="jauge-ia" class="fill"></div></div><div class="jval" id="jia">√ó0</div></div>
    <div class="jrow" id="jg-trader" style="display:none;"><div class="jlabel">üí∞ Trader</div><div class="bar"><div id="jauge-trader" class="fill"></div></div><div class="jval" id="jtrader">√ó0</div></div>
    <div class="jrow" id="jg-centre" style="display:none;"><div class="jlabel">üè¨ Centre</div><div class="bar"><div id="jauge-centre" class="fill"></div></div><div class="jval" id="jcentre">√ó0</div></div>
    <div class="jrow" id="jg-tech" style="display:none;"><div class="jlabel">üè† Tech</div><div class="bar"><div id="jauge-tech" class="fill"></div></div><div class="jval" id="jtech">Niv.0</div></div>
  </div>

  <div id="message"></div>
  <div id="clics-container" style="text-align:center; margin:16px 0; font-weight:800;">Clics/actions : <span id="clicks">0</span></div>

  <hr id="triche-sep">
  <div id="triche-label">Triche (tests)</div>
  <div class="debug-row">
    <button class="btn-yellow" onclick="toggleCheatMode()">üîì D√©verrouiller les outils de test</button>
    <div id="cheat-buttons" style="display:none;">
      <button class="btn-yellow" onclick="addMoney()">+1000 ‚Ç¨</button>
      <button class="btn-yellow" onclick="addNature()">+100 ressources</button>
      <button class="btn-yellow" onclick="addClicks()">+50 clics</button>
      <button class="btn-yellow" onclick="forceActivateEH()">Passer √† l'EH (test)</button>
      <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler</button>
      <button class="btn-yellow" onclick="toggleEvents()">üé≤ √âv√©nements ON/OFF</button>
    </div>
  </div>

<script>
// ===================================================================================
// √âTAT INITIAL ‚Äî conforme au cahier des charges (monnaie 1000, fiscalit√© 20 clics)
// ===================================================================================
const gameState = {
  // Stocks
  nature: 3000,
  confort: 0,
  production: 0,
  money: 1000,            // solde de d√©part demand√©
  budgetEtat: 0,
  monnaieActive: true,

  // Compteurs/√©tats
  clicks: 0,
  jeuBloque: false,
  gameOver: false,
  confortMaxAtteint: 0,

  // Zone d'√©quilibre
  optimumStreak: 0,
  optimumVictory: false,
  optimumRanges: { nature:[1800,2600], confort:[10,35], money:[400,1200] },

  // Fiscalit√© (OFF en EH)
  taxEnabled: true,
  taxEveryClicks: 20,
  _taxEverApplied: false,

  // Cr√©dit (int√©r√™ts seulement si achat ou d√©bit volontaire ‚Üí voir maybeApplyInterest())
  creditRate: 0.05,
  creditRateMin: 0.01,
  creditNegotiationsUsed: 0,
  lastNegotiationShownAt: 0,

  // EH (activ√© plus tard)
  ehActivated: false,
  ehAutoTriggerAt: 50,
  ehDonationEvery: 10,
  ehPrimeEvery: 50,
  ehFonteEvery: 10,
  ehBonusEvery: 10,
  ehTransactionTax: 0.04,

  // Investissements EH
  ecologicalInvestments: [], // {amount, remainingClicks, startClick}

  // Automatismes
  ia: 0, trader: 0, confortAuto: 0, centre: 0,
  automatismsGenerateClicks: false,

  // Tech / Production
  productionMultiplier: 1.0,
  techLevel: 0,
  baseProdCost: 5,              // co√ªt unitaire base en RESSOURCES
  prodCostUpgradesBought: 0,    // 0..3 ‚Üí 5‚Üí4‚Üí3‚Üí2

  // Paliers & achats (suivi des comptes)
  paliersDebloque:{
    comfort:false, ia:false, trader:false, upgradeProd:false,
    confortAuto:false, automatismsClics:false, priceIndicator:false, centreCommercial:false
  },
  nbAchatIA:0, nbAchatTrader:0, nbAchatConfortAuto:0, nbAchatUpgradeProd:0, nbAchatCentre:0,
  priceIndicatorActive:false
};

// ------------------------- Intervalles & triche/undo -------------------------
const intervals = { ia:null, trader:null, confortAuto:null, centre:null };
let automatismsActive = { ia:true, trader:true, confort:true, centre:true };
let lastState = null;
let cheatModeUnlocked = false;

// ===================================================================================
// SYST√àME D'√âV√âNEMENTS AL√âATOIRES (Version simplifi√©e)
// ===================================================================================
const randomEventsSystem = {
  enabled: true,
  nextIn: 0,
  minGap: 20,
  maxGap: 60,
  temporaryEffects: [],
  
  init: function() {
    this.nextIn = Math.floor(Math.random() * (this.maxGap - this.minGap)) + this.minGap;
  },
  
  processClick: function() {
    if (!this.enabled) return;
    
    this.nextIn--;
    this.updateTemporaryEffects();
    
    if (this.nextIn <= 0) {
      this.triggerRandomEvent();
      this.nextIn = Math.floor(Math.random() * (this.maxGap - this.minGap)) + this.minGap;
    }
  },
  
  processAutoTick: function() {
    this.updateTemporaryEffects();
  },
  
  triggerRandomEvent: function() {
    const events = [
      {
        name: "üåßÔ∏è Pluies bienvenues",
        text: "Des pluies fines nourrissent les sols.",
        effect: () => {
          gameState.nature += 30;
          this.addTemp("regen", 0.01, 8, "R√©g√©n√©ration √©cologique");
        }
      },
      {
        name: "üí• Mobilisation citoyenne",
        text: "Le climat social s'am√©liore.",
        effect: () => {
          gameState.confort += 3;
          this.addTemp("prodMult", 0.1, 10, "Productivit√© sociale");
        }
      },
      {
        name: "üìà Mini-bulle sp√©culative",
        text: "Les march√©s tanguent en votre faveur.",
        effect: () => {
          gameState.money += 300;
          this.addTemp("priceAdd", 0.2, 10, "Prix dop√©s");
        }
      }
    ];
    
    const event = events[Math.floor(Math.random() * events.length)];
    event.effect();
    this.showEvent(event.name, event.text);
  },
  
  showEvent: function(name, text) {
    const eventBox = document.getElementById("event-box");
    const eventText = document.getElementById("event-text");
    
    if (eventBox && eventText) {
      eventText.textContent = name + " - " + text;
      eventBox.style.display = "block";
      
      setTimeout(() => {
        eventBox.style.display = "none";
      }, 5000);
    }
  },
  
  addTemp: function(type, value, duration, label) {
    this.temporaryEffects.push({
      type: type,
      value: value,
      remaining: duration,
      label: label
    });
    this.updateTempEffectsUI();
  },
  
  updateTemporaryEffects: function() {
    this.temporaryEffects = this.temporaryEffects.filter(effect => {
      effect.remaining--;
      return effect.remaining > 0;
    });
    this.updateTempEffectsUI();
  },
  
  updateTempEffectsUI: function() {
    const tempList = document.getElementById("temp-list");
    if (!tempList) return;
    
    if (this.temporaryEffects.length === 0) {
      tempList.innerHTML = '<span style="color:#777;">Aucun</span>';
      return;
    }
    
    tempList.innerHTML = "";
    this.temporaryEffects.forEach(effect => {
      const pill = document.createElement("div");
      pill.className = "temp-pill";
      pill.textContent = `${effect.label} (${effect.remaining})`;
      tempList.appendChild(pill);
    });
  },
  
  mod: function(type) {
    return this.temporaryEffects
      .filter(effect => effect.type === type)
      .reduce((sum, effect) => sum + effect.value, 0);
  },
  
  reset: function() {
    this.temporaryEffects = [];
    this.nextIn = Math.floor(Math.random() * (this.maxGap - this.minGap)) + this.minGap;
    this.updateTempEffectsUI();
  },
  
  getFullState: function() {
    return {
      enabled: this.enabled,
      nextIn: this.nextIn,
      temporaryEffects: [...this.temporaryEffects]
    };
  },
  
  restoreFullState: function(state) {
    this.enabled = state.enabled;
    this.nextIn = state.nextIn;
    this.temporaryEffects = [...state.temporaryEffects];
    this.updateTempEffectsUI();
  }
};

// ===================================================================================
// OUTILS G√âN√âRIQUES
// ===================================================================================
function clamp(n, min=0){ return (n<min?min:n); }
function showMsg(txt){
  const m = document.getElementById("message");
  if(!m) return;
  m.innerHTML = '<span class="toast">'+txt+'</span>';
  setTimeout(()=>{ if(m.innerHTML.includes(txt)) m.innerHTML = ""; }, 4000);
}
function saveState(){
  lastState = {
    gameState: JSON.parse(JSON.stringify(gameState)),
    random: randomEventsSystem.getFullState()
  };
}
function undoAction(){
  if(!cheatModeUnlocked || !lastState) return;
  clearAllIntervals();
  const snap = lastState;
  Object.keys(gameState).forEach(k=>delete gameState[k]);
  Object.assign(gameState, snap.gameState);
  randomEventsSystem.restoreFullState(snap.random);
  restartIntervalsAfterUndo();
  updateUIValues();
  showMsg("‚è™ Action annul√©e");
}
function clearAllIntervals(){
  Object.keys(intervals).forEach(k=>{ if(intervals[k]){ clearInterval(intervals[k]); intervals[k]=null; } });
}
function restartIntervalsAfterUndo(){
  if (gameState.ia>0 && automatismsActive.ia && !gameState.ehActivated) startIAInterval();
  if (gameState.trader>0 && automatismsActive.trader && !gameState.ehActivated) startTraderInterval();
  if (gameState.confortAuto>0 && automatismsActive.confort && !gameState.ehActivated) startConfortAutoInterval();
  if (gameState.centre>0 && automatismsActive.centre && !gameState.ehActivated) startCentreInterval();
}

// ===================================================================================
// PRIX / CO√õT / INT√âR√äTS / FISCALIT√â
// ===================================================================================

// Prix de vente dynamique ‚Äî visible si l'indicateur est achet√©
function priceNow(){
  if (gameState.nature <= 0) return 1;
  let p = Math.max(1, Math.abs(gameState.money) / gameState.nature);
  // Effets temporaires "priceAdd" inject√©s par les √©v√©nements
  p += (randomEventsSystem ? (randomEventsSystem.mod("priceAdd")||0) : 0);
  return Math.round(p*100)/100;
}

// Co√ªt unitaire actuel de production EN RESSOURCES (pas d'euro ici)
function currentProdUnitCost(){
  const base = Math.max(2, gameState.baseProdCost - gameState.prodCostUpgradesBought);
  const delta = randomEventsSystem ? (randomEventsSystem.mod("prodCostDelta")||0) : 0;
  return Math.max(1, base + delta);
}

// Multiplicateur de production (tech √ó effets temporaires)
function currentProdMultiplier(){
  const extra = randomEventsSystem ? (randomEventsSystem.mod("prodMult")||0) : 0;
  return Math.max(0, gameState.productionMultiplier * (1 + extra));
}

// R√©g√©n√©ration passive (si un effet "regen" est actif)
function maybeApplyRegen(){
  const r = randomEventsSystem ? (randomEventsSystem.mod("regen")||0) : 0;
  if (r>0){ gameState.nature += Math.max(0, Math.round(gameState.nature * r)); }
}

// Int√©r√™ts de d√©couvert ‚Äî √† n'appeler qu'apr√®s un D√âBIT mon√©taire (achats, upgrades‚Ä¶)
// JAMAIS depuis "Produire" (qui ne doit pas toucher √† la monnaie).
function maybeApplyInterest(){
  if (gameState.money < 0){
    const due = Math.ceil(Math.abs(gameState.money) * gameState.creditRate);
    if (due>0){
      gameState.money -= due;
      showMsg("üí£ Int√©r√™ts de d√©couvert : -"+due+"‚Ç¨ (taux "+Math.round(gameState.creditRate*100)+"%)");
    }
  }
}

// Fiscalit√© ‚Äî tous les 20 clics, OFF en EH
function maybeApplyTax(){
  if (!gameState.taxEnabled || gameState.ehActivated) return;
  if (gameState.clicks>0 && gameState.clicks % gameState.taxEveryClicks === 0){
    const tax = Math.ceil(Math.abs(gameState.money) * 0.20);
    if (tax>0){
      gameState.money -= tax;
      gameState.nature += 1;
      gameState.confort += 1;
      gameState.budgetEtat += tax;
      gameState._taxEverApplied = true;
      // r√©v√©ler la jauge budget √† la 1re fois
      const row = document.getElementById("jg-budget");
      if (row) row.style.display="flex";
      showMsg("üí∏ Fiscalit√© : -"+tax+"‚Ç¨ | +1 üå± | +1 ü§ñ");
    }
  }
}

// Helpers d'affichage
function _fmtMoney(v){ return (v>=0? v.toFixed(0)+"‚Ç¨" : "-"+Math.abs(v).toFixed(0)+"‚Ç¨"); }
function _pct(part, total){ if(total<=0) return 0; return Math.max(0, Math.min(100, Math.round(part*100/total))); }

function toggleDisplay(id, on, isFlex){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = on ? (isFlex?"flex":"block") : "none";
}

// --------------------------- Mise √† jour de l'interface (UNIQUE) ---------------------------
function updateUIValues(){
  // Stocks (valeurs haut de cartes)
  const nEl = document.getElementById("nature");
  const cEl = document.getElementById("confort");
  const pEl = document.getElementById("production");
  const mEl = document.getElementById("money");
  const bEl = document.getElementById("jbudget");
  if(nEl) nEl.textContent = Math.max(0, Math.floor(gameState.nature));
  if(cEl) cEl.textContent = Math.max(0, Math.floor(gameState.confort));
  if(pEl) pEl.textContent = Math.max(0, Math.floor(gameState.production));
  if(mEl) mEl.textContent = Math.floor(gameState.money);

  // Jauges principales
  const jn = document.getElementById("jnature");
  const jc = document.getElementById("jconfort");
  const jm = document.getElementById("jmoney");
  if(jn) jn.textContent = Math.max(0, Math.floor(gameState.nature));
  if(jc) jc.textContent = Math.max(0, Math.floor(gameState.confort));
  if(jm) jm.textContent = _fmtMoney(gameState.money);

  const fN = document.getElementById("jauge-nature");
  const fC = document.getElementById("jauge-confort");
  const fM = document.getElementById("jauge-money");
  if(fN) fN.style.width = _pct(gameState.nature, 3000)+"%";
  if(fC) fC.style.width = _pct(gameState.confort, 50)+"%";
  if(fM) fM.style.width = _pct(Math.abs(gameState.money), 1200)+"%";

  // Jauges secondaires (valeurs + barres)
  const setJ = (idTxt, idBar, value, unit, per)=>
    { const t=document.getElementById(idTxt); if(t) t.textContent=(unit?unit:"")+value;
      const b=document.getElementById(idBar); if(b) b.style.width=Math.min(100, per)+"%"; };

  setJ("jachat-auto","jauge-achat-auto","√ó"+gameState.confortAuto,"", gameState.confortAuto*20);
  setJ("jia","jauge-ia","√ó"+gameState.ia,"", gameState.ia*20);
  setJ("jtrader","jauge-trader","√ó"+gameState.trader,"", gameState.trader*10);
  setJ("jcentre","jauge-centre","√ó"+gameState.centre,"", gameState.centre*20);
  setJ("jtech","jauge-tech","Niv."+gameState.techLevel,"", gameState.techLevel*33.4);
  if (bEl) bEl.textContent = _fmtMoney(gameState.budgetEtat);

  // Indicateur de prix si achet√©
  if (gameState.priceIndicatorActive){
    const box = document.getElementById("price-indicator");
    if (box) box.style.display="block";
    const priceEl = document.getElementById("current-price");
    if (priceEl) priceEl.textContent = priceNow().toFixed(2)+"‚Ç¨";
  }

  // Alertes crise (√©cologie, social)
  const alEco = document.getElementById("alert-crise");
  if(alEco){
    if (gameState.nature < 300) { alEco.style.display="block"; alEco.textContent="‚ö†Ô∏è Crise √©cologique imminente"; }
    else { alEco.style.display="none"; }
  }
  // ‚Äî‚Äî‚Äî AVANT d'afficher la crise sociale, on m√©morise le max de confort atteint
gameState.confortMaxAtteint = Math.max(gameState.confortMaxAtteint, gameState.confort);

const alSoc = document.getElementById("social-crise");
if (alSoc){
  // Ne s'affiche que si on est retomb√© ‚â§5 APR√àS avoir d√©j√† atteint ‚â•6
  const criseSociale = (gameState.confort <= 5) && (gameState.confortMaxAtteint >= 6);
  if (criseSociale) { 
    alSoc.style.display="block"; 
    alSoc.textContent="‚ö†Ô∏è Crise sociale"; 
  } else { 
    alSoc.style.display="none"; 
  }
}

  // Compteur de clics
  const clk = document.getElementById("clicks");
  if(clk) clk.textContent = gameState.clicks;

  // Boutons de base - TOUJOURS VISIBLES (sauf si jeu bloqu√©)
  toggleDisplay("produce-btn", !gameState.jeuBloque && !gameState.gameOver);
  toggleDisplay("sell-btn", !gameState.jeuBloque && !gameState.gameOver);

  // Visibilit√© des paliers (conform√©ment au cahier des charges)
  // Confort : visible d√®s 120 clics
  toggleDisplay("comfort-btn", gameState.clicks>=120);

  // IA : r√©apparition tous les 200 clics (200, 400, ‚Ä¶) en fonction des achats d√©j√† faits
  const nextIAThreshold = 200 * (gameState.nbAchatIA + 1);
  toggleDisplay("ouvrier-btn", gameState.clicks>=nextIAThreshold && gameState.ehActivated===false);

  // Trader : ‚â• 500 clics
  toggleDisplay("trader-btn", gameState.clicks>=500 && gameState.ehActivated===false);

  // Auto-confort : ‚â• 700 clics
  toggleDisplay("comfort-auto-btn", gameState.clicks>=700 && gameState.ehActivated===false);

  // Automatismes = clics : ‚â• 750 clics
  toggleDisplay("automatisms-btn", gameState.clicks>=750);

  // Indicateur de prix : ‚â• 1000 clics
  toggleDisplay("price-indicator-btn", gameState.clicks>=1000 && !gameState.priceIndicatorActive);

  // Centre : ‚â• 1100 clics
  toggleDisplay("centre-commercial-btn", gameState.clicks>=1100 && gameState.ehActivated===false);

  // Upgrade production : paliers fixes 400 / 700 / 1100, cap 3
  const upgradeThresholds = [400,700,1100];
  const canUpgrade = (gameState.techLevel < 3) && (gameState.clicks >= upgradeThresholds[gameState.techLevel]);
  toggleDisplay("upgrade-btn", canUpgrade && gameState.ehActivated===false);

  // Boutons EH
  toggleDisplay("evolution-btn", (gameState.nature < 500) && !gameState.ehActivated);
  toggleDisplay("rescue-eh-btn", (gameState.nature <= 0 || gameState.confort <= 0) && !gameState.ehActivated);

  // N√©gociation cr√©dit (paliers 300/600/900, quota 3)
  const showNego = (gameState.creditNegotiationsUsed < 3) && 
                   ((gameState.clicks>=300 && gameState.clicks<600) || 
                    (gameState.clicks>=600 && gameState.clicks<900) || 
                    (gameState.clicks>=900));
  toggleDisplay("nego-taux-btn", showNego);

  // Affichage des lignes de jauges secondaires si >0 (ou si confort d√©bloqu√©)
  toggleDisplay("jg-confort", (gameState.clicks>=120) || gameState.confort>0, true);
  toggleDisplay("jg-ia", gameState.ia>0, true);
  toggleDisplay("jg-trader", gameState.trader>0, true);
  toggleDisplay("jg-achat-auto", gameState.confortAuto>0, true);
  toggleDisplay("jg-centre", gameState.centre>0, true);
  toggleDisplay("jg-tech", gameState.techLevel>0, true);

  // Budget √âtat (ligne visible s'il y a eu 1er imp√¥t)
  const rowBudget = document.getElementById("jg-budget");
  if(rowBudget && gameState._taxEverApplied) rowBudget.style.display = "flex";

  // Zone d'√©quilibre : on l'affiche lorsqu'on se rapproche (ex. nature ‚â§ 1000)
  const zone = document.getElementById("optimum-zone");
  if(zone) zone.style.display = (gameState.nature<=1000 || gameState.optimumStreak>0) ? "block" : "none";

  // EH : panneau automatismes masqu√© en EH
  const panel = document.getElementById("automatisms-controls");
  if (panel) panel.style.display = (!gameState.ehActivated && (gameState.ia>0 || gameState.trader>0 || gameState.confortAuto>0 || gameState.centre>0)) ? "flex" : "none";

  // Bloc investissement EH
  const inv = document.getElementById("investment-block");
  if (inv) inv.style.display = gameState.ehActivated ? "block" : "none";

  // Messages EH
  const ehMsg = document.getElementById("eh-msg");
  if (ehMsg && gameState.ehActivated) {
    ehMsg.style.display = "block";
    ehMsg.textContent = "üå± √âconomie Hom√©ostatique active : imp√¥ts OFF, friction 4% sur transactions";
  }

  // Mise √† jour du texte/victoire
  updateOptimumUI();
}

// ---------------------- Zone d'√©quilibre : r√®gle 50/50 ----------------------
function inOptimum(){
  const r = gameState.optimumRanges;
  return (
    gameState.nature >= r.nature[0] && gameState.nature <= r.nature[1] &&
    gameState.confort>= r.confort[0] && gameState.confort<= r.confort[1] &&
    gameState.money  >= r.money[0]   && gameState.money  <= r.money[1]
  );
}
function updateOptimumStreak(){
  if (inOptimum()) gameState.optimumStreak++;
  else gameState.optimumStreak = 0;
  if (gameState.optimumStreak>=50 && !gameState.optimumVictory){
    gameState.optimumVictory = true;
    gameState.jeuBloque = true;
    const v = document.getElementById("optimum-victory"); if (v) v.style.display = "block";
    showMsg("üèÜ √âquilibre tenu 50 actions : victoire !");
  }
}
function updateOptimumUI(){
  const bar = document.getElementById("optimum-progress");
  const txt = document.getElementById("optimum-text");
  if(!bar || !txt) return;
  const v = Math.min(50, gameState.optimumStreak);
  bar.style.width = (v*2)+"%";
  txt.textContent = gameState.optimumVictory
    ? "Victoire atteinte."
    : "Progression : "+v+"/50 actions dans la zone d'√©quilibre.";
}

// ---------------------- M√©caniques EH (helpers non intrusifs) ----------------------
function ehFriction(amount){
  if (!gameState.ehActivated) return 0;
  return Math.round(Math.abs(amount) * gameState.ehTransactionTax);
}

// ============================ Actions principales ============================
// PRODUIRE ‚Äî ne touche JAMAIS √† la monnaie
function produce(){
  if (gameState.jeuBloque || gameState.gameOver) return;

  const cost = currentProdUnitCost();
  if (gameState.nature < cost){ showMsg("Ressources insuffisantes (co√ªt "+cost+")"); return; }

  saveState();
  gameState.nature -= cost;

  const prod = Math.max(1, Math.floor(currentProdMultiplier()));
  gameState.production += prod;

  gameState.clicks++;
  maybeApplyRegen();
  randomEventsSystem.processClick();

  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  showMsg("Production +"+prod+" (co√ªt "+cost+" ressources)");
  updateUIValues();
}

// VENDRE ‚Äî g√©n√®re de la monnaie, applique friction EH
function sell(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  const qty = Math.max(0, Math.floor(gameState.production));
  if (qty<=0){ showMsg("Aucun produit √† vendre."); return; }

  saveState();
  const price = priceNow();
  const revenue = qty * price;
  const fee = ehFriction(revenue);
  const net = revenue - fee;

  gameState.production -= qty;
  gameState.money += net;
  if (!gameState.monnaieActive) gameState.monnaieActive = true;

  gameState.clicks++;
  randomEventsSystem.processClick();

  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  showMsg("Vendu : +"+net.toFixed(2)+"‚Ç¨"+(fee?(" (frais EH "+fee+"‚Ç¨)"):""));
  updateUIValues();
}

// ---------------------------- Automatismes & toggles (UNIQUE) ----------------------------
function toggleAutomatism(kind){
  if (kind==="ia")     automatismsActive.ia = !automatismsActive.ia;
  if (kind==="trader") automatismsActive.trader = !automatismsActive.trader;
  if (kind==="confort") automatismsActive.confort = !automatismsActive.confort;
  if (kind==="centre") automatismsActive.centre = !automatismsActive.centre;

  // UI du panneau
  const map = [
    ["control-ia", automatismsActive.ia, "ü§ñ IA: "],
    ["control-trader", automatismsActive.trader, "üí∞ Trader: "],
    ["control-confort", automatismsActive.confort, "üõãÔ∏è Confort: "],
    ["control-centre", automatismsActive.centre, "üè¨ Centre: "]
  ];
  map.forEach(([id,on,label])=>{
    const b = document.getElementById(id);
    if(!b) return;
    b.className = "control-btn "+(on?"active":"inactive");
    b.textContent = label + (on?"ON":"OFF");
  });

  // (Re)d√©marrage/arr√™t des intervals si n√©cessaire (hors EH)
  if (!gameState.ehActivated){
    if (kind==="ia"){ if (automatismsActive.ia && gameState.ia>0) startIAInterval(); else stopInterval("ia"); }
    if (kind==="trader"){ if (automatismsActive.trader && gameState.trader>0) startTraderInterval(); else stopInterval("trader"); }
    if (kind==="confort"){ if (automatismsActive.confort && gameState.confortAuto>0) startConfortAutoInterval(); else stopInterval("confortAuto"); }
    if (kind==="centre"){ if (automatismsActive.centre && gameState.centre>0) startCentreInterval(); else stopInterval("centre"); }
  }
}

function stopInterval(key){
  if (intervals[key]){ clearInterval(intervals[key]); intervals[key]=null; }
}

// ============================ Intervalles (ticks auto) ============================
// IA ‚Äî toutes les 5s : consomme 5 ressources/IA et produit selon multiplicateur
function startIAInterval(){
  stopInterval("ia");
  if (!automatismsActive.ia || gameState.ia<=0 || gameState.ehActivated) return;
  intervals.ia = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const totalCost = 5 * gameState.ia;
    if (gameState.nature < totalCost) return;
    gameState.nature -= totalCost;
    const add = Math.max(1, Math.floor(currentProdMultiplier()*gameState.ia));
    gameState.production += add;

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 5000);
}

// Trader ‚Äî toutes les 3s : vend min(production, trader)
function startTraderInterval(){
  stopInterval("trader");
  if (!automatismsActive.trader || gameState.trader<=0 || gameState.ehActivated) return;
  intervals.trader = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const qty = Math.min(gameState.production, gameState.trader);
    if (qty<=0) return;
    const revenue = qty * priceNow();
    const fee = ehFriction(revenue);
    const net = revenue - fee;
    gameState.production -= qty;
    gameState.money += net;

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 3000);
}

// Achat Confort automatique ‚Äî toutes les 15s : ach√®te 1 confort √ó niveau (100‚Ç¨ l'unit√©)
function startConfortAutoInterval(){
  stopInterval("confortAuto");
  if (!automatismsActive.confort || gameState.confortAuto<=0 || gameState.ehActivated) return;
  intervals.confortAuto = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const units = Math.max(1, gameState.confortAuto);
    const base = 100 * units;
    const fee  = ehFriction(base);
    const total = base + fee;
    gameState.money -= total;
    gameState.confort += units;
    maybeApplyInterest();

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 15000);
}

// Centre ‚Äî toutes les 15s : +10 confort √ó centre, co√ªte 100‚Ç¨ √ó (10√ócentre)
function startCentreInterval(){
  stopInterval("centre");
  if (!automatismsActive.centre || gameState.centre<=0 || gameState.ehActivated) return;
  intervals.centre = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const gain = 10 * gameState.centre;
    const base = 100 * gain;
    const fee  = ehFriction(base);
    const total = base + fee;
    gameState.money -= total;
    gameState.confort += gain;
    maybeApplyInterest();

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 15000);
}

// ============================ Achats (impl√©ment√©s) ============================
// Rappel: tous les achats d√©clenchent un D√âBIT ‚Üí int√©r√™ts potentiels si solde < 0
function acheterConfort(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  saveState();

  const base = 100;
  const fee  = ehFriction(base);
  const total = base + fee;

  if (gameState.money < total){
    showMsg("üí≥ Achat √† cr√©dit ("+Math.round(total)+"‚Ç¨)");
  }

  gameState.money -= total;
  gameState.confort += 1;
  maybeApplyInterest();

  gameState.clicks++;
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  showMsg("üõãÔ∏è +1 confort ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  updateUIValues();
}

// === IA === (EXACTEMENT selon la consigne)
function acheterIA(){
  if (gameState.jeuBloque || gameState.gameOver) return;

  const cost = 500 * Math.pow(1.5, gameState.nbAchatIA);
  saveState();

  if (gameState.money < cost){
    showMsg("üí≥ IA achet√©e √† cr√©dit ("+Math.round(cost)+"‚Ç¨)");
  }

  gameState.money -= cost;
  gameState.ia += 1;
  gameState.nbAchatIA += 1;
  maybeApplyInterest();

  gameState.clicks++;
  if (automatismsActive.ia && !gameState.ehActivated) startIAInterval();

  showMsg("ü§ñ IA achet√©e (" + Math.round(cost) + "‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}
// === Trader auto ===
function acheterTrader(){
  if (gameState.jeuBloque || gameState.gameOver) return;

  const cost = 800 * Math.pow(1.5, gameState.nbAchatTrader);
  saveState();

  if (gameState.money < cost){
    showMsg("üí≥ Trader achet√© √† cr√©dit ("+Math.round(cost)+"‚Ç¨)");
  }

  gameState.money -= cost;
  gameState.trader += 1;
  gameState.nbAchatTrader += 1;
  maybeApplyInterest();

  gameState.clicks++;
  if (automatismsActive.trader && !gameState.ehActivated) startTraderInterval();

  showMsg("üí∞ Trader automatique achet√© ("+Math.round(cost)+"‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}
// === Confort automatique ===
function acheterConfortAuto(){
  if (gameState.jeuBloque || gameState.gameOver) return;

  const cost = 1200 * Math.pow(1.5, gameState.nbAchatConfortAuto);
  saveState();

  if (gameState.money < cost){
    showMsg("üí≥ Achat auto-confort √† cr√©dit ("+Math.round(cost)+"‚Ç¨)");
  }

  gameState.money -= cost;
  gameState.confortAuto += 1;
  gameState.nbAchatConfortAuto += 1;
  maybeApplyInterest();

  gameState.clicks++;
  if (automatismsActive.confort && !gameState.ehActivated) startConfortAutoInterval();

  showMsg("üîÑ Achat auto confort +1 ("+Math.round(cost)+"‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}
// === Upgrade production (r√©duction co√ªt unitaire : 5‚Üí4‚Üí3‚Üí2 ; cap 3) ===
function upgradeProd(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if (gameState.prodCostUpgradesBought >= 3){ showMsg("Am√©liorations de production au maximum"); return; }

  const level = gameState.prodCostUpgradesBought; // 0..2
  const cost = [1000, 2000, 3500][level];

  saveState();

  if (gameState.money < cost){
    showMsg("üí≥ Am√©lioration √† cr√©dit ("+cost+"‚Ç¨)");
  }

  gameState.money -= cost;
  gameState.prodCostUpgradesBought += 1;     // impacte currentProdUnitCost()
  gameState.techLevel = Math.min(3, gameState.techLevel + 1);
  gameState.productionMultiplier += 0.2;
  maybeApplyInterest();

  gameState.clicks++;
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  showMsg("üè† Production am√©lior√©e ("+cost+"‚Ç¨) - Co√ªt -1, productivit√© +20%");
  updateUIValues();
}

// === Centre commercial ===
function acheterCentre(){
  if (gameState.jeuBloque || gameState.gameOver) return;

  const cost = 2000 * Math.pow(1.5, gameState.nbAchatCentre);
  saveState();

  if (gameState.money < cost){
    showMsg("üí≥ Centre commercial √† cr√©dit ("+Math.round(cost)+"‚Ç¨)");
  }

  gameState.money -= cost;
  gameState.centre += 1;
  gameState.nbAchatCentre += 1;
  maybeApplyInterest();

  gameState.clicks++;
  if (automatismsActive.centre && !gameState.ehActivated) startCentreInterval();

  showMsg("üè¨ Centre commercial achet√© ("+Math.round(cost)+"‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}
// === Automatismes = clics ===
function acheterAutomatismsClics(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if (gameState.automatismsGenerateClicks) { showMsg("D√©j√† achet√©"); return; }

  const cost = 5000;
  saveState();

  if (gameState.money < cost){
    showMsg("üí≥ Option 'Automatismes = clics' √† cr√©dit ("+cost+"‚Ç¨)");
  }

  gameState.money -= cost;
  gameState.automatismsGenerateClicks = true;
  maybeApplyInterest();

  gameState.clicks++;
  showMsg("‚ö° Automatismes g√©n√®rent maintenant des clics ("+cost+"‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}

// === Indicateur de prix ===
function acheterIndicateur(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if (gameState.priceIndicatorActive) { showMsg("D√©j√† achet√©"); return; }

  const cost = 1500;
  saveState();

  if (gameState.money < cost){
    showMsg("üí≥ Indicateur de prix √† cr√©dit ("+cost+"‚Ç¨)");
  }

  gameState.money -= cost;
  gameState.priceIndicatorActive = true;
  maybeApplyInterest();

  gameState.clicks++;
  showMsg("üìä Indicateur de prix activ√© ("+cost+"‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}

// === N√©gociation cr√©dit ===
function negocierTaux(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if (gameState.creditNegotiationsUsed >= 3) { showMsg("Quota de n√©gociations √©puis√©"); return; }

  saveState();
  const oldRate = gameState.creditRate;
  gameState.creditRate = Math.max(gameState.creditRateMin, gameState.creditRate - 0.01);
  gameState.creditNegotiationsUsed += 1;
  gameState.clicks++;

  showMsg("ü§ù Taux n√©goci√© : "+Math.round(oldRate*100)+"% ‚Üí "+Math.round(gameState.creditRate*100)+"%");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}

// === Transition vers EH ===
function evolution(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if (gameState.ehActivated) { showMsg("EH d√©j√† activ√©e"); return; }

  saveState();
  gameState.ehActivated = true;
  gameState.taxEnabled = false; // Arr√™t de la fiscalit√©
  
  // Arr√™t de tous les automatismes
  clearAllIntervals();
  
  gameState.clicks++;

  const ehSuccess = document.getElementById("eh-success");
  if (ehSuccess) {
    ehSuccess.style.display = "block";
    ehSuccess.textContent = "üå± Transition r√©ussie vers l'√âconomie Hom√©ostatique !";
  }

  showMsg("üå± √âconomie Hom√©ostatique activ√©e ! Fiscalit√© OFF, automatismes arr√™t√©s.");
  randomEventsSystem.processClick();
  updateOptimumStreak();
  updateUIValues();
}

// === Secours EH ===
function activateRescueEH(){
  if (gameState.ehActivated) { showMsg("EH d√©j√† activ√©e"); return; }
  
  saveState();
  // Reset partiel pour sauver la partie
  gameState.nature = Math.max(100, gameState.nature);
  gameState.confort = Math.max(5, gameState.confort);
  gameState.money = Math.max(-500, gameState.money);
  
  // Activation EH
  gameState.ehActivated = true;
  gameState.taxEnabled = false;
  gameState.gameOver = false;
  
  clearAllIntervals();
  gameState.clicks++;

  showMsg("üå± Secours EH activ√© ! Situation stabilis√©e.");
  randomEventsSystem.processClick();
  updateOptimumStreak();
  updateUIValues();
}

// === Investissement √©cologique fixe ===
function investirEcologieFixe(){
  if (!gameState.ehActivated) { showMsg("Investissements disponibles uniquement en EH."); return; }

  const cost = 200;
  saveState();

  const fee = ehFriction(cost);
  const total = cost + fee;

  if (gameState.money < total){
    showMsg("üí≥ Investissement rapide √† cr√©dit ("+total+"‚Ç¨)");
  }

  gameState.money -= total;
  gameState.nature += 30;
  maybeApplyInterest();

  gameState.clicks++;
  showMsg("üåø Investissement rapide : -"+total+"‚Ç¨ ‚Üí +30 ressources"+(fee?(" (frais EH "+fee+"‚Ç¨)"):""));
  randomEventsSystem.processClick();
  updateOptimumStreak();
  updateUIValues();
}

// === Fonction g√©n√©rique d'investissement EH ===
function makeEcologicalInvestment(){
  if (!gameState.ehActivated) { showMsg("Investissements disponibles uniquement en EH."); return; }

  const input = document.getElementById("investment-amount");
  const val = Number(input?.value || 0);

  if (!val || !isFinite(val) || val <= 0) {
    showMsg("Montant invalide.");
    return;
  }

  saveState();

  const fee = ehFriction(Math.abs(val));
  const total = Math.abs(val) + fee;

  if (gameState.money < total){
    showMsg("üí≥ Investissement √† cr√©dit ("+Math.round(total)+"‚Ç¨)");
  }

  gameState.money -= total;
  maybeApplyInterest();

  // Effet imm√©diat simplifi√© (conforme √† ta version)
  const gain = Math.max(5, Math.floor(Math.abs(val) / 10));
  gameState.nature += gain;

  gameState.clicks++;
  showMsg("üíö Investissement r√©alis√© : +"+gain+" ressources"+(fee?(" (frais EH "+fee+"‚Ç¨)"):""));

  if (input) input.value = "";
  randomEventsSystem.processClick();
  updateOptimumStreak();
  updateUIValues();
}

// === Fonction de pr√©visualisation ===
function updateInvestmentPreview(){
  const preview = document.getElementById("investment-preview");
  const input = document.getElementById("investment-amount");
  if (!preview || !input) return;
  
  const val = Number(input.value || 0);
  if (!val) {
    preview.textContent = "";
    return;
  }
  
  const gain = Math.max(5, Math.floor(Math.abs(val) / 10));
  const fee = ehFriction(Math.abs(val));
  preview.textContent = `Pr√©view : +${gain} ressources, frais EH ${fee}‚Ç¨`;
}

// === Restart Game ===
function restartGame(){
  saveState();
  
  // Arr√™t de tous les intervalles
  clearAllIntervals();
  
  // Reset complet de l'√©tat
  Object.assign(gameState, {
    nature: 3000, confort: 0, production: 0, money: 1000, budgetEtat: 0,
    monnaieActive: true, clicks: 0, jeuBloque: false, gameOver: false,
    confortMaxAtteint: 0, optimumStreak: 0, optimumVictory: false,
    optimumRanges: { nature:[1800,2600], confort:[10,35], money:[400,1200] },
    taxEnabled: true, taxEveryClicks: 20, _taxEverApplied: false,
    creditRate: 0.05, creditRateMin: 0.01, creditNegotiationsUsed: 0,
    lastNegotiationShownAt: 0, ehActivated: false, ehAutoTriggerAt: 50,
    ehDonationEvery: 10, ehPrimeEvery: 50, ehFonteEvery: 10, ehBonusEvery: 10,
    ehTransactionTax: 0.04, ecologicalInvestments: [],
    ia: 0, trader: 0, confortAuto: 0, centre: 0, automatismsGenerateClicks: false,
    productionMultiplier: 1.0, techLevel: 0, baseProdCost: 5, prodCostUpgradesBought: 0,
    paliersDebloque: {
      comfort:false, ia:false, trader:false, upgradeProd:false,
      confortAuto:false, automatismsClics:false, priceIndicator:false, centreCommercial:false
    },
    nbAchatIA: 0, nbAchatTrader: 0, nbAchatConfortAuto: 0, nbAchatUpgradeProd: 0, nbAchatCentre: 0,
    priceIndicatorActive: false
  });
  
  // Reset du syst√®me d'√©v√©nements
  randomEventsSystem.reset();
  
  // Reset des automatismes
  automatismsActive = { ia:true, trader:true, confort:true, centre:true };
  
  // Reset de l'interface
  const elementsToHide = [
    "optimum-victory", "eh-msg", "eh-success", 
    "game-over-resources", "game-over-confort",
    "alert-crise", "social-crise", "investment-block"
  ];
  
  elementsToHide.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
  
  updateUIValues();
  showMsg("üîÑ Partie red√©marr√©e");
}

// ===================================================================================
// FONCTIONS DE TRICHE/DEBUG
// ===================================================================================
function toggleCheatMode(){
  cheatModeUnlocked = !cheatModeUnlocked;
  const buttons = document.getElementById("cheat-buttons");
  if (buttons) {
    buttons.style.display = cheatModeUnlocked ? "flex" : "none";
  }
  showMsg(cheatModeUnlocked ? "üîì Mode triche activ√©" : "üîí Mode triche d√©sactiv√©");
}

function addMoney(){
  if (!cheatModeUnlocked) return;
  saveState();
  gameState.money += 1000;
  showMsg("üí∞ +1000‚Ç¨ (triche)");
  updateUIValues();
}

function addNature(){
  if (!cheatModeUnlocked) return;
  saveState();
  gameState.nature += 100;
  showMsg("üå± +100 ressources (triche)");
  updateUIValues();
}

function addClicks(){
  if (!cheatModeUnlocked) return;
  saveState();
  gameState.clicks += 50;
  showMsg("‚ö° +50 clics (triche)");
  updateUIValues();
}

function forceActivateEH(){
  if (!cheatModeUnlocked) return;
  saveState();
  evolution();
  showMsg("üå± EH forc√©e (triche)");
}

function toggleEvents(){
  if (!cheatModeUnlocked) return;
  randomEventsSystem.enabled = !randomEventsSystem.enabled;
  showMsg("üé≤ √âv√©nements " + (randomEventsSystem.enabled ? "ON" : "OFF"));
}

// ===================================================================================
// V√âRIFICATIONS ET GAME OVER
// ===================================================================================
function checkGameOverConditions(){
  let gameOver = false;
  
  // Game Over : ressources √©puis√©es
  if (gameState.nature <= 0) {
    gameState.gameOver = true;
    gameOver = true;
    const gor = document.getElementById("game-over-resources");
    if (gor) {
      gor.style.display = "block";
      gor.textContent = "üí• Plan√®te non habitable (ressources √©puis√©es)";
    }
  }
  
  // Game Over : effondrement social (confort retombe √† 0 apr√®s avoir √©t√© > 0)
  if (gameState.confortMaxAtteint < gameState.confort) {
    gameState.confortMaxAtteint = gameState.confort;
  }
  
  if (gameState.confortMaxAtteint > 0 && gameState.confort <= 0) {
    gameState.gameOver = true;
    gameOver = true;
    const goc = document.getElementById("game-over-confort");
    if (goc) {
      goc.style.display = "block";
      goc.textContent = "üí• Effondrement social (confort retomb√© √† 0)";
    }
  }
  
  return gameOver;
}

// ===================================================================================
// INITIALISATION ET BOOT
// ===================================================================================
function initGame() {
  console.log("üöÄ D√©marrage Looop v1.30.5");
  
  // Initialisation du syst√®me d'√©v√©nements
  randomEventsSystem.init();
  
  // Premi√®re mise √† jour de l'interface
  updateUIValues();
  
  // Messages d'accueil diff√©r√©s
  setTimeout(() => {
    showMsg("üåç Looop - Simulateur d'√©quilibre √©cologique");
  }, 1000);
  
  setTimeout(() => {
    showMsg("üéØ Objectif : maintenir l'√©quilibre pendant 50 actions");
  }, 3500);
  
  console.log("üéÆ Jeu pr√™t !");
}

// Gestionnaire d'erreurs global
window.addEventListener('error', function(event) {
  console.error("‚ùå Erreur JavaScript d√©tect√©e:", event.error);
  showMsg("‚ö†Ô∏è Erreur d√©tect√©e - V√©rifiez la console");
});

// D√©marrage automatique
document.addEventListener('DOMContentLoaded', initGame);

</script>
</body>
</html>
