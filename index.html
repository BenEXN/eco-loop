<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Looop v1.21.0 – Corrections et Optimisations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #f3f3f3; font-family: sans-serif; margin:0; padding:0; }
    h1 { text-align: center; margin: 25px 0 10px; }
    .container { display: flex; justify-content: center; align-items: flex-start; margin: 0 auto 18px auto; max-width: 950px; gap: 24px;}
    .category { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #0001; flex: 1; padding: 32px 18px 18px 18px; margin: 0 6px; min-width: 250px; max-width: 320px; min-height: 250px; display: flex; flex-direction: column; align-items: center;}
    .cat-title { font-size: 1.25em; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px;}
    .stock { font-size: 1.1em; margin-bottom: 10px;}
    .products-box { background: #f7f7fa; border: 2px solid #dde1eb; border-radius: 10px; color: #333; margin-bottom: 10px; padding: 10px 28px; font-size: 1.2em; font-weight: bold; letter-spacing: 1px; box-shadow: 0 1px 4px #ddd5; min-width: 110px; text-align: center;}
    .message-box { border-radius: 10px; margin: 8px 0 14px 0; padding: 11px 14px 11px 14px; font-weight: bold; font-size: 1.08em; box-shadow: 0 1px 4px #0002; text-align: center; min-width: 130px; max-width: 260px; word-break: break-word; line-height: 1.25em;}
    .msg-orange { background: #ffe9cf; color: #d2691e; border: 2px solid #f5c387;}
    .msg-blue { background: #e7f4ff; color: #0978c6; border: 2px solid #7cc8fa;}
    .msg-red { background: #ffe3e3; color: #c00; border: 2px solid #e48888;}
    .msg-brown { background: #fff4d6; color: #be8c00; border: 2px solid #e2c071;}
    .msg-green { background: #e8f5e8; color: #2e7d32; border: 2px solid #81c784;}
    .btn-row { margin: 18px 0 0 0;}
    button { font-size: 1em; padding: 10px 18px; margin: 5px 0; border-radius: 14px; border: none; background: #ededed; color: #111; cursor: pointer; transition: background 0.2s;}
    .btn-yellow { background: #FFD600; color: #222; font-weight: bold;}
    .btn-annuler { background: #aaa; color: #fff; }
    .btn-credit { background: #ff6b35; color: #fff; font-weight: bold;}
    .btn-evolution { background: #4CAF50; color: #fff; font-weight: bold;}
    .debug-row { margin: 0 0 32px 0; display: flex; justify-content: center; gap: 10px;}
    .message { font-weight: bold; min-height: 24px; margin: 10px 0;}
    #clics-container { text-align: center; margin: 25px 0 0 0; font-size: 1.2em; font-weight: bold; color: #333;}
    #don-btn { margin-top: 10px; background: #FFD600; color: #222; font-weight: bold; border: none; border-radius: 8px; font-size: 1.1em; padding: 14px 20px;}
    #triche-sep { border: none; border-top: 3px solid #222; margin: 38px auto 12px auto; width: 94vw; max-width: 1000px;}
    #triche-label { text-align: left; font-size:1.13em; font-weight:normal; letter-spacing:1px; margin: 0 0 12px 0; color:#111; width: 95vw; max-width: 1000px; margin-left: auto; margin-right: auto;}
    
    /* Contrôles automatismes */
    .automatisms-controls { 
      margin: 15px auto 15px auto; 
      max-width: 950px; 
      display: none;
      justify-content: center; 
      gap: 20px; 
      flex-wrap: wrap;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
    }
    
    .automatisms-controls.visible {
      display: flex;
    }
    .control-btn { font-size: 0.9em; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s; min-width: 80px;}
    .control-btn.active { background: #4CAF50; color: white; }
    .control-btn.inactive { background: #f44336; color: white; }
    .control-btn.disabled { background: #ccc; color: #888; cursor: not-allowed; }
    
    /* Jauges */
    .jauge-bottom-barre { margin: 0 auto 6px auto; display: flex; flex-direction: row; align-items: center; gap: 8px; max-width: 600px;}
    .jauge-bottom-label { min-width: 70px; font-size: .99em; color: #888; text-align: right;}
    .jauge-bottom-bar { background: #eee; border-radius: 8px; height: 13px; flex: 1; overflow: hidden; position: relative;}
    .jauge-bottom-fill { height: 100%; border-radius: 8px; transition: width 0.19s;}
    #jauge-nature { background: #86e08e;}
    #jauge-confort { background: #86b6ea;}
    #jauge-money { background: #ffb3b3;}
    #jauge-achat-auto { background: #ffa726;}
    #jauge-ia { background: #ab47bc;}
    #jauge-trader { background: #26c6da;}
    #jauge-centre { background: #66bb6a;}
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>🌍 Looop <span style="font-size:0.7em;color:#777;">v1.21.0 Corrections</span></h1>
  
  <div class="automatisms-controls" id="automatisms-controls">
    <button class="control-btn disabled" id="control-ia" onclick="toggleAutomatism('ia')">🤖 IA: OFF</button>
    <button class="control-btn disabled" id="control-trader" onclick="toggleAutomatism('trader')">💰 Trader: OFF</button>
    <button class="control-btn disabled" id="control-confort" onclick="toggleAutomatism('confort')">🛋️ Confort: OFF</button>
    <button class="control-btn disabled" id="control-centre" onclick="toggleAutomatism('centre')">🏬 Centre: OFF</button>
  </div>
  
  <div class="container">
    <div class="category">
      <div class="cat-title">🌱 Environnement</div>
      <div class="stock">Ressources : <span id="nature">3000</span></div>
      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>
      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">🛠️ Produire</button>
      </div>
    </div>
    
    <div class="category">
      <div class="cat-title">🤖 Exosomatisation</div>
      <div class="stock">Confort : <span id="confort">0</span></div>
      <div class="products-box">
        Produits créés<br>
        <span id="production">0</span>
      </div>
      <div id="social-crise" class="message-box msg-brown" style="display:none;"></div>
      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">🛋️ Achat (100 €)</button>
        <button id="sell-btn" onclick="sell()">💶 Vendre</button>
      </div>
    </div>
    
    <div class="category">
      <div class="cat-title">💶 Économie</div>
      <div class="stock" id="money-row" style="display:none;">
        Monnaie (€) : <span id="money">10</span>
      </div>
      <div class="products-box" id="price-indicator-box" style="display:none;">
        Prix de vente<br>
        <span id="current-price">1€</span>
      </div>
      
      <button id="don-btn" onclick="receiveDon()">Recevoir mon don</button>
      <button id="credit-btn" onclick="activateCredit()" style="display:none;" class="btn-credit">💳 Effectuer un crédit</button>
      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div class="btn-row">
        <button id="ouvrier-btn" onclick="acheterIA()" style="display:none;">🤖 Engager une IA (500 €)</button>
        <button id="trader-btn" onclick="acheterTrader()" style="display:none;">🤖 Trader automatique (1 000 €)</button>
        <button id="comfort-auto-btn" onclick="acheterConfortAuto()" style="display:none;">🔄 Achat auto confort (2 000 €)</button>
        <button id="upgrade-btn2" onclick="upgradeProd2()" style="display:none;">💠 Améliorer la production (2 000 €)</button>
        <button id="automatisms-btn" onclick="acheterAutomatismsClics()" style="display:none;">⚡ Automatismes = clics (10 000 €)</button>
        <button id="centre-commercial-btn" onclick="acheterCentreCommercial()" style="display:none;">🏬 Centre commercial (5 000 €)</button>
        <button id="price-indicator-btn" onclick="acheterIndicateurPrix()" style="display:none;">📊 Indicateur de prix (30 000 €)</button>
        <button id="evolution-btn" onclick="evolution()" style="display:none;" class="btn-evolution">🌱 Évolution économique</button>
      </div>
    </div>
  </div>
  
  <!-- Jauges -->
  <div id="jauges-zone" style="margin: 0 auto 14px auto; max-width:620px;">
    <div class="jauge-bottom-barre">
      <div class="jauge-bottom-label">🌱 Ressources</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-nature"></div></div>
      <div class="jauge-bottom-val" id="jauge-nature-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-confort-container" style="display:none;">
      <div class="jauge-bottom-label">🤖 Confort</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-confort"></div></div>
      <div class="jauge-bottom-val" id="jauge-confort-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-money-container" style="display:none;">
      <div class="jauge-bottom-label">💶 Monnaie</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-money"></div></div>
      <div class="jauge-bottom-val" id="jauge-money-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-achat-auto-container" style="display:none;">
      <div class="jauge-bottom-label">🔄 Achat auto</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-achat-auto"></div></div>
      <div class="jauge-bottom-val" id="jauge-achat-auto-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-ia-container" style="display:none;">
      <div class="jauge-bottom-label">🤖 IA</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-ia"></div></div>
      <div class="jauge-bottom-val" id="jauge-ia-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-trader-container" style="display:none;">
      <div class="jauge-bottom-label">💰 Trader</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-trader"></div></div>
      <div class="jauge-bottom-val" id="jauge-trader-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-centre-container" style="display:none;">
      <div class="jauge-bottom-label">🏬 Centre</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-centre"></div></div>
      <div class="jauge-bottom-val" id="jauge-centre-txt"></div>
    </div>
  </div>
  
  <div class="message" id="message"></div>
  <div id="clics-container">Clics/actions : <span id="clicks">0</span></div>
  
  <hr id="triche-sep">
  <div id="triche-label">Triche</div>
  <div class="debug-row">
    <button class="btn-yellow" onclick="addMoney()">+1000 crédits (test)</button>
    <button class="btn-yellow" onclick="addOneNature()">+100 ressources (test)</button>
    <button class="btn-yellow" onclick="addClicks50()">Clics +50 (test)</button>
    <button class="btn-annuler" onclick="undoAction()">⏪ Annuler le clic précédent</button>
  </div>
  
  <script>
    // ==================== VARIABLES DU JEU ====================
    
    // Variables principales
    var gameState = {
      nature: 3000,
      confort: 0,
      production: 0,
      money: 10,
      clicks: 0,
      
      // États des systèmes
      monnaieActive: false,
      creditUnlocked: false,
      jeuBloque: false,
      criseSocialeActive: false,
      ehActivated: false,
      
      // Automatismes
      ia: 0,
      traderAuto: 0,
      confortAuto: 0,
      centreCommercial: 0,
      
      // Améliorations
      techLevel: 0,
      productionMultiplier: 1,
      automatismsGenerateClicks: false,
      priceIndicatorActive: false,
      
      // Paliers débloqués (pour éviter les réactivations)
      paliersUnlocked: {
        comfort: false,
        ia: false,
        trader: false,
        upgradeProd: false,
        confortAuto: false,
        automatismsClics: false,
        priceIndicator: false,
        centreCommercial: false
      }
    };
    
    // États des automatismes (ON/OFF)
    var automatismsActive = {
      ia: true,
      trader: true,
      confort: true,
      centre: true
    };
    
    // Gestion des intervalles (pour éviter les doublons)
    var intervals = {
      ia: null,
      trader: null,
      confortAuto: null,
      centreCommercial: null
    };
    
    // Gestion du crédit centralisé
    var pendingPurchase = null; // Stocke l'achat en attente
    
    // Sauvegarde pour l'annulation
    var lastState = null;
    
    // ==================== CONFIGURATION DES PALIERS ====================
    
    var paliers = {
      comfort: { clics: 120, cost: 100, unlocked: false },
      ia: { clics: 200, cost: 500, unlocked: false },
      trader: { clics: 500, cost: 1000, unlocked: false },
      upgradeProd: { clics: 600, cost: 2000, unlocked: false, condition: () => gameState.techLevel === 0 },
      confortAuto: { clics: 700, cost: 2000, unlocked: false },
      automatismsClics: { clics: 750, cost: 10000, unlocked: false, condition: () => !gameState.automatismsGenerateClicks },
      priceIndicator: { clics: 1000, cost: 30000, unlocked: false, condition: () => !gameState.priceIndicatorActive },
      centreCommercial: { clics: 1100, cost: 5000, unlocked: false }
    };
    
    // ==================== FONCTIONS UTILITAIRES ====================
    
    function saveState() {
      lastState = JSON.parse(JSON.stringify(gameState));
      lastState.automatismsActive = {...automatismsActive};
    }
    
    function undoAction() {
      if (lastState) {
        gameState = JSON.parse(JSON.stringify(lastState));
        automatismsActive = {...lastState.automatismsActive};
        updateUI("Action annulée");
      }
    }
    
    function needsCredit(amount) {
      return gameState.money < amount && !gameState.creditUnlocked;
    }
    
    function showCreditButton(purchaseType, amount) {
      if (gameState.creditUnlocked) return false;
      
      pendingPurchase = { type: purchaseType, amount: amount };
      document.getElementById("credit-btn").style.display = "block";
      return true;
    }
    
    function activateCredit() {
      gameState.creditUnlocked = true;
      document.getElementById("credit-btn").style.display = "none";
      
      // Effectuer l'achat en attente
      if (pendingPurchase) {
        executePendingPurchase();
        pendingPurchase = null;
      }
      
      updateUI("💳 Système de crédit déverrouillé ! Achats à crédit illimités");
    }
    
    function executePendingPurchase() {
      switch(pendingPurchase.type) {
        case 'comfort':
          acheterConfort();
          break;
        case 'ia':
          acheterIA();
          break;
        case 'trader':
          acheterTrader();
          break;
        case 'confortAuto':
          acheterConfortAuto();
          break;
        case 'centreCommercial':
          acheterCentreCommercial();
          break;
        case 'upgradeProd':
          upgradeProd2();
          break;
        case 'automatismsClics':
          acheterAutomatismsClics();
          break;
        case 'priceIndicator':
          acheterIndicateurPrix();
          break;
      }
    }
    
    function canAfford(amount) {
      return gameState.creditUnlocked || gameState.money >= amount;
    }
    
    function debitMoney(amount) {
      gameState.money -= amount;
    }
    
    function calculatePrice() {
      if (gameState.nature === 0) return 1;
      var price = Math.max(1, Math.abs(gameState.money) / gameState.nature);
      return Math.round(price * 100) / 100;
    }
    
    // ==================== ACTIONS PRINCIPALES ====================
    
    function produce() {
      if (gameState.jeuBloque) return;
      saveState();
      
      var cost = 5;
      if (gameState.nature >= cost) {
        gameState.nature -= cost;
        var prodAmount = Math.floor(gameState.productionMultiplier);
        gameState.production += prodAmount;
        gameState.clicks++;
        
        updateUI("Production : +" + prodAmount + " produits créés");
      } else {
        updateUI("Pas assez de ressources pour produire");
      }
    }
    
    function sell() {
      if (gameState.jeuBloque || gameState.production <= 0) {
        if (gameState.production <= 0) updateUI("Aucun produit à vendre");
        return;
      }
      
      saveState();
      var price = calculatePrice();
      var saleAmount = Math.min(gameState.production, 1);
      var totalEarnings = price * saleAmount;
      
      gameState.money += totalEarnings;
      gameState.production -= saleAmount;
      gameState.clicks++;
      
      if (!gameState.monnaieActive) {
        gameState.monnaieActive = true;
        document.getElementById("money-row").style.display = "block";
        document.getElementById("jauge-money-container").style.display = "flex";
      }
      
      updateUI("Vente : +" + totalEarnings.toFixed(2) + "€");
    }
    
    function receiveDon() {
      if (gameState.jeuBloque) return;
      saveState();
      
      gameState.money = 1000;
      gameState.clicks++;
      
      if (!gameState.monnaieActive) {
        gameState.monnaieActive = true;
        document.getElementById("money-row").style.display = "block";
        document.getElementById("jauge-money-container").style.display = "flex";
      }
      
      document.getElementById("don-btn").style.display = "none";
      updateUI("Don reçu : 1000€");
    }
    
    // ==================== ACHATS ET AMÉLIORATIONS ====================
    
    function acheterConfort() {
      if (gameState.jeuBloque || !gameState.monnaieActive) return;
      
      if (!canAfford(100)) {
        if (showCreditButton('comfort', 100)) {
          updateUI("Fonds insuffisants pour acheter du confort - Crédit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(100);
      gameState.confort += 1;
      gameState.clicks++;
      
      if (gameState.confort === 1) {
        document.getElementById("jauge-confort-container").style.display = "flex";
      }
      
      var message = "Confort acheté : +1 confort";
      if (gameState.money < 0) {
        message += " - Dette : " + Math.abs(gameState.money) + "€";
      }
      updateUI(message);
    }
    
    function acheterIA() {
      if (gameState.jeuBloque || !gameState.monnaieActive) return;
      
      if (!canAfford(500)) {
        if (showCreditButton('ia', 500)) {
          updateUI("Fonds insuffisants pour engager une IA - Crédit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(500);
      
      if (gameState.ia === 0) {
        gameState.ia = 1;
        document.getElementById("jauge-ia-container").style.display = "flex";
        startIAInterval();
      } else {
        gameState.ia *= 2;
      }
      
      gameState.clicks++;
      paliers.ia.unlocked = true;
      document.getElementById("ouvrier-btn").style.display = "none";
      
      updateUI("IA engagée ! Production automatique ×" + gameState.ia + " (toutes les 5s)");
    }
    
    function acheterTrader() {
      if (gameState.jeuBloque || !gameState.monnaieActive) return;
      
      if (!canAfford(1000)) {
        if (showCreditButton('trader', 1000)) {
          updateUI("Fonds insuffisants pour engager un trader - Crédit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(1000);
      
      if (gameState.traderAuto === 0) {
        gameState.traderAuto = 1;
        document.getElementById("jauge-trader-container").style.display = "flex";
        startTraderInterval();
      } else {
        gameState.traderAuto *= 2;
      }
      
      gameState.clicks++;
      paliers.trader.unlocked = true;
      document.getElementById("trader-btn").style.display = "none";
      
      updateUI("Trader automatique ×" + gameState.traderAuto + " engagé ! Vente automatique (toutes les 3s)");
    }
    
    function acheterConfortAuto() {
      if (gameState.jeuBloque || !gameState.monnaieActive) return;
      
      if (!canAfford(2000)) {
        if (showCreditButton('confortAuto', 2000)) {
          updateUI("Fonds insuffisants pour l'achat automatique de confort - Crédit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(2000);
      
      if (gameState.confortAuto === 0) {
        gameState.confortAuto = 1;
        document.getElementById("jauge-achat-auto-container").style.display = "flex";
        startConfortAutoInterval();
      } else {
        gameState.confortAuto *= 2;
      }
      
      gameState.clicks++;
      paliers.confortAuto.unlocked = true;
      document.getElementById("comfort-auto-btn").style.display = "none";
      
      updateUI("Achat automatique de confort activé ! +" + gameState.confortAuto + " confort toutes les 15s");
    }
    
    function acheterCentreCommercial() {
      if (gameState.jeuBloque || !gameState.monnaieActive) return;
      
      if (!canAfford(5000)) {
        if (showCreditButton('centreCommercial', 5000)) {
          updateUI("Fonds insuffisants pour le centre commercial - Crédit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(5000);
      
      if (gameState.centreCommercial === 0) {
        gameState.centreCommercial = 1;
        document.getElementById("jauge-centre-container").style.display = "flex";
        startCentreCommercialInterval();
      } else {
        gameState.centreCommercial *= 2;
      }
      
      gameState.clicks++;
      paliers.centreCommercial.unlocked = true;
      document.getElementById("centre-commercial-btn").style.display = "none";
      
      updateUI("Centre commercial activé ! +" + (10 * gameState.centreCommercial) + " confort toutes les 15s");
    }
    
    function upgradeProd2() {
      if (gameState.jeuBloque || !gameState.monnaieActive) return;
      
      if (!canAfford(2000)) {
        if (showCreditButton('upgradeProd', 2000)) {
          updateUI("Fonds insuffisants pour améliorer la production - Crédit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(2000);
      gameState.techLevel++;
      gameState.productionMultiplier *= 1.5;
      gameState.clicks++;
      
      paliers.upgradeProd.unlocked = true;
      document.getElementById("upgrade-btn2").style.display = "none";
      
      updateUI("Production améliorée ! Multiplicateur ×" + gameState.productionMultiplier.toFixed(1));
    }
    
    function acheterAutomatismsClics() {
      if (gameState.jeuBloque || !gameState.monnaieActive) return;
      
      if (!canAfford(10000)) {
        if (showCreditButton('automatismsClics', 10000)) {
          updateUI("Fonds insuffisants pour les automatismes = clics - Crédit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(10000);
      gameState.automatismsGenerateClicks = true;
      gameState.clicks++;
      
      paliers.automatismsClics.unlocked = true;
      document.getElementById("automatisms-btn").style.display = "none";
      
      updateUI("Automatismes activés ! Chaque action automatique compte comme un clic");
    }
    
    function acheterIndicateurPrix() {
      if (gameState.jeuBloque || !gameState.monnaieActive) return;
      
      if (!canAfford(30000)) {
        if (showCreditButton('priceIndicator', 30000)) {
          updateUI("Fonds insuffisants pour l'indicateur de prix - Crédit disponible");
          return;
        }
      }
      
      saveState();
      debitMoney(30000);
      gameState.priceIndicatorActive = true;
      gameState.clicks++;
      
      paliers.priceIndicator.unlocked = true;
      document.getElementById("price-indicator-btn").style.display = "none";
      
      updateUI("Indicateur de prix activé ! Le prix varie selon : |Monnaie| ÷ Ressources");
    }
    
    function evolution() {
      if (gameState.jeuBloque || !gameState.monnaieActive || gameState.ehActivated) return;
      
      saveState();
      gameState.ehActivated = true;
      gameState.jeuBloque = true;
      gameState.clicks++;
      
      // Arrêter tous les automatismes
      Object.keys(automatismsActive).forEach(key => {
        automatismsActive[key] = false;
      });
      
      // Masquer les contrôles d'automatismes
      document.getElementById("automatisms-controls").style.display = "none";
      
      // Afficher le message de succès
      var successBox = document.getElementById("eh-success");
      successBox.style.display = "block";
      successBox.textContent = "🌱 Transition vers l'Économie Homéostatique réussie ! Le jeu entre en phase d'équilibre...";
      
      // Masquer le bouton d'évolution
      document.getElementById("evolution-btn").style.display = "none";
      
      updateUI("🌱 Évolution vers l'Économie Homéostatique - Système stabilisé !");
    }
    
    // ==================== AUTOMATISMES - INTERVALLES ====================
    
    function startIAInterval() {
      if (intervals.ia) return; // Éviter les doublons
      
      intervals.ia = setInterval(function() {
        if (gameState.ia > 0 && !gameState.jeuBloque && automatismsActive.ia) {
          var cost = 5;
          if (gameState.nature >= cost * gameState.ia) {
            gameState.nature -= cost * gameState.ia;
            var prodAmount = Math.floor(gameState.ia * gameState.productionMultiplier);
            gameState.production += prodAmount;
            
            if (gameState.automatismsGenerateClicks) {
              gameState.clicks += prodAmount;
              updateUI();
            }
          }
        }
      }, 5000);
    }
    
    function startTraderInterval() {
      if (intervals.trader) return;
      
      intervals.trader = setInterval(function() {
        if (gameState.traderAuto > 0 && gameState.production > 0 && !gameState.jeuBloque && automatismsActive.trader) {
          var price = calculatePrice();
          var saleAmount = Math.min(gameState.production, gameState.traderAuto);
          var totalEarnings = price * saleAmount;
          
          gameState.money += totalEarnings;
          gameState.production -= saleAmount;
          
          if (gameState.automatismsGenerateClicks) {
            gameState.clicks += saleAmount;
            updateUI();
          }
        }
      }, 3000);
    }
    
    function startConfortAutoInterval() {
      if (intervals.confortAuto) return;
      
      intervals.confortAuto = setInterval(function() {
        if (gameState.confortAuto > 0 && !gameState.jeuBloque && automatismsActive.confort) {
          var prixConfort = 100;
          gameState.money -= prixConfort * gameState.confortAuto;
          gameState.confort += gameState.confortAuto;
          
          if (gameState.automatismsGenerateClicks) {
            gameState.clicks += gameState.confortAuto;
            updateUI();
          }
        }
      }, 15000);
    }
    
    function startCentreCommercialInterval() {
      if (intervals.centreCommercial) return;
      
      intervals.centreCommercial = setInterval(function() {
        if (gameState.centreCommercial > 0 && !gameState.jeuBloque && automatismsActive.centre) {
          var prixConfort = 100;
          var achatsQuantite = 10 * gameState.centreCommercial;
          gameState.money -= prixConfort * achatsQuantite;
          gameState.confort += achatsQuantite;
          
          if (gameState.automatismsGenerateClicks) {
            gameState.clicks += achatsQuantite;
            updateUI();
          }
        }
      }, 15000);
    }
    
    // ==================== CONTRÔLES AUTOMATISMES ====================
    
    function toggleAutomatism(type) {
      if (gameState.ehActivated) return; // Bloqué en mode EH
      
      // Vérifier si l'automatisme existe
      if (type === 'ia' && gameState.ia === 0) return;
      if (type === 'trader' && gameState.traderAuto === 0) return;
      if (type === 'confort' && gameState.confortAuto === 0) return;
      if (type === 'centre' && gameState.centreCommercial === 0) return;
      
      automatismsActive[type] = !automatismsActive[type];
      updateUI("Automatisme " + type + " : " + (automatismsActive[type] ? "ON" : "OFF"));
    }
    
    // ==================== GESTION DES PALIERS ====================
    
    function checkAndUnlockPaliers() {
      if (!gameState.monnaieActive) return;
      
      // Confort - 120 clics
      if (gameState.clicks >= 120 && !paliers.comfort.unlocked) {
        var btn = document.getElementById("comfort-btn");
        btn.style.display = "block";
        updateButtonState(btn, paliers.comfort.cost, "🛋️ Achat (100 €)");
      }
      
      // IA - 200 clics
      if (gameState.clicks >= 200 && !paliers.ia.unlocked) {
        var btn = document.getElementById("ouvrier-btn");
        btn.style.display = "block";
        updateButtonState(btn, paliers.ia.cost, "🤖 Engager une IA (500 €)");
      }
      
      // Trader - 500 clics
      if (gameState.clicks >= 500 && !paliers.trader.unlocked) {
        var btn = document.getElementById("trader-btn");
        btn.style.display = "block";
        updateButtonState(btn, paliers.trader.cost, "🤖 Trader automatique (1 000 €)");
      }
      
      // Upgrade Production - 600 clics ET techLevel = 0
      if (gameState.clicks >= 600 && gameState.techLevel === 0 && !paliers.upgradeProd.unlocked) {
        var btn = document.getElementById("upgrade-btn2");
        btn.style.display = "block";
        updateButtonState(btn, paliers.upgradeProd.cost, "💠 Améliorer la production (2 000 €)");
      }
      
      // Confort Auto - 700 clics
      if (gameState.clicks >= 700 && !paliers.confortAuto.unlocked) {
        var btn = document.getElementById("comfort-auto-btn");
        btn.style.display = "block";
        updateButtonState(btn, paliers.confortAuto.cost, "🔄 Achat auto confort (2 000 €)");
      }
      
      // Automatismes = Clics - 750 clics ET pas encore activé
      if (gameState.clicks >= 750 && !gameState.automatismsGenerateClicks && !paliers.automatismsClics.unlocked) {
        var btn = document.getElementById("automatisms-btn");
        btn.style.display = "block";
        updateButtonState(btn, paliers.automatismsClics.cost, "⚡ Automatismes = clics (10 000 €)");
      }
      
      // Indicateur Prix - 1000 clics ET pas encore activé
      if (gameState.clicks >= 1000 && !gameState.priceIndicatorActive && !paliers.priceIndicator.unlocked) {
        var btn = document.getElementById("price-indicator-btn");
        btn.style.display = "block";
        updateButtonState(btn, paliers.priceIndicator.cost, "📊 Indicateur de prix (30 000 €)");
      }
      
      // Centre Commercial - 1100 clics
      if (gameState.clicks >= 1100 && !paliers.centreCommercial.unlocked) {
        var btn = document.getElementById("centre-commercial-btn");
        btn.style.display = "block";
        updateButtonState(btn, paliers.centreCommercial.cost, "🏬 Centre commercial (5 000 €)");
      }
    }
    
    function updateButtonState(btn, cost, originalText) {
      if (needsCredit(cost)) {
        btn.textContent = "💳 Effectuer un crédit";
        btn.className = "btn-credit";
      } else {
        btn.textContent = originalText;
        btn.className = "";
      }
    }
    
    // ==================== CONTRÔLES AUTOMATISMES UI ====================
    
    function updateAutomatismControls() {
      var hasAnyAutomatism = (gameState.ia > 0 || gameState.traderAuto > 0 || gameState.confortAuto > 0 || gameState.centreCommercial > 0);
      
      if (hasAnyAutomatism && !gameState.ehActivated) {
        document.getElementById("automatisms-controls").style.display = "flex";
      } else {
        document.getElementById("automatisms-controls").style.display = "none";
      }
      
      // IA
      var iaBtn = document.getElementById("control-ia");
      if (gameState.ia > 0) {
        iaBtn.style.display = "inline-block";
        iaBtn.className = automatismsActive.ia ? "control-btn active" : "control-btn inactive";
        iaBtn.textContent = "🤖 IA: " + (automatismsActive.ia ? "ON" : "OFF");
      } else {
        iaBtn.style.display = "none";
      }
      
      // Trader
      var traderBtn = document.getElementById("control-trader");
      if (gameState.traderAuto > 0) {
        traderBtn.style.display = "inline-block";
        traderBtn.className = automatismsActive.trader ? "control-btn active" : "control-btn inactive";
        traderBtn.textContent = "💰 Trader: " + (automatismsActive.trader ? "ON" : "OFF");
      } else {
        traderBtn.style.display = "none";
      }
      
      // Confort Auto
      var confortBtn = document.getElementById("control-confort");
      if (gameState.confortAuto > 0) {
        confortBtn.style.display = "inline-block";
        confortBtn.className = automatismsActive.confort ? "control-btn active" : "control-btn inactive";
        confortBtn.textContent = "🛋️ Confort: " + (automatismsActive.confort ? "ON" : "OFF");
      } else {
        confortBtn.style.display = "none";
      }
      
      // Centre Commercial
      var centreBtn = document.getElementById("control-centre");
      if (gameState.centreCommercial > 0) {
        centreBtn.style.display = "inline-block";
        centreBtn.className = automatismsActive.centre ? "control-btn active" : "control-btn inactive";
        centreBtn.textContent = "🏬 Centre: " + (automatismsActive.centre ? "ON" : "OFF");
      } else {
        centreBtn.style.display = "none";
      }
    }
    
    // ==================== JAUGES ====================
    
    function updateJauges() {
      var maxVals = {
        nature: Math.max(3000, gameState.nature * 1.2),
        confort: Math.max(100, gameState.confort * 1.2),
        money: Math.max(10000, Math.abs(gameState.money) * 1.2),
        achatAuto: Math.max(10, gameState.confortAuto * 1.2),
        ia: Math.max(10, gameState.ia * 1.2),
        trader: Math.max(10, gameState.traderAuto * 1.2),
        centre: Math.max(10, gameState.centreCommercial * 1.2)
      };
      
      // Jauge Nature
      var naturePercent = Math.min(100, Math.max(0, (gameState.nature / maxVals.nature) * 100));
      document.getElementById("jauge-nature").style.width = naturePercent + "%";
      document.getElementById("jauge-nature-txt").textContent = Math.floor(gameState.nature);
      
      // Jauge Confort
      if (gameState.confort > 0) {
        document.getElementById("jauge-confort-container").style.display = "flex";
        var confortPercent = Math.min(100, Math.max(0, (gameState.confort / maxVals.confort) * 100));
        document.getElementById("jauge-confort").style.width = confortPercent + "%";
        document.getElementById("jauge-confort-txt").textContent = Math.floor(gameState.confort);
      }
      
      // Jauge Monnaie
      if (gameState.monnaieActive) {
        var moneyPercent = Math.min(100, Math.max(0, (Math.abs(gameState.money) / maxVals.money) * 100));
        document.getElementById("jauge-money").style.width = moneyPercent + "%";
        document.getElementById("jauge-money-txt").textContent = Math.floor(gameState.money) + "€";
      }
      
      // Jauge Achat Auto
      if (gameState.confortAuto > 0) {
        var achatPercent = Math.min(100, Math.max(0, (gameState.confortAuto / maxVals.achatAuto) * 100));
        document.getElementById("jauge-achat-auto").style.width = achatPercent + "%";
        document.getElementById("jauge-achat-auto-txt").textContent = "×" + gameState.confortAuto;
      }
      
      // Jauge IA
      if (gameState.ia > 0) {
        var iaPercent = Math.min(100, Math.max(0, (gameState.ia / maxVals.ia) * 100));
        document.getElementById("jauge-ia").style.width = iaPercent + "%";
        document.getElementById("jauge-ia-txt").textContent = "×" + gameState.ia;
      }
      
      // Jauge Trader
      if (gameState.traderAuto > 0) {
        var traderPercent = Math.min(100, Math.max(0, (gameState.traderAuto / maxVals.trader) * 100));
        document.getElementById("jauge-trader").style.width = traderPercent + "%";
        document.getElementById("jauge-trader-txt").textContent = "×" + gameState.traderAuto;
      }
      
      // Jauge Centre Commercial
      if (gameState.centreCommercial > 0) {
        var centrePercent = Math.min(100, Math.max(0, (gameState.centreCommercial / maxVals.centre) * 100));
        document.getElementById("jauge-centre").style.width = centrePercent + "%";
        document.getElementById("jauge-centre-txt").textContent = "×" + gameState.centreCommercial;
      }
    }
    
    // ==================== CRISES ET ALERTES ====================
    
    function updateCrises() {
      // Crise écologique
      var criseBox = document.getElementById("alert-crise");
      if (gameState.nature < 300) {
        criseBox.style.display = "block";
        criseBox.textContent = "Crise écologique : risque sur l'habitabilité humaine de la planète";
      } else {
        criseBox.style.display = "none";
      }
      
      // Message évolution EH
      var ehBox = document.getElementById("eh-msg");
      if (gameState.monnaieActive && gameState.nature <= 100 && !gameState.ehActivated) {
        ehBox.style.display = "block";
        ehBox.textContent = "Une évolution est possible : passer à l'économie homéostatique (EH)";
        document.getElementById("evolution-btn").style.display = "block";
      } else {
        ehBox.style.display = "none";
        if (!gameState.ehActivated) {
          document.getElementById("evolution-btn").style.display = "none";
        }
      }
      
      // Crise sociale
      var socialBox = document.getElementById("social-crise");
      if (gameState.confort > 5) {
        gameState.criseSocialeActive = true;
      }
      if (gameState.criseSocialeActive && gameState.confort > 0 && gameState.confort < 5) {
        socialBox.style.display = "block";
        socialBox.textContent = "Crise sociale – risque de révolution";
      } else if (gameState.confort === 0) {
        gameState.criseSocialeActive = false;
        socialBox.style.display = "none";
      } else {
        socialBox.style.display = "none";
      }
    }
    
    // ==================== INTERFACE UTILISATEUR ====================
    
    function updateUI(message) {
      // Vérifier et débloquer les paliers
      checkAndUnlockPaliers();
      
      // Mettre à jour les contrôles d'automatismes
      updateAutomatismControls();
      
      // Mettre à jour les valeurs affichées
      document.getElementById("nature").textContent = Math.floor(gameState.nature);
      document.getElementById("confort").textContent = Math.floor(gameState.confort);
      document.getElementById("production").textContent = Math.floor(gameState.production);
      document.getElementById("money").textContent = Math.floor(gameState.money);
      document.getElementById("clicks").textContent = gameState.clicks;
      
      // Indicateur de prix
      if (gameState.priceIndicatorActive) {
        document.getElementById("price-indicator-box").style.display = "block";
        var currentPrice = calculatePrice();
        document.getElementById("current-price").textContent = currentPrice.toFixed(2) + "€";
      }
      
      // Mettre à jour les jauges
      updateJauges();
      
      // Mettre à jour les crises
      updateCrises();
      
      // Afficher le message
      if (message) {
        document.getElementById("message").textContent = message;
      }
    }
    
    // ==================== FONCTIONS DE TRICHE ====================
    
    function addMoney() {
      gameState.money += 1000;
      updateUI("Test : +1000€");
    }
    
    function addOneNature() {
      gameState.nature += 100;
      updateUI("Test : +100 ressources");
    }
    
    function addClicks50() {
      gameState.clicks += 50;
      updateUI("Test : +50 clics - Total : " + gameState.clicks + " clics");
    }
    
    // ==================== INITIALISATION ====================
    
    // Démarrage du jeu
    updateUI("");
  </script>
</body>
</html>
