<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Looop ‚Äî UI v1.26.1 + M√©caniques v1.30 (EH complet)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --card:#fff; --ink:#111; --muted:#666; --bg:#f3f3f3; --shadow:#0001;
    --ok:#2e7d32; --okbg:#e6ffe6; --okbd:#66cc66;
    --warn:#cc5500; --warnbg:#fff2e6; --warnbd:#ff8533;
    --err:#c00; --errbg:#ffe6e6; --errbd:#ff6666;
    --info:#0066cc; --infobg:#e6f3ff; --infobd:#4da6ff;
    --gold:#8a6d00; --goldbg:#fff9c4; --goldbd:#f4d03f;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
  h1{ text-align:center; margin:22px 0 8px; }
  .sub{ font-size:.78em; color:#777; font-weight:600;}
  .container{ display:flex; justify-content:center; align-items:flex-start; gap:22px; margin:0 auto 18px; max-width:980px; padding:0 10px;}
  .category{ background:var(--card); border-radius:18px; box-shadow:0 4px 24px var(--shadow); flex:1; padding:26px 16px 16px; min-width:260px; max-width:330px;}
  .cat-title{ font-size:1.2em; font-weight:800; margin-bottom:12px; letter-spacing:.5px;}
  .stock{ font-size:1.05em; margin-bottom:8px;}
  .products-box{ background:#f7f7fa; border:2px solid #dde1eb; border-radius:10px; color:#333; margin:10px 0; padding:10px 22px; font-size:1.05em; font-weight:700; text-align:center; box-shadow:0 1px 4px #ddd5;}
  .message-box{ border-radius:10px; margin:8px 0 12px; padding:10px 12px; font-weight:700; font-size:1.02em; box-shadow:0 1px 4px #0002; text-align:center;}
  .msg-orange{ background:var(--warnbg); color:var(--warn); border:2px solid var(--warnbd);}
  .msg-red{ background:var(--errbg); color:var(--err); border:2px solid var(--errbd);}
  .msg-blue{ background:var(--infobg); color:var(--info); border:2px solid var(--infobd);}
  .msg-green{ background:var(--okbg); color:var(--ok); border:2px solid var(--okbd);}
  .msg-gold{ background:var(--goldbg); color:var(--gold); border:2px solid var(--goldbd);}
  .btn-row{ margin-top:14px; display:flex; flex-direction:column; align-items:center; gap:8px;}
  button{ font-size:1em; padding:10px 16px; border:none; border-radius:12px; background:#ededed; color:var(--ink); cursor:pointer; transition:transform .06s;}
  button:active{ transform:translateY(1px); }
  .btn-credit{ background:#ff6b35; color:#fff; font-weight:700;}
  .btn-evo{ background:#4CAF50; color:#fff; font-weight:700;}
  .btn-yellow{ background:#FFD600; color:#222; font-weight:700;}
  .btn-annuler{ background:#999; color:#fff;}
  .btn-invest{ background:#2e7d32; color:#fff; font-weight:700;}
  .btn-restart{ background:#2196F3; color:#fff; font-weight:700;}
  .automatisms-controls{ margin:14px auto; max-width:980px; display:none; justify-content:center; gap:10px; flex-wrap:wrap; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px #0001;}
  .control-btn{ font-size:.9em; padding:8px 12px; border-radius:8px; min-width:90px; border:none; }
  .active{ background:#4CAF50; color:#fff; } .inactive{ background:#f44336; color:#fff; } .disabled{ background:#ccc; color:#777;}
  #clics-container{ text-align:center; margin:16px 0; font-weight:800;}
  .jrow{ max-width:700px; margin:0 auto 6px; display:flex; align-items:center; gap:8px;}
  .jlabel{ min-width:120px; font-size:.95em; color:#666; text-align:right;}
  .bar{ background:#eee; border-radius:8px; height:13px; flex:1; overflow:hidden;}
  .fill{ height:100%; border-radius:8px; transition:width .19s;}
  #jauge-nature{ background:#86e08e;} #jauge-confort{ background:#86b6ea;} #jauge-money{ background:#ffb3b3;} #jauge-budget{ background:#ff9800;}
  #jauge-achat-auto{ background:#ffa726;} #jauge-ia{ background:#ab47bc;} #jauge-trader{ background:#26c6da;} #jauge-centre{ background:#66bb6a;} #jauge-tech{ background:#9c27b0;}
  .jval{ min-width:70px; text-align:right; font-size:.95em; color:#333;}
  .optimum-zone{ margin:12px auto; max-width:980px; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px #0001; text-align:center;}
  .optimum-progress-bar{ background:#eee; height:18px; border-radius:20px; max-width:420px; margin:10px auto; overflow:hidden; position:relative;}
  .optimum-progress-fill{ height:100%; background:linear-gradient(90deg,#4CAF50,#81C784); width:0%;}
  .optimum-progress-text{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:800; color:#333; font-size:.95em;}
  .optimum-victory{ background:var(--goldbg); border:2px solid var(--goldbd); color:var(--gold); padding:18px; border-radius:14px; font-size:1.12em; font-weight:800; text-align:center; margin:14px auto; max-width:680px; display:none; animation:victoryPulse 2s infinite;}
  @keyframes victoryPulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.02)}}
  .events-zone{ margin:12px auto; max-width:980px; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px #0001;}
  .event-notification{ background:#f0f8f0; border:2px solid #81c784; border-radius:10px; padding:10px; font-weight:700; color:#2e7d32; display:none;}
  /* Bloc investissement √©cologique avanc√© (EH) */
  .investment-block{ background:#e8f5e8; border:2px solid #81c784; border-radius:10px; padding:12px; margin:10px 0;}
  .investment-title{ font-weight:800; color:#2e7d32; margin-bottom:8px; text-align:center;}
  .investment-controls{ display:flex; align-items:center; justify-content:center; flex-wrap:wrap; gap:6px;}
  .investment-input{ width:110px; padding:8px; border:1px solid #ccc; border-radius:8px; font-size:1em;}
  .investment-list{ font-size:.92em; color:#555; margin-top:8px; max-height:120px; overflow-y:auto;}
  .investment-preview{ font-size:.85em; color:#2e7d32; margin-top:4px; font-style:italic; min-height:16px;}
  /* Triche */
  #triche-sep{ border:none; border-top:3px solid #222; margin:22px auto 10px; width:94vw; max-width:980px;}
  #triche-label{ max-width:980px; margin:0 auto 10px; color:#555;}
  .debug-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px auto 24px;}
  /* Responsive */
  @media (max-width:720px){
    .container{ flex-direction:column; gap:10px;}
    .category{ max-width:unset;}
    .jrow{ max-width:calc(100vw - 22px); }
    .investment-input{ width:140px; }
  }
</style>
</head>
<body>
  <h1>üåç Looop <span class="sub">UI v1.26.1 + M√©caniques v1.30 ‚Ä¢ EH complet ‚Ä¢ paliers hybrides</span></h1>

  <!-- Contr√¥les des automatismes -->
  <div class="automatisms-controls" id="automatisms-controls">
    <button id="control-ia" class="control-btn disabled" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button id="control-trader" class="control-btn disabled" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button id="control-confort" class="control-btn disabled" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button id="control-centre" class="control-btn disabled" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>

  <!-- Zone d'√©quilibre -->
  <div class="optimum-zone" id="optimum-zone">
    <div style="font-weight:800;">üéØ Zone d'√©quilibre</div>
    <div class="optimum-progress-bar">
      <div class="optimum-progress-fill" id="optimum-progress-fill"></div>
      <div class="optimum-progress-text" id="optimum-progress-text">0 / 50</div>
    </div>
    <div id="optimum-status" style="font-size:.95em;color:#555;">Objectif : maintenir l'√©quilibre pendant 50 actions</div>
  </div>

  <!-- Zone √©v√©nements -->
  <div class="events-zone">
    <div style="font-weight:800;margin-bottom:6px;">üåø √âv√©nements al√©atoires</div>
    <div id="event-box" class="event-notification">
      <span id="event-text"></span>
      <div id="event-effects" style="font-size:.9em;color:#666;margin-top:4px;"></div>
    </div>
  </div>

  <div class="container">
    <!-- Environnement -->
    <div class="category">
      <div class="cat-title">üå± Environnement</div>
      <div class="stock">Ressources : <span id="nature">3000</span></div>
      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>

      <!-- Bloc investissement √©cologique (EH avanc√©) -->
      <div id="investment-block" class="investment-block" style="display:none;">
        <div class="investment-title">üå± Investissement √©cologique (retour apr√®s 10 clics)</div>
        <div class="investment-controls">
          <input type="number" id="investment-amount" class="investment-input" placeholder="Montant ‚Ç¨" min="1" oninput="updateInvestmentPreview()">
          <button class="btn-invest" onclick="makeEcologicalInvestment()">üíö Investir</button>
        </div>
        <div id="investment-preview" class="investment-preview"></div>
        <div id="investment-list" class="investment-list">Aucun investissement en cours</div>
      </div>

      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
        <button id="invest-eco-fixed" class="btn-invest" style="display:none;" onclick="investirEcologieFixe()">üåø Investir √©cologie (‚Äë200‚Ç¨ ‚Üí +30 üå±)</button>
      </div>
    </div>

    <!-- Exosomatisation -->
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock">Confort : <span id="confort">0</span></div>
      <div class="products-box">Produits cr√©√©s<br><span id="production">0</span></div>
      <div id="social-crise" class="message-box msg-red" style="display:none;"></div>
      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">üõãÔ∏è Acheter du confort (100‚Ç¨)</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>
      </div>
    </div>

    <!-- √âconomie -->
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock" id="money-row" style="display:none;">Monnaie (‚Ç¨) : <span id="money">10</span></div>
      <div class="stock" id="budget-row" style="display:none;">Budget de l'√âtat : <span id="budget">0</span> ‚Ç¨</div>
      <div class="products-box" id="price-indicator" style="display:none;">Prix de vente<br><span id="current-price">1‚Ç¨</span></div>

      <button id="don-btn" onclick="receiveDon()">Recevoir mon don</button>
      <button id="credit-btn" class="btn-credit" style="display:none;" onclick="activateCredit()">üí≥ Valider le cr√©dit</button>
      <button id="nego-taux-btn" class="btn-yellow" style="display:none;" onclick="negocierTaux()">ü§ù N√©gocier mon cr√©dit (2000‚Ç¨)</button>

      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="ouvrier-btn" style="display:none;" onclick="acheterIA()">ü§ñ Engager une IA</button>
        <button id="trader-btn" style="display:none;" onclick="acheterTrader()">ü§ñ Trader automatique</button>
        <button id="comfort-auto-btn" style="display:none;" onclick="acheterConfortAuto()">üîÑ Achat auto confort</button>
        <button id="upgrade-btn" style="display:none;" onclick="upgradeProd()">üí† Upgrade production</button>
        <button id="centre-commercial-btn" style="display:none;" onclick="acheterCentre()">üè¨ Centre commercial</button>
        <button id="automatisms-btn" style="display:none;" onclick="acheterAutomatismsClics()">‚ö° Automatismes = clics</button>
        <button id="price-indicator-btn" style="display:none;" onclick="acheterIndicateur()">üìä Indicateur de prix</button>
        <button id="evolution-btn" class="btn-evo" style="display:none;" onclick="evolution()">üå± √âvolution √©conomique (EH)</button>
        <button id="rescue-eh-btn" class="btn-evo" style="display:none;" onclick="activateRescueEH()">üå± Passer √† l‚ÄôEH (secours)</button>
      </div>
    </div>
  </div>

  <!-- Jauges principales -->
  <div style="margin:0 auto 10px; max-width:740px;">
    <div class="jrow"><div class="jlabel">üå± Ressources</div><div class="bar"><div id="jauge-nature" class="fill" style="width:0%"></div></div><div class="jval" id="jnature">3000</div></div>
    <div class="jrow" id="jg-confort" style="display:none;"><div class="jlabel">ü§ñ Confort</div><div class="bar"><div id="jauge-confort" class="fill"></div></div><div class="jval" id="jconfort">0</div></div>
    <div class="jrow" id="jg-money" style="display:none;"><div class="jlabel">üí∂ Monnaie</div><div class="bar"><div id="jauge-money" class="fill"></div></div><div class="jval" id="jmoney">10‚Ç¨</div></div>
    <div class="jrow" id="jg-budget" style="display:none;"><div class="jlabel">üèõÔ∏è Budget √âtat</div><div class="bar"><div id="jauge-budget" class="fill"></div></div><div class="jval" id="jbudget">0‚Ç¨</div></div>
    <div class="jrow" id="jg-achat-auto" style="display:none;"><div class="jlabel">üîÑ Achat auto</div><div class="bar"><div id="jauge-achat-auto" class="fill"></div></div><div class="jval" id="jachat">√ó0</div></div>
    <div class="jrow" id="jg-ia" style="display:none;"><div class="jlabel">ü§ñ IA</div><div class="bar"><div id="jauge-ia" class="fill"></div></div><div class="jval" id="jia">√ó0</div></div>
    <div class="jrow" id="jg-trader" style="display:none;"><div class="jlabel">üí∞ Trader</div><div class="bar"><div id="jauge-trader" class="fill"></div></div><div class="jval" id="jtrader">√ó0</div></div>
    <div class="jrow" id="jg-centre" style="display:none;"><div class="jlabel">üè¨ Centre</div><div class="bar"><div id="jauge-centre" class="fill"></div></div><div class="jval" id="jcentre">√ó0</div></div>
    <div class="jrow" id="jg-tech" style="display:none;"><div class="jlabel">üí† Technologie</div><div class="bar"><div id="jauge-tech" class="fill"></div></div><div class="jval" id="jtech">Niv.0 (√ó1.0)</div></div>
  </div>

  <div id="message" style="text-align:center; font-weight:800; min-height:22px; margin:8px 0;"></div>
  <div id="clics-container">Clics/actions : <span id="clicks">0</span></div>

  <!-- Victoire -->
  <div id="optimum-victory" class="optimum-victory">
    üèÜ VICTOIRE ! Vous avez maintenu l'√©quilibre optimum pendant 50 actions !<br/>
    <button class="btn-restart" onclick="restartGame()" style="margin-top: 10px;">üîÑ Recommencer une partie</button>
  </div>

  <!-- Triche -->
  <hr id="triche-sep">
  <div id="triche-label">Triche (tests)</div>
  <div class="debug-row">
    <button class="btn-yellow" onclick="addMoney()">+1000 ‚Ç¨</button>
    <button class="btn-yellow" onclick="addNature()">+100 ressources</button>
    <button class="btn-yellow" onclick="addClicks()">+50 clics</button>
    <button class="btn-yellow" onclick="forceActivateEH()">Forcer EH</button>
    <button class="btn-yellow" onclick="toggleEvents()">üé≤ √âv√©nements ON/OFF</button>
    <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler</button>
  </div>

<script>
/* ==========================================================
   1) √âTAT & CONSTANTES (param√©trable)
   ========================================================== */
const CONST = {
  // Fiscalit√©
  taxEveryClicks: 20,
  taxRate: 0.20,

  // Cr√©dit
  creditRateStart: 0.05,
  creditRateMin: 0.01,
  negoStep: 0.01,
  negoCost: 2000,
  negoEveryClicks: 300,
  negoMax: 3,

  // EH
  ehAutoTriggerAt: 50,
  ehSuggestAt: 100,
  ehTransactionTax: 0.04,
  ehDonationEvery: 10,
  ehPrimeEvery: 50,
  ehFonteEvery: 10,
  ehBonusEvery: 10,

  // Production & upgrades
  baseProdCost: 5,
  upgradeCost: 2000,
  upgradesMax: 3,
  upgradeMult: 1.5,

  // Automatismes (prix base √ó multiplicateur co√ªt cyclique)
  palCosts: {
    ia: {base: 500, mult:1.5, cycle:200, label:"Engager une IA"},
    trader: {base:1000, mult:1.5, cycle:500, label:"Trader automatique"},
    autoConfort: {base:2000, mult:1.5, cycle:700, label:"Achat auto confort"},
    centre: {base:5000, mult:1.5, cycle:1100, label:"Centre commercial"},
    upgrade: {base:2000, mult:1.5, cycle:600, label:"Am√©liorer la production"},
    comfort: {base:100, mult:1.0, cycle:0, label:"Achat confort"},
    autoClicks: {base:10000, mult:1.0, cycle:0, label:"Automatismes = clics"},
    priceIndicator: {base:30000, mult:1.0, cycle:0, label:"Indicateur de prix"}
  },

  // Paliers fixes d‚Äôapparition (visibilit√©) v1.30
  paliersFixes: {
    comfort: 120,
    ia: 200,
    trader: 500,
    autoConfort: 700,
    autoClicks: 750,
    priceIndicator: 1000,
    centre: 1100,
    upgrades: [400,700,1100]
  },

  // Zone d‚Äô√©quilibre
  optimumRanges: { nature:[1800,2600], confort:[10,35], money:[400,1200] },
  optimumTarget: 50,

  // Timers automatismes
  tickIA: 5000,      // 5s
  tickTrader: 3000,  // 3s
  tickConfort: 15000,// 15s
  tickCentre: 15000  // 15s
};

let gameState = {
  // Stocks
  nature: 3000, confort: 0, production: 0, money: 10,
  // Syst√®mes
  clicks: 0, monnaieActive: false, priceIndicator: false, budgetEtat: 0,
  // Fiscalit√©
  taxEnabled: true,
  // Cr√©dit
  creditButtonShown: false, pendingPurchase: null,
  creditRate: CONST.creditRateStart, creditNegotiationsUsed: 0, lastNegotiationShownAt: 0,
  // EH
  ehActivated: false, ecologicalInvestments: [],
  ehPrimeClicks: 0, ehFonteClicks: 0, ehBonusClicks: 0, ehDonationClicks: 0,
  // Automatismes
  ia: 0, trader: 0, autoConfort: 0, centre: 0, automationsClickScore: false,
  // Tech
  techLevel: 0, productionMultiplier: 1.0, prodCostUpgradesBought: 0,
  // Paliers cycliques (compteurs d‚Äôachats)
  nb: { ia:0, trader:0, autoConfort:0, centre:0, upgrade:0 },
  // √âtats
  jeuBloque: false, gameOver: false, gameOverCause: null, confortMaxAtteint: 0,
  // Optimum
  optimumStreak: 0, optimumVictory: false,
  // √âv√©nements
  eventsEnabled: true, eventsRecent: [], nextEventIn: 0, activeTempEffects: []
};

// Sauvegarde pour Undo
let lastState = null;

// Intervalles
const intervals = { ia:null, trader:null, autoConfort:null, centre:null };

/* ==========================================================
   2) OUTILS
   ========================================================== */
function saveState(){
  lastState = {
    gs: JSON.parse(JSON.stringify(gameState)),
    ev: randomEventsSystem.getFullState()
  };
}
function undoAction(){
  if(!lastState) return;
  clearAllIntervals();
  gameState = JSON.parse(JSON.stringify(lastState.gs));
  randomEventsSystem.restoreFullState(lastState.ev);
  restartAutomatisms();
  showMsg("‚è™ Action annul√©e");
  updateUIValues();
}
function clearAllIntervals(){ Object.keys(intervals).forEach(k=>{ if(intervals[k]){ clearInterval(intervals[k]); intervals[k]=null; } }); }
function restartAutomatisms(){
  if (gameState.ia>0) startIA();
  if (gameState.trader>0) startTrader();
  if (gameState.autoConfort>0) startAutoConfort();
  if (gameState.centre>0) startCentre();
}
function showMsg(t){
  const m = document.getElementById("message"); if(!m) return;
  m.textContent = t;
  setTimeout(()=>{ if(m.textContent===t) m.textContent=""; }, 4000);
}
function calculatePrice(){
  if (gameState.nature<=0) return 1;
  const base = Math.max(1, Math.abs(gameState.money)/gameState.nature);
  return Math.round(base*100)/100;
}
function applyEHTaxOnTransaction(amount){
  if(!gameState.ehActivated) return 0;
  const tax = Math.round(Math.abs(amount) * CONST.ehTransactionTax);
  gameState.money -= tax;
  return tax;
}

/* ==========================================================
   3) FISCALIT√â / INT√âR√äTS / DONS & PRIMES EH
   ========================================================== */
function maybeApplyTax(){
  if (!gameState.taxEnabled) return;
  if (gameState.clicks>0 && gameState.clicks % CONST.taxEveryClicks === 0){
    const tax = Math.ceil(Math.abs(gameState.money) * CONST.taxRate);
    gameState.money -= tax;
    gameState.nature += 1;
    gameState.confort += 1;
    gameState.budgetEtat += tax;
    updateBudgetUI();
    showMsg(`üí∏ Imp√¥t : -${tax}‚Ç¨ | +1 üå± | +1 ü§ñ (Budget √âtat +${tax}‚Ç¨)`);
  }
}
function applyOverdraftInterest(){
  if (gameState.money < 0){
    const due = Math.ceil(Math.abs(gameState.money) * gameState.creditRate);
    if (due>0){ gameState.money -= due; showMsg(`üí£ Int√©r√™ts : -${due}‚Ç¨ (taux ${Math.round(gameState.creditRate*100)}%)`); }
    // Bouton n√©go visible si conditions remplies (tous les 300 clics, max 3 usages, pas bloqu√©)
    const atStep = Math.floor(gameState.clicks / CONST.negoEveryClicks);
    const shouldShow = (gameState.clicks>0 &&
                        gameState.clicks % CONST.negoEveryClicks === 0 &&
                        gameState.creditNegotiationsUsed < CONST.negoMax &&
                        gameState.lastNegotiationShownAt !== gameState.clicks);
    document.getElementById("nego-taux-btn").style.display = shouldShow ? "inline-block":"none";
    if (shouldShow) gameState.lastNegotiationShownAt = gameState.clicks;
  } else {
    document.getElementById("nego-taux-btn").style.display = "none";
  }
}
function negocierTaux(){
  if (gameState.creditNegotiationsUsed >= CONST.negoMax){ showMsg("ü§ù N√©go √©puis√©e (3/3)"); return; }
  const cost = CONST.negoCost;
  saveState();
  // D√©bit (en EH on taxe la transaction)
  let debit = cost;
  gameState.money -= debit;
  applyEHTaxOnTransaction(debit);
  gameState.creditRate = Math.max(CONST.creditRateMin, +(gameState.creditRate - CONST.negoStep).toFixed(2));
  gameState.creditNegotiationsUsed++;
  showMsg(`ü§ù Taux n√©goci√© : ${Math.round(gameState.creditRate*100)}% (co√ªt ${cost}‚Ç¨)`);
  updateUIValues();
}

/* ==========================================================
   4) EH ‚Äî cycles, primes, fonte, bonus, auto‚Äëdon, investissements
   ========================================================== */
function evolution(){
  if (gameState.ehActivated || gameState.optimumVictory) return;
  saveState();
  gameState.clicks++;
  maybeApplyTax(); // priorit√©: bascule EH apr√®s avoir √©valu√© le clic en cours
  // Activation EH (bonus d‚Äôentr√©e doux : rien de sp√© ici, la spec ne l‚Äôexige pas)
  gameState.ehActivated = true;
  gameState.taxEnabled = false;
  document.getElementById("invest-eco-fixed").style.display = "inline-block";
  document.getElementById("investment-block").style.display = "block";
  document.getElementById("eh-success").style.display = "block";
  document.getElementById("eh-success").textContent = "üå± √âconomie hom√©ostatique activ√©e";
  // On coupe les automatismes par d√©faut (relan√ßables plus tard si tu veux √©voluer √ßa)
  clearAllIntervals();
  updateUI("Passage √† l'EH");
}
function checkEHMechanics(){
  if (!gameState.ehActivated) return;
  // Dons auto (micro) chaque 10 actions : +d au joueur et +d au budget
  if (gameState.clicks>0 && gameState.clicks % CONST.ehDonationEvery === 0){
    const d = computeDonByResources();
    gameState.money += d;
    gameState.budgetEtat += d;
    updateBudgetUI();
    showMsg(`üéÅ Don EH : +${d}‚Ç¨ (Budget √âtat +${d}‚Ç¨)`);
  }
  // Prime EH chaque 50 actions : montant proportionnel √† l‚Äô√©tat de nature (inspiration v1.26.1)
  if (gameState.clicks>0 && gameState.clicks % CONST.ehPrimeEvery === 0){
    const prime = computeEhPrime();
    if (prime>0){ gameState.money += prime; gameState.budgetEtat += prime; updateBudgetUI(); showMsg(`üå± Prime EH : +${prime}‚Ç¨ (Budget √âtat +${prime}‚Ç¨)`); }
  }
  // Fonte mon√©taire ¬±4% vers 0 (toutes les 10 actions)
  if (gameState.clicks>0 && gameState.clicks % CONST.ehFonteEvery === 0){
    const amt = Math.round(Math.abs(gameState.money)*0.04);
    if (gameState.money>0) gameState.money -= amt; else if (gameState.money<0) gameState.money += amt;
    showMsg("üí∏ Fonte EH : 4% vers 0");
  }
  // Bonus +1/+1 toutes les 10 actions
  if (gameState.clicks>0 && gameState.clicks % CONST.ehBonusEvery === 0){
    gameState.nature += 1; gameState.confort += 1;
  }
  // Maturation des investissements avanc√©s
  processEcologicalInvestments();
}
function computeDonByResources(){
  // Don plus √©lev√© quand ressources basses ‚Äî bornes souples
  const lack = Math.max(0, 3000 - gameState.nature);
  return Math.min(1200, Math.max(200, Math.floor(lack * 0.5)));
}
function computeEhPrime(){
  // Prime proportionnelle √† l‚Äô√©tat de nature, inspir√©e de v1.26.1
  // Ici on la relie √† |money| pour garder une tension macro
  if (gameState.nature<=0) return 0;
  let percent = 0;
  if (gameState.nature >= 1500) percent = (gameState.nature/1500)*100;
  else if (gameState.nature >= 300) percent = 10 + ((gameState.nature-300)/(1500-300))*90;
  else percent = 10;
  return Math.round(Math.abs(gameState.money) * (percent/100));
}
function investirEcologieFixe(){
  if (!gameState.ehActivated) return;
  const cost = 200;
  if (gameState.money < cost){ showMsg("Pas assez d'‚Ç¨ (200‚Ç¨)"); return; }
  saveState();
  gameState.money -= cost;
  applyEHTaxOnTransaction(cost);
  gameState.nature += 30;
  gameState.clicks++;
  randomEventsSystem.processClick(false);
  applyOverdraftInterest();
  checkEHMechanics();
  updateUI("üåø Investissement fixe : -200‚Ç¨ ‚Üí +30 ressources");
}

/* === Investissements EH avanc√©s (saisie libre) === */
function updateInvestmentPreview(){
  const input = document.getElementById("investment-amount");
  const pv = document.getElementById("investment-preview");
  const amount = +input.value;
  if (!amount || amount<=0){ pv.textContent=""; return; }
  const maxInvestment = (gameState.money >= 0 ? gameState.money : Math.abs(gameState.money));
  if (amount > maxInvestment){ pv.textContent = `‚ùå Montant trop √©lev√© (max ${maxInvestment}‚Ç¨)`; pv.style.color = "#c00"; return; }
  const moneyReturn = amount + Math.ceil(amount*0.02);
  const gain = previewResourcesGain(amount);
  pv.textContent = `üìà Retour dans 10 clics : +${gain} ressources, +${moneyReturn}‚Ç¨`;
  pv.style.color = "#2e7d32";
}
function previewResourcesGain(amount){
  const plafond=3000, facteur=30;
  const bonus = (amount/(gameState.nature+1)) * (plafond/(gameState.nature+1));
  let g = Math.max(3, Math.round(bonus*facteur));
  return Math.min(g, 50);
}
function makeEcologicalInvestment(){
  if (!gameState.ehActivated || gameState.optimumVictory) return;
  const input = document.getElementById("investment-amount");
  const amount = +input.value;
  if (!amount || amount<=0){ showMsg("Montant invalide"); return; }
  const maxInvestment = (gameState.money >= 0 ? gameState.money : Math.abs(gameState.money));
  if (amount > maxInvestment){ showMsg(`Montant trop √©lev√© (max ${maxInvestment}‚Ç¨)`); return; }
  saveState();
  gameState.money -= amount;
  applyEHTaxOnTransaction(amount);
  gameState.ecologicalInvestments.push({amount, remainingClicks:10, startClick:gameState.clicks});
  input.value=""; updateInvestmentPreview(); updateInvestmentDisplay();
  showMsg(`Investissement √©cologique ${amount}‚Ç¨ (retour dans 10 clics)`);
  updateUIValues();
}
function processEcologicalInvestments(){
  if (gameState.ecologicalInvestments.length===0) return;
  let totR=0, totM=0;
  for (let i=gameState.ecologicalInvestments.length-1; i>=0; i--){
    const inv = gameState.ecologicalInvestments[i];
    inv.remainingClicks--;
    if (inv.remainingClicks<=0){
      const gainR = previewResourcesGain(inv.amount);
      const retM = inv.amount + Math.ceil(inv.amount*0.02);
      gameState.nature += gainR;
      gameState.money += retM;
      totR += gainR; totM += retM;
      gameState.ecologicalInvestments.splice(i,1);
    }
  }
  if (totR>0){ showMsg(`üå± Investissement : +${totR} ressources, +${totM}‚Ç¨ r√©cup√©r√©s`); }
  updateInvestmentDisplay();
}
function updateInvestmentDisplay(){
  const list = document.getElementById("investment-list");
  if (!list) return;
  if (gameState.ecologicalInvestments.length===0){ list.textContent = "Aucun investissement en cours"; return; }
  list.innerHTML = "Investissements en cours :<br/>" +
    gameState.ecologicalInvestments.map(inv=>`‚Ä¢ ${inv.amount}‚Ç¨ (dans ${inv.remainingClicks} clics)`).join("<br/>");
}

/* ==========================================================
   5) CR√âDIT (one‚Äëshot) + Achats
   ========================================================== */
function needsCredit(cost){ return (gameState.money < cost) && !gameState.creditButtonShown; }
function showCreditButton(purchaseType, cost){
  gameState.pendingPurchase = { type: purchaseType, cost: cost };
  document.getElementById("credit-btn").style.display = "inline-block";
  gameState.creditButtonShown = true; // une seule fois par partie
  showMsg("üí≥ Cr√©dit disponible pour finaliser l'achat.");
}
function activateCredit(){
  if (!gameState.pendingPurchase) return;
  // ex√©cuter l‚Äôachat m√™me si solde passe n√©gatif
  const p = gameState.pendingPurchase;
  saveState();
  gameState.money -= p.cost;
  if (gameState.ehActivated) applyEHTaxOnTransaction(p.cost);
  // Appliquer l'effet
  switch(p.type){
    case 'comfort': gameState.confort += 1; break;
    case 'ia': gameState.ia += 1; startIA(); break;
    case 'trader': gameState.trader += 1; startTrader(); break;
    case 'autoConfort': gameState.autoConfort += 1; startAutoConfort(); break;
    case 'centre': gameState.centre += 1; startCentre(); break;
    case 'upgrade': applyProdUpgrade(); break;
    case 'autoClicks': gameState.automationsClickScore = true; break;
    case 'pi': gameState.priceIndicator = true; break;
  }
  gameState.clicks++;
  randomEventsSystem.processClick(false);
  applyOverdraftInterest();
  if (gameState.ehActivated) checkEHMechanics();
  document.getElementById("credit-btn").style.display = "none";
  gameState.pendingPurchase = null;
  updateUI("Cr√©dit valid√© ‚úÖ");
}
/* Achats de base */
function acheterConfort(){
  if (!gameState.monnaieActive){ updateUI("Active d'abord la monnaie (vendre / don)"); return; }
  const cost = 100;
  if (needsCredit(cost)){ showCreditButton('comfort', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState(); gameState.money -= cost; if(gameState.ehActivated) applyEHTaxOnTransaction(cost);
  gameState.confort += 1; gameState.clicks++;
  randomEventsSystem.processClick(false); maybeApplyTax(); applyOverdraftInterest(); if(gameState.ehActivated) checkEHMechanics();
  updateUI("Confort +1");
}
function acheterIA(){
  const cost = currentCost('ia');
  if (needsCredit(cost)){ showCreditButton('ia', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState(); gameState.money -= cost; if(gameState.ehActivated) applyEHTaxOnTransaction(cost);
  gameState.ia = (gameState.ia===0?1:gameState.ia*2); // croissance exponentielle type v1.26.1
  gameState.nb.ia++; gameState.clicks++; startIA();
  randomEventsSystem.processClick(false); maybeApplyTax(); applyOverdraftInterest(); if(gameState.ehActivated) checkEHMechanics();
  updateUI("IA engag√©e ! √ó"+gameState.ia);
}
function acheterTrader(){
  const cost = currentCost('trader');
  if (needsCredit(cost)){ showCreditButton('trader', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState(); gameState.money -= cost; if(gameState.ehActivated) applyEHTaxOnTransaction(cost);
  gameState.trader = (gameState.trader===0?1:gameState.trader*2);
  gameState.nb.trader++; gameState.clicks++; startTrader();
  randomEventsSystem.processClick(false); maybeApplyTax(); applyOverdraftInterest(); if(gameState.ehActivated) checkEHMechanics();
  updateUI("Trader auto √ó"+gameState.trader);
}
function acheterConfortAuto(){
  const cost = currentCost('autoConfort');
  if (needsCredit(cost)){ showCreditButton('autoConfort', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState(); gameState.money -= cost; if(gameState.ehActivated) applyEHTaxOnTransaction(cost);
  gameState.autoConfort = (gameState.autoConfort===0?1:gameState.autoConfort*2);
  gameState.nb.autoConfort++; gameState.clicks++; startAutoConfort();
  randomEventsSystem.processClick(false); maybeApplyTax(); applyOverdraftInterest(); if(gameState.ehActivated) checkEHMechanics();
  updateUI("Achat auto confort √ó"+gameState.autoConfort);
}
function acheterCentre(){
  const cost = currentCost('centre');
  if (needsCredit(cost)){ showCreditButton('centre', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState(); gameState.money -= cost; if(gameState.ehActivated) applyEHTaxOnTransaction(cost);
  gameState.centre = (gameState.centre===0?1:gameState.centre*2);
  gameState.nb.centre++; gameState.clicks++; startCentre();
  randomEventsSystem.processClick(false); maybeApplyTax(); applyOverdraftInterest(); if(gameState.ehActivated) checkEHMechanics();
  updateUI("Centre commercial √ó"+gameState.centre);
}
function upgradeProd(){
  if (gameState.prodCostUpgradesBought>=CONST.upgradesMax){ updateUI("Am√©liorations √©puis√©es"); return; }
  const cost = currentCost('upgrade'); // hybride : co√ªt cyclique + paliers fixes d‚Äôapparition
  if (needsCredit(cost)){ showCreditButton('upgrade', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState(); gameState.money -= cost; if(gameState.ehActivated) applyEHTaxOnTransaction(cost);
  applyProdUpgrade(); gameState.clicks++;
  randomEventsSystem.processClick(false); maybeApplyTax(); applyOverdraftInterest(); if(gameState.ehActivated) checkEHMechanics();
  updateUI("üí† Upgrade : co√ªt prod -1 & multiplicateur √ó1.5");
}
function applyProdUpgrade(){
  gameState.prodCostUpgradesBought = Math.min(CONST.upgradesMax, gameState.prodCostUpgradesBought+1);
  gameState.productionMultiplier = +(gameState.productionMultiplier*CONST.upgradeMult).toFixed(2);
  gameState.techLevel++;
  gameState.nb.upgrade++;
  document.getElementById("jg-tech").style.display="flex";
  document.getElementById("upgrade-btn").style.display="none";
}
function acheterAutomatismsClics(){
  const cost = currentCost('autoClicks');
  if (needsCredit(cost)){ showCreditButton('autoClicks', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState(); gameState.money -= cost; if(gameState.ehActivated) applyEHTaxOnTransaction(cost);
  gameState.automationsClickScore = true; gameState.clicks++;
  randomEventsSystem.processClick(false); maybeApplyTax(); applyOverdraftInterest(); if(gameState.ehActivated) checkEHMechanics();
  updateUI("‚ö° Les automatismes comptent comme des clics");
}
function acheterIndicateur(){
  const cost = currentCost('priceIndicator');
  if (needsCredit(cost)){ showCreditButton('pi', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState(); gameState.money -= cost; if(gameState.ehActivated) applyEHTaxOnTransaction(cost);
  gameState.priceIndicator = true; gameState.clicks++;
  randomEventsSystem.processClick(false); maybeApplyTax(); applyOverdraftInterest(); if(gameState.ehActivated) checkEHMechanics();
  document.getElementById("price-indicator").style.display="block";
  updateUI("üìä Indicateur de prix activ√©");
}

/* ==========================================================
   6) ACTIONS de base
   ========================================================== */
function produce(){
  if (gameState.jeuBloque||gameState.gameOver||gameState.optimumVictory) return;
  saveState();
  const unitCost = Math.max(1, CONST.baseProdCost - gameState.prodCostUpgradesBought); // 5‚Üí2
  if (gameState.nature >= unitCost){
    gameState.nature -= unitCost;
    const prod = Math.floor(gameState.productionMultiplier);
    gameState.production += prod;
    gameState.clicks++;
    randomEventsSystem.processClick(false);
    if (!gameState.ehActivated) maybeApplyTax(); else checkEHMechanics();
    applyOverdraftInterest();
    updateUI(`Production +${prod} (co√ªt ${unitCost})`);
  } else {
    updateUI("Ressources insuffisantes");
  }
}
function sell(){
  if (gameState.jeuBloque||gameState.gameOver||gameState.optimumVictory) return;
  if (gameState.production<=0){ updateUI("Aucun produit √† vendre"); return; }
  saveState();
  const price = calculatePrice();
  const qty = 1;
  let rev = price * qty;
  gameState.money += rev;
  if (gameState.ehActivated) applyEHTaxOnTransaction(rev);
  gameState.production -= qty;
  gameState.clicks++;
  if (!gameState.monnaieActive){ gameState.monnaieActive = true; document.getElementById("money-row").style.display="block"; document.getElementById("jg-money").style.display="flex"; }
  randomEventsSystem.processClick(false);
  if (!gameState.ehActivated) maybeApplyTax(); else checkEHMechanics();
  applyOverdraftInterest();
  updateUI(`Vendu : +${rev.toFixed(2)}‚Ç¨`);
}
function receiveDon(){
  if (gameState.jeuBloque||gameState.gameOver||gameState.optimumVictory) return;
  saveState();
  // Don initial : on fixe √† 1000 pour d√©marrer la monnaie
  gameState.money = 1000;
  gameState.budgetEtat += 0; // (hors EH initial) ‚Äî l‚Äôalimentation du budget via dons/prime est en EH
  gameState.clicks++;
  if (!gameState.monnaieActive){ gameState.monnaieActive = true; document.getElementById("money-row").style.display="block"; document.getElementById("jg-money").style.display="flex"; }
  randomEventsSystem.processClick(false); if(!gameState.ehActivated) maybeApplyTax(); else checkEHMechanics();
  applyOverdraftInterest();
  document.getElementById("don-btn").style.display="none";
  updateUI("Don re√ßu : 1000‚Ç¨");
}

/* ==========================================================
   7) AUTOMATISMES
   ========================================================== */
function startIA(){
  if (intervals.ia) clearInterval(intervals.ia);
  document.getElementById("jg-ia").style.display="flex";
  intervals.ia = setInterval(function(){
    if (gameState.jeuBloque||gameState.gameOver||gameState.ehActivated||gameState.optimumVictory) return;
    if (gameState.ia<=0) return;
    // co√ªt ressource fixe 5 / IA (comme v1.26.1)
    const totalCost = 5 * gameState.ia;
    if (gameState.nature >= totalCost){
      gameState.nature -= totalCost;
      const prod = Math.floor(1 * gameState.ia * gameState.productionMultiplier);
      gameState.production += prod;
      if (gameState.automationsClickScore){
        gameState.clicks += prod;
        randomEventsSystem.processClick(true);
        maybeApplyTax(); applyOverdraftInterest();
      }
      updateUIValues();
    }
  }, CONST.tickIA);
  updateAutomatismControls();
}
function startTrader(){
  if (intervals.trader) clearInterval(intervals.trader);
  document.getElementById("jg-trader").style.display="flex";
  intervals.trader = setInterval(function(){
    if (gameState.jeuBloque||gameState.gameOver||gameState.ehActivated||gameState.optimumVictory) return;
    if (gameState.trader<=0 || gameState.production<=0) return;
    const sale = Math.min(gameState.production, gameState.trader);
    const price = calculatePrice();
    let rev = price * sale;
    gameState.money += rev;
    gameState.production -= sale;
    if (gameState.automationsClickScore){
      gameState.clicks += sale;
      randomEventsSystem.processClick(true);
      maybeApplyTax(); applyOverdraftInterest();
    }
    updateUIValues();
  }, CONST.tickTrader);
  updateAutomatismControls();
}
function startAutoConfort(){
  if (intervals.autoConfort) clearInterval(intervals.autoConfort);
  document.getElementById("jg-achat-auto").style.display="flex";
  intervals.autoConfort = setInterval(function(){
    if (gameState.jeuBloque||gameState.gameOver||gameState.ehActivated||gameState.optimumVictory) return;
    if (gameState.autoConfort<=0) return;
    const unit = gameState.autoConfort;
    const cost = 100 * unit;
    if (gameState.money >= cost || gameState.creditButtonShown){
      gameState.money -= cost;
      gameState.confort += unit;
      if (gameState.automationsClickScore){
        gameState.clicks += unit;
        randomEventsSystem.processClick(true);
        maybeApplyTax(); applyOverdraftInterest();
      }
      updateUIValues();
    }
  }, CONST.tickConfort);
  updateAutomatismControls();
}
function startCentre(){
  if (intervals.centre) clearInterval(intervals.centre);
  document.getElementById("jg-centre").style.display="flex";
  intervals.centre = setInterval(function(){
    if (gameState.jeuBloque||gameState.gameOver||gameState.ehActivated||gameState.optimumVictory) return;
    if (gameState.centre<=0) return;
    const achat = 10 * gameState.centre;
    const cost = 100 * achat;
    if (gameState.money >= cost || gameState.creditButtonShown){
      gameState.money -= cost;
      gameState.confort += achat;
      if (gameState.automationsClickScore){
        gameState.clicks += achat;
        randomEventsSystem.processClick(true);
        maybeApplyTax(); applyOverdraftInterest();
      }
      updateUIValues();
    }
  }, CONST.tickCentre);
  updateAutomatismControls();
}
function toggleAutomatism(type){
  // ON/OFF simple en stoppant/restart l‚Äôintervalle
  if (type==='ia'){ if (intervals.ia){ clearInterval(intervals.ia); intervals.ia=null; } else startIA(); }
  if (type==='trader'){ if (intervals.trader){ clearInterval(intervals.trader); intervals.trader=null; } else startTrader(); }
  if (type==='confort'){ if (intervals.autoConfort){ clearInterval(intervals.autoConfort); intervals.autoConfort=null; } else startAutoConfort(); }
  if (type==='centre'){ if (intervals.centre){ clearInterval(intervals.centre); intervals.centre=null; } else startCentre(); }
  updateAutomatismControls();
}
function updateAutomatismControls(){
  const any = gameState.ia>0||gameState.trader>0||gameState.autoConfort>0||gameState.centre>0;
  document.getElementById("automatisms-controls").style.display = any && !gameState.ehActivated && !gameState.optimumVictory ? "flex":"none";
  btnState("control-ia", gameState.ia>0, !!intervals.ia, "ü§ñ IA");
  btnState("control-trader", gameState.trader>0, !!intervals.trader, "üí∞ Trader");
  btnState("control-confort", gameState.autoConfort>0, !!intervals.autoConfort, "üõãÔ∏è Confort");
  btnState("control-centre", gameState.centre>0, !!intervals.centre, "üè¨ Centre");
}
function btnState(id, available, on, label){
  const b=document.getElementById(id);
  if (!available){ b.className="control-btn disabled"; b.textContent=label+": OFF"; return; }
  b.className = "control-btn " + (on?"active":"inactive");
  b.textContent = label + ": " + (on?"ON":"OFF");
}

/* ==========================================================
   8) PALIERS FIXES & CYCLIQUES (hybride)
   ========================================================== */
function checkPaliers(){
  if (!gameState.monnaieActive || gameState.optimumVictory) return;
  const c = gameState.clicks;

  if (c>=CONST.paliersFixes.comfort) document.getElementById("comfort-btn").style.display="inline-block";

  // IA r√©apparition tous les 200 clics (et co√ªt cyclique √ó1.5 √† chaque achat)
  if (c>0 && c % CONST.paliersFixes.ia === 0) showPalBtn('ouvrier-btn','ia');
  if (c>0 && c % CONST.paliersFixes.trader === 0) showPalBtn('trader-btn','trader');
  if (c>=CONST.paliersFixes.autoConfort) showPalBtn('comfort-auto-btn','autoConfort');
  if (c>=CONST.paliersFixes.autoClicks && !gameState.automationsClickScore) document.getElementById("automatisms-btn").style.display="inline-block";
  if (c>=CONST.paliersFixes.priceIndicator && !gameState.priceIndicator) document.getElementById("price-indicator-btn").style.display="inline-block";
  if (c>=CONST.paliersFixes.centre) showPalBtn('centre-commercial-btn','centre');

  // Upgrades visibles aux paliers 400/700/1100 si <3 achet√©es
  const idx = gameState.prodCostUpgradesBought;
  if (idx<CONST.paliersFixes.upgrades.length){
    const need = CONST.paliersFixes.upgrades[idx];
    if (c>=need) document.getElementById("upgrade-btn").style.display="inline-block";
  }

  // Suggestion EH si nature ‚â§100
  if (gameState.monnaieActive && gameState.nature <= CONST.ehSuggestAt && !gameState.ehActivated && !gameState.gameOver && !gameState.optimumVictory){
    document.getElementById("eh-msg").style.display="block";
    document.getElementById("eh-msg").textContent = "Une √©volution est possible : passer √† l'√©conomie hom√©ostatique (EH)";
    document.getElementById("evolution-btn").style.display="inline-block";
  } else {
    document.getElementById("eh-msg").style.display="none";
    if (!gameState.ehActivated && !gameState.gameOver) document.getElementById("evolution-btn").style.display="none";
  }
}
function showPalBtn(buttonId, type){
  const btn = document.getElementById(buttonId);
  if (btn && btn.style.display!=="inline-block") btn.style.display="inline-block";
}
function currentCost(type){
  const cfg = CONST.palCosts[type];
  if (!cfg) return 0;
  const n = (type==='ia'?gameState.nb.ia: type==='trader'?gameState.nb.trader: type==='autoConfort'?gameState.nb.autoConfort: type==='centre'?gameState.nb.centre: type==='upgrade'?gameState.nb.upgrade:0);
  return Math.round(cfg.base * Math.pow(cfg.mult, n));
}

/* ==========================================================
   9) JAUGES / ALERTES / OPTIMUM / FIN & RESTART
   ========================================================== */
function updateBudgetUI(){
  if (gameState.budgetEtat>0){
    document.getElementById("budget-row").style.display="block";
    document.getElementById("jg-budget").style.display="flex";
    const maxB = Math.max(1000, gameState.budgetEtat*1.3);
    document.getElementById("jauge-budget").style.width = Math.min(100,(gameState.budgetEtat/maxB)*100)+"%";
    document.getElementById("jbudget").textContent = Math.floor(gameState.budgetEtat)+"‚Ç¨";
  }
}
function updateJauges(){
  const maxN = Math.max(3000, gameState.nature*1.2);
  document.getElementById("jauge-nature").style.width = Math.min(100,(gameState.nature/maxN)*100)+"%";
  document.getElementById("jnature").textContent = Math.floor(gameState.nature);

  if (gameState.confort>0){ document.getElementById("jg-confort").style.display="flex";
    const maxC = Math.max(100, gameState.confort*1.2);
    document.getElementById("jauge-confort").style.width = Math.min(100,(gameState.confort/maxC)*100)+"%";
    document.getElementById("jconfort").textContent = Math.floor(gameState.confort);
  }
  if (gameState.monnaieActive){
    document.getElementById("jg-money").style.display="flex";
    const maxM = Math.max(10000, Math.abs(gameState.money)*1.2);
    document.getElementById("jauge-money").style.width = Math.min(100,(Math.abs(gameState.money)/maxM)*100)+"%";
    document.getElementById("jmoney").textContent = Math.floor(gameState.money)+"‚Ç¨";
  }
  if (gameState.autoConfort>0){ document.getElementById("jg-achat-auto").style.display="flex";
    const maxA = Math.max(10, gameState.autoConfort*1.2);
    document.getElementById("jauge-achat-auto").style.width = Math.min(100,(gameState.autoConfort/maxA)*100)+"%";
    document.getElementById("jachat").textContent = "√ó"+gameState.autoConfort;
  }
  if (gameState.ia>0){ document.getElementById("jg-ia").style.display="flex";
    const maxI = Math.max(10, gameState.ia*1.2);
    document.getElementById("jauge-ia").style.width = Math.min(100,(gameState.ia/maxI)*100)+"%";
    document.getElementById("jia").textContent = "√ó"+gameState.ia;
  }
  if (gameState.trader>0){ document.getElementById("jg-trader").style.display="flex";
    const maxT = Math.max(10, gameState.trader*1.2);
    document.getElementById("jauge-trader").style.width = Math.min(100,(gameState.trader/maxT)*100)+"%";
    document.getElementById("jtrader").textContent = "√ó"+gameState.trader;
  }
  if (gameState.centre>0){ document.getElementById("jg-centre").style.display="flex";
    const maxCen = Math.max(10, gameState.centre*1.2);
    document.getElementById("jauge-centre").style.width = Math.min(100,(gameState.centre/maxCen)*100)+"%";
    document.getElementById("jcentre").textContent = "√ó"+gameState.centre;
  }
  if (gameState.techLevel>0){ document.getElementById("jg-tech").style.display="flex";
    const maxTch = Math.max(5, gameState.techLevel*1.2);
    document.getElementById("jauge-tech").style.width = Math.min(100,(gameState.techLevel/maxTch)*100)+"%";
    document.getElementById("jtech").textContent = `Niv.${gameState.techLevel} (√ó${gameState.productionMultiplier.toFixed(1)})`;
  }
}
function updateAlerts(){
  const box = document.getElementById("alert-crise");
  if (gameState.nature <= CONST.ehSuggestAt && !gameState.ehActivated){
    box.style.display="block";
    box.className = "message-box " + (gameState.nature<=100?"msg-red":"msg-orange");
    box.textContent = (gameState.nature<=100?"‚ö†Ô∏è Ressources critiques (‚â§100). Recommand√© : passer √† l'EH.":"Alerte ressources : sous 300, attention √† l'habitabilit√© !");
  } else box.style.display="none";

  const s = document.getElementById("social-crise");
  if (gameState.confort <= 5 && gameState.confortMaxAtteint > 5 && !gameState.gameOver){
    s.style.display="block";
    s.textContent="‚ö†Ô∏è Risque de crise sociale majeure";
  } else s.style.display="none";

  if (gameState.confort > gameState.confortMaxAtteint) gameState.confortMaxAtteint = gameState.confort;
  if (!gameState.ehActivated && !gameState.gameOver && !gameState.optimumVictory &&
     (gameState.nature<=0 || (gameState.confort<=0 && gameState.confortMaxAtteint>0))){
    document.getElementById("rescue-eh-btn").style.display="inline-block";
  } else document.getElementById("rescue-eh-btn").style.display="none";

  // Auto-EH si nature ‚â§ 50
  if (!gameState.ehActivated && gameState.nature <= CONST.ehAutoTriggerAt){ evolution(); }
}
function isInOptimum(){
  const r=CONST.optimumRanges;
  return gameState.nature>=r.nature[0] && gameState.nature<=r.nature[1] &&
         gameState.confort>=r.confort[0] && gameState.confort<=r.confort[1] &&
         gameState.money>=r.money[0] && gameState.money<=r.money[1];
}
function checkOptimum(){
  if (gameState.optimumVictory || gameState.gameOver) return;
  if (isInOptimum()){
    gameState.optimumStreak++;
    if ([10,20,30,40].includes(gameState.optimumStreak)) showMsg(`üéØ Super ! ${gameState.optimumStreak} actions d‚Äô√©quilibre d'affil√©e`);
    if (gameState.optimumStreak>=CONST.optimumTarget) triggerOptimumVictory();
  } else gameState.optimumStreak = 0;

  const pct = Math.min(100, (gameState.optimumStreak/CONST.optimumTarget)*100);
  document.getElementById("optimum-progress-fill").style.width = pct+"%";
  document.getElementById("optimum-progress-text").textContent = `${gameState.optimumStreak} / ${CONST.optimumTarget}`;
  document.getElementById("optimum-status").textContent = (isInOptimum()?"‚úÖ Dans la zone d'optimum":"‚ùå Ajustez");
}
function triggerOptimumVictory(){
  gameState.optimumVictory = true; gameState.jeuBloque = true; clearAllIntervals();
  document.getElementById("optimum-victory").style.display="block";
  showMsg("üèÜ VICTOIRE !");
}
function triggerGameOver(cause){
  gameState.gameOver = true; gameState.gameOverCause = cause; gameState.jeuBloque = true;
  clearAllIntervals();
  if (cause==='resources'){ const box=document.getElementById("game-over-resources"); box.style.display="block"; box.textContent="üåç La plan√®te n'est plus habitable : Perdu !"; }
  if (cause==='confort'){ const box=document.getElementById("game-over-confort"); box.style.display="block"; box.textContent="‚öîÔ∏è R√©volution de la soci√©t√© : Perdu !"; }
  setTimeout(()=>{ document.getElementById("rescue-eh-btn").style.display="inline-block"; showMsg("üå± Solution de secours disponible : EH"); }, 3000);
}
function activateRescueEH(){
  if (gameState.optimumVictory) return;
  saveState();
  gameState.nature += 100; gameState.confort += 50;
  evolution();
  updateUI("Secours EH : +100 ressources, +50 confort");
}
function restartGame(){
  clearAllIntervals();
  gameState = {
    nature:3000, confort:0, production:0, money:10,
    clicks:0, monnaieActive:false, priceIndicator:false, budgetEtat:0,
    taxEnabled:true,
    creditButtonShown:false, pendingPurchase:null, creditRate:CONST.creditRateStart, creditNegotiationsUsed:0, lastNegotiationShownAt:0,
    ehActivated:false, ecologicalInvestments:[], ehPrimeClicks:0, ehFonteClicks:0, ehBonusClicks:0, ehDonationClicks:0,
    ia:0, trader:0, autoConfort:0, centre:0, automationsClickScore:false,
    techLevel:0, productionMultiplier:1.0, prodCostUpgradesBought:0,
    nb:{ia:0,trader:0,autoConfort:0,centre:0,upgrade:0},
    jeuBloque:false, gameOver:false, gameOverCause:null, confortMaxAtteint:0,
    optimumStreak:0, optimumVictory:false,
    eventsEnabled:true, eventsRecent:[], nextEventIn:0, activeTempEffects:[]
  };
  lastState=null;
  document.getElementById("optimum-victory").style.display="none";
  document.getElementById("credit-btn").style.display="none";
  document.getElementById("invest-eco-fixed").style.display="none";
  document.getElementById("investment-block").style.display="none";
  document.getElementById("eh-success").style.display="none";
  document.getElementById("evolution-btn").style.display="none";
  document.getElementById("rescue-eh-btn").style.display="none";
  document.getElementById("game-over-resources").style.display="none";
  document.getElementById("game-over-confort").style.display="none";
  initializeGame();
  showMsg("üîÑ Nouvelle partie !");
}

/* ==========================================================
   10) UI glue
   ========================================================== */
function updateUI(msg){
  checkPaliers();
  updateAutomatismControls();
  updateUIValues();
  updateBudgetUI();
  if (msg) showMsg(msg);
}
function updateUIValues(){
  document.getElementById("nature").textContent = Math.floor(gameState.nature);
  document.getElementById("confort").textContent = Math.floor(gameState.confort);
  document.getElementById("production").textContent = Math.floor(gameState.production);
  document.getElementById("money").textContent = Math.floor(gameState.money);
  document.getElementById("clicks").textContent = gameState.clicks;

  if (!gameState.gameOver && !gameState.optimumVictory){
    if (gameState.nature <= 0){ triggerGameOver('resources'); return; }
    if (gameState.confort <= 0 && gameState.confortMaxAtteint > 0){ triggerGameOver('confort'); return; }
  }
  updateJauges();
  updateAlerts();

  if (gameState.priceIndicator){
    document.getElementById("price-indicator").style.display="block";
    document.getElementById("current-price").textContent = calculatePrice().toFixed(2)+"‚Ç¨";
  }
  // Zone optimum
  checkOptimum();
}

/* ==========================================================
   11) √âV√âNEMENTS (pool 1‚Äì160, tirage 20‚Äì60, anti-r√©p√©tition 5)
   ========================================================== */
const randomEventsSystem = {
  enabled:true, nextIn:0, recent:[], maxRecent:5, activeTemp:[],
  init(){ this.schedule(); },
  schedule(){ this.nextIn = Math.floor(Math.random()*41)+20; }, // 20‚Äì60
  processClick(isAuto){
    if (!this.enabled || gameState.jeuBloque || gameState.gameOver || gameState.optimumVictory) return;
    if (--this.nextIn<=0){ this.trigger(); this.schedule(); }
    this.processTemp();
  },
  trigger(){
    const pool = this.events.filter(e=>!this.recent.includes(e.id));
    const ev = pool.length>0 ? pool[Math.floor(Math.random()*pool.length)]
                             : this.events[Math.floor(Math.random()*this.events.length)];
    this.recent.push(ev.id); if (this.recent.length>this.maxRecent) this.recent.shift();
    saveState();
    ev.effect(gameState, this);
    const box=document.getElementById("event-box");
    const txt=document.getElementById("event-text");
    const fx=document.getElementById("event-effects");
    if (box){ txt.textContent=`${ev.icon} ${ev.name} ‚Äî ${ev.text}`; fx.textContent=ev.fx; box.style.display="block"; setTimeout(()=>{box.style.display="none";}, 5000); }
    setTimeout(()=>updateUI("√âv√©nement: "+ev.name), 0);
  },
  addTemp(type,val,dur){ this.activeTemp.push({type,value:val,remain:dur}); },
  mod(type){ return this.activeTemp.reduce((s,e)=>s+(e.type===type?e.value:0),0); },
  processTemp(){
    for (let i=this.activeTemp.length-1;i>=0;i--){ if(--this.activeTemp[i].remain<=0) this.activeTemp.splice(i,1); }
  },
  toggle(){ this.enabled=!this.enabled; },
  getFullState(){ return {enabled:this.enabled,nextIn:this.nextIn,recent:[...this.recent],activeTemp:JSON.parse(JSON.stringify(this.activeTemp))}; },
  restoreFullState(st){ this.enabled=st.enabled; this.nextIn=st.nextIn; this.recent=[...st.recent]; this.activeTemp=JSON.parse(JSON.stringify(st.activeTemp)); },

  // G√©n√©ration compacte de 160 √©v√©nements coh√©rents (rempla√ßable par ta table manuelle si souhait√©)
  events: (()=>{
    const arr=[];
    const namesA=["Invasion de criquets","Vague de chaleur","Temp√™te","P√©nurie d‚Äôeau","Mar√©e noire","Pic de biodiversit√©","Pluie bienfaitrice","Innovation verte","Gr√®ve g√©n√©rale","Festival solidaire","Crash boursier","Appel d‚Äôair touristique","Subvention verte","Taxe carbone","Fuite technologique","Cyberattaque","Boom √©nerg√©tique","Effet rebond","Restauration des sols","√âpid√©mie locale"];
    const icons=["ü™≤","üî•","üå™Ô∏è","üö±","üõ¢Ô∏è","ü¶ã","üåßÔ∏è","üí°","‚úä","üéâ","üìâ","üß≥","üí∂","üè∑Ô∏è","üõ†Ô∏è","üß®","‚ö°","üîÅ","üå±","ü¶†"];
    // 160 items avec patterns vari√©s
    for(let i=1;i<=160;i++){
      const k = i%namesA.length, name = namesA[k], icon=icons[k];
      // pattern d‚Äôeffet : alterner des impacts
      const t = i%8;
      let eff, fx;
      switch(t){
        case 0: eff=(gs)=>{ gs.nature=Math.max(0,gs.nature- (20+ (i%5)*10)); }; fx=`Ressources -${20+(i%5)*10}`; break;
        case 1: eff=(gs)=>{ gs.nature+= (10+ (i%6)*5); }; fx=`Ressources +${10+(i%6)*5}`; break;
        case 2: eff=(gs)=>{ gs.confort=Math.max(0, gs.confort-1); }; fx=`Confort -1`; break;
        case 3: eff=(gs)=>{ gs.confort+=1; }; fx=`Confort +1`; break;
        case 4: eff=(gs)=>{ gs.money+= (30+ (i%7)*10); }; fx=`Monnaie +${30+(i%7)*10}‚Ç¨`; break;
        case 5: eff=(gs)=>{ gs.money-= (20+ (i%7)*10); }; fx=`Monnaie -${20+(i%7)*10}‚Ç¨`; break;
        case 6: eff=(gs)=>{ gs.ia = Math.max(0, gs.ia - (gs.ia>0?1:0)); }; fx=`IA -1 (si >0)`; break;
        case 7: eff=(gs,self)=>{ self.addTemp('regen',0.05,15); }; fx=`Effet temporaire : r√©g√©n√©ration +5% (15 clics)`; break;
      }
      arr.push({ id:i, name:`${name} #${i}`, icon:icon, text:"", fx:fx, effect:eff });
    }
    // Ajouter quelques √©v√©nements bien typ√©s :
    arr[0].text="Les cultures sont ravag√©es.";
    arr[1].text="La chaleur √©prouve la soci√©t√©.";
    arr[2].text="Destruction d‚Äôinfrastructures.";
    arr[3].text="Les nappes s‚Äôass√®chent.";
    arr[4].text="Pollution s√©v√®re du littoral.";
    arr[5].text="√âlan de diversit√© retrouv√©.";
    arr[6].text="Pluie salvatrice.";
    arr[7].text="Effet temporaire sur les cycles naturels.";
    return arr;
  })()
};
function toggleEvents(){ randomEventsSystem.toggle(); showMsg("üé≤ √âv√©nements : "+(randomEventsSystem.enabled?"ON":"OFF")); }

/* ==========================================================
   12) TRICHE (tests)
   ========================================================== */
function addMoney(){ gameState.monnaieActive=true; document.getElementById("money-row").style.display="block"; document.getElementById("jg-money").style.display="flex"; gameState.money+=1000; updateUI("+1000‚Ç¨ (test)"); }
function addNature(){ gameState.nature+=100; updateUI("+100 ressources (test)"); }
function addClicks(){ gameState.clicks+=50; randomEventsSystem.processClick(false); updateUI("+50 clics (test)"); }
function forceActivateEH(){ saveState(); evolution(); updateUI("EH forc√©e (test)"); }

/* ==========================================================
   13) INITIALISATION
   ========================================================== */
function initializeGame(){
  randomEventsSystem.init();
  // Sc√©narisation courte
  setTimeout(()=>showMsg("üåç Vos choix √©conomiques d√©termineront l'habitabilit√© future."), 1200);
  setTimeout(()=>showMsg("üõ†Ô∏è Commencez par produire, puis vendre pour activer la monnaie."), 4200);
  setTimeout(()=>showMsg("üéØ Objectif : atteindre et maintenir l'√©quilibre."), 7600);
  updateUI("");
}
window.onload = initializeGame;

/* ==========================================================
   14) CLIC CENTRAL : appel√© apr√®s chaque action ‚Üí √©v√©nements / fiscalit√© / int√©r√™ts / EH
   (d√©j√† g√©r√©s √† chaque action concern√©e)
   ========================================================== */
</script>
</body>
</html>
