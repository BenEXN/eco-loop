<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Looop ‚Äî Unifi√©e (UI v1.26.1 + R√®gles v1.30 + EH compl√®te + √âv√©nements 160)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f3f3; --card:#fff; --shadow:#0001; --ink:#111;
    --bar:#eee; --ok:#4CAF50; --ok2:#81C784; --warn:#ff8533; --red:#cc0000; --blue:#0066cc; --gold:#b8860b;
    --c-nature:#86e08e; --c-confort:#86b6ea; --c-money:#ffb3b3; --c-budget:#ff9800;
    --c-achat:#ffa726; --c-ia:#ab47bc; --c-trader:#26c6da; --c-centre:#66bb6a; --c-tech:#9c27b0;
  }
  body{ background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; margin:0 }
  h1{ text-align:center; margin:22px 0 8px; }
  .container{ display:flex; justify-content:center; align-items:flex-start; gap:24px; margin:0 auto 18px; max-width:980px; padding:0 10px; }
  .category{ background:var(--card); border-radius:18px; box-shadow:0 4px 24px var(--shadow); flex:1; padding:26px 16px 16px; min-width:260px; max-width:330px; }
  .cat-title{ font-size:1.2em; font-weight:700; margin-bottom:12px; letter-spacing:.5px }
  .stock{ font-size:1.05em; margin-bottom:8px }
  .products-box{ background:#f7f7fa; border:2px solid #dde1eb; border-radius:10px; color:#333; margin:10px 0; padding:10px 22px; font-size:1.05em; font-weight:700; text-align:center; box-shadow:0 1px 4px #ddd5 }
  .message-box{ border-radius:10px; margin:8px 0 12px; padding:10px 12px; font-weight:700; font-size:1.02em; box-shadow:0 1px 4px #0002; text-align:center }
  .msg-orange{ background:#fff2e6; color:#cc5500; border:2px solid var(--warn) }
  .msg-red{ background:#ffe6e6; color:var(--red); border:2px solid #ff6666 }
  .msg-blue{ background:#e6f3ff; color:var(--blue); border:2px solid #4da6ff }
  .msg-green{ background:#e6ffe6; color:#066; border:2px solid #66cc66 }
  .msg-gold{ background:#fff9c4; color:#8a6d00; border:2px solid #f4d03f }
  .btn-row{ margin-top:14px; display:flex; flex-direction:column; align-items:center; gap:8px }
  button{ font-size:1em; padding:10px 16px; border:none; border-radius:12px; background:#ededed; color:#111; cursor:pointer; transition:filter .15s }
  button:hover{ filter:brightness(.98) }
  .btn-credit{ background:#ff6b35; color:#fff; font-weight:700 }
  .btn-evo{ background:#4CAF50; color:#fff; font-weight:700 }
  .btn-yellow{ background:#FFD600; color:#222; font-weight:700 }
  .btn-annuler{ background:#999; color:#fff }
  .btn-invest{ background:#2e7d32; color:#fff; font-weight:700 }
  #clics-container{ text-align:center; margin:16px 0; font-weight:700 }
  .bar{ background:var(--bar); border-radius:8px; height:13px; flex:1; overflow:hidden }
  .fill{ height:100%; border-radius:8px; transition:width .2s }
  .jrow{ max-width:680px; margin:0 auto 6px; display:flex; align-items:center; gap:8px }
  .jlabel{ min-width:120px; font-size:.95em; color:#666; text-align:right }
  .jval{ min-width:70px; text-align:right; font-size:.95em; color:#333 }
  #jauge-nature{ background:var(--c-nature) } #jauge-confort{ background:var(--c-confort) } #jauge-money{ background:var(--c-money) } #jauge-budget{ background:var(--c-budget) }
  #jauge-achat{ background:var(--c-achat) } #jauge-ia{ background:var(--c-ia) } #jauge-trader{ background:var(--c-trader) } #jauge-centre{ background:var(--c-centre) } #jauge-tech{ background:var(--c-tech) }
  .automatisms-controls{ margin:14px auto; max-width:980px; display:none; justify-content:center; gap:10px; flex-wrap:wrap; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px var(--shadow) }
  .control-btn{ font-size:.9em; padding:8px 12px; border-radius:8px; border:none; min-width:90px }
  .active{ background:#4CAF50; color:#fff } .inactive{ background:#f44336; color:#fff } .disabled{ background:#ccc; color:#777 }
  .events-zone{ margin:12px auto; max-width:980px; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px var(--shadow) }
  .event-notification{ background:#f0f8f0; border:2px solid #81c784; border-radius:10px; padding:10px; font-weight:700; color:#2e7d32; display:none }
  .optimum-zone{ margin:12px auto; max-width:980px; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px var(--shadow); text-align:center }
  .optimum-progress-bar{ background:#eee; height:18px; border-radius:20px; max-width:420px; margin:10px auto; overflow:hidden; position:relative }
  .optimum-progress-fill{ height:100%; background:linear-gradient(90deg,var(--ok),var(--ok2)); width:0% }
  .optimum-progress-text{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-weight:700; color:#333; font-size:.9em }
  .optimum-victory{ background:#fff9c4; border:2px solid #f4d03f; color:var(--gold); padding:18px; border-radius:15px; font-size:1.1em; font-weight:700; text-align:center; margin:12px auto; max-width:680px; animation:victoryPulse 2s infinite }
  @keyframes victoryPulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.02)} }
  #triche-sep{ border:none; border-top:3px solid #222; margin:22px auto 10px; width:94vw; max-width:980px }
  #triche-label{ max-width:980px; margin:0 auto 10px; color:#555 }
  .debug-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px auto 24px }
  .hidden{ display:none }
  /* EH ‚Äì bloc investissement (avanc√©) */
  .investment-block{ background:#e8f5e8; border:2px solid #81c784; border-radius:10px; padding:12px; margin:8px 0 }
  .investment-title{ font-weight:700; color:#2e7d32; margin-bottom:8px; text-align:center }
  .investment-input{ width:110px; padding:8px; border:1px solid #ccc; border-radius:6px; margin:0 6px; font-size:1em }
  .investment-list{ font-size:.9em; color:#555; margin-top:8px; max-height:110px; overflow-y:auto }
  .investment-preview{ font-size:.85em; color:#2e7d32; margin-top:5px; font-style:italic; min-height:16px }
  .investment-controls{ display:flex; align-items:center; justify-content:center; flex-wrap:wrap; gap:6px }
  /* Mobile */
  @media (max-width:720px){
    .container{ flex-direction:column; gap:12px }
    .category{ max-width:unset }
    .jrow{ max-width:calc(100vw - 22px) }
  }
</style>
</head>
<body>
  <h1>üåç Looop ‚Äî <span style="font-size:.7em;color:#777;">UI v1.26.1 + R√®gles v1.30 + EH compl√®te + √âv√©nements</span></h1>

  <!-- Contr√¥les automatismes -->
  <div class="automatisms-controls" id="automatisms-controls">
    <button id="control-ia" class="control-btn disabled" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button id="control-trader" class="control-btn disabled" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button id="control-confort" class="control-btn disabled" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button id="control-centre" class="control-btn disabled" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>

  <!-- Zone d'√©quilibre -->
  <div class="optimum-zone" id="optimum-zone">
    <div style="font-weight:700;">üéØ Zone d'√©quilibre</div>
    <div class="optimum-progress-bar">
      <div class="optimum-progress-fill" id="optimum-progress-fill"></div>
      <div class="optimum-progress-text" id="optimum-progress-text">0 / 50</div>
    </div>
    <div id="optimum-status" style="font-size:.95em;color:#555;">Objectif : maintenir l'√©quilibre pendant 50 actions</div>
  </div>

  <!-- Message de victoire -->
  <div id="optimum-victory" class="optimum-victory hidden">
    üèÜ VICTOIRE ! Vous avez maintenu l'√©quilibre optimum (50/50).<br/>
    <button class="btn-yellow" onclick="restartGame()" style="margin-top:10px;">üîÑ Rejouer</button>
  </div>

  <!-- Zone √©v√©nements -->
  <div class="events-zone">
    <div style="font-weight:700;margin-bottom:6px;">üåø √âv√©nements al√©atoires</div>
    <div id="event-box" class="event-notification">
      <span id="event-text"></span>
      <div id="event-effects" style="font-size:.9em;color:#666;margin-top:4px;"></div>
    </div>
  </div>

  <div class="container">
    <!-- Environnement -->
    <div class="category">
      <div class="cat-title">üå± Environnement</div>
      <div class="stock">Ressources : <span id="nature">3000</span></div>
      <div id="alert-crise" class="message-box msg-orange hidden"></div>

      <!-- Bloc investissement √©cologique EH (avanc√©) -->
      <div id="investment-block" class="investment-block hidden">
        <div class="investment-title">üå± Investissement √©cologique (avanc√©)</div>
        <div class="investment-controls">
          <input type="number" id="investment-amount" class="investment-input" placeholder="Montant (‚Ç¨)" min="1" oninput="updateInvestmentPreview()"/>
          <button class="btn-invest" onclick="makeEcologicalInvestment()">üíö Investir</button>
        </div>
        <div id="investment-preview" class="investment-preview"></div>
        <div id="investment-list" class="investment-list">Aucun investissement en cours</div>
      </div>

      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
        <button id="invest-eco-fixed-btn" class="btn-invest hidden" onclick="investirEcologieFixe()">üåø Investir √©cologie (‚Äì200‚Ç¨ ‚Üí +30)</button>
      </div>
    </div>

    <!-- Exosomatisation -->
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock">Confort : <span id="confort">0</span></div>
      <div class="products-box">Produits cr√©√©s<br/><span id="production">0</span></div>
      <div id="social-crise" class="message-box msg-red hidden"></div>

      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" class="hidden">üõãÔ∏è Acheter du confort (100‚Ç¨)</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>
      </div>

      <div class="btn-row">
        <button id="ouvrier-btn" class="hidden" onclick="acheterIA()">ü§ñ Engager une IA</button>
        <button id="trader-btn" class="hidden" onclick="acheterTrader()">üí∞ Trader automatique</button>
        <button id="comfort-auto-btn" class="hidden" onclick="acheterConfortAuto()">üîÑ Achat auto confort</button>
        <button id="centre-commercial-btn" class="hidden" onclick="acheterCentreCommercial()">üè¨ Centre commercial</button>
        <button id="upgrade-btn" class="hidden" onclick="upgradeProduction()">üí† Am√©liorer la production</button>
      </div>
    </div>

    <!-- √âconomie -->
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock hidden" id="money-row">Monnaie (‚Ç¨) : <span id="money">10</span></div>
      <div class="stock hidden" id="budget-row">Budget de l'√âtat : <span id="budget-etat">0</span> ‚Ç¨</div>
      <div class="products-box hidden" id="price-indicator">Prix de vente<br/><span id="current-price">1‚Ç¨</span></div>

      <button id="don-btn" onclick="receiveDon()">Recevoir mon don</button>
      <button id="credit-btn" class="btn-credit hidden" onclick="activateCredit()">üí≥ Valider le cr√©dit</button>
      <button id="nego-taux-btn" class="btn-yellow hidden" onclick="negocierTaux()">ü§ù N√©gocier mon cr√©dit</button>

      <div id="eh-msg" class="message-box msg-blue hidden"></div>
      <div id="eh-success" class="message-box msg-green hidden"></div>
      <div id="game-over-resources" class="message-box msg-red hidden"></div>
      <div id="game-over-confort" class="message-box msg-red hidden"></div>

      <div class="btn-row">
        <button id="automatisms-btn" class="hidden" onclick="acheterAutomatismsClics()">‚ö° Automatismes = clics (10‚ÄØ000‚Ç¨)</button>
        <button id="price-indicator-btn" class="hidden" onclick="acheterIndicateurPrix()">üìä Indicateur de prix (30‚ÄØ000‚Ç¨)</button>
        <button id="evolution-btn" class="btn-evo hidden" onclick="evolution()">üå± Passer √† l'√©conomie hom√©ostatique</button>
        <button id="rescue-eh-btn" class="btn-evo hidden" onclick="activateRescueEH()">üå± Passer √† l'EH (secours)</button>
      </div>
    </div>
  </div>

  <!-- Jauges -->
  <div style="margin:0 auto 10px; max-width:720px;">
    <div class="jrow"><div class="jlabel">üå± Ressources</div><div class="bar"><div id="jauge-nature" class="fill" style="width:0%"></div></div><div class="jval" id="jnature">3000</div></div>
    <div class="jrow hidden" id="jg-confort"><div class="jlabel">ü§ñ Confort</div><div class="bar"><div id="jauge-confort" class="fill"></div></div><div class="jval" id="jconfort">0</div></div>
    <div class="jrow hidden" id="jg-money"><div class="jlabel">üí∂ Monnaie</div><div class="bar"><div id="jauge-money" class="fill"></div></div><div class="jval" id="jmoney">10‚Ç¨</div></div>
    <div class="jrow hidden" id="jg-budget"><div class="jlabel">üèõÔ∏è Budget √âtat</div><div class="bar"><div id="jauge-budget" class="fill"></div></div><div class="jval" id="jbudget">0‚Ç¨</div></div>
    <div class="jrow hidden" id="jg-achat"><div class="jlabel">üîÑ Achat auto</div><div class="bar"><div id="jauge-achat" class="fill"></div></div><div class="jval" id="jachat">√ó0</div></div>
    <div class="jrow hidden" id="jg-ia"><div class="jlabel">ü§ñ IA</div><div class="bar"><div id="jauge-ia" class="fill"></div></div><div class="jval" id="jia">√ó0</div></div>
    <div class="jrow hidden" id="jg-trader"><div class="jlabel">üí∞ Trader</div><div class="bar"><div id="jauge-trader" class="fill"></div></div><div class="jval" id="jtrader">√ó0</div></div>
    <div class="jrow hidden" id="jg-centre"><div class="jlabel">üè¨ Centre</div><div class="bar"><div id="jauge-centre" class="fill"></div></div><div class="jval" id="jcentre">√ó0</div></div>
    <div class="jrow hidden" id="jg-tech"><div class="jlabel">üí† Niveau techno</div><div class="bar"><div id="jauge-tech" class="fill"></div></div><div class="jval" id="jtech">Niv.0 (√ó1.0)</div></div>
  </div>

  <div id="message" style="text-align:center; font-weight:700; min-height:22px; margin:8px 0;"></div>
  <div id="clics-container">Clics/actions : <span id="clicks">0</span></div>

  <!-- Triche -->
  <hr id="triche-sep"/>
  <div id="triche-label">Triche (tests)</div>
  <div class="debug-row">
    <button class="btn-yellow" id="unlock-cheat" onclick="toggleCheat()">üîì D√©verrouiller les outils de test</button>
  </div>
  <div class="debug-row hidden" id="cheat-box">
    <button class="btn-yellow" onclick="cheatAddMoney()">+1000 ‚Ç¨</button>
    <button class="btn-yellow" onclick="cheatAddNature()">+100 ressources</button>
    <button class="btn-yellow" onclick="cheatAddClicks()">+50 clics</button>
    <button class="btn-yellow" onclick="cheatRemoveNature()">-100 ressources</button>
    <button class="btn-yellow" onclick="cheatForceEH()">Forcer EH</button>
    <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler</button>
    <button class="btn-yellow" onclick="toggleEvents()">üé≤ √âv√©nements ON/OFF</button>
  </div>

<script>
/* ============================================================
   CONSTANTES D'√âQUILIBRAGE (centralis√©es)
   ============================================================ */
const CFG = {
  taxEveryClicks: 20,
  taxRate: 0.20,
  eh: {
    transactionTax: 0.04,
    donationEvery: 10,
    primeEvery: 50,
    fonteEvery: 10,
    fonteRate: 0.04,
    bonusEvery: 10,
  },
  price: { min: 1 },
  baseProdCost: 5,
  upgrades: { max: 3, cost: 2000, multPerUpgrade: 1.5, costDecreasePerUp: 1, minProdCost: 2, paliersFixed: [400,700,1100] },
  auto: {
    ia: { baseCost: 500, mult: 1.5, tick: 5000, resCostPerIA: 5 },
    trader: { baseCost: 1000, mult: 1.5, tick: 3000 },
    autoConfort: { baseCost: 2000, mult: 1.5, tick: 15000, unitPrice: 100 },
    centre: { baseCost: 5000, mult: 1.5, tick: 15000, confortPerCentre: 10, unitPrice: 100 },
    autoClicksCost: 10000
  },
  priceIndicator: { cost: 30000 },
  comfort: { cost: 100, unlockAtClicks: 120 },
  unlockFixed: { iaEvery: 200, traderAt: 500, autoConfortAt: 700, autoClicksAt: 750, indicatorAt: 1000, centreAt: 1100 },
  credit: { rate: 0.05, minRate: 0.01, negoStep: 0.01, negoEveryClicks: 300, negoMax: 3, negoCost: 2000 },
  optimum: { nature:[1800,2600], confort:[10,35], money:[400,1200], target: 50 },
  ehAutoTriggerAt: 50, // auto-EH si nature ‚â§ 50
};

/* ============================================================
   √âTAT DU JEU
   ============================================================ */
let gs = {
  // stocks
  nature: 3000, confort: 0, production: 0, money: 10,

  // syst√®mes
  clicks: 0, monnaieActive: false, priceIndicatorActive: false,

  // fiscalit√©
  budgetEtat: 0, taxEnabled: true,

  // cr√©dit
  creditButtonShown: false, pendingPurchase: null,
  creditRate: CFG.credit.rate, creditNegotiationsUsed: 0, lastNegotiationShownAt: 0,

  // EH
  ehActivated: false, ehPrimeClicks: 0, ehFonteClicks: 0, ehBonusClicks: 0,

  // automatismes
  ia: 0, trader: 0, confortAuto: 0, centre: 0,
  automationsClickScore: false,

  // upgrades prod
  prodUpgrades: 0, productionMultiplier: 1.0, techLevel: 0,

  // √©tats
  jeuBloque: false, gameOver: false, gameOverCause: null, confortMaxAtteint: 0,

  // optimum
  optimumStreak: 0, optimumVictory: false,

  // EH investissements avanc√©s
  ecologicalInvestments: [],

  // paliers visibles (pour √©viter clignotements)
  unlocked: {
    comfort:false, ia:false, trader:false, autoConfort:false, centre:false, autoClicks:false, priceIndicator:false, upgrade:false
  }
};

let cheatUnlocked = false;
let intervals = { ia:null, trader:null, autoConfort:null, centre:null };
let lastSnapshot = null;

/* ============================================================
   OUTILS G√âN√âRAUX
   ============================================================ */
function saveSnapshot(){
  lastSnapshot = {
    gs: JSON.parse(JSON.stringify(gs)),
    events: randomEvents.getState()
  };
}
function undoAction(){
  if(!cheatUnlocked || !lastSnapshot) return;
  clearAllIntervals();
  gs = JSON.parse(JSON.stringify(lastSnapshot.gs));
  randomEvents.setState(lastSnapshot.events);
  restartIntervalsIfAny();
  showMsg("Action annul√©e");
  fullUpdate();
}
function clearAllIntervals(){ for(const k in intervals){ if(intervals[k]){ clearInterval(intervals[k]); intervals[k]=null; } } }
function restartIntervalsIfAny(){
  if(gs.ia>0) startIA();
  if(gs.trader>0) startTrader();
  if(gs.confortAuto>0) startAutoConfort();
  if(gs.centre>0) startCentre();
}
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function fmtEuros(n){ return (Math.floor(n)).toLocaleString('fr-FR')+"‚Ç¨"; }
function showMsg(t){
  const m = document.getElementById("message"); if(!m) return;
  m.textContent = t; setTimeout(()=>{ if(m.textContent===t) m.textContent=""; }, 4000);
}

/* ============================================================
   PRIX & VENTE
   ============================================================ */
function calculatePrice(){
  if (gs.nature<=0) return CFG.price.min;
  const p = Math.max(CFG.price.min, Math.abs(gs.money)/gs.nature);
  return Math.round(p*100)/100;
}

/* ============================================================
   FISCALIT√â, INT√âR√äTS, DONS/PRIMES EH, FONTE EH
   ============================================================ */
function maybeApplyTax(){
  if (!gs.taxEnabled || gs.ehActivated) return;
  if (gs.clicks>0 && gs.clicks % CFG.taxEveryClicks === 0){
    const tax = Math.ceil(Math.abs(gs.money)*CFG.taxRate);
    if (tax>0){
      gs.money -= tax;
      gs.nature += 1;
      gs.confort += 1;
      gs.budgetEtat += tax;
      showMsg(`üí∏ Imp√¥t : -${tax}‚Ç¨ | +1 üå± | +1 ü§ñ (Budget √âtat +${tax}‚Ç¨)`);
      updateBudgetUI();
    }
  }
}
function applyOverdraftInterest(){
  if (gs.money < 0){
    const due = Math.ceil(Math.abs(gs.money) * gs.creditRate);
    if (due>0){ gs.money -= due; showMsg(`üí£ Int√©r√™ts : -${due}‚Ç¨ (taux ${Math.round(gs.creditRate*100)}%)`); }
    show(document.getElementById("nego-taux-btn"));
  } else {
    hide(document.getElementById("nego-taux-btn"));
  }
}
/* Don proportionnel √† la faiblesse des ressources (plancher/plafond) */
function computeDonByResources(){
  const lack = Math.max(0, 3000 - gs.nature);
  return Math.min(1200, Math.max(200, Math.floor(lack * 0.5)));
}
/* Cycles EH (micro‚Äëdon / prime / fonte / bonus) */
function processEHAfterClick(){
  if (!gs.ehActivated) return;

  // Dons (micro) toutes les 10 actions
  gs.ehPrimeClicks++; gs.ehFonteClicks++; gs.ehBonusClicks++;

  if (gs.ehPrimeClicks >= CFG.eh.primeEvery){ // prime macro (50)
    applyEHPrime();
    gs.ehPrimeClicks = 0;
  }
  if (gs.ehFonteClicks >= CFG.eh.fonteEvery){ // fonte 4%
    applyEHFonte();
    gs.ehFonteClicks = 0;
  }
  if (gs.ehBonusClicks >= CFG.eh.bonusEvery){ // bonus +1/+1
    gs.nature += 1; gs.confort += 1;
    gs.ehBonusClicks = 0;
  }

  // micro‚Äëdon chaque 10 actions (s√©par√© de prime/bonus pour clart√©)
  if (gs.clicks>0 && gs.clicks % CFG.eh.donationEvery === 0){
    const d = computeDonByResources();
    gs.money += d;
    gs.budgetEtat += d;
    showMsg(`üéÅ Don EH : +${d}‚Ç¨ (Budget √âtat +${d}‚Ç¨)`);
    updateBudgetUI();
  }

  // Investissements avanc√©s : d√©cr√©ment et restitution
  processEcologicalInvestments();
}
function applyEHPrime(){
  // Prime proportionnelle √† l'√©tat de la nature, reprenant l'esprit de v1.26.1 :
  // - tr√®s basse nature ‚Üí prime mini (~10% de |money|)
  // - nature m√©diane ‚Üí ~ 10‚Äì100% de |money|
  // - nature √©lev√©e (‚â•1500) ‚Üí peut d√©passer (jusqu'√† ~nature/1500)*100% de |money|
  let percent = 0;
  if (gs.nature >= 1500) percent = (gs.nature / 1500) * 100;
  else if (gs.nature >= 300) percent = 10 + ((gs.nature - 300) / (1500 - 300)) * 90;
  else if (gs.nature > 0) percent = 10;
  else percent = 0;

  const prime = Math.round(Math.abs(gs.money) * (percent/100));
  if (prime>0){
    gs.money += prime;
    gs.budgetEtat += prime;
    showMsg(`üå± Prime EH : +${prime}‚Ç¨ (Budget √âtat +${prime}‚Ç¨)`);
    updateBudgetUI();
  }
}
function applyEHFonte(){
  if (gs.money === 0) return;
  const amt = Math.round(Math.abs(gs.money) * CFG.eh.fonteRate);
  if (amt>0){
    gs.money += (gs.money>0 ? -amt : +amt);
    showMsg(`üí∏ Fonte EH : ¬±${Math.round(CFG.eh.fonteRate*100)}% ‚Üí ${fmtEuros(gs.money)}`);
  }
}
/* Taxe EH (4%) sur toute transaction mon√©taire (achats & ventes), appliqu√©e apr√®s transaction */
function applyEHTax(amount){
  if (!gs.ehActivated) return 0;
  const tax = Math.round(Math.abs(amount) * CFG.eh.transactionTax);
  gs.money -= tax; // frais "√©cologiques" non budg√©taires
  return tax;
}

/* ============================================================
   EH ‚Äî Investissements √©cologiques (avanc√© + fixe)
   ============================================================ */
function updateInvestmentPreview(){
  const input = document.getElementById("investment-amount");
  const preview = document.getElementById("investment-preview");
  const val = parseInt(input.value||"0",10);
  if (!val || val<=0){ preview.textContent=""; return; }

  const maxInv = (gs.money>=0) ? gs.money : Math.abs(gs.money);
  if (val > maxInv){ preview.textContent = `‚ùå Montant trop √©lev√© (max ${maxInv}‚Ç¨)`; preview.style.color="#cc0000"; return; }

  // Gain ressources selon pression inverse sur nature (min 3, max 50)
  const factor = 30;
  const bonus = (val / (gs.nature+1)) * (3000 / (gs.nature+1));
  let resGain = Math.max(3, Math.round(bonus * factor));
  resGain = Math.min(resGain, 50);

  const moneyReturn = val + Math.ceil(val * 0.02);
  preview.textContent = `üìà Retour dans 10 clics : +${resGain} ressources, +${moneyReturn} ‚Ç¨`;
  preview.style.color = "#2e7d32";
}
function makeEcologicalInvestment(){
  if (!gs.ehActivated) return;
  const input = document.getElementById("investment-amount");
  const amount = parseInt(input.value||"0",10);
  if (!amount || amount<=0){ showMsg("Montant invalide"); return; }

  const maxInv = (gs.money>=0) ? gs.money : Math.abs(gs.money);
  if (amount > maxInv){ showMsg(`Montant trop √©lev√© (max ${maxInv}‚Ç¨)`); return; }

  saveSnapshot();
  gs.money -= amount;
  gs.ecologicalInvestments.push({ amount, remainingClicks:10, startClick:gs.clicks });
  input.value=""; updateInvestmentPreview(); updateInvestmentList();
  showMsg(`Investissement √©cologique de ${amount}‚Ç¨ (retour dans 10 clics)`);
  fullUpdate();
}
function processEcologicalInvestments(){
  if (gs.ecologicalInvestments.length===0) return;
  let totalRes=0,totalMoney=0;
  for (let i=gs.ecologicalInvestments.length-1;i>=0;i--){
    gs.ecologicalInvestments[i].remainingClicks--;
    if (gs.ecologicalInvestments[i].remainingClicks<=0){
      const inv = gs.ecologicalInvestments[i];
      // Calcul du gain
      const factor = 30;
      const bonus = (inv.amount / (gs.nature+1)) * (3000 / (gs.nature+1));
      let resGain = Math.max(3, Math.round(bonus * factor));
      resGain = Math.min(resGain, 50);
      const moneyReturn = inv.amount + Math.ceil(inv.amount * 0.02);
      gs.nature += resGain; gs.money += moneyReturn;
      totalRes += resGain; totalMoney += moneyReturn;
      gs.ecologicalInvestments.splice(i,1);
    }
  }
  if (totalRes>0){ showMsg(`Investissements restitu√©s : +${totalRes} ressources, +${totalMoney}‚Ç¨`); }
  updateInvestmentList();
}
function updateInvestmentList(){
  const list = document.getElementById("investment-list");
  if (gs.ecologicalInvestments.length===0){ list.textContent="Aucun investissement en cours"; return; }
  list.innerHTML = "En cours :<br/>" + gs.ecologicalInvestments.map(x=>`‚Ä¢ ${x.amount}‚Ç¨ (dans ${x.remainingClicks} clics)`).join("<br/>");
}
function investirEcologieFixe(){
  if (!gs.ehActivated) return;
  const cost = 200;
  if (gs.money < cost){ showMsg("Fonds insuffisants (200‚Ç¨)"); return; }
  saveSnapshot();
  gs.money -= cost;
  gs.nature += 30;
  gs.clicks++;
  randomEvents.processClick(false);
  // Taxe EH apr√®s transaction
  const t = applyEHTax(cost);
  applyOverdraftInterest();
  processEHAfterClick();
  showMsg(`üåø Investissement fixe : -200‚Ç¨ (+30 ressources)${t?` (frais EH ${t}‚Ç¨)`:''}`);
  fullUpdate();
}

/* ============================================================
   CR√âDIT (one-shot) & N√âGOCIATION
   ============================================================ */
function needsCredit(cost){ return (gs.money < cost) && !gs.creditButtonShown; }
function showCreditButton(type,cost){
  gs.pendingPurchase = { type, cost };
  show(document.getElementById("credit-btn"));
  gs.creditButtonShown = true;
  showMsg("üí≥ Cr√©dit disponible pour finaliser l'achat");
}
function activateCredit(){
  if (!gs.pendingPurchase) return;
  saveSnapshot();
  const p = gs.pendingPurchase;
  gs.money -= p.cost; // achat r√©alis√©, m√™me si n√©gatif
  executePendingPurchase(p.type);
  gs.pendingPurchase = null;
  hide(document.getElementById("credit-btn"));
  gs.clicks++;
  randomEvents.processClick(false);
  applyOverdraftInterest();
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  showMsg("Cr√©dit valid√© ‚úÖ");
  fullUpdate();
}
function executePendingPurchase(type){
  switch(type){
    case 'comfort': gs.confort+=1; break;
    case 'ia': buyIAEffect(); break;
    case 'trader': buyTraderEffect(); break;
    case 'confortAuto': buyConfortAutoEffect(); break;
    case 'centre': buyCentreEffect(); break;
    case 'upgrade': applyUpgradeEffect(); break;
    case 'priceIndicator': gs.priceIndicatorActive=true; show(document.getElementById("price-indicator")); break;
    case 'autoClicks': gs.automationsClickScore=true; break;
  }
}
function negocierTaux(){
  // Appara√Æt tous les 300 clics si non utilis√© 3 fois ; co√ªt 2000‚Ç¨ ; -1pp (min 1%).
  const canAppear = (gs.clicks - gs.lastNegotiationShownAt >= CFG.credit.negoEveryClicks);
  if (!canAppear || gs.creditNegotiationsUsed >= CFG.credit.negoMax){ showMsg("N√©gociation indisponible"); return; }

  const cost = CFG.credit.negoCost;
  if (gs.money < cost){ showMsg("Fonds insuffisants pour n√©gocier (2000‚Ç¨)"); return; }

  saveSnapshot();
  gs.money -= cost;
  if (gs.ehActivated){ applyEHTax(cost); }
  gs.creditRate = Math.max(CFG.credit.minRate, Math.round((gs.creditRate - CFG.credit.negoStep)*100)/100);
  gs.creditNegotiationsUsed++;
  gs.lastNegotiationShownAt = gs.clicks;
  showMsg(`ü§ù Taux n√©goci√© : ${Math.round(gs.creditRate*100)}% (utilisations ${gs.creditNegotiationsUsed}/3)`);
  fullUpdate();
}

/* ============================================================
   ACTIONS DE BASE
   ============================================================ */
function produce(){
  if (gs.jeuBloque || gs.gameOver || gs.optimumVictory) return;
  saveSnapshot();
  const unitCost = Math.max(CFG.upgrades.minProdCost, CFG.baseProdCost - gs.prodUpgrades);
  if (gs.nature >= unitCost){
    gs.nature -= unitCost;
    gs.production += Math.floor(gs.productionMultiplier);
    gs.clicks++;
    randomEvents.processClick(false);
    if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
    applyOverdraftInterest();
    showMsg(`Production +${Math.floor(gs.productionMultiplier)} (co√ªt ${unitCost})`);
    fullUpdate();
  } else {
    showMsg(`Ressources insuffisantes (co√ªt ${unitCost})`);
  }
}
function sell(){
  if (gs.jeuBloque || gs.gameOver || gs.optimumVictory) return;
  if (gs.production<=0){ showMsg("Aucun produit √† vendre"); return; }
  saveSnapshot();
  const price = calculatePrice();
  const qty = 1;
  gs.money += price * qty;
  gs.production -= qty;
  if (!gs.monnaieActive){ gs.monnaieActive = true; show(document.getElementById("money-row")); show(document.getElementById("jg-money")); }
  gs.clicks++;
  randomEvents.processClick(false);
  if (gs.ehActivated){ const t = applyEHTax(price*qty); if(t){} processEHAfterClick(); } else maybeApplyTax();
  applyOverdraftInterest();
  showMsg(`Vendu : +${(price*qty).toFixed(2)}‚Ç¨`);
  fullUpdate();
}
function receiveDon(){
  if (gs.jeuBloque || gs.gameOver || gs.optimumVictory) return;
  saveSnapshot();
  const d = computeDonByResources();
  gs.money += d;
  gs.budgetEtat += d; // hors EH : le bouton de don alimente aussi l'√âtat
  if (!gs.monnaieActive){ gs.monnaieActive = true; show(document.getElementById("money-row")); show(document.getElementById("jg-money")); }
  gs.clicks++;
  randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  updateBudgetUI();
  hide(document.getElementById("don-btn"));
  showMsg(`Don re√ßu : +${d}‚Ç¨ (Budget √âtat +${d}‚Ç¨)`);
  fullUpdate();
}

/* ============================================================
   ACHATS & PALIERS (visibilit√© fixe + co√ªts cycliques)
   ============================================================ */
const dynamicCost = {
  ia: (n)=> Math.round(CFG.auto.ia.baseCost * Math.pow(CFG.auto.ia.mult, n)),
  trader: (n)=> Math.round(CFG.auto.trader.baseCost * Math.pow(CFG.auto.trader.mult, n)),
  confortAuto: (n)=> Math.round(CFG.auto.autoConfort.baseCost * Math.pow(CFG.auto.autoConfort.mult, n)),
  centre: (n)=> Math.round(CFG.auto.centre.baseCost * Math.pow(CFG.auto.centre.mult, n)),
  upgrade: (n)=> Math.round(CFG.upgrades.cost * Math.pow(CFG.upgrades.multPerUpgrade, n)),
};

function acheterConfort(){
  if (!gs.monnaieActive){ showMsg("Active d'abord la monnaie (vendre / don)"); return; }
  const cost = CFG.comfort.cost;
  if (needsCredit(cost)){ showCreditButton('comfort',cost); return; }
  if (gs.money < cost){ showMsg("Fonds insuffisants"); return; }
  saveSnapshot();
  gs.money -= cost;
  if (gs.ehActivated) applyEHTax(cost);
  gs.confort += 1;
  gs.clicks++;
  randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  if (gs.confort===1){ show(document.getElementById("jg-confort")); }
  showMsg("Confort +1");
  fullUpdate();
}

function acheterIA(){
  const cost = dynamicCost.ia(gs.ia>0 ? Math.log2(gs.ia)+0 : 0); // co√ªt cyclique par nb d'achats (doublement interne)
  if (needsCredit(cost)){ showCreditButton('ia',cost); return; }
  if (gs.money < cost){ showMsg("Fonds insuffisants"); return; }
  saveSnapshot();
  gs.money -= cost; if (gs.ehActivated) applyEHTax(cost);
  buyIAEffect();
  gs.clicks++; randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  showMsg(`IA engag√©e (√ó${gs.ia}) ‚Äî Tick 5s`);
  fullUpdate();
}
function buyIAEffect(){
  if (gs.ia===0){ gs.ia=1; show(document.getElementById("jg-ia")); startIA(); }
  else { gs.ia*=2; clearInterval(intervals.ia); startIA(); }
}

function acheterTrader(){
  const already = purchasesCount.trader; const cost = dynamicCost.trader(already);
  if (needsCredit(cost)){ showCreditButton('trader',cost); return; }
  if (gs.money < cost){ showMsg("Fonds insuffisants"); return; }
  saveSnapshot();
  gs.money -= cost; if (gs.ehActivated) applyEHTax(cost);
  buyTraderEffect();
  gs.clicks++; randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  showMsg(`Trader auto √ó${gs.trader} ‚Äî Tick 3s`);
  fullUpdate();
}
function buyTraderEffect(){
  gs.trader = Math.max(1, gs.trader*2 || 1);
  show(document.getElementById("jg-trader"));
  clearInterval(intervals.trader); startTrader();
  purchasesCount.trader++;
}

function acheterConfortAuto(){
  const c = purchasesCount.confortAuto; const cost = dynamicCost.confortAuto(c);
  if (needsCredit(cost)){ showCreditButton('confortAuto',cost); return; }
  if (gs.money < cost){ showMsg("Fonds insuffisants"); return; }
  saveSnapshot();
  gs.money -= cost; if (gs.ehActivated) applyEHTax(cost);
  buyConfortAutoEffect();
  gs.clicks++; randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  showMsg(`Achat auto confort √ó${gs.confortAuto} ‚Äî Tick 15s`);
  fullUpdate();
}
function buyConfortAutoEffect(){
  gs.confortAuto = Math.max(1, gs.confortAuto*2 || 1);
  show(document.getElementById("jg-achat"));
  clearInterval(intervals.autoConfort); startAutoConfort();
  purchasesCount.confortAuto++;
}

function acheterCentreCommercial(){
  const c = purchasesCount.centre; const cost = dynamicCost.centre(c);
  if (needsCredit(cost)){ showCreditButton('centre',cost); return; }
  if (gs.money < cost){ showMsg("Fonds insuffisants"); return; }
  saveSnapshot();
  gs.money -= cost; if (gs.ehActivated) applyEHTax(cost);
  buyCentreEffect();
  gs.clicks++; randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  showMsg(`Centre commercial √ó${gs.centre} ‚Äî Tick 15s`);
  fullUpdate();
}
function buyCentreEffect(){
  gs.centre = Math.max(1, gs.centre*2 || 1);
  show(document.getElementById("jg-centre"));
  clearInterval(intervals.centre); startCentre();
  purchasesCount.centre++;
}

function upgradeProduction(){
  if (gs.prodUpgrades>=CFG.upgrades.max){ showMsg("Am√©liorations √©puis√©es"); return; }
  const cost = dynamicCost.upgrade(gs.prodUpgrades);
  if (needsCredit(cost)){ showCreditButton('upgrade',cost); return; }
  if (gs.money < cost){ showMsg("Fonds insuffisants"); return; }
  saveSnapshot();
  gs.money -= cost; if (gs.ehActivated) applyEHTax(cost);
  applyUpgradeEffect();
  gs.clicks++; randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  showMsg(`üí† Upgrade : co√ªt‚Äëprod -1 & multiplicateur √ó${gs.productionMultiplier.toFixed(1)}`);
  fullUpdate();
}
function applyUpgradeEffect(){
  gs.prodUpgrades = Math.min(CFG.upgrades.max, gs.prodUpgrades+1);
  gs.techLevel += 1; show(document.getElementById("jg-tech"));
  gs.productionMultiplier = parseFloat((gs.productionMultiplier * CFG.upgrades.multPerUpgrade).toFixed(4));
  hide(document.getElementById("upgrade-btn")); // se r√©affichera au prochain palier fixe si <= max
}

function acheterAutomatismsClics(){
  const cost = CFG.auto.autoClicksCost;
  if (needsCredit(cost)){ showCreditButton('autoClicks',cost); return; }
  if (gs.money < cost){ showMsg("Fonds insuffisants"); return; }
  saveSnapshot();
  gs.money -= cost; if (gs.ehActivated) applyEHTax(cost);
  gs.automationsClickScore = true;
  gs.clicks++; randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  hide(document.getElementById("automatisms-btn"));
  showMsg("‚ö° Les actions automatiques comptent comme des clics");
  fullUpdate();
}
function acheterIndicateurPrix(){
  const cost = CFG.priceIndicator.cost;
  if (needsCredit(cost)){ showCreditButton('priceIndicator',cost); return; }
  if (gs.money < cost){ showMsg("Fonds insuffisants"); return; }
  saveSnapshot();
  gs.money -= cost; if (gs.ehActivated) applyEHTax(cost);
  gs.priceIndicatorActive = true; show(document.getElementById("price-indicator"));
  gs.clicks++; randomEvents.processClick(false);
  if (gs.ehActivated) processEHAfterClick(); else maybeApplyTax();
  applyOverdraftInterest();
  hide(document.getElementById("price-indicator-btn"));
  showMsg("üìä Indicateur de prix activ√©");
  fullUpdate();
}

/* Suivi des achats cycliques par type (pour afficher les co√ªts progressifs) */
const purchasesCount = { trader:0, confortAuto:0, centre:0 };

/* ============================================================
   AUTOMATISMES (IA 5s, Trader 3s, Auto/Centre 15s)
   ============================================================ */
function startIA(){
  if (intervals.ia) clearInterval(intervals.ia);
  intervals.ia = setInterval(()=>{
    if (gs.jeuBloque||gs.gameOver||gs.ehActivated||gs.optimumVictory) return;
    const totalCost = CFG.auto.ia.resCostPerIA * gs.ia;
    if (gs.nature >= totalCost){
      gs.nature -= totalCost;
      const prod = Math.floor(gs.ia * gs.productionMultiplier);
      gs.production += prod;
      if (gs.automationsClickScore){
        gs.clicks += Math.max(1, prod);
        randomEvents.processClick(true);
        maybeApplyTax();
        applyOverdraftInterest();
      }
      liteUpdate();
    }
  }, CFG.auto.ia.tick);
  updateAutomatismControls();
}
function startTrader(){
  if (intervals.trader) clearInterval(intervals.trader);
  intervals.trader = setInterval(()=>{
    if (gs.jeuBloque||gs.gameOver||gs.ehActivated||gs.optimumVictory) return;
    const qty = Math.min(gs.production, Math.max(1, gs.trader));
    if (qty>0){
      const price = calculatePrice();
      const earn = price * qty;
      gs.production -= qty; gs.money += earn;
      if (gs.automationsClickScore){
        gs.clicks += qty;
        randomEvents.processClick(true);
        maybeApplyTax();
        applyOverdraftInterest();
      }
      liteUpdate();
    }
  }, CFG.auto.trader.tick);
  updateAutomatismControls();
}
function startAutoConfort(){
  if (intervals.autoConfort) clearInterval(intervals.autoConfort);
  intervals.autoConfort = setInterval(()=>{
    if (gs.jeuBloque||gs.gameOver||gs.ehActivated||gs.optimumVictory) return;
    const unit = Math.max(1, gs.confortAuto);
    const cost = CFG.auto.autoConfort.unitPrice * unit;
    if (gs.money >= cost || gs.creditButtonShown){
      gs.money -= cost;
      gs.confort += unit;
      if (gs.automationsClickScore){
        gs.clicks += unit; randomEvents.processClick(true); maybeApplyTax(); applyOverdraftInterest();
      }
      liteUpdate();
    }
  }, CFG.auto.autoConfort.tick);
  updateAutomatismControls();
}
function startCentre(){
  if (intervals.centre) clearInterval(intervals.centre);
  intervals.centre = setInterval(()=>{
    if (gs.jeuBloque||gs.gameOver||gs.ehActivated||gs.optimumVictory) return;
    const achat = CFG.auto.centre.confortPerCentre * Math.max(1, gs.centre);
    const cost = CFG.auto.centre.unitPrice * achat;
    if (gs.money >= cost || gs.creditButtonShown){
      gs.money -= cost; gs.confort += achat;
      if (gs.automationsClickScore){
        gs.clicks += achat; randomEvents.processClick(true); maybeApplyTax(); applyOverdraftInterest();
      }
      liteUpdate();
    }
  }, CFG.auto.centre.tick);
  updateAutomatismControls();
}
/* ON/OFF visuel (arr√™t/reprise des intervalles) */
function toggleAutomatism(type){
  if (gs.ehActivated || gs.optimumVictory) return;
  if (type==='ia' && gs.ia>0){ if (intervals.ia){ clearInterval(intervals.ia); intervals.ia=null;} else startIA(); }
  if (type==='trader' && gs.trader>0){ if (intervals.trader){ clearInterval(intervals.trader); intervals.trader=null;} else startTrader(); }
  if (type==='confort' && gs.confortAuto>0){ if (intervals.autoConfort){ clearInterval(intervals.autoConfort); intervals.autoConfort=null;} else startAutoConfort(); }
  if (type==='centre' && gs.centre>0){ if (intervals.centre){ clearInterval(intervals.centre); intervals.centre=null;} else startCentre(); }
  updateAutomatismControls();
}
function updateAutomatismControls(){
  const any = gs.ia>0||gs.trader>0||gs.confortAuto>0||gs.centre>0;
  const panel = document.getElementById("automatisms-controls");
  panel.style.display = (any && !gs.ehActivated && !gs.optimumVictory) ? "flex":"none";
  btnState("control-ia", gs.ia>0, !!intervals.ia, "ü§ñ IA");
  btnState("control-trader", gs.trader>0, !!intervals.trader, "üí∞ Trader");
  btnState("control-confort", gs.confortAuto>0, !!intervals.autoConfort, "üõãÔ∏è Confort");
  btnState("control-centre", gs.centre>0, !!intervals.centre, "üè¨ Centre");
}
function btnState(id, available, on, label){
  const b = document.getElementById(id);
  if (!available){ b.className="control-btn disabled"; b.textContent=label+": OFF"; return; }
  b.className="control-btn "+(on?"active":"inactive");
  b.textContent = label+" : "+(on?"ON":"OFF");
}

/* ============================================================
   EH ‚Äî Activation / Secours
   ============================================================ */
function evolution(){
  if (gs.ehActivated || !gs.monnaieActive) return;
  saveSnapshot();
  activateEH(false);
  showMsg("üå± EH activ√©e : √©conomie durable, dons/prime/fonte/bonus, investissements √©cologiques");
  fullUpdate();
}
function activateRescueEH(){
  if (gs.optimumVictory) return;
  saveSnapshot();
  gs.nature += 100; gs.confort += 50;
  if (gs.confort > gs.confortMaxAtteint) gs.confortMaxAtteint = gs.confort;
  activateEH(true);
  showMsg("üå± Secours EH : +100 ressources, +50 confort");
  fullUpdate();
}
function activateEH(isRescue){
  gs.ehActivated = true;
  gs.taxEnabled = false;
  gs.ehPrimeClicks = gs.ehFonteClicks = gs.ehBonusClicks = 0;

  // Par d√©faut OFF pendant EH
  clearAllIntervals();
  document.getElementById("automatisms-controls").style.display="none";

  show(document.getElementById("investment-block"));
  show(document.getElementById("invest-eco-fixed-btn"));
  hide(document.getElementById("evolution-btn"));
  hide(document.getElementById("rescue-eh-btn"));
  hide(document.getElementById("game-over-resources"));
  hide(document.getElementById("game-over-confort"));

  const box = document.getElementById("eh-success");
  box.textContent = "üå± √âconomie hom√©ostatique activ√©e";
  show(box);

  setTimeout(()=> showMsg("Investissez pour stabiliser la plan√®te, la friction EH (4%) s'applique aux transactions."), 800);
}

/* ============================================================
   PALIERS (visibilit√© fixe)
   ============================================================ */
function checkFixedUnlocks(){
  if (gs.clicks>=CFG.comfort.unlockAtClicks && !gs.unlocked.comfort){
    gs.unlocked.comfort = true; show(document.getElementById("comfort-btn"));
  }
  // IA r√©appara√Æt tous les 200 clics
  if (gs.clicks>0 && gs.clicks % CFG.unlockFixed.iaEvery === 0) show(document.getElementById("ouvrier-btn"));
  if (gs.clicks>=CFG.unlockFixed.traderAt) show(document.getElementById("trader-btn"));
  if (gs.clicks>=CFG.unlockFixed.autoConfortAt) show(document.getElementById("comfort-auto-btn"));
  if (gs.clicks>=CFG.unlockFixed.autoClicksAt && !gs.automationsClickScore) show(document.getElementById("automatisms-btn"));
  if (gs.clicks>=CFG.unlockFixed.indicatorAt && !gs.priceIndicatorActive) show(document.getElementById("price-indicator-btn"));
  if (gs.clicks>=CFG.unlockFixed.centreAt) show(document.getElementById("centre-commercial-btn"));

  // Upgrade prod aux paliers 400/700/1100 tant que < 3
  if (gs.prodUpgrades < CFG.upgrades.max){
    const need = CFG.upgrades.paliersFixed[gs.prodUpgrades];
    if (gs.clicks >= need) show(document.getElementById("upgrade-btn"));
  }
}

/* ============================================================
   ZONE D'OPTIMUM (victoire √† 50)
   ============================================================ */
function isInOptimum(){
  return (
    gs.nature>=CFG.optimum.nature[0] && gs.nature<=CFG.optimum.nature[1] &&
    gs.confort>=CFG.optimum.confort[0] && gs.confort<=CFG.optimum.confort[1] &&
    gs.money>=CFG.optimum.money[0] && gs.money<=CFG.optimum.money[1]
  );
}
function checkOptimum(){
  if (gs.optimumVictory) return;
  if (isInOptimum()){
    gs.optimumStreak++;
    if ([10,20,30,40].includes(gs.optimumStreak)){ showMsg(`üéØ Excellent ! √âquilibre maintenu depuis ${gs.optimumStreak} actions`); }
    if (gs.optimumStreak>=CFG.optimum.target){ triggerVictory(); }
  } else { if (gs.optimumStreak>0) gs.optimumStreak=0; }
  updateOptimumUI();
}
function triggerVictory(){
  gs.optimumVictory = true; gs.jeuBloque = true; clearAllIntervals(); hideActionButtons();
  document.getElementById("optimum-victory").classList.remove("hidden");
  showMsg("üèÜ Victoire : √©quilibre maintenu 50 actions !");
}
function updateOptimumUI(){
  const pct = Math.min(100, (gs.optimumStreak/CFG.optimum.target)*100);
  document.getElementById("optimum-progress-fill").style.width = pct+"%";
  document.getElementById("optimum-progress-text").textContent = `${gs.optimumStreak} / ${CFG.optimum.target}`;
  const status = document.getElementById("optimum-status");
  if (gs.optimumVictory){ status.textContent="üèÜ Victoire atteinte !"; status.style.color= "#b8860b"; status.style.fontWeight="700"; }
  else if (isInOptimum()){ status.textContent="‚úÖ Dans la zone d‚Äôoptimum !"; status.style.color="#2e7d32"; status.style.fontWeight="700"; }
  else { status.textContent="‚ùå Ajustez vos leviers"; status.style.color="#cc0000"; status.style.fontWeight="normal"; }
}

/* ============================================================
   ALERTES / GAME OVER
   ============================================================ */
function updateAlerts(){
  const crise = document.getElementById("alert-crise");
  if (gs.nature < 300){ crise.textContent="Crise √©cologique : risque sur l'habitabilit√©"; crise.className="message-box msg-orange"; show(crise); }
  else hide(crise);

  const social = document.getElementById("social-crise");
  if (gs.confort <= 5 && gs.confortMaxAtteint > 5 && !gs.gameOver){ social.textContent="‚ö†Ô∏è Risque de crise sociale majeure"; show(social); }
  else hide(social);

  if (!gs.ehActivated && !gs.gameOver && !gs.optimumVictory && (gs.nature <= 100) && gs.monnaieActive){
    const ehBox = document.getElementById("eh-msg");
    ehBox.textContent="Une √©volution est possible : passer √† l'√©conomie hom√©ostatique (EH)";
    show(ehBox); show(document.getElementById("evolution-btn"));
  } else { hide(document.getElementById("eh-msg")); hide(document.getElementById("evolution-btn")); }

  // Auto‚ÄëEH si nature ‚â§ 50
  if (!gs.ehActivated && gs.nature <= CFG.ehAutoTriggerAt && gs.monnaieActive){ evolution(); }

  // Afficher secours si GO latent
  if (!gs.ehActivated && !gs.optimumVictory && (gs.nature<=0 || (gs.confort<=0 && gs.confortMaxAtteint>0))){
    show(document.getElementById("rescue-eh-btn"));
  }
}
function checkGameOver(){
  if (!gs.gameOver && !gs.ehActivated && !gs.optimumVictory){
    if (gs.nature <= 0){ triggerGO('resources'); return true; }
    if (gs.confort <= 0 && gs.confortMaxAtteint > 0){ triggerGO('confort'); return true; }
  }
  return false;
}
function triggerGO(cause){
  gs.gameOver = true; gs.gameOverCause = cause; gs.jeuBloque = true; clearAllIntervals(); hideActionButtons();
  if (cause==='resources'){ const box = document.getElementById("game-over-resources"); box.textContent="üåç La plan√®te n'est plus habitable : Perdu !"; show(box); }
  if (cause==='confort'){ const box = document.getElementById("game-over-confort"); box.textContent="‚öîÔ∏è Crise sociale : Perdu !"; show(box); }
  setTimeout(()=>{ show(document.getElementById("rescue-eh-btn")); showMsg("üå± Solution de secours disponible : passer √† l'EH"); }, 3000);
}
function hideActionButtons(){
  ["produce-btn","sell-btn","comfort-btn","don-btn","credit-btn","ouvrier-btn","trader-btn","comfort-auto-btn","upgrade-btn","automatisms-btn","centre-commercial-btn","price-indicator-btn","evolution-btn"].forEach(id=>hide(document.getElementById(id)));
  document.getElementById("automatisms-controls").style.display="none";
}

/* ============================================================
   UI (valeurs + jauges + paliers + indicateurs)
   ============================================================ */
function updateBudgetUI(){
  if (gs.budgetEtat>0){ show(document.getElementById("budget-row")); show(document.getElementById("jg-budget")); }
  const maxB = Math.max(1000, gs.budgetEtat*1.3);
  const pct = Math.min(100, (gs.budgetEtat/maxB)*100);
  document.getElementById("jauge-budget").style.width = pct+"%";
  document.getElementById("jbudget").textContent = fmtEuros(gs.budgetEtat);
}
function liteUpdate(){
  document.getElementById("nature").textContent = Math.floor(gs.nature);
  document.getElementById("confort").textContent = Math.floor(gs.confort);
  document.getElementById("production").textContent = Math.floor(gs.production);
  document.getElementById("money").textContent = Math.floor(gs.money);
  document.getElementById("clicks").textContent = gs.clicks;

  if (gs.confort > gs.confortMaxAtteint) gs.confortMaxAtteint = gs.confort;

  // jauges
  const maxN = Math.max(3000, gs.nature*1.2);
  document.getElementById("jauge-nature").style.width = Math.min(100,(gs.nature/maxN)*100)+"%";
  document.getElementById("jnature").textContent = Math.floor(gs.nature);

  if (gs.confort>0){
    show(document.getElementById("jg-confort"));
    const maxC = Math.max(100, gs.confort*1.2);
    document.getElementById("jauge-confort").style.width = Math.min(100,(gs.confort/maxC)*100)+"%";
    document.getElementById("jconfort").textContent = Math.floor(gs.confort);
  }
  if (gs.monnaieActive){
    show(document.getElementById("jg-money"));
    const maxM = Math.max(10000, Math.abs(gs.money)*1.2);
    document.getElementById("jauge-money").style.width = Math.min(100,(Math.abs(gs.money)/maxM)*100)+"%";
    document.getElementById("jmoney").textContent = fmtEuros(gs.money);
  }
  if (gs.priceIndicatorActive){
    show(document.getElementById("price-indicator"));
    document.getElementById("current-price").textContent = calculatePrice().toFixed(2)+"‚Ç¨";
  }
  if (gs.confortAuto>0){
    show(document.getElementById("jg-achat"));
    const max = Math.max(10, gs.confortAuto*1.2);
    document.getElementById("jauge-achat").style.width = Math.min(100,(gs.confortAuto/max)*100)+"%";
    document.getElementById("jachat").textContent = "√ó"+gs.confortAuto;
  }
  if (gs.ia>0){
    show(document.getElementById("jg-ia"));
    const max = Math.max(10, gs.ia*1.2);
    document.getElementById("jauge-ia").style.width = Math.min(100,(gs.ia/max)*100)+"%";
    document.getElementById("jia").textContent = "√ó"+gs.ia;
  }
  if (gs.trader>0){
    show(document.getElementById("jg-trader"));
    const max = Math.max(10, gs.trader*1.2);
    document.getElementById("jauge-trader").style.width = Math.min(100,(gs.trader/max)*100)+"%";
    document.getElementById("jtrader").textContent = "√ó"+gs.trader;
  }
  if (gs.centre>0){
    show(document.getElementById("jg-centre"));
    const max = Math.max(10, gs.centre*1.2);
    document.getElementById("jauge-centre").style.width = Math.min(100,(gs.centre/max)*100)+"%";
    document.getElementById("jcentre").textContent = "√ó"+gs.centre;
  }
  if (gs.techLevel>0){
    show(document.getElementById("jg-tech"));
    const max = Math.max(5, gs.techLevel*1.2);
    document.getElementById("jauge-tech").style.width = Math.min(100,(gs.techLevel/max)*100)+"%";
    document.getElementById("jtech").textContent = `Niv.${gs.techLevel} (√ó${gs.productionMultiplier.toFixed(1)})`;
  }
}
function fullUpdate(){
  liteUpdate();
  updateBudgetUI();
  updateAlerts();
  checkFixedUnlocks();
  checkOptimum();
  if (checkGameOver()) return;
}

/* ============================================================
   TRICHE
   ============================================================ */
function toggleCheat(){
  cheatUnlocked = !cheatUnlocked;
  const box = document.getElementById("cheat-box");
  const btn = document.getElementById("unlock-cheat");
  if (cheatUnlocked){ show(box); btn.textContent="üîí Masquer les outils de test"; btn.className="btn-annuler"; showMsg("Outils de test activ√©s"); }
  else { hide(box); btn.textContent="üîì D√©verrouiller les outils de test"; btn.className="btn-yellow"; showMsg("Outils de test masqu√©s"); }
}
function cheatAddMoney(){ if(!cheatUnlocked) return; saveSnapshot(); gs.money+=1000; gs.monnaieActive=true; show(document.getElementById("money-row")); show(document.getElementById("jg-money")); fullUpdate(); }
function cheatAddNature(){ if(!cheatUnlocked) return; saveSnapshot(); gs.nature+=100; fullUpdate(); }
function cheatAddClicks(){ if(!cheatUnlocked) return; saveSnapshot(); gs.clicks+=50; fullUpdate(); }
function cheatRemoveNature(){ if(!cheatUnlocked) return; saveSnapshot(); gs.nature=Math.max(0, gs.nature-100); fullUpdate(); }
function cheatForceEH(){ if(!cheatUnlocked) return; saveSnapshot(); if(!gs.ehActivated) activateEH(false); fullUpdate(); }

/* ============================================================
   √âV√âNEMENTS (1‚Äì160) ‚Äî tirage 20‚Äì60, anti‚Äër√©p√©tition (5)
   ============================================================ */
const randomEvents = {
  enabled: true, nextIn: 0, recent: [], window: 5, activeTemp: [],
  init(){ this.schedule(); },
  schedule(){ this.nextIn = Math.floor(Math.random()*41)+20; },
  processClick(isAuto){
    if (!this.enabled) return;
    if (--this.nextIn<=0){ this.trigger(); this.schedule(); }
    this.tickTemps();
  },
  trigger(){
    const pool = this.events.filter((e,i)=>!this.recent.includes(i));
    const evIndex = (pool.length? this.events.indexOf(pool[Math.floor(Math.random()*pool.length)]) : Math.floor(Math.random()*this.events.length));
    const ev = this.events[evIndex];
    this.recent.push(evIndex); if (this.recent.length>this.window) this.recent.shift();
    saveSnapshot();
    ev.effect(gs, this);
    // UI vignette 5s
    const box=document.getElementById("event-box"), txt=document.getElementById("event-text"), fx=document.getElementById("event-effects");
    if (box){ txt.textContent="üåø "+ev.name+" ‚Äî "+ev.text; fx.textContent=ev.hint||""; box.style.display="block"; setTimeout(()=>{ box.style.display="none"; }, 5000); }
    setTimeout(()=> fullUpdate(), 80);
  },
  addTemp(type,value,dur){ this.activeTemp.push({type,value,remain:dur}); },
  mod(type){ return this.activeTemp.reduce((s,e)=>s+(e.type===type?e.value:0),0); },
  tickTemps(){ for(let i=this.activeTemp.length-1;i>=0;i--){ if(--this.activeTemp[i].remain<=0) this.activeTemp.splice(i,1); } },
  getState(){ return {enabled:this.enabled,nextIn:this.nextIn,recent:[...this.recent],activeTemp:JSON.parse(JSON.stringify(this.activeTemp))}; },
  setState(st){ this.enabled=st.enabled; this.nextIn=st.nextIn; this.recent=[...st.recent]; this.activeTemp=JSON.parse(JSON.stringify(st.activeTemp)); },

  // === 160 √©v√©nements vari√©s (g√©n√©r√©s) ===
  events: (function generate160(){
    const E=[];
    const push=(id,name,text,hint,effect)=>E.push({id,name,text,hint,effect});
    // 1‚Äì40 : ressources & confort
    for(let i=1;i<=10;i++){
      push(i, "Vague de chaleur "+i, "Stress hydrique.", "Ressources -"+(30+i*2), (g)=>{ g.nature = Math.max(0, g.nature-(30+i*2)); g.confort=Math.max(0,g.confort- (i%3===0?1:0)); });
    }
    for(let i=11;i<=20;i++){
      push(i, "Pluies salvatrices "+(i-10), "R√©pit √©cologique.", "Ressources +"+(20+(i-10)*3), (g)=>{ g.nature += (20+(i-10)*3); });
    }
    for(let i=21;i<=30;i++){
      push(i, "Tension sociale "+(i-20), "Protestations.", "Confort -1", (g)=>{ g.confort = Math.max(0, g.confort-1); });
    }
    for(let i=31;i<=40;i++){
      push(i, "Innovation verte "+(i-30), "Nouveaux proc√©d√©s.", "Ressources +15, Tech +1 (temp 20 clics)", (g,es)=>{ g.nature+=15; es.addTemp('techBoost',0.1,20); });
    }
    // 41‚Äì80 : monnaie & production
    for(let i=41;i<=50;i++){
      push(i, "Boom de la demande "+(i-40), "Les prix montent.", "Prix ‚Üë (temp 15 clics)", (g,es)=>{ es.addTemp('price',0.15,15); });
    }
    for(let i=51;i<=60;i++){
      push(i, "Crash de la demande "+(i-50), "Les prix baissent.", "Prix ‚Üì (temp 15 clics)", (g,es)=>{ es.addTemp('price',-0.15,15); });
    }
    for(let i=61;i<=70;i++){
      push(i, "Subvention cibl√©e "+(i-60), "Aide publique.", "+150‚Ç¨ & Budget +150‚Ç¨", (g)=>{ g.money+=150; g.budgetEtat+=150; });
    }
    for(let i=71;i<=80;i++){
      push(i, "Taxe carbone "+(i-70), "Co√ªts de transition.", "-80‚Ç¨", (g)=>{ g.money-=80; });
    }
    // 81‚Äì120 : automatismes & infrastructures
    for(let i=81;i<=90;i++){
      push(i, "Panne d'IA "+(i-80), "Arr√™ts temporaires.", "IA -1 (min 0)", (g)=>{ g.ia=Math.max(0,g.ia-1); });
    }
    for(let i=91;i<=100;i++){
      push(i, "Trader inspir√© "+(i-90), "Meilleures ventes.", "Vente +1/tick (temp 12 clics)", (g,es)=>{ es.addTemp('trader',1,12); });
    }
    for(let i=101;i<=110;i++){
      push(i, "Centre anim√© "+(i-100), "Affluence record.", "+10 confort imm√©diat", (g)=>{ g.confort+=10; });
    }
    for(let i=111;i<=120;i++){
      push(i, "Maintenance co√ªteuse "+(i-110), "R√©parations.", "-120‚Ç¨", (g)=>{ g.money-=120; });
    }
    // 121‚Äì160 : mix & effets temporaires
    for(let i=121;i<=130;i++){
      push(i, "Loterie √©cologique "+(i-120), "Projet r√©compens√©.", "+60‚Ç¨ & +40 ressources", (g)=>{ g.money+=60; g.nature+=40; });
    }
    for(let i=131;i<=140;i++){
      push(i, "Temp√™te exceptionnelle "+(i-130), "D√©g√¢ts infra.", "Ressources -40, IA -1", (g)=>{ g.nature=Math.max(0,g.nature-40); g.ia=Math.max(0,g.ia-1); });
    }
    for(let i=141;i<=150;i++){
      push(i, "Partenariat local "+(i-140), "Circuits courts.", "Prix ‚Üë10% (temp 18 clics)", (g,es)=>{ es.addTemp('price',0.10,18); });
    }
    for(let i=151;i<=160;i++){
      push(i, "Mobilisation citoyenne "+(i-150), "Solidarit√©.", "+1 confort & +30‚Ç¨", (g)=>{ g.confort+=1; g.money+=30; });
    }
    return E;
  })()
};
function toggleEvents(){ randomEvents.enabled = !randomEvents.enabled; showMsg("üé≤ √âv√©nements : "+(randomEvents.enabled?"ON":"OFF")); }

/* ============================================================
   INITIALISATION / RESTART
   ============================================================ */
function initialize(){
  // Intro sc√©naris√©e
  setTimeout(()=>showMsg("üåç La plan√®te est fragile. Vos choix √©conomiques comptent."), 1000);
  setTimeout(()=>showMsg("üõ†Ô∏è Produisez, vendez, achetez ‚Äî puis stabilisez."), 5000);
  setTimeout(()=>showMsg("üéØ Objectif : 50 actions cons√©cutives dans la zone d'√©quilibre."), 9000);
  randomEvents.init();
  fullUpdate();
}
function restartGame(){
  clearAllIntervals();
  gs = {
    nature:3000, confort:0, production:0, money:10,
    clicks:0, monnaieActive:false, priceIndicatorActive:false,
    budgetEtat:0, taxEnabled:true,
    creditButtonShown:false, pendingPurchase:null,
    creditRate:CFG.credit.rate, creditNegotiationsUsed:0, lastNegotiationShownAt:0,
    ehActivated:false, ehPrimeClicks:0, ehFonteClicks:0, ehBonusClicks:0,
    ia:0, trader:0, confortAuto:0, centre:0, automationsClickScore:false,
    prodUpgrades:0, productionMultiplier:1.0, techLevel:0,
    jeuBloque:false, gameOver:false, gameOverCause:null, confortMaxAtteint:0,
    optimumStreak:0, optimumVictory:false,
    ecologicalInvestments:[],
    unlocked:{comfort:false, ia:false, trader:false, autoConfort:false, centre:false, autoClicks:false, priceIndicator:false, upgrade:false}
  };
  cheatUnlocked = cheatUnlocked; // inchang√©
  intervals = { ia:null, trader:null, autoConfort:null, centre:null };
  purchasesCount.trader=0; purchasesCount.confortAuto=0; purchasesCount.centre=0;
  lastSnapshot=null;
  hide(document.getElementById("optimum-victory"));
  show(document.getElementById("produce-btn")); show(document.getElementById("sell-btn")); show(document.getElementById("don-btn"));
  ["comfort-btn","credit-btn","ouvrier-btn","trader-btn","comfort-auto-btn","upgrade-btn","automatisms-btn","centre-commercial-btn","price-indicator-btn","evolution-btn","rescue-eh-btn"].forEach(id=>hide(document.getElementById(id)));
  document.getElementById("investment-block").classList.add("hidden");
  document.getElementById("invest-eco-fixed-btn").classList.add("hidden");
  hide(document.getElementById("eh-success")); hide(document.getElementById("eh-msg"));
  hide(document.getElementById("game-over-resources")); hide(document.getElementById("game-over-confort"));
  hide(document.getElementById("alert-crise")); hide(document.getElementById("social-crise"));
  hide(document.getElementById("money-row")); hide(document.getElementById("budget-row")); hide(document.getElementById("price-indicator"));
  hide(document.getElementById("jg-money")); hide(document.getElementById("jg-budget")); hide(document.getElementById("jg-confort"));
  hide(document.getElementById("jg-achat")); hide(document.getElementById("jg-ia")); hide(document.getElementById("jg-trader")); hide(document.getElementById("jg-centre")); hide(document.getElementById("jg-tech"));
  document.getElementById("investment-list").textContent = "Aucun investissement en cours";
  document.getElementById("investment-preview").textContent = "";
  randomEvents.init();
  fullUpdate();
}

/* ============================================================
   BOUCLES D'APPEL PAR ACTION (ordre strict)
   - Incr√©mente clicks
   - √âv√©nement possible
   - Fiscalit√© (hors EH) OU cycles EH
   - Int√©r√™ts de d√©couvert
   - Mises √† jour UI & optimum
   ============================================================ */
// (d√©j√† respect√© dans chaque action via calls : processClick -> maybeApplyTax/processEHAfterClick -> applyOverdraftInterest)

/* ============================================================
   BOOT
   ============================================================ */
window.onload = initialize;
</script>
</body>
</html>
