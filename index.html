<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Looop ‚Äî 1.30.5</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f3f3; --card:#fff; --ink:#111; --muted:#666;
    --shadow:0 4px 24px #0001;
    --bar:#eee; --ok:#4CAF50; --ok2:#81C784; --danger:#c00;
    --res:#86e08e; --conf:#86b6ea; --money:#ffb3b3; --budget:#ff9800;
    --ia:#ab47bc; --trader:#26c6da; --auto:#ffa726; --centre:#66bb6a; --tech:#9c27b0;
    --eh:#2e7d32; --ehbg:#e8f5e8; --ehbord:#81c784;
    --toastbg:#fff9c4; --toastbd:#f4d03f; --toastfg:#8a6d00;
  }
  html,body{background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; margin:0}
  h1{ text-align:center; margin:22px 0 10px}

  .container{ display:flex; justify-content:center; align-items:flex-start; gap:24px; margin:0 auto 18px; max-width:980px; padding:0 10px;}
  .category{ background:var(--card); border-radius:18px; box-shadow:var(--shadow); flex:1; padding:26px 16px 16px; min-width:260px; max-width:330px;}
  .cat-title{ font-size:1.25em; font-weight:800; margin-bottom:12px; letter-spacing:.3px; text-align:center;}
  .stock-value{ font-size:1.6em; font-weight:900; text-align:center; }
  .stock-label{ font-size:.95em; color:var(--muted); text-align:center; margin-bottom:10px;}
  .products-box{ background:#f7f7fa; border:2px solid #dde1eb; border-radius:10px; margin:12px 0; padding:10px 22px; font-weight:700; text-align:center; box-shadow:0 1px 4px #ddd5;}
  .message-box{ border-radius:10px; margin:8px 0 12px; padding:10px 12px; font-weight:700; font-size:1.02em; box-shadow:0 1px 4px #0002; text-align:center;}
  .msg-orange{ background:#fff2e6; color:#cc5500; border:2px solid #ff8533;}
  .msg-red{ background:#ffe6e6; color:#c00; border:2px solid #ff6666;}
  .msg-blue{ background:#e6f3ff; color:#0066cc; border:2px solid #4da6ff;}
  .msg-green{ background:#e6ffe6; color:#066; border:2px solid #66cc66;}
  .msg-gold{ background:#fff9c4; color:#8a6d00; border:2px solid #f4d03f;}

  .btn-row{ margin-top:14px; display:flex; flex-direction:column; align-items:center; gap:8px;}
  button{ font-size:1em; padding:10px 16px; border:none; border-radius:12px; background:#ededed; color:var(--ink); cursor:pointer;}
  .btn-evo{ background:#4CAF50; color:#fff; font-weight:700;}
  .btn-yellow{ background:#FFD600; color:#222; font-weight:700;}
  .btn-annuler{ background:#999; color:#fff;}
  .btn-invest{ background:var(--eh); color:#fff; font-weight:700;}

  /* Contr√¥les des automatismes */
  .automatisms-controls{ margin:14px auto; max-width:980px; display:none; justify-content:center; gap:10px; flex-wrap:wrap; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001;}
  .control-btn{ font-size:.9em; padding:8px 12px; border-radius:8px; border:none; min-width:100px; }
  .active{ background:#4CAF50; color:#fff; } .inactive{ background:#f44336; color:#fff; } .disabled{ background:#ccc; color:#777;}

  /* Zone d'√©quilibre */
  .optimum-zone{ display:none; margin:12px auto; max-width:980px; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001; text-align:center;}
  .optimum-progress-bar{ background:var(--bar); height:20px; border-radius:20px; max-width:420px; margin:10px auto; overflow:hidden; position:relative;}
  .optimum-progress-fill{ height:100%; background:linear-gradient(90deg,var(--ok),var(--ok2)); width:0%;}
  .optimum-text{ font-size:.95em; color:#555; margin-top:6px;}
  #optimum-victory{ display:none; background:#fff9c4; border:2px solid #f4d03f; color:#8a6d00; padding:16px; border-radius:12px; text-align:center; font-weight:800; max-width:700px; margin:12px auto; }

  /* √âv√©nements + encart effets temporaires actifs */
  .events-zone{ margin:12px auto; max-width:980px; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001;}
  .event-notification{ background:#f0f8f0; border:2px solid #81c784; border-radius:10px; padding:10px; font-weight:700; color:#2e7d32; display:none;}
  .temp-effects{ margin-top:10px; padding:10px; background:#fafafa; border:1px dashed #bbb; border-radius:10px; font-size:.92em;}
  .temp-effects h4{ margin:0 0 6px 0; font-size:.95em; color:#444; }
  .temp-list{ display:flex; flex-wrap:wrap; gap:6px; }
  .temp-pill{ background:#eef3ff; border:1px solid #cfe0ff; color:#1a4fb3; border-radius:999px; padding:4px 8px; }

  /* Jauges */
  .jrows{ margin:0 auto 10px; max-width:720px;}
  .jrow{ display:flex; align-items:center; gap:8px; margin:0 auto 6px; }
  .jlabel{ min-width:120px; text-align:right; font-size:1em; color:#555; }
  .bar{ background:var(--bar); border-radius:8px; height:14px; flex:1; overflow:hidden;}
  .fill{ height:100%; border-radius:8px; transition:width .2s;}
  #jauge-nature{ background:var(--res);}
  #jauge-confort{ background:var(--conf);}
  #jauge-money{ background:var(--money);}
  #jauge-budget{ background:var(--budget);}
  #jauge-ia{ background:var(--ia);}
  #jauge-trader{ background:var(--trader);}
  #jauge-achat-auto{ background:var(--auto);}
  #jauge-centre{ background:var(--centre);}
  #jauge-tech{ background:var(--tech);}
  .jval{ min-width:80px; text-align:right; }

  /* EH investissement avanc√© */
  .investment-block{ background:var(--ehbg); border:2px solid var(--ehbord); border-radius:10px; padding:12px; margin-top:10px;}
  .investment-title{ font-weight:800; color:var(--eh); text-align:center; margin-bottom:8px;}
  .investment-controls{ display:flex; justify-content:center; gap:8px; flex-wrap:wrap;}
  .investment-input{ width:100px; padding:8px; border:1px solid #ccc; border-radius:8px; font-size:1em;}
  .investment-preview{ font-size:.9em; color:var(--eh); text-align:center; min-height:18px; margin-top:6px;}
  .investment-list{ font-size:.9em; color:#555; margin-top:8px; max-height:120px; overflow:auto;}

  /* Toast court */
  #message{ text-align:center; font-weight:800; min-height:24px; margin:8px 0;}
  .toast{ display:inline-block; background:var(--toastbg); color:var(--toastfg); border:2px solid var(--toastbd); padding:6px 10px; border-radius:10px;}

  /* Triche */
  #triche-sep{ border:none; border-top:3px solid #222; margin:22px auto 10px; width:94vw; max-width:980px;}
  #triche-label{ max-width:980px; margin:0 auto 10px; color:#555;}
  .debug-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px auto 24px;}

  /* Mobile */
  @media (max-width:760px){
    .container{ flex-direction:column; gap:12px;}
    .jrows{ max-width:calc(100vw - 22px);}
    .jlabel{ min-width:90px;}
  }
</style>
</head>
<body>
  <h1>üåç Looop ‚Äî 1.30.5</h1>

  <!-- Contr√¥les des automatismes -->
  <div class="automatisms-controls" id="automatisms-controls">
    <button id="control-ia"     class="control-btn disabled" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button id="control-trader" class="control-btn disabled" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button id="control-confort" class="control-btn disabled" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button id="control-centre" class="control-btn disabled" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>

  <!-- Zone d'√©quilibre (affich√©e quand ressources ‚â§ 1000) -->
  <div class="optimum-zone" id="optimum-zone">
    <div style="font-weight:800;">üéØ Zone d'√©quilibre</div>
    <div class="optimum-progress-bar"><div class="optimum-progress-fill" id="optimum-progress"></div></div>
    <div class="optimum-text" id="optimum-text">Maintenez l'√©quilibre pendant 50 actions.</div>
  </div>

  <!-- Message de victoire -->
  <div id="optimum-victory">
    üèÜ VICTOIRE : √âquilibre maintenu pendant 50 actions !<br/>
    <button class="btn-yellow" onclick="restartGame()">üîÑ Recommencer</button>
  </div>

  <!-- √âv√©nements & effets temporaires -->
  <div class="events-zone">
    <div style="font-weight:800; margin-bottom:6px;">üåø √âv√©nements al√©atoires</div>
    <div id="event-box" class="event-notification">
      <div id="event-text"></div>
      <div id="event-effects" style="font-size:.9em;color:#666;margin-top:4px;"></div>
    </div>
    <div class="temp-effects">
      <h4>Effets temporaires actifs</h4>
      <div id="temp-list" class="temp-list"><span style="color:#777;">Aucun</span></div>
    </div>
  </div>

  <div class="container">
    <!-- Environnement -->
    <div class="category">
      <div class="cat-title">üå± Plan√®te</div>
      <div class="stock-value" id="nature">3000</div>
      <div class="stock-label">Ressources</div>

      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>

      <!-- Bloc investissement √©cologique (EH) -->
      <div id="investment-block" class="investment-block" style="display:none;">
        <div class="investment-title">üå± Investissement √©cologique (retour en 10 actions)</div>
        <div class="investment-controls">
          <input type="number" id="investment-amount" class="investment-input" placeholder="Montant ‚Ç¨" min="1" oninput="updateInvestmentPreview()">
          <button class="btn-invest" onclick="makeEcologicalInvestment()">üíö Investir</button>
          <button class="btn-invest" onclick="investirEcologieFixe()">üåø Raccourci (‚Äì200‚Ç¨ ‚Üí +30)</button>
        </div>
        <div id="investment-preview" class="investment-preview"></div>
        <div id="investment-list" class="investment-list">Aucun investissement en cours</div>
      </div>
    </div>

    <!-- Exosomatisation -->
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock-value" id="confort">0</div>
      <div class="stock-label">Confort</div>

      <div class="products-box">Produits cr√©√©s<br/><span id="production">0</span></div>
      <div id="social-crise" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">üõãÔ∏è Achat (100 ‚Ç¨)</button>
      </div>
    </div>

    <!-- √âconomie -->
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock-value" id="money">1000</div>
      <div class="stock-label">Monnaie (‚Ç¨)</div>

      <div class="products-box" id="price-indicator" style="display:none;">Prix de vente<br><span id="current-price">1‚Ç¨</span></div>

      <!-- Bouton n√©gociation cr√©dit (par paliers 300/600/900) -->
      <button id="nego-taux-btn" class="btn-yellow" style="display:none;" onclick="negocierTaux()">ü§ù N√©gocier mon cr√©dit</button>

      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>

        <!-- Am√©liorations/paliers -->
        <button id="ouvrier-btn" style="display:none;" onclick="acheterIA()">ü§ñ Engager une IA</button>
        <button id="trader-btn" style="display:none;" onclick="acheterTrader()">üí∞ Trader automatique</button>
        <button id="comfort-auto-btn" style="display:none;" onclick="acheterConfortAuto()">üîÑ Achat auto confort</button>
        <button id="upgrade-btn" style="display:none;" onclick="upgradeProd()">üí† Am√©liorer la production</button>
        <button id="centre-commercial-btn" style="display:none;" onclick="acheterCentre()">üè¨ Centre commercial</button>
        <button id="automatisms-btn" style="display:none;" onclick="acheterAutomatismsClics()">‚ö° Automatismes = clics</button>
        <button id="price-indicator-btn" style="display:none;" onclick="acheterIndicateur()">üìä Indicateur de prix</button>

        <!-- EH -->
        <button id="evolution-btn" class="btn-evo" style="display:none;" onclick="evolution()">üå± Passer √† l'√©conomie hom√©ostatique</button>
        <button id="rescue-eh-btn" class="btn-evo" style="display:none;" onclick="activateRescueEH()">üå± Secours EH</button>
      </div>
    </div>
  </div>

  <!-- Jauges -->
  <div class="jrows">
    <div class="jrow"><div class="jlabel">üå± Ressources</div><div class="bar"><div id="jauge-nature" class="fill" style="width:0%"></div></div><div class="jval" id="jnature">3000</div></div>
    <div class="jrow" id="jg-confort" style="display:none;"><div class="jlabel">ü§ñ Confort</div><div class="bar"><div id="jauge-confort" class="fill"></div></div><div class="jval" id="jconfort">0</div></div>
    <div class="jrow"><div class="jlabel">üí∂ Monnaie</div><div class="bar"><div id="jauge-money" class="fill"></div></div><div class="jval" id="jmoney">1000‚Ç¨</div></div>
    <div class="jrow" id="jg-budget" style="display:none;"><div class="jlabel">üèõÔ∏è Budget √âtat</div><div class="bar"><div id="jauge-budget" class="fill"></div></div><div class="jval" id="jbudget">0‚Ç¨</div></div>

    <div class="jrow" id="jg-achat-auto" style="display:none;"><div class="jlabel">üîÑ Achat auto</div><div class="bar"><div id="jauge-achat-auto" class="fill"></div></div><div class="jval" id="jachat-auto">√ó0</div></div>
    <div class="jrow" id="jg-ia" style="display:none;"><div class="jlabel">ü§ñ IA</div><div class="bar"><div id="jauge-ia" class="fill"></div></div><div class="jval" id="jia">√ó0</div></div>
    <div class="jrow" id="jg-trader" style="display:none;"><div class="jlabel">üí∞ Trader</div><div class="bar"><div id="jauge-trader" class="fill"></div></div><div class="jval" id="jtrader">√ó0</div></div>
    <div class="jrow" id="jg-centre" style="display:none;"><div class="jlabel">üè¨ Centre</div><div class="bar"><div id="jauge-centre" class="fill"></div></div><div class="jval" id="jcentre">√ó0</div></div>
    <div class="jrow" id="jg-tech" style="display:none;"><div class="jlabel">üí† Tech</div><div class="bar"><div id="jauge-tech" class="fill"></div></div><div class="jval" id="jtech">Niv.0</div></div>
  </div>

  <div id="message"></div>
  <div id="clics-container" style="text-align:center; margin:16px 0; font-weight:800;">Clics/actions : <span id="clicks">0</span></div>

  <hr id="triche-sep">
  <div id="triche-label">Triche (tests)</div>
  <div class="debug-row">
    <button class="btn-yellow" onclick="toggleCheatMode()">üîì D√©verrouiller les outils de test</button>
    <div id="cheat-buttons" style="display:none;">
      <button class="btn-yellow" onclick="addMoney()">+1000 ‚Ç¨</button>
      <button class="btn-yellow" onclick="addNature()">+100 ressources</button>
      <button class="btn-yellow" onclick="addClicks()">+50 clics</button>
      <button class="btn-yellow" onclick="forceActivateEH()">Passer √† l'EH (test)</button>
      <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler</button>
      <button class="btn-yellow" onclick="toggleEvents()">üé≤ √âv√©nements ON/OFF</button>
    </div>
  </div>
  <!-- ============================ BLOC 2/6 ‚Äî Logique de base & moteur d'√©v√©nements ============================ -->
<script>
// ===================================================================================
// √âTAT INITIAL ‚Äî conforme au cahier des charges (monnaie 1000, fiscalit√© 20 clics)
// ===================================================================================
const gameState = {
  // Stocks
  nature: 3000,
  confort: 0,
  production: 0,
  money: 1000,            // solde de d√©part demand√©
  budgetEtat: 0,
  monnaieActive: true,

  // Compteurs/√©tats
  clicks: 0,
  jeuBloque: false,
  gameOver: false,
  confortMaxAtteint: 0,

  // Zone d'√©quilibre
  optimumStreak: 0,
  optimumVictory: false,
  optimumRanges: { nature:[1800,2600], confort:[10,35], money:[400,1200] },

  // Fiscalit√© (OFF en EH)
  taxEnabled: true,
  taxEveryClicks: 20,
  _taxEverApplied: false,

  // Cr√©dit (int√©r√™ts seulement si achat ou d√©bit volontaire ‚Üí voir maybeApplyInterest())
  creditRate: 0.05,
  creditRateMin: 0.01,
  creditNegotiationsUsed: 0,
  lastNegotiationShownAt: 0,

  // EH (activ√© plus tard)
  ehActivated: false,
  ehAutoTriggerAt: 50,
  ehDonationEvery: 10,
  ehPrimeEvery: 50,
  ehFonteEvery: 10,
  ehBonusEvery: 10,
  ehTransactionTax: 0.04,

  // Investissements EH
  ecologicalInvestments: [], // {amount, remainingClicks, startClick}

  // Automatismes
  ia: 0, trader: 0, confortAuto: 0, centre: 0,
  automatismsGenerateClicks: false,

  // Tech / Production
  productionMultiplier: 1.0,
  techLevel: 0,
  baseProdCost: 5,              // co√ªt unitaire base en RESSOURCES
  prodCostUpgradesBought: 0,    // 0..3 ‚Üí 5‚Üí4‚Üí3‚Üí2

  // Paliers & achats (suivi des comptes)
  paliersDebloque:{
    comfort:false, ia:false, trader:false, upgradeProd:false,
    confortAuto:false, automatismsClics:false, priceIndicator:false, centreCommercial:false
  },
  nbAchatIA:0, nbAchatTrader:0, nbAchatConfortAuto:0, nbAchatUpgradeProd:0, nbAchatCentre:0,
  priceIndicatorActive:false
};

// ------------------------- Intervalles & triche/undo -------------------------
const intervals = { ia:null, trader:null, confortAuto:null, centre:null };
let automatismsActive = { ia:true, trader:true, confort:true, centre:true };
let lastState = null;
let cheatModeUnlocked = false;

// ===================================================================================
// OUTILS G√âN√âRIQUES
// ===================================================================================
function clamp(n, min=0){ return (n<min?min:n); }
function showMsg(txt){
  const m = document.getElementById("message");
  if(!m) return;
  m.innerHTML = '<span class="toast">'+txt+'</span>';
  setTimeout(()=>{ if(m.innerHTML.includes(txt)) m.innerHTML = ""; }, 4000);
}
function saveState(){
  lastState = {
    gameState: JSON.parse(JSON.stringify(gameState)),
    random: randomEventsSystem.getFullState()
  };
}
function undoAction(){
  if(!cheatModeUnlocked || !lastState) return;
  clearAllIntervals();
  const snap = lastState;
  Object.keys(gameState).forEach(k=>delete gameState[k]);
  Object.assign(gameState, snap.gameState);
  randomEventsSystem.restoreFullState(snap.random);
  restartIntervalsAfterUndo();
  updateUIValues();
  showMsg("‚è™ Action annul√©e");
}
function clearAllIntervals(){
  Object.keys(intervals).forEach(k=>{ if(intervals[k]){ clearInterval(intervals[k]); intervals[k]=null; } });
}
function restartIntervalsAfterUndo(){
  if (gameState.ia>0 && automatismsActive.ia && !gameState.ehActivated) startIAInterval();
  if (gameState.trader>0 && automatismsActive.trader && !gameState.ehActivated) startTraderInterval();
  if (gameState.confortAuto>0 && automatismsActive.confort && !gameState.ehActivated) startConfortAutoInterval();
  if (gameState.centre>0 && automatismsActive.centre && !gameState.ehActivated) startCentreInterval();
}

// ===================================================================================
// PRIX / CO√õT / INT√âR√äTS / FISCALIT√â
// ===================================================================================

// Prix de vente dynamique ‚Äî visible si l'indicateur est achet√©
function priceNow(){
  if (gameState.nature <= 0) return 1;
  let p = Math.max(1, Math.abs(gameState.money) / gameState.nature);
  // Effets temporaires "priceAdd" inject√©s par les √©v√©nements (ajout√© dans le bloc 4/6)
  p += (randomEventsSystem ? (randomEventsSystem.mod("priceAdd")||0) : 0);
  return Math.round(p*100)/100;
}

// Co√ªt unitaire actuel de production EN RESSOURCES (pas d'euro ici)
function currentProdUnitCost(){
  const base = Math.max(2, gameState.baseProdCost - gameState.prodCostUpgradesBought);
  const delta = randomEventsSystem ? (randomEventsSystem.mod("prodCostDelta")||0) : 0;
  return Math.max(1, base + delta);
}

// Multiplicateur de production (tech √ó effets temporaires)
function currentProdMultiplier(){
  const extra = randomEventsSystem ? (randomEventsSystem.mod("prodMult")||0) : 0;
  return Math.max(0, gameState.productionMultiplier * (1 + extra));
}

// R√©g√©n√©ration passive (si un effet "regen" est actif)
function maybeApplyRegen(){
  const r = randomEventsSystem ? (randomEventsSystem.mod("regen")||0) : 0;
  if (r>0){ gameState.nature += Math.max(0, Math.round(gameState.nature * r)); }
}

// Int√©r√™ts de d√©couvert ‚Äî √† n'appeler qu'apr√®s un D√âBIT mon√©taire (achats, upgrades‚Ä¶)
// JAMAIS depuis "Produire" (qui ne doit pas toucher √† la monnaie).
function maybeApplyInterest(){
  if (gameState.money < 0){
    const due = Math.ceil(Math.abs(gameState.money) * gameState.creditRate);
    if (due>0){
      gameState.money -= due;
      showMsg("üí£ Int√©r√™ts de d√©couvert : -"+due+"‚Ç¨ (taux "+Math.round(gameState.creditRate*100)+"%)");
    }
    // bouton de n√©go g√©r√© ailleurs (bloc 3/6)
  }
}

// Fiscalit√© ‚Äî tous les 20 clics, OFF en EH
function maybeApplyTax(){
  if (!gameState.taxEnabled || gameState.ehActivated) return;
  if (gameState.clicks>0 && gameState.clicks % gameState.taxEveryClicks === 0){
    const tax = Math.ceil(Math.abs(gameState.money) * 0.20);
    if (tax>0){
      gameState.money -= tax;
      gameState.nature += 1;
      gameState.confort += 1;
      gameState.budgetEtat += tax;
      gameState._taxEverApplied = true;
      // r√©v√©ler la jauge budget √† la 1re fois
      const row = document.getElementById("jg-budget");
      if (row) row.style.display="flex";
      showMsg("üí∏ Fiscalit√© : -"+tax+"‚Ç¨ | +1 üå± | +1 ü§ñ");
    }
  }
}

// ===================================================================================
// MOTEUR D'√âV√âNEMENTS AL√âATOIRES (sans la grande liste ici ‚Äî elle arrive au bloc 4/6)
// ===================================================================================
const randomEventsSystem = {
  enabled: true,
  nextIn: 0,
  minGap: 20, maxGap: 60,

<script>
// ============================== BLOC 3/6 ‚Äî COEUR DU JEU ==============================

// Helpers d'affichage
function _fmtMoney(v){ return (v>=0? v.toFixed(0)+"‚Ç¨" : "-"+Math.abs(v).toFixed(0)+"‚Ç¨"); }
function _pct(part, total){ if(total<=0) return 0; return Math.max(0, Math.min(100, Math.round(part*100/total))); }

function toggleDisplay(id, on, isFlex){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = on ? (isFlex?"flex":"block") : "none";
}

// --------------------------- Mise √† jour de l'interface (UNIQUE) ---------------------------
function updateUIValues(){
  // Stocks (valeurs haut de cartes)
  const nEl = document.getElementById("nature");
  const cEl = document.getElementById("confort");
  const pEl = document.getElementById("production");
  const mEl = document.getElementById("money");
  const bEl = document.getElementById("jbudget");
  if(nEl) nEl.textContent = Math.max(0, Math.floor(gameState.nature));
  if(cEl) cEl.textContent = Math.max(0, Math.floor(gameState.confort));
  if(pEl) pEl.textContent = Math.max(0, Math.floor(gameState.production));
  if(mEl) mEl.textContent = Math.floor(gameState.money);

  // Jauges principales
  const jn = document.getElementById("jnature");
  const jc = document.getElementById("jconfort");
  const jm = document.getElementById("jmoney");
  if(jn) jn.textContent = Math.max(0, Math.floor(gameState.nature));
  if(jc) jc.textContent = Math.max(0, Math.floor(gameState.confort));
  if(jm) jm.textContent = _fmtMoney(gameState.money);

  const fN = document.getElementById("jauge-nature");
  const fC = document.getElementById("jauge-confort");
  const fM = document.getElementById("jauge-money");
  if(fN) fN.style.width = _pct(gameState.nature, 3000)+"%";
  if(fC) fC.style.width = _pct(gameState.confort, 50)+"%";
  if(fM) fM.style.width = _pct(Math.abs(gameState.money), 1200)+"%";

  // Jauges secondaires (valeurs + barres)
  const setJ = (idTxt, idBar, value, unit, per)=>
    { const t=document.getElementById(idTxt); if(t) t.textContent=(unit?unit:"")+value;
      const b=document.getElementById(idBar); if(b) b.style.width=Math.min(100, per)+"%"; };

  setJ("jachat-auto","jauge-achat-auto","√ó"+gameState.confortAuto,"", gameState.confortAuto*20);
  setJ("jia","jauge-ia","√ó"+gameState.ia,"", gameState.ia*20);
  setJ("jtrader","jauge-trader","√ó"+gameState.trader,"", gameState.trader*10);
  setJ("jcentre","jauge-centre","√ó"+gameState.centre,"", gameState.centre*20);
  setJ("jtech","jauge-tech","Niv."+gameState.techLevel,"", gameState.techLevel*33.4);
  if (bEl) bEl.textContent = _fmtMoney(gameState.budgetEtat);

  // Indicateur de prix si achet√©
  if (gameState.priceIndicatorActive){
    const box = document.getElementById("price-indicator");
    if (box) box.style.display="block";
    const priceEl = document.getElementById("current-price");
    if (priceEl) priceEl.textContent = priceNow().toFixed(2)+"‚Ç¨";
  }

  // Alertes crise (√©cologie, social)
  const alEco = document.getElementById("alert-crise");
  if(alEco){
    if (gameState.nature < 300) { alEco.style.display="block"; alEco.textContent="‚ö†Ô∏è Crise √©cologique imminente"; }
    else { alEco.style.display="none"; }
  }
  const alSoc = document.getElementById("social-crise");
  if(alSoc){
    if (gameState.confort<=5 && gameState.clicks>0) { alSoc.style.display="block"; alSoc.textContent="‚ö†Ô∏è Crise sociale"; }
    else { alSoc.style.display="none"; }
  }

  // Compteur de clics
  const clk = document.getElementById("clicks");
  if(clk) clk.textContent = gameState.clicks;

  // *** CORRECTION CRITIQUE : Boutons de base - TOUJOURS VISIBLES (sauf si jeu bloqu√©) ***
  toggleDisplay("produce-btn", !gameState.jeuBloque && !gameState.gameOver);
  toggleDisplay("sell-btn", !gameState.jeuBloque && !gameState.gameOver);

  // Visibilit√© des paliers (conform√©ment au cahier des charges)
  // Confort : visible d√®s 120 clics
  toggleDisplay("comfort-btn", gameState.clicks>=120);

  // IA : r√©apparition tous les 200 clics (200, 400, ‚Ä¶) en fonction des achats d√©j√† faits
  const nextIAThreshold = 200 * (gameState.nbAchatIA + 1);
  toggleDisplay("ouvrier-btn", gameState.clicks>=nextIAThreshold && gameState.ehActivated===false);

  // Trader : ‚â• 500 clics
  toggleDisplay("trader-btn", gameState.clicks>=500 && gameState.ehActivated===false);

  // Auto-confort : ‚â• 700 clics
  toggleDisplay("comfort-auto-btn", gameState.clicks>=700 && gameState.ehActivated===false);

  // Automatismes = clics : ‚â• 750 clics
  toggleDisplay("automatisms-btn", gameState.clicks>=750);

  // Indicateur de prix : ‚â• 1000 clics
  toggleDisplay("price-indicator-btn", gameState.clicks>=1000 && !gameState.priceIndicatorActive);

  // Centre : ‚â• 1100 clics
  toggleDisplay("centre-commercial-btn", gameState.clicks>=1100 && gameState.ehActivated===false);

  // Upgrade production : paliers fixes 400 / 700 / 1100, cap 3
  const upgradeThresholds = [400,700,1100];
  const canUpgrade = (gameState.techLevel < 3) && (gameState.clicks >= upgradeThresholds[gameState.techLevel]);
  toggleDisplay("upgrade-btn", canUpgrade && gameState.ehActivated===false);

  // Boutons EH
  toggleDisplay("evolution-btn", gameState.clicks >= 50 && !gameState.ehActivated);
  toggleDisplay("rescue-eh-btn", (gameState.nature <= 0 || gameState.confort <= 0) && !gameState.ehActivated);

  // N√©gociation cr√©dit (paliers 300/600/900, quota 3)
  const showNego = (gameState.creditNegotiationsUsed < 3) && 
                   ((gameState.clicks>=300 && gameState.clicks<600) || 
                    (gameState.clicks>=600 && gameState.clicks<900) || 
                    (gameState.clicks>=900));
  toggleDisplay("nego-taux-btn", showNego);

  // Affichage des lignes de jauges secondaires si >0 (ou si confort d√©bloqu√©)
  toggleDisplay("jg-confort", (gameState.clicks>=120) || gameState.confort>0, true);
  toggleDisplay("jg-ia", gameState.ia>0, true);
  toggleDisplay("jg-trader", gameState.trader>0, true);
  toggleDisplay("jg-achat-auto", gameState.confortAuto>0, true);
  toggleDisplay("jg-centre", gameState.centre>0, true);
  toggleDisplay("jg-tech", gameState.techLevel>0, true);

  // Budget √âtat (ligne visible s'il y a eu 1er imp√¥t)
  const rowBudget = document.getElementById("jg-budget");
  if(rowBudget && gameState._taxEverApplied) rowBudget.style.display = "flex";

  // Zone d'√©quilibre : on l'affiche lorsqu'on se rapproche (ex. nature ‚â§ 1000)
  const zone = document.getElementById("optimum-zone");
  if(zone) zone.style.display = (gameState.nature<=1000 || gameState.optimumStreak>0) ? "block" : "none";

  // EH : panneau automatismes masqu√© en EH
  const panel = document.getElementById("automatisms-controls");
  if (panel) panel.style.display = (!gameState.ehActivated && (gameState.ia>0 || gameState.trader>0 || gameState.confortAuto>0 || gameState.centre>0)) ? "flex" : "none";

  // Bloc investissement EH
  const inv = document.getElementById("investment-block");
  if (inv) inv.style.display = gameState.ehActivated ? "block" : "none";

  // Messages EH
  const ehMsg = document.getElementById("eh-msg");
  if (ehMsg && gameState.ehActivated) {
    ehMsg.style.display = "block";
    ehMsg.textContent = "üå± √âconomie Hom√©ostatique active : imp√¥ts OFF, friction 4% sur transactions";
  }

  // Mise √† jour du texte/victoire
  updateOptimumUI();
}

// ---------------------- Zone d'√©quilibre : r√®gle 50/50 ----------------------
function inOptimum(){
  const r = gameState.optimumRanges;
  return (
    gameState.nature >= r.nature[0] && gameState.nature <= r.nature[1] &&
    gameState.confort>= r.confort[0] && gameState.confort<= r.confort[1] &&
    gameState.money  >= r.money[0]   && gameState.money  <= r.money[1]
  );
}
function updateOptimumStreak(){
  if (inOptimum()) gameState.optimumStreak++;
  else gameState.optimumStreak = 0;
  if (gameState.optimumStreak>=50 && !gameState.optimumVictory){
    gameState.optimumVictory = true;
    gameState.jeuBloque = true;
    const v = document.getElementById("optimum-victory"); if (v) v.style.display = "block";
    showMsg("üèÜ √âquilibre tenu 50 actions : victoire !");
  }
}
function updateOptimumUI(){
  const bar = document.getElementById("optimum-progress");
  const txt = document.getElementById("optimum-text");
  if(!bar || !txt) return;
  const v = Math.min(50, gameState.optimumStreak);
  bar.style.width = (v*2)+"%";
  txt.textContent = gameState.optimumVictory
    ? "Victoire atteinte."
    : "Progression : "+v+"/50 actions dans la zone d'√©quilibre.";
}

// ---------------------- M√©caniques EH (helpers non intrusifs) ----------------------
function ehFriction(amount){
  if (!gameState.ehActivated) return 0;
  return Math.round(Math.abs(amount) * gameState.ehTransactionTax);
}

// ============================ Actions principales ============================
// PRODUIRE ‚Äî ne touche JAMAIS √† la monnaie
function produce(){
  if (gameState.jeuBloque || gameState.gameOver) return;

  const cost = currentProdUnitCost();
  if (gameState.nature < cost){ showMsg("Ressources insuffisantes (co√ªt "+cost+")"); return; }

  saveState();
  gameState.nature -= cost;

  const prod = Math.max(1, Math.floor(currentProdMultiplier()));
  gameState.production += prod;

  gameState.clicks++;
  maybeApplyRegen();
  randomEventsSystem.processClick();

  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  showMsg("Production +"+prod+" (co√ªt "+cost+" ressources)");
  updateUIValues();
}

// VENDRE ‚Äî g√©n√®re de la monnaie, applique friction EH
function sell(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  const qty = Math.max(0, Math.floor(gameState.production));
  if (qty<=0){ showMsg("Aucun produit √† vendre."); return; }

  saveState();
  const price = priceNow();
  const revenue = qty * price;
  const fee = ehFriction(revenue);
  const net = revenue - fee;

  gameState.production -= qty;
  gameState.money += net;
  if (!gameState.monnaieActive) gameState.monnaieActive = true;

  gameState.clicks++;
  randomEventsSystem.processClick();

  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  showMsg("Vendu : +"+net.toFixed(2)+"‚Ç¨"+(fee?(" (frais EH "+fee+"‚Ç¨)"):""));
  updateUIValues();
}

// ---------------------------- Automatismes & toggles (UNIQUE) ----------------------------
function toggleAutomatism(kind){
  if (kind==="ia")     automatismsActive.ia = !automatismsActive.ia;
  if (kind==="trader") automatismsActive.trader = !automatismsActive.trader;
  if (kind==="confort") automatismsActive.confort = !automatismsActive.confort;
  if (kind==="centre") automatismsActive.centre = !automatismsActive.centre;

  // UI du panneau
  const map = [
    ["control-ia", automatismsActive.ia, "ü§ñ IA: "],
    ["control-trader", automatismsActive.trader, "üí∞ Trader: "],
    ["control-confort", automatismsActive.confort, "üõãÔ∏è Confort: "],
    ["control-centre", automatismsActive.centre, "üè¨ Centre: "]
  ];
  map.forEach(([id,on,label])=>{
    const b = document.getElementById(id);
    if(!b) return;
    b.className = "control-btn "+(on?"active":"inactive");
    b.textContent = label + (on?"ON":"OFF");
  });

  // (Re)d√©marrage/arr√™t des intervals si n√©cessaire (hors EH)
  if (!gameState.ehActivated){
    if (kind==="ia"){ if (automatismsActive.ia && gameState.ia>0) startIAInterval(); else stopInterval("ia"); }
    if (kind==="trader"){ if (automatismsActive.trader && gameState.trader>0) startTraderInterval(); else stopInterval("trader"); }
    if (kind==="confort"){ if (automatismsActive.confort && gameState.confortAuto>0) startConfortAutoInterval(); else stopInterval("confortAuto"); }
    if (kind==="centre"){ if (automatismsActive.centre && gameState.centre>0) startCentreInterval(); else stopInterval("centre"); }
  }
}

function stopInterval(key){
  if (intervals[key]){ clearInterval(intervals[key]); intervals[key]=null; }
}

// ============================ Intervalles (ticks auto) ============================
// IA ‚Äî toutes les 5s : consomme 5 ressources/IA et produit selon multiplicateur
function startIAInterval(){
  stopInterval("ia");
  if (!automatismsActive.ia || gameState.ia<=0 || gameState.ehActivated) return;
  intervals.ia = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const totalCost = 5 * gameState.ia;
    if (gameState.nature < totalCost) return;
    gameState.nature -= totalCost;
    const add = Math.max(1, Math.floor(currentProdMultiplier()*gameState.ia));
    gameState.production += add;

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 5000);
}

// Trader ‚Äî toutes les 3s : vend min(production, trader)
function startTraderInterval(){
  stopInterval("trader");
  if (!automatismsActive.trader || gameState.trader<=0 || gameState.ehActivated) return;
  intervals.trader = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const qty = Math.min(gameState.production, gameState.trader);
    if (qty<=0) return;
    const revenue = qty * priceNow();
    const fee = ehFriction(revenue);
    const net = revenue - fee;
    gameState.production -= qty;
    gameState.money += net;

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 3000);
}

// Achat Confort automatique ‚Äî toutes les 15s : ach√®te 1 confort √ó niveau (100‚Ç¨ l'unit√©)
function startConfortAutoInterval(){
  stopInterval("confortAuto");
  if (!automatismsActive.confort || gameState.confortAuto<=0 || gameState.ehActivated) return;
  intervals.confortAuto = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const units = Math.max(1, gameState.confortAuto);
    const base = 100 * units;
    const fee  = ehFriction(base);
    const total = base + fee;
    gameState.money -= total;
    gameState.confort += units;
    maybeApplyInterest();

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 15000);
}

// Centre ‚Äî toutes les 15s : +10 confort √ó centre, co√ªte 100‚Ç¨ √ó (10√ócentre)
function startCentreInterval(){
  stopInterval("centre");
  if (!automatismsActive.centre || gameState.centre<=0 || gameState.ehActivated) return;
  intervals.centre = setInterval(()=>{
    if (gameState.jeuBloque || gameState.ehActivated) return;
    const gain = 10 * gameState.centre;
    const base = 100 * gain;
    const fee  = ehFriction(base);
    const total = base + fee;
    gameState.money -= total;
    gameState.confort += gain;
    maybeApplyInterest();

    if (gameState.automatismsGenerateClicks){
      gameState.clicks++;
      randomEventsSystem.processAutoTick();
      if (!gameState.ehActivated) maybeApplyTax();
      updateOptimumStreak();
    }
    updateUIValues();
  }, 15000);
}

// ============================ Achats (impl√©ment√©s) ============================
// Rappel: tous les achats d√©clenchent un D√âBIT ‚Üí int√©r√™ts potentiels si solde < 0
function acheterConfort(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  saveState();
  const base = 100;
  const fee  = ehFriction(base);
  const total = base + fee;
  if (gameState.money < total){ showMsg("Fonds insuffisants"); return; }
  gameState.money -= total;
  gameState.confort += 1;
  maybeApplyInterest();
  gameState.clicks++;
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  showMsg("üõãÔ∏è +1 confort ("+total+"‚Ç¨"+(fee?(" dont frais EH "+fee+"‚Ç¨"):"")+")");
  updateUIValues();
}

// === IA === (EXACTEMENT selon la consigne)
function acheterIA(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  const cost = 500 * Math.pow(1.5, gameState.nbAchatIA);
  if (gameState.money < cost) { showMsg("Fonds insuffisants"); return; }

  saveState();
  gameState.money -= cost;
  gameState.ia += 1;
  gameState.nbAchatIA += 1;
  maybeApplyInterest();
  gameState.clicks++;

  // D√©marrer l'intervalle si actif
  if (automatismsActive.ia && !gameState.ehActivated) startIAInterval();

  showMsg("ü§ñ IA achet√©e (" + Math.round(cost) + "‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}

// === Trader auto ===
function acheterTrader(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  const cost = 800 * Math.pow(1.5, gameState.nbAchatTrader);
  if (gameState.money < cost) { showMsg("Fonds insuffisants"); return; }

  saveState();
  gameState.money -= cost;
  gameState.trader += 1;
  gameState.nbAchatTrader += 1;
  maybeApplyInterest();
  gameState.clicks++;

  if (automatismsActive.trader && !gameState.ehActivated) startTraderInterval();

  showMsg("üí∞ Trader automatique achet√© ("+Math.round(cost)+"‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}

// === Confort automatique ===
function acheterConfortAuto(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  const cost = 1200 * Math.pow(1.5, gameState.nbAchatConfortAuto);
  if (gameState.money < cost) { showMsg("Fonds insuffisants"); return; }

  saveState();
  gameState.money -= cost;
  gameState.confortAuto += 1;
  gameState.nbAchatConfortAuto += 1;
  maybeApplyInterest();
  gameState.clicks++;

  if (automatismsActive.confort && !gameState.ehActivated) startConfortAutoInterval();

  showMsg("üîÑ Achat auto confort +1 ("+Math.round(cost)+"‚Ç¨)");
  randomEventsSystem.processClick();
  if (!gameState.ehActivated) maybeApplyTax();
  updateOptimumStreak();
  updateUIValues();
}

// === Upgrade production (r√©duction co√ªt unitaire : 5‚Üí4‚Üí3‚Üí2 ; cap 3) ===
function upgradeProd(){
  if (gameState.jeuBloque || gameState.gameOver) return;
  if (gameState.prodCostUpgradesBought >= 3){ showMsg("Am√©liorations de production au maximum"); return; }

  // Co√ªt croissant en ‚Ç¨ (doublage raisonnable par niveau)
  const level = gameState.prodCostUpgradesBought; // 0..2
  const cost = [1000, 2000, 3500][level];
  if (gameState.money < cost){ showMsg("Fonds insuffisants"); return; }

  saveState();
  gameState.money -= cost;
  gameState.prodCostUpgradesBought += 1;     // impacte currentProdUnitCost()
  gameState.techLevel = Math.min(3, gameState.techLevel + 1);
  // bonus l√©ger de productivit√© pour le ressenti
  gameState.

<!-- ============================ BLOC 4/6 ‚Äî √âV√âNEMENTS (260) ============================ -->
<script>
// Petit utilitaire d'effets s√ªrs
function _add(gs, key, delta){ gs[key] = Math.max(0, (gs[key]||0) + delta); }
function _money(gs, delta){
  // Les √©v√©nements "donnent/prennent" directement ‚Äî ce ne sont pas des transactions du joueur.
  gs.money = (gs.money||0) + delta;
}
function _cap(x, min, max){ return Math.max(min, Math.min(max, x)); }

// Fabrique un √©v√©nement
function makeEvent(name, text, fx, disp){
  return { name, text, effect: fx, display: disp||"" };
}

// Quelques g√©n√©rateurs d'effets temporaires "propres"
function tempBoostProd(sys, multDelta, actions, label){
  sys.addTemp("prodMult", multDelta, actions, label);
}
function tempPrice(sys, add, actions, label){
  sys.addTemp("priceAdd", add, actions, label);
}
function tempProdCost(sys, delta, actions, label){
  sys.addTemp("prodCostDelta", delta, actions, label);
}
function tempRegen(sys, rate, actions, label){
  // ex: 0.01 ‚áí +1% de nature par action pendant N actions
  sys.addTemp("regen", rate, actions, label);
}

// √âv√©nements "unitaires" vari√©s
const EV = [];

// 1) Famille √âCO : s√©cheresse / inondation / canicule / parasites / feux / pollution / restauration
const ecoShocks = [
  { n:"S√©cheresse r√©gionale", dN:-Math.floor(Math.random()*80+70), price:+0.4, regen:0, tempCost:+1 },
  { n:"Inondations",          dN:-Math.floor(Math.random()*60+50), price:+0.2, regen:0, tempCost:+1 },
  { n:"Canicule s√©v√®re",      dN:-Math.floor(Math.random()*70+60), price:+0.3, regen:0, tempCost:+2 },
  { n:"Parasites agricoles",  dN:-Math.floor(Math.random()*40+30), price:+0.25, regen:0, tempCost:+1 },
  { n:"Feux de for√™t",        dN:-Math.floor(Math.random()*90+80), price:+0.35, regen:0, tempCost:+2 },
  { n:"Pollution du fleuve",  dN:-Math.floor(Math.random()*50+40), price:+0.15, regen:0, tempCost:+1 },
];
ecoShocks.forEach(s=>{
  EV.push(makeEvent(
    "üå°Ô∏è "+s.n,
    "Des conditions extr√™mes ab√Æment les √©cosyst√®mes. Les mati√®res premi√®res se rar√©fient.",
    (gs, sys)=>{
      _add(gs, "nature", s.dN);
      tempProdCost(sys, +s.tempCost, 12, "Production plus co√ªteuse");
      tempPrice(sys, +s.price, 10, "Prix de march√© tendu");
    },
    "üå± "+s.dN+" ressources, co√ªt prod ‚Üë temporaire, prix +"
  ));
});

// Restaurations / rewilding / pluies bienvenues
const ecoReliefs = [
  { n:"Pluies bienvenues",         dN:+Math.floor(Math.random()*50+40), regen:+0.01 },
  { n:"Programme de reboisement",  dN:+Math.floor(Math.random()*60+50), regen:+0.015 },
  { n:"Restauration d'habitats",   dN:+Math.floor(Math.random()*55+45), regen:+0.012 },
  { n:"Agriculture r√©g√©n√©ratrice", dN:+Math.floor(Math.random()*45+35), regen:+0.01 },
];
ecoReliefs.forEach(s=>{
  EV.push(makeEvent(
    "üåßÔ∏è "+s.n,
    "Un sursaut √©cologique redonne de l'oxyg√®ne √† la plan√®te. Les ressources se refont petit √† petit.",
    (gs, sys)=>{
      _add(gs, "nature", s.dN);
      tempRegen(sys, s.regen, 12, "R√©g√©n√©ration √©cologique");
      tempProdCost(sys, -1, 8, "Cha√Æne d'approvisionnement plus fluide");
    },
    "üå± +"+s.dN+" | r√©g√©n√©ration temporaire"
  ));
});

// 2) Famille SOCIALE : gr√®ves, solidarit√©, innovation sociale, tensions, f√™tes
const social = [
  { n:"Gr√®ve g√©n√©rale",  dC:-Math.floor(Math.random()*3+2), prod:-0.15 },
  { n:"Mobilisation citoyenne", dC:+Math.floor(Math.random()*4+2), prod:+0.1 },
  { n:"Tensions sociales", dC:-Math.floor(Math.random()*3+1), price:+0.2 },
  { n:"F√™te des Communs", dC:+Math.floor(Math.random()*3+1), price:-0.1 },
];
social.forEach(s=>{
  EV.push(makeEvent(
    "üë• "+s.n,
    "Le climat social bouge. Les comportements d'achat et de production s'ajustent.",
    (gs, sys)=>{
      if (s.dC) _add(gs, "confort", s.dC);
      if (s.prod) tempBoostProd(sys, s.prod, 10, (s.prod>0?"Productivit√© sociale":"Productivit√© en berne"));
      if (s.price) tempPrice(sys, s.price, 8, (s.price>0?"Prix sous tension":"Prix apais√©s"));
    },
    (s.dC?(s.dC>0?`ü§ñ +${s.dC}`:`ü§ñ ${s.dC}`):"")+" effets temporaires"
  ));
});

// 3) Famille MARCH√â : bulles, krachs, afflux capitaux, panique
const market = [
  { n:"Mini‚Äëbulle sp√©culative", money:+Math.floor(Math.random()*400+200), price:+0.2 },
  { n:"Krach sectoriel",        money:-Math.floor(Math.random()*500+300), price:-0.2 },
  { n:"Afflux de capitaux",     money:+Math.floor(Math.random()*600+300), price:+0.1 },
  { n:"Panique des d√©taillants",money:-Math.floor(Math.random()*350+150), price:-0.3 },
];
market.forEach(s=>{
  EV.push(makeEvent(
    "üìà "+s.n,
    "Les march√©s tanguent. Vos comptes sont touch√©s et les prix se r√©ajustent.",
    (gs, sys)=>{
      _money(gs, s.money);
      tempPrice(sys, s.price, 10, (s.price>0?"Prix dop√©s":"Prix d√©prim√©s"));
    },
    (s.money>0?`üí∂ +${s.money}`:`üí∂ ${s.money}`)+" | prix temporairement "+(s.price>0?"‚Üë":"‚Üì")
  ));
});

// 4) Famille TECHNO : perc√©es, pannes, hacks, optimisation
const tech = [
  { n:"Perc√©e frugale",     prod:+0.25, cost:-1, txt:"+25% prod, co√ªt -1" },
  { n:"Panne critique",     prod:-0.30, cost:+1, txt:"-30% prod, co√ªt +1" },
  { n:"Optimisation IA",    prod:+0.20, cost:0,  txt:"+20% prod" },
  { n:"Hame√ßonnage √©vit√©",  prod:+0.10, cost:0,  txt:"+10% prod (veille accrue)" },
];
tech.forEach(s=>{
  EV.push(makeEvent(
    "üß™ "+s.n,
    "La technologie joue en votre faveur‚Ä¶ ou pas. Vos cha√Ænes s'ajustent.",
    (gs, sys)=>{
      if (s.prod) tempBoostProd(sys, s.prod, 12, "Choc technologique");
      if (s.cost) tempProdCost(sys, s.cost, 12, "Ajustement co√ªts de prod");
    },
    s.txt
  ));
});

// 5) Famille POLITIQUES PUBLIQUES (ne pas confondre avec fiscalit√© de base du jeu)
const policy = [
  { n:"Aides √† l'√©co‚Äëconception", money:+200, nat:+40, tempRegen:+0.01 },
  { n:"Norme stricte anti‚Äëpollution", nat:+60, cost:+1 },
  { n:"Subvention isolation", confort:+2, money:+150 },
  { n:"Contr√¥le prix temporaire", price:-0.25 },
  { n:"Guerre commerciale", price:+0.35, cost:+1 },
];
policy.forEach(s=>{
  EV.push(makeEvent(
    "üèõÔ∏è "+s.n,
    "D√©cision publique : l'environnement √©conomique change, avec des effets imm√©diats ou temporaires.",
    (gs, sys)=>{
      if (s.money) _money(gs, s.money);
      if (s.nat) _add(gs, "nature", s.nat);
      if (s.confort) _add(gs, "confort", s.confort);
      if (s.tempRegen) tempRegen(sys, s.tempRegen, 10, "Coup de pouce √©cologique");
      if (s.price) tempPrice(sys, s.price, 10, (s.price>0?"Prix sous pression":"Prix mod√©r√©s"));
      if (s.cost)  tempProdCost(sys, s.cost, 10, "Chocs de co√ªts");
    },
    [
      s.money?`üí∂ ${(s.money>0?"+":"")+s.money}`:null,
      s.nat?`üå± ${(s.nat>0?"+":"")+s.nat}`:null,
      s.confort?`ü§ñ ${(s.confort>0?"+":"")+s.confort}`:null,
      s.price?`prix ${(s.price>0?"‚Üë":"‚Üì")} temporaire`:null
    ].filter(Boolean).join(" | ")
  ));
});

// 6) Famille EH (si activ√©) : dons/entraide, frictions apais√©es, initiatives locales, stress EH
const ehFamily = [
  { n:"Entraide locale",        money:+120, confort:+2 },
  { n:"Prime verte citoyenne",  money:+180, nat:+30 },
  { n:"Friction apais√©e",       fee:-0.02 }, // interpr√©t√© comme baisse temporaire de co√ªts de prod
  { n:"Stress de transition",   prod:-0.15, price:+0.15 },
];
ehFamily.forEach(s=>{
  EV.push(makeEvent(
    "üåø [EH] "+s.n,
    "Dans l'√©conomie hom√©ostatique, le corps social s'adapte.",
    (gs, sys)=>{
      if (!gs.ehActivated){ // si pas EH, effet r√©duit + texte adapt√©
        _money(gs, Math.floor((s.money||0)/2));
        if (s.nat) _add(gs,"nature", Math.floor(s.nat/2));
        if (s.confort) _add(gs,"confort", Math.max(1, Math.floor(s.confort/2)));
        if (s.prod) tempBoostProd(sys, s.prod/2, 8, "Ajustement (hors EH)");
        if (s.price) tempPrice(sys, (s.price/2), 8, "Prix ajust√©s (hors EH)");
        if (s.fee) tempProdCost(sys, Math.round(s.fee*10), 8, "Friction ajust√©e");
        return;
      }
      if (s.money) _money(gs, s.money);
      if (s.nat) _add(gs,"nature", s.nat);
      if (s.confort) _add(gs,"confort", s.confort);
      if (s.prod) tempBoostProd(sys, s.prod, 10, "Transition EH");
      if (s.price) tempPrice(sys, s.price, 10, "Signal de prix EH");
      if (s.fee) tempProdCost(sys, Math.round(s.fee*10), 10, "Friction modifi√©e");
    },
    "Effets conditionnels selon EH"
  ));
});

// 7) Petits "fluffs" r√©p√©tables avec l√©g√®res variations num√©riques pour atteindre ~260
function series(label, count, builder){
  for(let i=1;i<=count;i++){ EV.push(builder(i)); }
}

// S√©rie "micro‚Äë√©v√©nements nature" (+/‚àí modestes, style m√©t√©o locale)
series("M√©t√©o locale", 40, (i)=>{
  const sign = Math.random()<0.5?-1:+1;
  const dN = sign*Math.floor(Math.random()*18+8);
  return makeEvent(
    "‚õÖ M√©t√©o locale #"+i,
    (sign>0?"Des pluies fines nourrissent les sols.":"Un temps sec fatigue les sols."),
    (gs, sys)=>{ _add(gs,"nature", dN); if (sign>0) tempRegen(sys, 0.004, 6, "R√©g√©n√©ration l√©g√®re"); },
    "üå± "+(dN>0?"+":"")+dN+(sign>0?" | l√©g√®re r√©g√©n√©ration":"")
  );
});

// S√©rie "micro‚Äëmarch√©" (ajustements de prix courts)
series("Ajustement march√©", 40, (i)=>{
  const p = (Math.random()<0.5?-1:+1) * (Math.random()*0.18+0.05);
  return makeEvent(
    "üíπ Ajustement de march√© #"+i,
    "Les interm√©diaires ajustent leurs marges.",
    (gs, sys)=>{ tempPrice(sys, p, 6, "Micro‚Äëajustement des prix"); },
    "Prix "+(p>0?"‚Üë":"‚Üì")+" temporaire"
  );
});

// S√©rie "productivit√© op√©rationnelle"
series("Productivit√©", 40, (i)=>{
  const m = (Math.random()<0.55?+1:-1) * (Math.random()*0.22+0.08);
  return makeEvent(
    "‚öôÔ∏è Productivit√© #"+i,
    (m>0?"De bons r√©glages fluidifient la production.":"Des contretemps ralentissent la production."),
    (gs, sys)=>{ tempBoostProd(sys, m, 8, "Productivit√© op√©rationnelle"); },
    (m>0?"+":"-")+"prod temporaire"
  );
});

// S√©rie "approvisionnement" (co√ªt unitaire bouge un peu)
series("Approvisionnement", 40, (i)=>{
  const c = (Math.random()<0.5?+1:-1) * (Math.random()<0.5?1:2);
  return makeEvent(
    "üöö Approvisionnement #"+i,
    "Les co√ªts de production fluctuent avec la logistique.",
    (gs, sys)=>{ tempProdCost(sys, c, 8, "Co√ªts logistiques"); },
    "Co√ªt de prod "+(c>0?"‚Üë":"‚Üì")+" temporaire"
  );
});

// S√©rie "Solidarit√©s & tensions" (modeste confort +/‚àí)
series("Solidarit√©s & tensions", 40, (i)=>{
  const d = (Math.random()<0.55?+1:-1) * (Math.random()<0.5?1:2);
  return makeEvent(
    "ü§ù Humeurs sociales #"+i,
    (d>0?"R√©seaux de solidarit√© actifs.":"Ambiance morose, quelques frictions."),
    (gs)=>{ _add(gs,"confort", d); },
    "ü§ñ "+(d>0?"+":"")+d
  );
});

// On a d√©j√† ~6 familles √ó 4‚Äì6 chacun + 5 familles √ó 4 = ~30
// + 5 s√©ries √ó 40 = 200 ‚Äî> total ‚âà 230. Compl√©tons avec 30 "sp√©ciaux".

const specials = [
  makeEvent("üî¨ Recyclage pionnier",
    "Une start‚Äëup convertit des d√©chets en mati√®re premi√®re utilisable.",
    (gs, sys)=>{ _add(gs,"nature", +55); tempProdCost(sys, -1, 12, "Mati√®re recycl√©e"); },
    "üå± +55 | co√ªt prod ‚Üì temporaire"
  ),
  makeEvent("üõ∞Ô∏è Observation spatiale",
    "De meilleurs mod√®les m√©t√©o vous aident √† planifier la production.",
    (gs, sys)=>{ tempBoostProd(sys, +0.18, 12, "Planification fine"); },
    "+18% prod temporaire"
  ),
  makeEvent("üõ°Ô∏è Cyber‚Äëattaque √©vit√©e",
    "Votre SI encaisse une tentative sans d√©g√¢ts. Vigilance accrue.",
    (gs, sys)=>{ tempBoostProd(sys, +0.08, 10, "R√©activit√©"); tempProdCost(sys, -1, 6, "Frais √©vit√©s"); },
    "Prod +8% | co√ªt -1 (temp.)"
  ),
  makeEvent("üß≠ Coop inter‚Äëterritoires",
    "Des partenaires relaient des stocks, √©vitant des ruptures.",
    (gs, sys)=>{ tempPrice(sys, -0.18, 10, "Prix stabilis√©s"); },
    "Prix ‚Üì temporaire"
  ),
  makeEvent("

<!-- ============================ BLOC 5/6 ‚Äî FONCTIONS EH AVANC√âES ============================ -->
<script>
/* =========================================================================
   BLOC 5/6 ‚Äî Fonctions EH avanc√©es et m√©caniques sp√©cialis√©es
   ‚ö†Ô∏è  AUCUNE RED√âFINITION de fonctions existantes (updateUIValues, toggleAutomatism, etc.)
   ========================================================================= */

// ===================================================================================
// M√âCANIQUES EH AVANC√âES
// ===================================================================================

// Gestion des investissements √©cologiques en EH
function ehInvestmentTick(){
  if (!Array.isArray(gameState.ecologicalInvestments)) gameState.ecologicalInvestments = [];
  
  const now = gameState.clicks;
  const matured = [];
  const still = [];
  
  for (const inv of gameState.ecologicalInvestments) {
    const elapsed = now - (inv.startClick || now);
    const isDue = elapsed >= 10;
    (isDue ? matured : still).push(inv);
  }
  
  // Traiter les investissements arriv√©s √† maturit√©
  matured.forEach(inv => {
    const amt = Math.abs(inv.amount || 0);
    const pressure = Math.max(200, gameState.nature);
    const raw = Math.round((amt / pressure) * 60);
    const gainNature = Math.max(3, Math.min(50, raw));
    
    gameState.nature += gainNature;
    
    const bonus = Math.ceil(amt * 0.02);
    const delta = (inv.amount >= 0) ? (inv.amount + bonus) : (-amt + bonus);
    gameState.money += delta;
    
    showMsg("‚úÖ Investissement arriv√© : +"+gainNature+" üå±, "+(delta>=0?"+":"")+delta+"‚Ç¨");
  });
  
  gameState.ecologicalInvestments = still;
  updateInvestmentListUI();
}

function updateInvestmentListUI(){
  const box = document.getElementById("investment-list");
  if (!box) return;
  
  const arr = gameState.ecologicalInvestments || [];
  if (arr.length === 0) {
    box.textContent = "Aucun investissement en cours";
    return;
  }
  
  const now = gameState.clicks;
  box.innerHTML = "";
  
  arr.forEach((inv, i) => {
    const remain = Math.max(0, 10 - (now - (inv.startClick || now)));
    const div = document.createElement("div");
    div.textContent = `#${i+1} ‚Ä¢ ${inv.amount>=0 ? (-inv.amount+"‚Ç¨") : (`dette ${inv.amount}‚Ç¨`)} ‚Ä¢ reste ${remain} actions`;
    box.appendChild(div);
  });
}

// Am√©lioration de la fonction updateInvestmentPreview (remplace le stub du BLOC 3)
function updateInvestmentPreviewAdvanced(){
  const preview = document.getElementById("investment-preview");
  const input = document.getElementById("investment-amount");
  if (!preview || !input) return;
  
  const val = Number(input.value || 0);
  if (!val) {
    preview.textContent = "";
    return;
  }
  
  const maxPos = Math.max(0, gameState.money);
  const maxNeg = Math.abs(Math.min(0, gameState.money));
  const ok = (val > 0 && val <= maxPos) || (val < 0 && Math.abs(val) <= maxNeg);
  
  if (!ok) {
    preview.textContent = `Montant hors borne (solde/dette).`;
    return;
  }
  
  const amt = Math.abs(val);
  const pressure = Math.max(200, gameState.nature);
  const raw = Math.round((amt / pressure) * 60);
  const gainNature = Math.max(3, Math.min(50, raw));
  const bonus = Math.ceil(amt * 0.02);
  
  preview.textContent = `Pr√©vision (10 actions) : +${gainNature} üå±, ${val>=0?"+":""}${val}‚Ç¨ rembours√©s + bonus ~${bonus}‚Ç¨`;
}

// Fonction d'investissement EH complexe (remplace le stub du BLOC 3)
function makeEcologicalInvestmentAdvanced(){
  if (!gameState.ehActivated) {
    showMsg("Investissements disponibles uniquement en EH.");
    return;
  }
  
  saveState();
  
  const input = document.getElementById("investment-amount");
  const val = Number(input?.value || 0);
  
  if (!val || !isFinite(val)) {
    showMsg("Montant invalide.");
    return;
  }
  
  if (val > 0 && val > gameState.money) {
    showMsg("Montant sup√©rieur au solde.");
    return;
  }
  
  if (val < 0 && Math.abs(val) > Math.abs(Math.min(0, gameState.money))) {
    showMsg("Montant > dette autoris√©e.");
    return;
  }
  
  const fee = ehFriction(Math.abs(val));
  gameState.money -= (val + fee);
  maybeApplyInterest();
  
  const inv = { 
    amount: val, 
    startClick: gameState.clicks 
  };
  gameState.ecologicalInvestments.push(inv);
  
  gameState.clicks++;
  showMsg("üíö Investissement lanc√© : "+(val>0?("-"+(val+fee)+"‚Ç¨"):("-"+fee+"‚Ç¨ de frais"))+" ‚Ä¢ restitution dans 10 actions.");
  
  ehInvestmentTick();
  randomEventsSystem.processClick();
  updateOptimumStreak();
  updateUIValues();
}

// ===================================================================================
// CYCLES EH (dons, primes, fonte, bonus)
// ===================================================================================

function checkEHCycles(){
  if (!gameState.ehActivated) return;
  
  const clicks = gameState.clicks;
  
  // Don √©cologique tous les 10 clics
  if (clicks > 0 && clicks % gameState.ehDonationEvery === 0) {
    const don = Math.floor(Math.abs(gameState.money) * 0.02);
    if (don > 0) {
      gameState.money -= don;
      gameState.nature += Math.floor(don / 10) + 1;
      showMsg("üå± Don √©cologique EH : -"+don+"‚Ç¨ ‚Üí +"+(Math.floor(don/10)+1)+" ressources");
    }
  }
  
  // Prime verte tous les 50 clics
  if (clicks > 0 && clicks % gameState.ehPrimeEvery === 0) {
    const prime = Math.floor(gameState.nature * 0.03) + 20;
    gameState.money += prime;
    showMsg("üíö Prime verte EH : +"+prime+"‚Ç¨");
  }
  
  // Fonte/bonus tous les 10 clics (l√©gers ajustements)
  if (clicks > 0 && clicks % gameState.ehBonusEvery === 0) {
    if (Math.random() < 0.6) {
      // Bonus positif
      const bonus = Math.floor(Math.random() * 15 + 5);
      const type = Math.random() < 0.5 ? "nature" : "confort";
      gameState[type] += bonus;
      showMsg("üåø Bonus EH : +"+bonus+" "+(type==="nature"?"üå±":"ü§ñ"));
    } else {
      // Fonte l√©g√®re
      const fonte = Math.floor(Math.random() * 10 + 3);
      gameState.nature = Math.max(0, gameState.nature - fonte);
      showMsg("üçÉ Fonte naturelle EH : -"+fonte+" üå±");
    }
  }
}

// ===================================================================================
// GAME OVER & CONDITIONS DE FIN
// ===================================================================================

function checkGameOverConditions(){
  let gameOver = false;
  
  // Game Over : ressources √©puis√©es
  if (gameState.nature <= 0) {
    gameState.gameOver = true;
    gameOver = true;
    const gor = document.getElementById("game-over-resources");
    if (gor) {
      gor.style.display = "block";
      gor.textContent = "üí• Plan√®te non habitable (ressources √©puis√©es)";
    }
  }
  
  // Game Over : effondrement social (confort retombe √† 0 apr√®s avoir √©t√© > 0)
  if (gameState.confortMaxAtteint < gameState.confort) {
    gameState.confortMaxAtteint = gameState.confort;
  }
  
  if (gameState.confortMaxAtteint > 0 && gameState.confort <= 0) {
    gameState.gameOver = true;
    gameOver = true;
    const goc = document.getElementById("game-over-confort");
    if (goc) {
      goc.style.display = "block";
      goc.textContent = "üí• Effondrement social (confort retomb√© √† 0)";
    }
  }
  
  // Bouton secours EH si Game Over et EH pas encore activ√©e
  if (gameOver && !gameState.ehActivated) {
    const rescueBtn = document.getElementById("rescue-eh-btn");
    if (rescueBtn) {
      rescueBtn.style.display = "block";
    }
  }
  
  return gameOver;
}

// ===================================================================================
// PALIERS AVANC√âS ET CONDITIONS SP√âCIALES
// ===================================================================================

function checkAdvancedMilestones(){
  const clicks = gameState.clicks;
  
  // Auto-activation EH √† 50 clics si pas encore fait
  if (clicks >= gameState.ehAutoTriggerAt && !gameState.ehActivated) {
    const evolutionBtn = document.getElementById("evolution-btn");
    if (evolutionBtn) {
      evolutionBtn.style.display = "block";
    }
  }
  
  // R√©v√©lation progressive des jauges selon activit√©
  if (gameState.ia > 0) {
    const jgIA = document.getElementById("jg-ia");
    if (jgIA) jgIA.style.display = "flex";
  }
  
  if (gameState.trader > 0) {
    const jgTrader = document.getElementById("jg-trader");
    if (jgTrader) jgTrader.style.display = "flex";
  }
  
  if (gameState.confortAuto > 0) {
    const jgAuto = document.getElementById("jg-achat-auto");
    if (jgAuto) jgAuto.style.display = "flex";
  }
  
  if (gameState.centre > 0) {
    const jgCentre = document.getElementById("jg-centre");
    if (jgCentre) jgCentre.style.display = "flex";
  }
  
  if (gameState.techLevel > 0) {
    const jgTech = document.getElementById("jg-tech");
    if (jgTech) jgTech.style.display = "flex";
  }
}

// ===================================================================================
// MISE √Ä JOUR SP√âCIALIS√âE (compl√©ment √† updateUIValues du BLOC 3)
// ===================================================================================

function updateSpecializedUI(){
  // Mise √† jour des investissements EH
  if (gameState.ehActivated) {
    ehInvestmentTick();
    updateInvestmentListUI();
  }
  
  // V√©rification des cycles EH
  checkEHCycles();
  
  // V√©rification conditions de fin
  checkGameOverConditions();
  
  // V√©rification paliers avanc√©s
  checkAdvancedMilestones();
}

// ===================================================================================
// AM√âLIORATIONS DES FONCTIONS EXISTANTES
// ===================================================================================

// Am√©lioration de la fonction de red√©marrage (alternative plus robuste)
function restartGameAdvanced(){
  // Sauvegarde avant reset
  saveState();
  
  // Arr√™t de tous les intervalles
  clearAllIntervals();
  
  // Reset complet de l'√©tat
  const initialState = {
    nature: 3000, confort: 0, production: 0, money: 1000, budgetEtat: 0,
    monnaieActive: true, clicks: 0, jeuBloque: false, gameOver: false,
    confortMaxAtteint: 0, optimumStreak: 0, optimumVictory: false,
    optimumRanges: { nature:[1800,2600], confort:[10,35], money:[400,1200] },
    taxEnabled: true, taxEveryClicks: 20, _taxEverApplied: false,
    creditRate: 0.05, creditRateMin: 0.01, creditNegotiationsUsed: 0,
    lastNegotiationShownAt: 0, ehActivated: false, ehAutoTriggerAt: 50,
    ehDonationEvery: 10, ehPrimeEvery: 50, ehFonteEvery: 10, ehBonusEvery: 10,
    ehTransactionTax: 0.04, ecologicalInvestments: [],
    ia: 0, trader: 0, confortAuto: 0, centre: 0, automatismsGenerateClicks: false,
    productionMultiplier: 1.0, techLevel: 0, baseProdCost: 5, prodCostUpgradesBought: 0,
    paliersDebloque: {
      comfort:false, ia:false, trader:false, upgradeProd:false,
      confortAuto:false, automatismsClics:false, priceIndicator:false, centreCommercial:false
    },
    nbAchatIA: 0, nbAchatTrader: 0, nbAchatConfortAuto: 0, nbAchatUpgradeProd: 0, nbAchatCentre: 0,
    priceIndicatorActive: false
  };
  
  // Application du reset
  Object.keys(gameState).forEach(k => delete gameState[k]);
  Object.assign(gameState, initialState);
  
  // Reset du syst√®me d'√©v√©nements
  if (randomEventsSystem && typeof randomEventsSystem.reset === "function") {
    randomEventsSystem.reset();
  }
  
  // Reset de l'interface
  const elementsToHide = [
    "optimum-victory", "eh-msg", "eh-success", 
    "game-over-resources", "game-over-confort",
    "alert-crise", "social-crise", "investment-block"
  ];
  
  elementsToHide.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
  
  // Mise √† jour compl√®te
  if (typeof updateUIValues === "function") {
    updateUIValues();
  }
  
  showMsg("üîÑ Partie enti√®rement r√©initialis√©e");
  
  // Messages d'accueil diff√©r√©s
  setTimeout(() => showMsg("üåç Objectif : maintenir l'√©quilibre √©cologique et social"), 800);
  setTimeout(() => showMsg("üéØ Zone d'√©quilibre : Nature 1800-2600, Confort 10-35, Argent 400-1200‚Ç¨"), 3000);
}

// ===================================================================================
// HOOKS POUR INT√âGRATION AVEC LE BLOC 3
// ===================================================================================

// Cette fonction peut √™tre appel√©e depuis le BLOC 3 pour les mises √† jour sp√©cialis√©es
function postActionUpdate(){
  updateSpecializedUI();
}

// Hook pour les actions principales (√† appeler depuis produce/sell)
function processEHEffects(){
  if (gameState.ehActivated) {
    checkEHCycles();
  }
}

// ===================================================================================
// UTILITAIRES DE DIAGNOSTIC ET DEBUG
// ===================================================================================

function diagnosticGameState(){
  if (!cheatModeUnlocked) return;
  
  console.log("=== DIAGNOSTIC √âTAT DU JEU ===");
  console.log("Clics:", gameState.clicks);
  console.log("Ressources:", gameState.nature);
  console.log("Confort:", gameState.confort);
  console.log("Argent:", gameState.money);
  console.log("EH activ√©:", gameState.ehActivated);
  console.log("Automatismes:", {
    ia: gameState.ia,
    trader: gameState.trader,
    confortAuto: gameState.confortAuto,
    centre: gameState.centre
  });
  console.log("Zone d'√©quilibre:", gameState.optimumStreak + "/50");
  console.log("Investissements EH:", gameState.ecologicalInvestments.length);
}

// Fonction de test pour v√©rifier l'int√©grit√©
function testGameIntegrity(){
  if (!cheatModeUnlocked) return;
  
  const issues = [];
  
  if (gameState.nature < 0) issues.push("‚ùå Ressources n√©gatives");
  if (gameState.confort < 0) issues.push("‚ùå Confort n√©gatif");
  if (typeof gameState.clicks !== "number") issues.push("‚ùå Compteur clics invalide");
  if (!Array.isArray(gameState.ecologicalInvestments)) issues.push("‚ùå Investissements EH corrompus");
  
  if (issues.length === 0) {
    showMsg("‚úÖ Int√©grit√© du jeu OK");
    console.log("‚úÖ Aucun probl√®me d√©tect√©");
  } else {
    showMsg("‚ö†Ô∏è Probl√®mes d√©tect√©s (voir console)");
    console.log("=== PROBL√àMES D√âTECT√âS ===");
    issues.forEach(issue => console.log(issue));
  }
}

</script>
<!-- ============================ /FIN BLOC 5/6 ============================

  <!-- ============================ BLOC 6/6 ‚Äî FINALISATION & BOOT ============================ -->
<script>
/* =========================================================================
   BLOC 6/6 ‚Äî Boot s√©curis√© et finalisation
   ‚ö†Ô∏è  AUCUNE RED√âFINITION - Uniquement initialisation et boot
   ========================================================================= */

// ===================================================================================
// FONCTION DE BOOT S√âCURIS√âE
// ===================================================================================
(function safeBoot() {
  console.log("üöÄ D√©marrage Looop v1.30.5");
  
  // V√©rification de l'int√©grit√© des fonctions critiques
  const criticalFunctions = [
    'updateUIValues', 'produce', 'sell', 'toggleAutomatism',
    'acheterIA', 'acheterTrader', 'acheterConfort'
  ];
  
  const missingFunctions = criticalFunctions.filter(fname => typeof window[fname] !== 'function');
  
  if (missingFunctions.length > 0) {
    console.error("‚ùå Fonctions manquantes:", missingFunctions);
    showMsg("‚ö†Ô∏è Erreur de chargement - Rechargez la page");
    return;
  }
  
  console.log("‚úÖ Fonctions critiques OK");
  
  // Initialisation du syst√®me d'√©v√©nements
  if (typeof randomEventsSystem === 'object' && typeof randomEventsSystem.init === 'function') {
    randomEventsSystem.init();
    console.log("‚úÖ Syst√®me d'√©v√©nements initialis√©");
  }
  
  // Configuration initiale des contr√¥les automatismes
  const controlsPanel = document.getElementById("automatisms-controls");
  if (controlsPanel) {
    controlsPanel.style.display = "none"; // Masqu√© au d√©but
  }
  
  // Configuration des boutons ON/OFF
  const automConfigMap = [
    ["control-ia", "ia", "ü§ñ IA: "],
    ["control-trader", "trader", "üí∞ Trader: "],
    ["control-confort", "confort", "üõãÔ∏è Confort: "],
    ["control-centre", "centre", "üè¨ Centre: "]
  ];
  
  automConfigMap.forEach(([id, key, label]) => {
    const btn = document.getElementById(id);
    if (btn) {
      const active = automatismsActive && automatismsActive[key];
      btn.className = "control-btn " + (active ? "active" : "disabled");
      btn.textContent = label + (active ? "ON" : "OFF");
    }
  });
  
  // Premi√®re mise √† jour de l'interface
  if (typeof updateUIValues === 'function') {
    updateUIValues();
    console.log("‚úÖ Interface initialis√©e");
  }
  
  // V√©rification de l'√©tat initial
  const initialChecks = [
    gameState.clicks === 0,
    gameState.nature === 3000,
    gameState.money === 1000,
    gameState.jeuBloque === false
  ];
  
  if (initialChecks.every(check => check)) {
    console.log("‚úÖ √âtat initial correct");
  } else {
    console.warn("‚ö†Ô∏è √âtat initial inattendu");
  }
  
  // Messages d'accueil diff√©r√©s
  setTimeout(() => {
    if (typeof showMsg === 'function') {
      showMsg("üåç Looop - Simulateur d'√©quilibre √©cologique");
    }
  }, 1000);
  
  setTimeout(() => {
    if (typeof showMsg === 'function') {
      showMsg("üéØ Objectif : maintenir l'√©quilibre pendant 50 actions");
    }
  }, 3500);
  
  console.log("üéÆ Jeu pr√™t !");
  
})();

// ===================================================================================
// GESTIONNAIRES D'ERREURS GLOBAUX
// ===================================================================================

// Capture des erreurs JavaScript pour diagnostic
window.addEventListener('error', function(event) {
  console.error("‚ùå Erreur JavaScript d√©tect√©e:", event.error);
  
  if (typeof showMsg === 'function') {
    showMsg("‚ö†Ô∏è Erreur d√©tect√©e - V√©rifiez la console");
  }
  
  // En mode debug, afficher plus de d√©tails
  if (window.cheatModeUnlocked) {
    console.error("D√©tails:", {
      message: event.message,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno
    });
  }
});

// Capture des promesses rejet√©es
window.addEventListener('unhandledrejection', function(event) {
  console.error("‚ùå Promise rejet√©e:", event.reason);
  event.preventDefault(); // Emp√™che l'affichage dans la console du navigateur
});

// ===================================================================================
// FONCTIONS UTILITAIRES FINALES
// ===================================================================================

// V√©rification p√©riodique de l'int√©grit√© (en mode debug)
function startIntegrityMonitoring() {
  if (!window.cheatModeUnlocked) return;
  
  setInterval(() => {
    // V√©rifications basiques
    if (typeof gameState !== 'object') {
      console.error("‚ùå gameState corrompu");
      return;
    }
    
    if (gameState.nature < 0) {
      console.warn("‚ö†Ô∏è Ressources n√©gatives d√©tect√©es");
      gameState.nature = 0;
    }
    
    if (gameState.confort < 0) {
      console.warn("‚ö†Ô∏è Confort n√©gatif d√©tect√©");
      gameState.confort = 0;
    }
    
    if (typeof gameState.clicks !== 'number' || gameState.clicks < 0) {
      console.warn("‚ö†Ô∏è Compteur clics invalide");
      gameState.clicks = Math.max(0, parseInt(gameState.clicks) || 0);
    }
    
  }, 30000); // V√©rification toutes les 30 secondes
}

// Fonction de sauvegarde d'urgence (mode debug)
function emergencySave() {
  if (!window.cheatModeUnlocked) return;
  
  try {
    const saveData = {
      gameState: JSON.parse(JSON.stringify(gameState)),
      timestamp: Date.now(),
      version: "1.30.5"
    };
    
    localStorage.setItem('looop_emergency_save', JSON.stringify(saveData));
    console.log("üíæ Sauvegarde d'urgence cr√©√©e");
    showMsg("üíæ Sauvegarde d'urgence OK");
    
  } catch (error) {
    console.error("‚ùå Erreur sauvegarde:", error);
  }
}

// Fonction de restauration d'urgence (mode debug)
function emergencyRestore() {
  if (!window.cheatModeUnlocked) return;
  
  try {
    const saveData = localStorage.getItem('looop_emergency_save');
    if (!saveData) {
      showMsg("‚ùå Aucune sauvegarde trouv√©e");
      return;
    }
    
    const parsed = JSON.parse(saveData);
    if (parsed.gameState) {
      Object.assign(gameState, parsed.gameState);
      if (typeof updateUIValues === 'function') {
        updateUIValues();
      }
      showMsg("üîÑ Sauvegarde restaur√©e");
      console.log("üîÑ √âtat restaur√© depuis:", new Date(parsed.timestamp));
    }
