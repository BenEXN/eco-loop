<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Looop ‚Äî UI v1.26.1 + R√®gles v1.30 + EH + Paliers + √âv√©nements robustes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f3f3; --card:#fff; --ink:#111; --muted:#666;
    --shadow:0 4px 24px #0001;
    --bar:#eee; --ok:#4CAF50; --ok2:#81C784; --danger:#c00;
    --res:#86e08e; --conf:#86b6ea; --money:#ffb3b3; --budget:#ff9800;
    --ia:#ab47bc; --trader:#26c6da; --auto:#ffa726; --centre:#66bb6a; --tech:#9c27b0;
    --eh:#2e7d32; --ehbg:#e8f5e8; --ehbord:#81c784;
    --toastbg:#fff9c4; --toastbd:#f4d03f; --toastfg:#8a6d00;
  }
  html,body{background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; margin:0}
  h1{ text-align:center; margin:22px 0 10px}
  .container{ display:flex; justify-content:center; align-items:flex-start; gap:24px; margin:0 auto 18px; max-width:980px; padding:0 10px;}
  .category{ background:var(--card); border-radius:18px; box-shadow:var(--shadow); flex:1; padding:26px 16px 16px; min-width:260px; max-width:330px;}
  .cat-title{ font-size:1.25em; font-weight:800; margin-bottom:12px; letter-spacing:.3px; text-align:center;}
  .stock-value{ font-size:1.6em; font-weight:900; text-align:center; }
  .stock-label{ font-size:.95em; color:var(--muted); text-align:center; margin-bottom:10px;}
  .products-box{ background:#f7f7fa; border:2px solid #dde1eb; border-radius:10px; margin:12px 0; padding:10px 22px; font-weight:700; text-align:center; box-shadow:0 1px 4px #ddd5;}
  .message-box{ border-radius:10px; margin:8px 0 12px; padding:10px 12px; font-weight:700; font-size:1.02em; box-shadow:0 1px 4px #0002; text-align:center;}
  .msg-orange{ background:#fff2e6; color:#cc5500; border:2px solid #ff8533;}
  .msg-red{ background:#ffe6e6; color:#c00; border:2px solid #ff6666;}
  .msg-blue{ background:#e6f3ff; color:#0066cc; border:2px solid #4da6ff;}
  .msg-green{ background:#e6ffe6; color:#066; border:2px solid #66cc66;}
  .msg-gold{ background:#fff9c4; color:#8a6d00; border:2px solid #f4d03f;}
  .btn-row{ margin-top:14px; display:flex; flex-direction:column; align-items:center; gap:8px;}
  button{ font-size:1em; padding:10px 16px; border:none; border-radius:12px; background:#ededed; color:var(--ink); cursor:pointer;}
  .btn-evo{ background:#4CAF50; color:#fff; font-weight:700;}
  .btn-yellow{ background:#FFD600; color:#222; font-weight:700;}
  .btn-annuler{ background:#999; color:#fff;}
  .btn-invest{ background:var(--eh); color:#fff; font-weight:700;}
  .automatisms-controls{ margin:14px auto; max-width:980px; display:none; justify-content:center; gap:10px; flex-wrap:wrap; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001;}
  .control-btn{ font-size:.9em; padding:8px 12px; border-radius:8px; border:none; min-width:100px; }
  .active{ background:#4CAF50; color:#fff; } .inactive{ background:#f44336; color:#fff; } .disabled{ background:#ccc; color:#777;}

  /* Zone d'√©quilibre */
  .optimum-zone{ display:none; margin:12px auto; max-width:980px; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001; text-align:center;}
  .optimum-progress-bar{ background:var(--bar); height:20px; border-radius:20px; max-width:420px; margin:10px auto; overflow:hidden; position:relative;}
  .optimum-progress-fill{ height:100%; background:linear-gradient(90deg,var(--ok),var(--ok2)); width:0%;}
  .optimum-text{ font-size:.95em; color:#555; margin-top:6px;}
  #optimum-victory{ display:none; background:#fff9c4; border:2px solid #f4d03f; color:#8a6d00; padding:16px; border-radius:12px; text-align:center; font-weight:800; max-width:700px; margin:12px auto; }

  /* √âv√©nements + encart effets temporaires actifs */
  .events-zone{ margin:12px auto; max-width:980px; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 2px 12px #0001;}
  .event-notification{ background:#f0f8f0; border:2px solid #81c784; border-radius:10px; padding:10px; font-weight:700; color:#2e7d32; display:none;}
  .temp-effects{ margin-top:10px; padding:10px; background:#fafafa; border:1px dashed #bbb; border-radius:10px; font-size:.92em;}
  .temp-effects h4{ margin:0 0 6px 0; font-size:.95em; color:#444; }
  .temp-list{ display:flex; flex-wrap:wrap; gap:6px; }
  .temp-pill{ background:#eef3ff; border:1px solid #cfe0ff; color:#1a4fb3; border-radius:999px; padding:4px 8px; }

  /* Jauges */
  .jrows{ margin:0 auto 10px; max-width:720px;}
  .jrow{ display:flex; align-items:center; gap:8px; margin:0 auto 6px; }
  .jlabel{ min-width:120px; text-align:right; font-size:1em; color:#555; }
  .bar{ background:var(--bar); border-radius:8px; height:14px; flex:1; overflow:hidden;}
  .fill{ height:100%; border-radius:8px; transition:width .2s;}
  #jauge-nature{ background:var(--res);}
  #jauge-confort{ background:var(--conf);}
  #jauge-money{ background:var(--money);}
  #jauge-budget{ background:var(--budget);}
  #jauge-ia{ background:var(--ia);}
  #jauge-trader{ background:var(--trader);}
  #jauge-achat-auto{ background:var(--auto);}
  #jauge-centre{ background:var(--centre);}
  #jauge-tech{ background:var(--tech);}
  .jval{ min-width:80px; text-align:right; }

  /* EH investissement avanc√© */
  .investment-block{ background:var(--ehbg); border:2px solid var(--ehbord); border-radius:10px; padding:12px; margin-top:10px;}
  .investment-title{ font-weight:800; color:var(--eh); text-align:center; margin-bottom:8px;}
  .investment-controls{ display:flex; justify-content:center; gap:8px; flex-wrap:wrap;}
  .investment-input{ width:100px; padding:8px; border:1px solid #ccc; border-radius:8px; font-size:1em;}
  .investment-preview{ font-size:.9em; color:var(--eh); text-align:center; min-height:18px; margin-top:6px;}
  .investment-list{ font-size:.9em; color:#555; margin-top:8px; max-height:120px; overflow:auto;}

  /* Toast court */
  #message{ text-align:center; font-weight:800; min-height:24px; margin:8px 0;}
  .toast{ display:inline-block; background:var(--toastbg); color:var(--toastfg); border:2px solid var(--toastbd); padding:6px 10px; border-radius:10px;}

  /* Triche */
  #triche-sep{ border:none; border-top:3px solid #222; margin:22px auto 10px; width:94vw; max-width:980px;}
  #triche-label{ max-width:980px; margin:0 auto 10px; color:#555;}
  .debug-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px auto 24px;}

  /* Mobile */
  @media (max-width:760px){
    .container{ flex-direction:column; gap:12px;}
    .jrows{ max-width:calc(100vw - 22px);}
    .jlabel{ min-width:90px;}
  }
</style>
</head>
<body>
  <h1>üåç Looop ‚Äî √âquilibre √©co‚Äë√©co ‚Ä¢ EH ‚Ä¢ Fiscalit√© ‚Ä¢ √âv√©nements</h1>

  <!-- Contr√¥les des automatismes -->
  <div class="automatisms-controls" id="automatisms-controls">
    <button id="control-ia"     class="control-btn disabled" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button id="control-trader" class="control-btn disabled" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button id="control-confort" class="control-btn disabled" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button id="control-centre" class="control-btn disabled" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>

  <!-- Zone d'√©quilibre (affich√©e quand ressources ‚â§ 1000) -->
  <div class="optimum-zone" id="optimum-zone">
    <div style="font-weight:800;">üéØ Zone d'√©quilibre</div>
    <div class="optimum-progress-bar"><div class="optimum-progress-fill" id="optimum-progress"></div></div>
    <div class="optimum-text" id="optimum-text">Maintenez l‚Äô√©quilibre pendant 50 actions.</div>
  </div>

  <!-- Message de victoire -->
  <div id="optimum-victory">
    üèÜ VICTOIRE : √âquilibre maintenu pendant 50 actions !<br/>
    <button class="btn-yellow" onclick="restartGame()">üîÑ Recommencer</button>
  </div>

  <!-- √âv√©nements & effets temporaires -->
  <div class="events-zone">
    <div style="font-weight:800; margin-bottom:6px;">üåø √âv√©nements al√©atoires</div>
    <div id="event-box" class="event-notification">
      <div id="event-text"></div>
      <div id="event-effects" style="font-size:.9em;color:#666;margin-top:4px;"></div>
    </div>
    <div class="temp-effects">
      <h4>Effets temporaires actifs</h4>
      <div id="temp-list" class="temp-list"><span style="color:#777;">Aucun</span></div>
    </div>
  </div>

  <div class="container">
    <!-- Environnement -->
    <div class="category">
      <div class="cat-title">üå± Plan√®te</div>
      <div class="stock-value" id="nature">3000</div>
      <div class="stock-label">Ressources</div>

      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>

      <!-- Bloc investissement √©cologique (EH) -->
      <div id="investment-block" class="investment-block" style="display:none;">
        <div class="investment-title">üå± Investissement √©cologique (retour en 10 actions)</div>
        <div class="investment-controls">
          <input type="number" id="investment-amount" class="investment-input" placeholder="Montant ‚Ç¨" min="1" oninput="updateInvestmentPreview()">
          <button class="btn-invest" onclick="makeEcologicalInvestment()">üíö Investir</button>
          <button class="btn-invest" onclick="investirEcologieFixe()">üåø Raccourci (‚Äì200‚Ç¨ ‚Üí +30)</button>
        </div>
        <div id="investment-preview" class="investment-preview"></div>
        <div id="investment-list" class="investment-list">Aucun investissement en cours</div>
      </div>
    </div>

    <!-- Exosomatisation -->
    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock-value" id="confort">0</div>
      <div class="stock-label">Confort</div>

      <div class="products-box">Produits cr√©√©s<br/><span id="production">0</span></div>
      <div id="social-crise" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">üõãÔ∏è Achat (500 ‚Ç¨)</button>
      </div>
    </div>

    <!-- √âconomie -->
    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock-value" id="money">1000</div>
      <div class="stock-label">Monnaie (‚Ç¨)</div>

      <div class="products-box" id="price-indicator" style="display:none;">Prix de vente<br><span id="current-price">1‚Ç¨</span></div>

      <!-- Bouton n√©gociation cr√©dit (par paliers 300/600/900) -->
      <button id="nego-taux-btn" class="btn-yellow" style="display:none;" onclick="negocierTaux()">ü§ù N√©gocier mon cr√©dit</button>

      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>

        <!-- Am√©liorations/paliers -->
        <button id="ouvrier-btn" style="display:none;" onclick="acheterIA()">ü§ñ Engager une IA</button>
        <button id="trader-btn" style="display:none;" onclick="acheterTrader()">üí∞ Trader automatique</button>
        <button id="comfort-auto-btn" style="display:none;" onclick="acheterConfortAuto()">üîÑ Achat auto confort</button>
        <button id="upgrade-btn" style="display:none;" onclick="upgradeProd()">üí† Am√©liorer la production</button>
        <button id="centre-commercial-btn" style="display:none;" onclick="acheterCentre()">üè¨ Centre commercial</button>
        <button id="automatisms-btn" style="display:none;" onclick="acheterAutomatismsClics()">‚ö° Automatismes = clics</button>
        <button id="price-indicator-btn" style="display:none;" onclick="acheterIndicateur()">üìä Indicateur de prix</button>

        <!-- EH -->
        <button id="evolution-btn" class="btn-evo" style="display:none;" onclick="evolution()">üå± Passer √† l'√©conomie hom√©ostatique</button>
        <button id="rescue-eh-btn" class="btn-evo" style="display:none;" onclick="activateRescueEH()">üå± Secours EH</button>
      </div>
    </div>
  </div>

  <!-- Jauges -->
  <div class="jrows">
    <div class="jrow"><div class="jlabel">üå± Ressources</div><div class="bar"><div id="jauge-nature" class="fill" style="width:0%"></div></div><div class="jval" id="jnature">3000</div></div>
    <div class="jrow" id="jg-confort" style="display:none;"><div class="jlabel">ü§ñ Confort</div><div class="bar"><div id="jauge-confort" class="fill"></div></div><div class="jval" id="jconfort">0</div></div>
    <div class="jrow"><div class="jlabel">üí∂ Monnaie</div><div class="bar"><div id="jauge-money" class="fill"></div></div><div class="jval" id="jmoney">1000‚Ç¨</div></div>
    <div class="jrow" id="jg-budget" style="display:none;"><div class="jlabel">üèõÔ∏è Budget √âtat</div><div class="bar"><div id="jauge-budget" class="fill"></div></div><div class="jval" id="jbudget">0‚Ç¨</div></div>

    <div class="jrow" id="jg-achat-auto" style="display:none;"><div class="jlabel">üîÑ Achat auto</div><div class="bar"><div id="jauge-achat-auto" class="fill"></div></div><div class="jval" id="jachat-auto">√ó0</div></div>
    <div class="jrow" id="jg-ia" style="display:none;"><div class="jlabel">ü§ñ IA</div><div class="bar"><div id="jauge-ia" class="fill"></div></div><div class="jval" id="jia">√ó0</div></div>
    <div class="jrow" id="jg-trader" style="display:none;"><div class="jlabel">üí∞ Trader</div><div class="bar"><div id="jauge-trader" class="fill"></div></div><div class="jval" id="jtrader">√ó0</div></div>
    <div class="jrow" id="jg-centre" style="display:none;"><div class="jlabel">üè¨ Centre</div><div class="bar"><div id="jauge-centre" class="fill"></div></div><div class="jval" id="jcentre">√ó0</div></div>
    <div class="jrow" id="jg-tech" style="display:none;"><div class="jlabel">üí† Tech</div><div class="bar"><div id="jauge-tech" class="fill"></div></div><div class="jval" id="jtech">Niv.0</div></div>
  </div>

  <div id="message"></div>
  <div id="clics-container" style="text-align:center; margin:16px 0; font-weight:800;">Clics/actions : <span id="clicks">0</span></div>

  <hr id="triche-sep">
  <div id="triche-label">Triche (tests)</div>
  <div class="debug-row">
    <button class="btn-yellow" onclick="toggleCheatMode()">üîì D√©verrouiller les outils de test</button>
    <div id="cheat-buttons" style="display:none;">
      <button class="btn-yellow" onclick="addMoney()">+1000 ‚Ç¨</button>
      <button class="btn-yellow" onclick="addNature()">+100 ressources</button>
      <button class="btn-yellow" onclick="addClicks()">+50 clics</button>
      <button class="btn-yellow" onclick="forceActivateEH()">Passer √† l'EH (test)</button>
      <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler</button>
      <button class="btn-yellow" onclick="toggleEvents()">üé≤ √âv√©nements ON/OFF</button>
    </div>
  </div>

<script>
/* =========================================================================
   √âTAT G√âN√âRAL ‚Äî coh√©rent avec ton cahier des charges unifi√©
   ========================================================================= */
var gameState = {
  // stocks
  nature: 3000,
  confort: 0,
  production: 0,
  money: 1000,         // ‚úÖ Solde initial corrig√©
  budgetEtat: 0,       // n‚Äôappara√Æt qu‚Äôau 1er imp√¥t pr√©lev√©
  monnaieActive: true, // monnaie est d√©j√† active car solde initial affich√©

  // syst√®mes
  clicks: 0,
  jeuBloque: false,
  gameOver: false,
  confortMaxAtteint: 0,

  // optimum
  optimumStreak: 0,
  optimumVictory: false,
  optimumRanges: { nature:[1800,2600], confort:[10,35], money:[400,1200] },

  // fiscalit√© (OFF en EH)
  taxEnabled: true,         // d√©sactiv√©e en EH
  taxEveryClicks: 20,       // ‚úÖ 20 clics
  _taxEverApplied: false,   // pour r√©v√©ler budget au 1er pr√©l√®vement

  // cr√©dit & n√©gociation
  creditRate: 0.05,          // 5%
  creditRateMin: 0.01,       // 1%
  creditNegotiationsUsed: 0, // max 3
  lastNegotiationShownAt: 0, // dernier multiple de 300
  // pas de bouton "cr√©dit" : achats autoris√©s m√™me si money < 0

  // EH ‚Äî √©conomie hom√©ostatique
  ehActivated: false,
  ehAutoTriggerAt: 50,      // auto si ressources ‚â§ 50
  ehDonationEvery: 10,
  ehPrimeEvery: 50,
  ehFonteEvery: 10,
  ehBonusEvery: 10,
  ehTransactionTax: 0.04,   // friction 4% sur transactions
  ehPrimeClicks: 0,
  ehFonteClicks: 0,
  ehBonusClicks: 0,

  // investissements EH
  ecologicalInvestments: [], // {amount, remainingClicks, startClick}

  // automatismes
  ia: 0,
  trader: 0,
  confortAuto: 0,
  centre: 0,
  automatismsGenerateClicks: false,

  // techno / prod
  productionMultiplier: 1.0,
  techLevel: 0,
  baseProdCost: 5,
  prodCostUpgradesBought: 0, // max 3 (5‚Üí4‚Üí3‚Üí2)

  // paliers / co√ªts cycliques
  paliersDebloque: {
    comfort: false,
    ia: false,
    trader: false,
    upgradeProd: false,
    confortAuto: false,
    automatismsClics: false,
    priceIndicator: false,
    centreCommercial: false
  },
  nbAchatIA: 0,
  nbAchatTrader: 0,
  nbAchatConfortAuto: 0,
  nbAchatUpgradeProd: 0,
  nbAchatCentre: 0,
  priceIndicatorActive: false
};

// Automatismes ON/OFF (UI)
var automatismsActive = { ia:true, trader:true, confort:true, centre:true };
// Intervalles
var intervals = { ia:null, trader:null, confortAuto:null, centre:null };
// Undo
var lastState = null;
// Triche
var cheatModeUnlocked = false;

/* =========================================================================
   UTILITAIRES
   ========================================================================= */
function saveState(){
  lastState = {
    gameState: JSON.parse(JSON.stringify(gameState)),
    random: randomEventsSystem.getFullState()
  };
}
function undoAction(){
  if(!cheatModeUnlocked || !lastState) return;
  clearAllIntervals();
  gameState = JSON.parse(JSON.stringify(lastState.gameState));
  randomEventsSystem.restoreFullState(lastState.random);
  restartIntervalsAfterUndo();
  showMsg("Action annul√©e");
  updateUIValues();
}
function clearAllIntervals(){
  Object.keys(intervals).forEach(k => { if(intervals[k]){ clearInterval(intervals[k]); intervals[k]=null; } });
}
function restartIntervalsAfterUndo(){
  if (gameState.ia>0 && automatismsActive.ia && !gameState.ehActivated) startIAInterval();
  if (gameState.trader>0 && automatismsActive.trader && !gameState.ehActivated) startTraderInterval();
  if (gameState.confortAuto>0 && automatismsActive.confort && !gameState.ehActivated) startConfortAutoInterval();
  if (gameState.centre>0 && automatismsActive.centre && !gameState.ehActivated) startCentreInterval();
}

function showMsg(t){
  var m=document.getElementById("message");
  if(!m) return;
  m.innerHTML = '<span class="toast">'+t+'</span>';
  setTimeout(()=>{ if(m.innerText.includes(t)) m.innerHTML=""; }, 4000);
}

function clamp(n,min){ return (n<min?min:n); }
function priceNow(){
  if (gameState.nature<=0) return 1;
  var p = Math.max(1, Math.abs(gameState.money)/gameState.nature);
  return Math.round(p*100)/100;
}

/* =========================================================================
   FISCALIT√â / INT√âR√äTS / N√âGOCIATION
   ========================================================================= */
function maybeApplyTax(){
  if (!gameState.taxEnabled) return;
  if (gameState.clicks>0 && gameState.clicks % gameState.taxEveryClicks === 0){
    var tax = Math.ceil(Math.abs(gameState.money) * 0.20);
    if (tax>0){
      gameState.money -= tax;
      gameState.nature += 1;
      gameState.confort += 1;
      gameState.budgetEtat += tax;
      gameState._taxEverApplied = true;
      // R√©v√©ler budget au 1er pr√©l√®vement
      document.getElementById("jg-budget").style.display="flex";
      showMsg("üí∏ Fiscalit√© : -"+tax+"‚Ç¨ | +1 üå± | +1 ü§ñ (Budget √âtat +"+tax+"‚Ç¨)");
    }
  }
}

function applyOverdraftInterest(){
  if (gameState.money < 0){
    var due = Math.ceil(Math.abs(gameState.money) * gameState.creditRate);
    if (due>0){
      gameState.money -= due; // dette se creuse
      showMsg("üí£ Int√©r√™ts de d√©couvert : -"+due+"‚Ç¨ (taux "+Math.round(gameState.creditRate*100)+"%)");
    }
    // Affiche le bouton de n√©go si on est en n√©gatif ET palier atteint
    maybeShowNegotiationButton();
  } else {
    document.getElementById("nego-taux-btn").style.display="none";
  }
}

// N√©gociation : apparait aux multiples de 300 (300/600/900), co√ªt 2000‚Ç¨, ‚Äì1 pp, min 1%, max 3 fois.
// En EH, applique aussi la friction 4% (d√©bit suppl√©mentaire) ‚Äî on la d√©duit de l‚Äôargent.
function maybeShowNegotiationButton(){
  if (gameState.creditNegotiationsUsed >= 3) { document.getElementById("nego-taux-btn").style.display="none"; return; }
  var palier = Math.floor(gameState.clicks/300)*300;
  if (palier>=300 && palier !== gameState.lastNegotiationShownAt){
    document.getElementById("nego-taux-btn").style.display="inline-block";
    gameState.lastNegotiationShownAt = palier;
  }
}
function negociierDebit(total){
  // Applique la friction EH si activ√©e
  if (gameState.ehActivated){
    var t = Math.round(Math.abs(total) * gameState.ehTransactionTax);
    gameState.money -= t;
  }
}
function negocierTaux(){
  if (gameState.creditNegotiationsUsed >= 3) { showMsg("ü§ù Limite atteinte"); return; }
  saveState();
  var cost = 2000;
  gameState.money -= cost;
  negociierDebit(cost);
  if (gameState.creditRate > gameState.creditRateMin){
    gameState.creditRate = Math.max(gameState.creditRateMin, Math.round((gameState.creditRate - 0.01)*100)/100);
    gameState.creditNegotiationsUsed++;
    showMsg("ü§ù Taux n√©goci√© : "+Math.round(gameState.creditRate*100)+"% (co√ªt 2000‚Ç¨)");
  } else {
    showMsg("ü§ù Taux d√©j√† au minimum.");
  }
  updateUIValues();
}

/* =========================================================================
   EH ‚Äî √âconomie hom√©ostatique
   ========================================================================= */
function evolution(){
  if (gameState.ehActivated) return;
  saveState();
  gameState.ehActivated = true;
  gameState.taxEnabled = false; // OFF en EH
  // Coups EH √† z√©ro pour cycles (prime/fonte/bonus)
  gameState.ehPrimeClicks = 0;
  gameState.ehFonteClicks = 0;
  gameState.ehBonusClicks = 0;

  // Arr√™t des automatismes par d√©faut en EH
  clearAllIntervals();
  automatismsActive.ia=false; automatismsActive.trader=false;
  automatismsActive.confort=false; automatismsActive.centre=false;
  updateAutomatismControls();

  document.getElementById("eh-msg").style.display="block";
  document.getElementById("eh-msg").textContent = "üå± EH activ√©e : friction 4% sur transactions, dons/prime, fonte, bonus, investissements √©cologiques.";
  document.getElementById("investment-block").style.display="block";
  showMsg("Passage √† l'EH r√©ussi");
  updateUIValues();
}
function activateRescueEH(){
  saveState();
  gameState.nature += 100;
  gameState.confort += 50;
  if (gameState.confort > gameState.confortMaxAtteint) gameState.confortMaxAtteint = gameState.confort;
  evolution();
  showMsg("üå± Secours EH : +100 ressources, +50 confort");
}

function applyEHTax(amount){
  if (!gameState.ehActivated) return 0;
  var fee = Math.round(Math.abs(amount) * gameState.ehTransactionTax);
  if (fee>0) gameState.money -= fee;
  return fee;
}
function checkEHMechanics(){
  if (!gameState.ehActivated) return;

  // Micro-don tous les 10 clics (proportionnel aux ressources basses)
  gameState.ehPrimeClicks++;
  gameState.ehFonteClicks++;
  gameState.ehBonusClicks++;

  if (gameState.ehPrimeClicks >= gameState.ehDonationEvery){
    var d = computeDonByResources();
    gameState.money += d;
    gameState.budgetEtat += d;
    showMsg("üéÅ Don EH : +"+d+"‚Ç¨ (Budget √âtat +"+d+"‚Ç¨)");
    gameState.ehPrimeClicks = 0;
  }

  // Prime EH toutes les 50 actions ‚Äî fonction simple li√©e √† l‚Äô√©tat de nature
  if (gameState.clicks>0 && gameState.clicks % gameState.ehPrimeEvery === 0){
    var primePercent = (gameState.nature>=1500) ? (gameState.nature/1500)*100
                    : (gameState.nature>=300)  ? (10 + ((gameState.nature-300)/(1500-300))*90)
                    : (gameState.nature>0)     ? 10 : 0;
    var primeAmount = Math.round(Math.abs(gameState.money) * (primePercent/100));
    if (primeAmount>0){
      gameState.money += primeAmount;
      gameState.budgetEtat += primeAmount;
      showMsg("üå± Prime EH : +"+primeAmount+"‚Ç¨ (Budget √âtat +"+primeAmount+"‚Ç¨)");
    }
  }

  // Fonte mon√©taire ¬±4% vers 0 toutes les 10 actions
  if (gameState.ehFonteClicks >= gameState.ehFonteEvery){
    if (gameState.money !== 0){
      var f = Math.round(Math.abs(gameState.money) * 0.04);
      gameState.money += (gameState.money>0 ? -f : +f);
      showMsg("üí∏ Fonte mon√©taire EH : "+(gameState.money>0?"-":"+")+f+"‚Ç¨");
    }
    gameState.ehFonteClicks = 0;
  }

  // Bonus cycliques +1/+1 toutes les 10 actions
  if (gameState.ehBonusClicks >= gameState.ehBonusEvery){
    gameState.nature += 1;
    gameState.confort += 1;
    gameState.ehBonusClicks = 0;
  }

  processEcologicalInvestments();
}
function computeDonByResources(){
  // Don plus √©lev√© quand ressources sont basses (plancher 200, plafond 1200).
  var lack = Math.max(0, 3000 - gameState.nature);
  var don = Math.min(1200, Math.max(200, Math.floor(lack * 0.5)));
  return don;
}

/* =========================================================================
   INVESTISSEMENTS √âCOLOGIQUES (EH)
   ========================================================================= */
function updateInvestmentPreview(){
  var input = document.getElementById("investment-amount");
  var preview = document.getElementById("investment-preview");
  var amount = parseInt(input.value||"0");
  if (!amount || amount<=0){ preview.textContent=""; return; }

  var maxInvestment = (gameState.money>=0) ? gameState.money : Math.abs(gameState.money);
  if (amount > maxInvestment){
    preview.style.color = "#c00";
    preview.textContent = "‚ùå Montant trop √©lev√©. Max autoris√© : "+maxInvestment+" ‚Ç¨";
    return;
  }
  var moneyReturn = amount + Math.ceil(amount*0.02);
  // Formule inverse de pression (inspir√©e v1.26.1)
  var factor = 30;
  var bonus = (amount / (gameState.nature+1)) * (3000/(gameState.nature+1));
  var resourcesGain = Math.max(3, Math.round(bonus*factor));
  resourcesGain = Math.min(resourcesGain, 50);
  preview.style.color = "#2e7d32";
  preview.textContent = "üìà Retour dans 10 actions : +"+resourcesGain+" ressources, +"+moneyReturn+" ‚Ç¨";
}
function makeEcologicalInvestment(){
  var input = document.getElementById("investment-amount");
  var amount = parseInt(input.value||"0");
  if (!amount || amount<=0){ showMsg("Montant invalide"); return; }

  var maxInvestment = (gameState.money>=0) ? gameState.money : Math.abs(gameState.money);
  if (amount > maxInvestment){ showMsg("Montant trop √©lev√© (max "+maxInvestment+"‚Ç¨)"); return; }

  saveState();
  gameState.money -= amount;
  applyEHTax(amount);

  gameState.ecologicalInvestments.push({ amount:amount, remainingClicks:10, startClick:gameState.clicks });
  input.value=""; updateInvestmentPreview();
  updateInvestmentDisplay();
  showMsg("Investissement √©cologique : "+amount+"‚Ç¨ (retour dans 10 actions)");
  updateUIValues();
}
function investirEcologieFixe(){
  if (!gameState.ehActivated){ showMsg("EH requis"); return; }
  var cost = 200;
  saveState();
  gameState.money -= cost;
  applyEHTax(cost);
  gameState.nature += 30;
  gameState.clicks++;
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
  updateUIValues();
}
function processEcologicalInvestments(){
  if (gameState.ecologicalInvestments.length===0) return;
  var done=[];
  var totalRes=0, totalMoney=0;
  for (var i=gameState.ecologicalInvestments.length-1;i>=0;i--){
    var inv = gameState.ecologicalInvestments[i];
    inv.remainingClicks--;
    if (inv.remainingClicks<=0){
      var factor=30;
      var bonus = (inv.amount/(gameState.nature+1))*(3000/(gameState.nature+1));
      var resGain = Math.max(3, Math.round(bonus*factor));
      resGain = Math.min(resGain, 50);
      var moneyRet = inv.amount + Math.ceil(inv.amount*0.02);
      gameState.nature += resGain;
      gameState.money  += moneyRet;
      totalRes += resGain; totalMoney += moneyRet;
      done.push(i);
    }
  }
  done.forEach(idx=>gameState.ecologicalInvestments.splice(idx,1));
  if (totalRes>0) showMsg("Investissement : +"+totalRes+" ressources, +"+totalMoney+"‚Ç¨");
  updateInvestmentDisplay();
}
function updateInvestmentDisplay(){
  var el = document.getElementById("investment-list");
  if (gameState.ecologicalInvestments.length===0){ el.textContent="Aucun investissement en cours"; return; }
  var html = "En cours :<br/>";
  gameState.ecologicalInvestments.forEach(inv => { html += "‚Ä¢ "+inv.amount+"‚Ç¨ (dans "+inv.remainingClicks+" actions)<br/>"; });
  el.innerHTML = html;
}

/* =========================================================================
   ACTIONS DE BASE
   ========================================================================= */
function produce(){
  if (gameState.jeuBloque||gameState.optimumVictory) return;
  saveState();
  var cost = Math.max(2, gameState.baseProdCost - gameState.prodCostUpgradesBought); // 5‚Üí4‚Üí3‚Üí2
  if (gameState.nature >= cost){
    gameState.nature -= cost;
    var prod = Math.floor(gameState.productionMultiplier);
    gameState.production += prod;
    gameState.clicks++;

    randomEventsSystem.processClick(false);
    if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }

    showMsg("Production +"+prod+" (co√ªt "+cost+")");
    updateUIValues();
  } else {
    showMsg("Ressources insuffisantes (co√ªt "+cost+")");
  }
}
function sell(){
  if (gameState.jeuBloque||gameState.optimumVictory) return;
  if (gameState.production<=0){ showMsg("Aucun produit √† vendre"); return; }
  saveState();
  var price = priceNow();
  var qty = 1;
  var revenue = price*qty;
  gameState.money += revenue;
  gameState.production -= qty;
  gameState.clicks++;

  var fee = applyEHTax(revenue);
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }

  showMsg("Vendu : +"+revenue.toFixed(2)+"‚Ç¨"+(fee?(" (frais EH "+fee+"‚Ç¨)"):""));
  updateUIValues();
}
function acheterConfort(){
  if (gameState.jeuBloque||gameState.optimumVictory) return;
  var cost = 500; // ‚úÖ corrig√©
  saveState();
  gameState.money -= cost; // cr√©dit implicite : peut passer en n√©gatif
  applyEHTax(cost);
  gameState.confort += 1;
  gameState.clicks++;

  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }

  if (gameState.confort===1) document.getElementById("jg-confort").style.display="flex";
  showMsg("Confort +1");
  updateUIValues();
}

/* =========================================================================
   AM√âLIORATIONS / PALIERS (visibilit√© fixe + co√ªts cycliques √ó1.5)
   ========================================================================= */
var paliersConfig = {
  comfort:            { palierBase:120, cycle:0,    coutBase:500,  mult:1.0,  name:"Achat", emoji:"üõãÔ∏è" }, // label g√©r√© ailleurs
  ia:                 { palierBase:200, cycle:200,  coutBase:500,  mult:1.5,  name:"Engager une IA", emoji:"ü§ñ"},
  trader:             { palierBase:500, cycle:500,  coutBase:1000, mult:1.5,  name:"Trader automatique", emoji:"üí∞"},
  upgradeProd:        { palierBase:400, cycle:300,  coutBase:2000, mult:1.5,  name:"Am√©liorer la production", emoji:"üí†"}, // visible 400/700/1100
  confortAuto:        { palierBase:700, cycle:700,  coutBase:2000, mult:1.5,  name:"Achat auto confort", emoji:"üîÑ"},
  automatismsClics:   { palierBase:750, cycle:0,    coutBase:10000,mult:1.0,  name:"Automatismes = clics", emoji:"‚ö°"},
  priceIndicator:     { palierBase:1000,cycle:0,    coutBase:30000,mult:1.0,  name:"Indicateur de prix", emoji:"üìä"},
  centreCommercial:   { palierBase:1100,cycle:1100, coutBase:5000, mult:1.5,  name:"Centre commercial", emoji:"üè¨"}
};
function costFor(type){
  var cfg = paliersConfig[type]; if (!cfg) return 0;
  var n=0;
  if (type==='ia') n = gameState.nbAchatIA;
  else if (type==='trader') n = gameState.nbAchatTrader;
  else if (type==='confortAuto') n = gameState.nbAchatConfortAuto;
  else if (type==='upgradeProd') n = gameState.nbAchatUpgradeProd;
  else if (type==='centreCommercial') n = gameState.nbAchatCentre;
  var c = Math.round(cfg.coutBase * Math.pow(cfg.mult, n));
  return c;
}

function acheterIA(){
  var cost = costFor('ia');
  saveState();
  gameState.money -= cost;
  applyEHTax(cost);
  if (gameState.ia===0){ gameState.ia = 1; if(!gameState.ehActivated) startIAInterval(); }
  else { gameState.ia *= 2; if(!gameState.ehActivated){ clearInterval(intervals.ia); startIAInterval(); } }
  gameState.nbAchatIA++;
  gameState.clicks++;
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
  document.getElementById("jg-ia").style.display="flex";
  showMsg("IA √ó"+gameState.ia+" (tick 5s)");
  document.getElementById("ouvrier-btn").style.display="none";
  updateUIValues();
}
function acheterTrader(){
  var cost = costFor('trader');
  saveState();
  gameState.money -= cost; applyEHTax(cost);
  if (gameState.trader===0){ gameState.trader=1; if(!gameState.ehActivated) startTraderInterval(); }
  else { gameState.trader*=2; if(!gameState.ehActivated){ clearInterval(intervals.trader); startTraderInterval(); } }
  gameState.nbAchatTrader++; gameState.clicks++;
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
  document.getElementById("jg-trader").style.display="flex";
  showMsg("Trader √ó"+gameState.trader+" (tick 3s)");
  document.getElementById("trader-btn").style.display="none";
  updateUIValues();
}
function acheterConfortAuto(){
  var cost = costFor('confortAuto');
  saveState();
  gameState.money -= cost; applyEHTax(cost);
  if (gameState.confortAuto===0){ gameState.confortAuto=1; if(!gameState.ehActivated) startConfortAutoInterval(); }
  else { gameState.confortAuto*=2; if(!gameState.ehActivated){ clearInterval(intervals.confortAuto); startConfortAutoInterval(); } }
  gameState.nbAchatConfortAuto++; gameState.clicks++;
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
  document.getElementById("jg-achat-auto").style.display="flex";
  showMsg("Achat auto confort √ó"+gameState.confortAuto+" (tick 15s)");
  document.getElementById("comfort-auto-btn").style.display="none";
  updateUIValues();
}
function acheterCentre(){
  var cost = costFor('centreCommercial');
  saveState();
  gameState.money -= cost; applyEHTax(cost);
  if (gameState.centre===0){ gameState.centre=1; if(!gameState.ehActivated) startCentreInterval(); }
  else { gameState.centre*=2; if(!gameState.ehActivated){ clearInterval(intervals.centre); startCentreInterval(); } }
  gameState.nbAchatCentre++; gameState.clicks++;
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
  document.getElementById("jg-centre").style.display="flex";
  showMsg("Centre √ó"+gameState.centre+" (tick 15s, +10 confort/centre)");
  document.getElementById("centre-commercial-btn").style.display="none";
  updateUIValues();
}
function upgradeProd(){
  // Visible 400/700/1100 et max 3
  if (gameState.prodCostUpgradesBought>=3){ showMsg("Am√©liorations √©puis√©es"); return; }
  var cost = costFor('upgradeProd');
  saveState();
  gameState.money -= cost; applyEHTax(cost);
  gameState.prodCostUpgradesBought = Math.min(3, gameState.prodCostUpgradesBought+1);
  gameState.productionMultiplier *= 1.5;
  gameState.techLevel += 1;
  gameState.nbAchatUpgradeProd++;
  gameState.clicks++;
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
  document.getElementById("jg-tech").style.display="flex";
  showMsg("üí† Prod am√©lior√©e : co√ªt -1 & mult √ó1.5 (Niv."+gameState.techLevel+")");
  document.getElementById("upgrade-btn").style.display="none";
  updateUIValues();
}
function acheterAutomatismsClics(){
  var cost = 10000;
  saveState();
  gameState.money -= cost; applyEHTax(cost);
  gameState.automatismsGenerateClicks = true;
  gameState.clicks++;
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
  showMsg("‚ö° Les actions auto comptent dans les clics");
  document.getElementById("automatisms-btn").style.display="none";
  updateUIValues();
}
function acheterIndicateur(){
  var cost = 30000;
  saveState();
  gameState.money -= cost; applyEHTax(cost);
  gameState.priceIndicatorActive = true;
  document.getElementById("price-indicator").style.display="block";
  gameState.clicks++;
  randomEventsSystem.processClick(false);
  if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
  showMsg("üìä Indicateur de prix activ√©");
  updateUIValues();
}

/* =========================================================================
   AUTOMATISMES (5s / 3s / 15s) + cap 1 √©v√©nement max par tick auto
   ========================================================================= */
function startIAInterval(){
  if (intervals.ia) clearInterval(intervals.ia);
  intervals.ia = setInterval(function(){
    if (gameState.jeuBloque || gameState.ehActivated || !automatismsActive.ia) return;
    var unitCost = Math.max(2, gameState.baseProdCost - gameState.prodCostUpgradesBought); // upgrades s‚Äôappliquent
    // co√ªt explicite 5/IA minimum pour rester exigeant
    unitCost = Math.max(unitCost, 5);
    var total = unitCost * gameState.ia;
    if (gameState.nature >= total){
      gameState.nature -= total;
      var add = Math.floor(gameState.ia * gameState.productionMultiplier);
      gameState.production += add;
      if (gameState.automatismsGenerateClicks){
        // 1 seul tirage √©ventuel par tick auto
        gameState.clicks += add;
        randomEventsSystem.processAutoTick(); // ‚úÖ AU PLUS UN √©v√©nement pour ce tick
        if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
      }
      updateUIValues();
    }
  }, 5000);
  updateAutomatismControls();
}
function startTraderInterval(){
  if (intervals.trader) clearInterval(intervals.trader);
  intervals.trader = setInterval(function(){
    if (gameState.jeuBloque || gameState.ehActivated || !automatismsActive.trader) return;
    var can = Math.min(gameState.production, gameState.trader);
    if (can>0){
      var p = priceNow();
      var rev = p*can;
      gameState.production -= can;
      gameState.money += rev;
      if (gameState.automatismsGenerateClicks){
        gameState.clicks += can;
        randomEventsSystem.processAutoTick();
        if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
      }
      updateUIValues();
    }
  }, 3000);
  updateAutomatismControls();
}
function startConfortAutoInterval(){
  if (intervals.confortAuto) clearInterval(intervals.confortAuto);
  intervals.confortAuto = setInterval(function(){
    if (gameState.jeuBloque || gameState.ehActivated || !automatismsActive.confort) return;
    var unit = gameState.confortAuto;
    if (unit>0){
      var cost = 100 * unit;
      gameState.money -= cost; // peut passer n√©gatif
      gameState.confort += unit;
      if (gameState.automatismsGenerateClicks){
        gameState.clicks += unit;
        randomEventsSystem.processAutoTick();
        if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
      }
      updateUIValues();
    }
  }, 15000);
  updateAutomatismControls();
}
function startCentreInterval(){
  if (intervals.centre) clearInterval(intervals.centre);
  intervals.centre = setInterval(function(){
    if (gameState.jeuBloque || gameState.ehActivated || !automatismsActive.centre) return;
    var achat = 10 * gameState.centre;
    if (achat>0){
      var cost = 100 * achat;
      gameState.money -= cost;
      gameState.confort += achat;
      if (gameState.automatismsGenerateClicks){
        gameState.clicks += achat;
        randomEventsSystem.processAutoTick();
        if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }
      }
      updateUIValues();
    }
  }, 15000);
  updateAutomatismControls();
}
function toggleAutomatism(type){
  if (gameState.ehActivated) return;
  if (type==='ia' && gameState.ia===0) return;
  if (type==='trader' && gameState.trader===0) return;
  if (type==='confort' && gameState.confortAuto===0) return;
  if (type==='centre' && gameState.centre===0) return;
  automatismsActive[type] = !automatismsActive[type];
  if (type==='ia'){ if (automatismsActive.ia) startIAInterval(); else { clearInterval(intervals.ia); intervals.ia=null; } }
  if (type==='trader'){ if (automatismsActive.trader) startTraderInterval(); else { clearInterval(intervals.trader); intervals.trader=null; } }
  if (type==='confort'){ if (automatismsActive.confort) startConfortAutoInterval(); else { clearInterval(intervals.confortAuto); intervals.confortAuto=null; } }
  if (type==='centre'){ if (automatismsActive.centre) startCentreInterval(); else { clearInterval(intervals.centre); intervals.centre=null; } }
  showMsg("Automatisme "+type+" : "+(automatismsActive[type]?"ON":"OFF"));
}

/* =========================================================================
   PALIERS (visibilit√©) ‚Äî selon ton cahier des charges
   ========================================================================= */
function checkAndUnlockPaliers(){
  // Achat confort (affichage) : ‚â•120 clics
  if (gameState.clicks>=paliersConfig.comfort.palierBase && !gameState.paliersDebloque.comfort){
    gameState.paliersDebloque.comfort=true;
    document.getElementById("comfort-btn").style.display="block";
  }

  if (!gameState.ehActivated){
    // IA : r√©apparition tous les 200 clics
    if (gameState.clicks>0 && gameState.clicks % 200 === 0){
      document.getElementById("ouvrier-btn").style.display="block";
    }
    // Trader : ‚â•500
    if (gameState.clicks>=paliersConfig.trader.palierBase) document.getElementById("trader-btn").style.display="block";
    // Upgrade prod : 400/700/1100
    var ups = gameState.prodCostUpgradesBought;
    var need = [400,700,1100][ups];
    if (need && gameState.clicks>=need) document.getElementById("upgrade-btn").style.display="block";
    // Auto confort : ‚â•700
    if (gameState.clicks>=paliersConfig.confortAuto.palierBase) document.getElementById("comfort-auto-btn").style.display="block";
    // Automatismes=clics : ‚â•750
    if (gameState.clicks>=paliersConfig.automatismsClics.palierBase && !gameState.automatismsGenerateClicks) document.getElementById("automatisms-btn").style.display="block";
    // Indicateur prix : ‚â•1000
    if (gameState.clicks>=paliersConfig.priceIndicator.palierBase && !gameState.priceIndicatorActive) document.getElementById("price-indicator-btn").style.display="block";
    // Centre : ‚â•1100
    if (gameState.clicks>=paliersConfig.centreCommercial.palierBase) document.getElementById("centre-commercial-btn").style.display="block";
  }

  // Proposer EH si ressources ‚â§100
  if (gameState.nature<=100 && !gameState.ehActivated) document.getElementById("evolution-btn").style.display="block";
}

/* =========================================================================
   JAUGES / ALERTES / OPTIMUM
   ========================================================================= */
function updateUIValues(){
  // Valeurs
  document.getElementById("nature").textContent = Math.floor(gameState.nature);
  document.getElementById("confort").textContent = Math.floor(gameState.confort);
  document.getElementById("production").textContent = Math.floor(gameState.production);
  document.getElementById("money").textContent = Math.floor(gameState.money);
  document.getElementById("clicks").textContent = gameState.clicks;

  if (gameState.confort > gameState.confortMaxAtteint) gameState.confortMaxAtteint = gameState.confort;

  // Jauges
  var maxN = Math.max(3000, gameState.nature*1.2);
  var maxC = Math.max(100, gameState.confort*1.2);
  var maxM = Math.max(10000, Math.abs(gameState.money)*1.2);
  document.getElementById("jauge-nature").style.width = Math.min(100,(gameState.nature/maxN)*100)+"%";
  document.getElementById("jnature").textContent = Math.floor(gameState.nature);
  if (gameState.confort>0){
    document.getElementById("jg-confort").style.display="flex";
    document.getElementById("jauge-confort").style.width = Math.min(100,(gameState.confort/maxC)*100)+"%";
    document.getElementById("jconfort").textContent = Math.floor(gameState.confort);
  }
  document.getElementById("jauge-money").style.width = Math.min(100,(Math.abs(gameState.money)/maxM)*100)+"%";
  document.getElementById("jmoney").textContent = Math.floor(gameState.money)+"‚Ç¨";

  if (gameState.budgetEtat>0){
    document.getElementById("jg-budget").style.display="flex";
    var maxB = Math.max(1000, gameState.budgetEtat*1.3);
    document.getElementById("jauge-budget").style.width = Math.min(100,(gameState.budgetEtat/maxB)*100)+"%";
    document.getElementById("jbudget").textContent = Math.floor(gameState.budgetEtat)+"‚Ç¨";
  }

  if (gameState.confortAuto>0){
    document.getElementById("jg-achat-auto").style.display="flex";
    document.getElementById("jauge-achat-auto").style.width = Math.min(100,(gameState.confortAuto/ (gameState.confortAuto*1.2 || 1))*100)+"%";
    document.getElementById("jachat-auto").textContent = "√ó"+gameState.confortAuto;
  }
  if (gameState.ia>0){
    document.getElementById("jg-ia").style.display="flex";
    document.getElementById("jauge-ia").style.width = Math.min(100,(gameState.ia/(gameState.ia*1.2 || 1))*100)+"%";
    document.getElementById("jia").textContent = "√ó"+gameState.ia;
  }
  if (gameState.trader>0){
    document.getElementById("jg-trader").style.display="flex";
    document.getElementById("jauge-trader").style.width = Math.min(100,(gameState.trader/(gameState.trader*1.2 || 1))*100)+"%";
    document.getElementById("jtrader").textContent = "√ó"+gameState.trader;
  }
  if (gameState.centre>0){
    document.getElementById("jg-centre").style.display="flex";
    document.getElementById("jauge-centre").style.width = Math.min(100,(gameState.centre/(gameState.centre*1.2 || 1))*100)+"%";
    document.getElementById("jcentre").textContent = "√ó"+gameState.centre;
  }
  if (gameState.techLevel>0){
    document.getElementById("jg-tech").style.display="flex";
    document.getElementById("jauge-tech").style.width = Math.min(100,(gameState.techLevel/(gameState.techLevel*1.2 || 1))*100)+"%";
    document.getElementById("jtech").textContent = "Niv."+gameState.techLevel+" (√ó"+gameState.productionMultiplier.toFixed(1)+")";
  }

  // Alertes
  var crise = document.getElementById("alert-crise");
  if (gameState.nature<=100 && !gameState.ehActivated){
    crise.style.display="block";
    crise.className="message-box msg-red";
    crise.textContent="‚ö†Ô∏è Ressources critiques (‚â§100). Recommand√© : passer √† l'EH.";
    document.getElementById("evolution-btn").style.display="block";
  } else if (gameState.nature<300 && !gameState.ehActivated){
    crise.style.display="block";
    crise.className="message-box msg-orange";
    crise.textContent="Alerte ressources : sous 300, attention √† l'habitabilit√© !";
  } else {
    crise.style.display="none";
  }

  var social = document.getElementById("social-crise");
  if (gameState.confort<=5 && gameState.confortMaxAtteint>5 && !gameState.gameOver){
    social.style.display="block";
    social.textContent="‚ö†Ô∏è Risque de crise sociale majeure";
  } else { social.style.display="none"; }

  // Game over conditions (clamp pour √©viter n√©gatifs ind√©sir√©s)
  gameState.nature = Math.max(0, gameState.nature);
  gameState.confort = Math.max(0, gameState.confort);
  if (!gameState.gameOver && !gameState.ehActivated && !gameState.optimumVictory){
    if (gameState.nature<=0) return triggerGameOver('resources');
    if (gameState.confort<=0 && gameState.confortMaxAtteint>0) return triggerGameOver('confort');
  }

  // Indicateur de prix
  if (gameState.priceIndicatorActive){
    document.getElementById("price-indicator").style.display="block";
    document.getElementById("current-price").textContent = priceNow().toFixed(2)+"‚Ç¨";
  }

  // Zone d'√©quilibre ‚Äî n‚Äôappara√Æt que quand ressources ‚â§ 1000
  if (gameState.nature<=1000) document.getElementById("optimum-zone").style.display="block";
  updateOptimum();
  checkAndUnlockPaliers();
  updateAutomatismControls();
  randomEventsSystem.refreshTempUI();
}
function updateAutomatismControls(){
  var any = (gameState.ia>0||gameState.trader>0||gameState.confortAuto>0||gameState.centre>0);
  document.getElementById("automatisms-controls").style.display = (any && !gameState.ehActivated) ? "flex":"none";
  setBtn("control-ia", gameState.ia>0, !!intervals.ia, "ü§ñ IA");
  setBtn("control-trader", gameState.trader>0, !!intervals.trader, "üí∞ Trader");
  setBtn("control-confort", gameState.confortAuto>0, !!intervals.confortAuto, "üõãÔ∏è Confort");
  setBtn("control-centre", gameState.centre>0, !!intervals.centre, "üè¨ Centre");
}
function setBtn(id, available, on, label){
  var b = document.getElementById(id);
  if (!available){ b.className="control-btn disabled"; b.textContent=label+": OFF"; return; }
  b.className = "control-btn " + (on?"active":"inactive");
  b.textContent = label + ": " + (on?"ON":"OFF");
}
function updateOptimum(){
  if (gameState.optimumVictory) return;
  var inZone =
    gameState.nature>=gameState.optimumRanges.nature[0] && gameState.nature<=gameState.optimumRanges.nature[1] &&
    gameState.confort>=gameState.optimumRanges.confort[0] && gameState.confort<=gameState.optimumRanges.confort[1] &&
    gameState.money>=gameState.optimumRanges.money[0] && gameState.money<=gameState.optimumRanges.money[1];
  if (inZone) gameState.optimumStreak++; else gameState.optimumStreak=0;
  var pct = Math.min(100, (gameState.optimumStreak/50)*100);
  document.getElementById("optimum-progress").style.width = pct+"%";
  document.getElementById("optimum-text").textContent = (inZone?("‚úÖ Dans l‚Äôoptimum ("+gameState.optimumStreak+"/50)"):"‚ùå Ajustez");
  if (gameState.optimumStreak>=50){
    gameState.optimumVictory = true;
    gameState.jeuBloque = true;
    clearAllIntervals();
    document.getElementById("optimum-victory").style.display="block";
  }
}
function triggerGameOver(cause){
  gameState.gameOver = true; gameState.jeuBloque = true; clearAllIntervals();
  document.getElementById("rescue-eh-btn").style.display="none";
  if (cause==='resources'){ var b=document.getElementById("game-over-resources"); b.style.display="block"; b.textContent="üåç La plan√®te n'est plus habitable : Perdu !"; }
  if (cause==='confort'){ var c=document.getElementById("game-over-confort"); c.style.display="block"; c.textContent="‚öîÔ∏è R√©volution de la soci√©t√© : Perdu !"; }
  setTimeout(()=>{ document.getElementById("rescue-eh-btn").style.display="block"; }, 3000);
}
function restartGame(){
  clearAllIntervals();
  // Reset complet
  var keepCheat = cheatModeUnlocked;
  gameState = {
    nature:3000, confort:0, production:0, money:1000, budgetEtat:0, monnaieActive:true,
    clicks:0, jeuBloque:false, gameOver:false, confortMaxAtteint:0,
    optimumStreak:0, optimumVictory:false,
    optimumRanges: { nature:[1800,2600], confort:[10,35], money:[400,1200] },
    taxEnabled:true, taxEveryClicks:20, _taxEverApplied:false,
    creditRate:0.05, creditRateMin:0.01, creditNegotiationsUsed:0, lastNegotiationShownAt:0,
    ehActivated:false, ehAutoTriggerAt:50, ehDonationEvery:10, ehPrimeEvery:50, ehFonteEvery:10, ehBonusEvery:10, ehTransactionTax:0.04,
    ehPrimeClicks:0, ehFonteClicks:0, ehBonusClicks:0,
    ecologicalInvestments:[],
    ia:0, trader:0, confortAuto:0, centre:0, automatismsGenerateClicks:false,
    productionMultiplier:1.0, techLevel:0, baseProdCost:5, prodCostUpgradesBought:0,
    paliersDebloque:{comfort:false,ia:false,trader:false,upgradeProd:false,confortAuto:false,automatismsClics:false,priceIndicator:false,centreCommercial:false},
    nbAchatIA:0, nbAchatTrader:0, nbAchatConfortAuto:0, nbAchatUpgradeProd:0, nbAchatCentre:0,
    priceIndicatorActive:false
  };
  automatismsActive = { ia:true, trader:true, confort:true, centre:true };
  randomEventsSystem.reset();
  cheatModeUnlocked = keepCheat;
  // UI
  document.getElementById("optimum-victory").style.display="none";
  document.getElementById("investment-block").style.display="none";
  document.getElementById("price-indicator").style.display="none";
  document.getElementById("evolution-btn").style.display="none";
  document.getElementById("rescue-eh-btn").style.display="none";
  document.getElementById("game-over-resources").style.display="none";
  document.getElementById("game-over-confort").style.display="none";
  document.getElementById("jg-budget").style.display="none";
  document.getElementById("comfort-btn").style.display="none";
  document.getElementById("ouvrier-btn").style.display="none";
  document.getElementById("trader-btn").style.display="none";
  document.getElementById("comfort-auto-btn").style.display="none";
  document.getElementById("upgrade-btn").style.display="none";
  document.getElementById("automatisms-btn").style.display="none";
  document.getElementById("centre-commercial-btn").style.display="none";
  document.getElementById("price-indicator-btn").style.display="none";
  updateUIValues();
  showMsg("üîÑ Nouvelle partie");
}

/* =========================================================================
   √âV√âNEMENTS AL√âATOIRES ‚Äî ROBUSTESSE & EFFETS TEMPORAIRES
   - Anti-r√©p√©tition: pas 2 fois de suite, ni dans les 10 derniers
   - 1 seul √©v√©nement max par tick automatique
   - Effets temporaires appliqu√©s partout, avec UI + notifications √† l‚Äôactivation et √† la fin
   - Clamp des jauges pour √©viter n√©gatifs
   ========================================================================= */
var randomEventsSystem = {
  enabled: true,
  nextIn: 0,                 // compte √† rebours d‚Äôactions
  minGap: 20, maxGap: 60,    // tirage al√©atoire
  recent: [], maxRecent: 10, // anti-r√©p√©tition courte
  activeTemp: [],            // {type, value, remain, label}
  autoTickGuard:false,       // pour limiter √† 1 tirage par tick auto

  reset(){ this.recent=[]; this.activeTemp=[]; this.schedule(); this.refreshTempUI(); this.autoTickGuard=false; hideEvent(); },
  init(){ this.schedule(); this.refreshTempUI(); },
  schedule(){ this.nextIn = Math.floor(Math.random()*(this.maxGap-this.minGap+1)) + this.minGap; },

  // Actions manuelles (produce/sell/acheter) ‚Üí peuvent d√©clencher un √©v√©nement
  processClick(){
    if (!this.enabled) return;
    if (--this.nextIn<=0){ this.trigger(); this.schedule(); }
    this.processTemp(); // d√©cr√©mente dur√©es
  },
  // Actions automatiques ‚Üí AU PLUS UN √©v√©nement par tick intervalle
  processAutoTick(){
    if (!this.enabled) return;
    if (this.autoTickGuard) { this.processTemp(); return; }
    this.autoTickGuard = true;
    if (--this.nextIn<=0){ this.trigger(); this.schedule(); }
    this.processTemp();
    // lib√®re le garde apr√®s un court d√©lai (avant prochain tick)
    setTimeout(()=>{ this.autoTickGuard=false; }, 0);
  },

  trigger(){
    var pool = this.events.filter((e,i)=> this.recent.indexOf(i)===-1 );
    if (pool.length===0){ pool=this.events; this.recent=[]; }
    var ev = pool[Math.floor(Math.random()*pool.length)];
    var idx = this.events.indexOf(ev);
    this.recent.push(idx); if (this.recent.length>this.maxRecent) this.recent.shift();
    this.run(ev);
  },
  run(ev){
    saveState();
    // Applique l‚Äôeffet; toute √©criture sur nature/confort clamp√©e ensuite
    ev.effect(gameState, this);
    // Clamp s√©curit√© (√©viter n√©gatifs non souhait√©s)
    gameState.nature = Math.max(0, gameState.nature);
    gameState.confort = Math.max(0, gameState.confort);

    // UI vignette 5s
    showEvent("üåø "+ev.name+" ‚Äî "+ev.text, ev.display||"");
    setTimeout(hideEvent, 5000);

    setTimeout(()=>updateUIValues(), 0);
  },

  addTemp(type, value, duration, label){
    // Applique un buff/debuff temporaire (ex: prodMult +0.25, prix +10%, regen, etc.)
    this.activeTemp.push({type,value,remain:duration,label});
    this.refreshTempUI();
    showMsg("‚è±Ô∏è Effet temporaire : "+label+" ("+duration+" actions)");
  },
  mod(type){ // somme des modifs par type (ex: "prodMult", "priceAdd", "prodCostDelta")
    return this.activeTemp.reduce((s,e)=> s + (e.type===type ? e.value : 0), 0);
  },
  processTemp(){
    var ended=[];
    for (var i=this.activeTemp.length-1;i>=0;i--){
      this.activeTemp[i].remain--;
      if (this.activeTemp[i].remain<=0){ ended.push(this.activeTemp[i]); this.activeTemp.splice(i,1); }
    }
    ended.forEach(e => showMsg("‚åõ Fin de l‚Äôeffet : "+e.label));
    this.refreshTempUI();
  },
  refreshTempUI(){
    var box = document.getElementById("temp-list");
    if (!box) return;
    if (this.activeTemp.length===0){ box.innerHTML = '<span style="color:#777;">Aucun</span>'; return; }
    box.innerHTML = "";
    this.activeTemp.forEach(e=>{
      var pill = document.createElement("div");
      pill.className="temp-pill";
      pill.textContent = e.label+" ‚Ä¢ "+e.remain;
      box.appendChild(pill);
    });
  },
  getFullState(){ return {enabled:this.enabled, nextIn:this.nextIn, recent:[...this.recent], activeTemp:JSON.parse(JSON.stringify(this.activeTemp))}; },
  restoreFullState(st){ this.enabled=st.enabled; this.nextIn=st.nextIn; this.recent=[...st.recent]; this.activeTemp=JSON.parse(JSON.stringify(st.activeTemp)); this.refreshTempUI(); },

  /* ====== D√âFINIR LA LISTE DES √âV√âNEMENTS ICI ======
     ‚ûú Remplace/compl√®te par tes 160 √©v√©nements (id:1..160).
     Chaque √©v√©nement : { id, name, text, display, effect(gs,sys){...} }
     Tu peux utiliser sys.addTemp(type,value,duration,label) pour effets temporaires, et sys.mod(type) pour les lire dans les actions :
       - "prodMult" (¬± addition au multiplicateur de production)
       - "priceAdd" (¬± addition sur prix en ‚Ç¨)
       - "prodCostDelta" (¬± change le co√ªt unitaire de prod)
       - "regen" (¬± fraction de r√©g√©n√©ration des ressources par action)
     Ces mods sont pris en compte dans produce()/priceNow() ci‚Äëdessous via des hooks.
  */
  events: [
    { id:1, name:"Vague verte", text:"Innovation propre", display:"+25% production (10 actions)", effect:(gs,sys)=>{ sys.addTemp("prodMult", 0.25, 10, "+25% prod"); } },
    { id:2, name:"Inflation √©clair", text:"Co√ªts en hausse", display:"+1‚Ç¨ sur le prix (8 actions)", effect:(gs,sys)=>{ sys.addTemp("priceAdd", 1.00, 8, "+1‚Ç¨ prix"); } },
    { id:3, name:"Guerre de ressources", text:"Extraction difficile", display:"+2 co√ªt prod (12 actions)", effect:(gs,sys)=>{ sys.addTemp("prodCostDelta", +2, 12, "+2 co√ªt prod"); } },
    { id:4, name:"Pluie salvatrice", text:"R√©g√©n√©ration naturelle", display:"+5% regen ressources (15 actions)", effect:(gs,sys)=>{ sys.addTemp("regen", 0.05, 15, "+5% regen"); } },
    { id:5, name:"Temp√™te", text:"D√©g√¢ts aux stocks", display:"-60 ressources", effect:(gs)=>{ gs.nature = clamp(gs.nature - 60, 0); } },
    { id:6, name:"Stress social", text:"Tensions", display:"-1 confort", effect:(gs)=>{ gs.confort = clamp(gs.confort - 1, 0); } },
    { id:7, name:"Loterie verte", text:"Subvention surprise", display:"+70‚Ç¨ & +30 ressources", effect:(gs)=>{ gs.money += 70; gs.nature += 30; } },
    { id:8, name:"Bug IA", text:"Effet neutralis√©", display:"IA -1 si possible", effect:(gs)=>{ if (gs.ia>0) gs.ia--; } },
    { id:9, name:"Coup de froid", text:"Consommation baisse", display:"-1 confort", effect:(gs)=>{ gs.confort = clamp(gs.confort - 1, 0); } },
    { id:10,name:"March√© euphorique", text:"Prix dop√©s", display:"+2‚Ç¨ prix (6 actions)", effect:(gs,sys)=>{ sys.addTemp("priceAdd", 2, 6, "+2‚Ç¨ prix"); } }
    // üëâ Colle ici ta liste 11..160.
  ]
};

// Aides UI √©v√©nements
function showEvent(t, fx){ var box=document.getElementById("event-box"); if(!box) return; document.getElementById("event-text").textContent=t; document.getElementById("event-effects").textContent=fx||""; box.style.display="block"; }
function hideEvent(){ var box=document.getElementById("event-box"); if(box) box.style.display="none"; }

/* Hooks de mods temporaires dans la prod, le co√ªt, le prix et la r√©g√©n√©ration */
function currentProdMultiplier(){
  var extra = randomEventsSystem.mod("prodMult") || 0;
  return Math.max(0, gameState.productionMultiplier * (1 + extra));
}
function currentProdUnitCost(){
  var base = Math.max(2, gameState.baseProdCost - gameState.prodCostUpgradesBought);
  var delta = randomEventsSystem.mod("prodCostDelta") || 0;
  return Math.max(1, base + delta);
}
function priceNow(){
  if (gameState.nature<=0) return 1;
  var p = Math.max(1, Math.abs(gameState.money)/gameState.nature);
  p += (randomEventsSystem.mod("priceAdd") || 0);
  return Math.round(p*100)/100;
}
// R√©g√©n√©ration passive √† chaque action (si effet actif)
function maybeApplyRegen(){
  var r = randomEventsSystem.mod("regen") || 0;
  if (r>0){ gameState.nature += Math.max(0, Math.round(gameState.nature * r)); }
}

/* =========================================================================
   TRICHE
   ========================================================================= */
function toggleCheatMode(){
  cheatModeUnlocked = !cheatModeUnlocked;
  document.getElementById("cheat-buttons").style.display = cheatModeUnlocked ? "flex":"none";
  showMsg(cheatModeUnlocked?"Outils de test ON":"Outils de test OFF");
}
function addMoney(){ if(!cheatModeUnlocked) return; saveState(); gameState.money+=1000; updateUIValues(); }
function addNature(){ if(!cheatModeUnlocked) return; saveState(); gameState.nature+=100; updateUIValues(); }
function addClicks(){ if(!cheatModeUnlocked) return; saveState(); gameState.clicks+=50; updateUIValues(); }
function forceActivateEH(){ if(!cheatModeUnlocked) return; saveState(); evolution(); updateUIValues(); }
function toggleEvents(){ if(!cheatModeUnlocked) return; randomEventsSystem.enabled=!randomEventsSystem.enabled; showMsg("üé≤ √âv√©nements "+(randomEventsSystem.enabled?"ON":"OFF")); }

/* =========================================================================
   INITIALISATION
   ========================================================================= */
function initializeGame(){
  randomEventsSystem.init();

  // Messages d‚Äôintro
  setTimeout(()=>showMsg("üåç Vos choix √©conomiques influencent l‚Äôhabitabilit√© de la plan√®te."), 1200);
  setTimeout(()=>showMsg("üõ†Ô∏è Produisez, vendez, achetez ‚Äî et tenez la zone d‚Äô√©quilibre."), 4200);

  // D√©part UI
  updateUIValues();
}
initializeGame();

/* =========================================================================
   Red√©finition de produce() pour utiliser les hooks de mods temporaires
   ========================================================================= */
(function patchProduce(){
  const _produce = produce;
  window.produce = function(){
    if (gameState.jeuBloque||gameState.optimumVictory) return;
    saveState();

    // co√ªt unitaire sous effets temporaires
    var cost = currentProdUnitCost();

    if (gameState.nature >= cost){
      gameState.nature -= cost;
      // production avec multiplicateur temporaire
      var prod = Math.max(1, Math.floor(currentProdMultiplier()));
      gameState.production += prod;
      gameState.clicks++;

      // r√©g√©n√©ration √©ventuelle
      maybeApplyRegen();

      randomEventsSystem.processClick(false);
      if (gameState.ehActivated) checkEHMechanics(); else { maybeApplyTax(); applyOverdraftInterest(); }

      showMsg("Production +"+prod+" (co√ªt "+cost+")");
      updateUIValues();
    } else {
      showMsg("Ressources insuffisantes (co√ªt "+cost+")");
    }
  };
})();
</script>
</body>
</html>
