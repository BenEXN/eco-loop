<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Looop v1.30 — Fiscalité/Crédit/EH + Événements (160)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { background:#f3f3f3; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; margin:0; padding:0; color:#111;}
    h1 { text-align:center; margin:24px 0 8px; }
    .container { display:flex; justify-content:center; align-items:flex-start; gap:24px; margin:0 auto 18px; max-width:980px; padding:0 10px;}
    .category { background:#fff; border-radius:18px; box-shadow:0 4px 24px #0001; flex:1; padding:26px 16px 16px; min-width:260px; max-width:330px; }
    .cat-title { font-size:1.2em; font-weight:700; margin-bottom:12px; letter-spacing:.5px;}
    .stock { font-size:1.05em; margin-bottom:8px; }
    .products-box { background:#f7f7fa; border:2px solid #dde1eb; border-radius:10px; color:#333; margin:10px 0; padding:10px 22px; font-size:1.05em; font-weight:700; text-align:center; box-shadow:0 1px 4px #ddd5;}
    .message-box { border-radius:10px; margin:8px 0 12px; padding:10px 12px; font-weight:700; font-size:1.02em; box-shadow:0 1px 4px #0002; text-align:center;}
    .msg-orange{ background:#fff2e6; color:#cc5500; border:2px solid #ff8533;}
    .msg-red{ background:#ffe6e6; color:#c00; border:2px solid #ff6666;}
    .msg-blue{ background:#e6f3ff; color:#0066cc; border:2px solid #4da6ff;}
    .msg-green{ background:#e6ffe6; color:#066; border:2px solid #66cc66;}
    .msg-gold{ background:#fff9c4; color:#8a6d00; border:2px solid #f4d03f;}
    .btn-row { margin-top:14px; display:flex; flex-direction:column; align-items:center; gap:8px;}
    button{ font-size:1em; padding:10px 16px; border:none; border-radius:12px; background:#ededed; color:#111; cursor:pointer;}
    .btn-credit{ background:#ff6b35; color:#fff; font-weight:700;}
    .btn-evo{ background:#4CAF50; color:#fff; font-weight:700;}
    .btn-yellow{ background:#FFD600; color:#222; font-weight:700;}
    .btn-annuler{ background:#999; color:#fff;}
    .btn-invest{ background:#2e7d32; color:#fff; font-weight:700;}
    #clics-container{ text-align:center; margin:16px 0; font-weight:700;}
    .bar { background:#eee; border-radius:8px; height:13px; flex:1; overflow:hidden;}
    .fill { height:100%; border-radius:8px; transition:width .2s;}
    #jauge-nature{ background:#86e08e;}
    #jauge-confort{ background:#86b6ea;}
    #jauge-money{ background:#ffb3b3;}
    #jauge-budget{ background:#ff9800;}
    .jrow{ max-width:640px; margin:0 auto 6px; display:flex; align-items:center; gap:8px;}
    .jlabel{ min-width:92px; font-size:.95em; color:#666; text-align:right;}
    .jval{ min-width:70px; text-align:right; font-size:.95em; color:#333;}
    .automatisms-controls{ margin:14px auto; max-width:980px; display:none; justify-content:center; gap:10px; flex-wrap:wrap; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px #0001;}
    .control-btn{ font-size:.9em; padding:8px 12px; border-radius:8px; border:none; min-width:90px; }
    .active{ background:#4CAF50; color:#fff; } .inactive{ background:#f44336; color:#fff; } .disabled{ background:#ccc; color:#777;}
    .events-zone{ margin:12px auto; max-width:980px; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px #0001;}
    .event-notification{ background:#f0f8f0; border:2px solid #81c784; border-radius:10px; padding:10px; font-weight:700; color:#2e7d32; display:none;}
    .optimum-zone{ margin:12px auto; max-width:980px; padding:12px; background:#fff; border-radius:12px; box-shadow:0 2px 12px #0001; text-align:center;}
    .optimum-progress-bar{ background:#eee; height:18px; border-radius:20px; max-width:400px; margin:10px auto; overflow:hidden;}
    .optimum-progress-fill{ height:100%; background:linear-gradient(90deg,#4CAF50,#81C784); width:0%;}
    #triche-sep{ border:none; border-top:3px solid #222; margin:22px auto 10px; width:94vw; max-width:980px;}
    #triche-label{ max-width:980px; margin:0 auto 10px; color:#555;}
    .debug-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px auto 24px;}
    @media (max-width:720px){
      .container{ flex-direction:column; gap:12px;}
      .category{ max-width:unset;}
      .jrow{ max-width:calc(100vw - 22px);}
    }
  </style>
</head>
<body>
  <h1>🌍 Looop <span style="font-size:.7em;color:#777;">v1.30 — EH non figée • Crédit • Fiscalité • 160 événements</span></h1>

  <!-- Contrôles des automatismes -->
  <div class="automatisms-controls" id="automatisms-controls">
    <button id="control-ia" class="control-btn disabled" onclick="toggleAutomatism('ia')">🤖 IA: OFF</button>
    <button id="control-trader" class="control-btn disabled" onclick="toggleAutomatism('trader')">💰 Trader: OFF</button>
    <button id="control-confort" class="control-btn disabled" onclick="toggleAutomatism('confort')">🛋️ Confort: OFF</button>
    <button id="control-centre" class="control-btn disabled" onclick="toggleAutomatism('centre')">🏬 Centre: OFF</button>
  </div>

  <!-- Zone optimum (conservée) -->
  <div class="optimum-zone">
    <div style="font-weight:700;">🎯 Zone d'équilibre</div>
    <div class="optimum-progress-bar"><div class="optimum-progress-fill" id="optimum-progress"></div></div>
    <div id="optimum-text" style="font-size:.95em;color:#555;">Objectif indicatif : garder l'équilibre (info)</div>
  </div>

  <!-- Zone événements -->
  <div class="events-zone">
    <div style="font-weight:700;margin-bottom:6px;">🌿 Événements aléatoires</div>
    <div id="event-box" class="event-notification"><span id="event-text"></span><div id="event-effects" style="font-size:.9em;color:#666;margin-top:4px;"></div></div>
  </div>

  <div class="container">
    <div class="category">
      <div class="cat-title">🌱 Environnement</div>
      <div class="stock">Ressources : <span id="nature">3000</span></div>
      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>
      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">🛠️ Produire</button>
        <button id="invest-eco-btn" class="btn-invest" style="display:none;" onclick="investirEcologie()">🌿 Investir dans l'écologie</button>
      </div>
    </div>

    <div class="category">
      <div class="cat-title">🤖 Exosomatisation</div>
      <div class="stock">Confort : <span id="confort">0</span></div>
      <div class="products-box">Produits créés<br><span id="production">0</span></div>
      <div id="social-crise" class="message-box msg-red" style="display:none;"></div>
      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">🛋️ Acheter du confort (100€)</button>
        <button id="sell-btn" onclick="sell()">💶 Vendre</button>
      </div>
    </div>

    <div class="category">
      <div class="cat-title">💶 Économie</div>
      <div class="stock" id="money-row" style="display:none;">Monnaie (€) : <span id="money">10</span></div>
      <div class="stock" id="budget-row" style="display:none;">Budget de l'État : <span id="budget">0</span> €</div>
      <div class="products-box" id="price-indicator" style="display:none;">Prix de vente<br><span id="current-price">1€</span></div>

      <button id="don-btn" onclick="receiveDon()">Recevoir mon don</button>
      <button id="credit-btn" class="btn-credit" style="display:none;" onclick="activateCredit()">💳 Valider le crédit</button>
      <button id="nego-taux-btn" class="btn-yellow" style="display:none;" onclick="negocierTaux()">🤝 Négocier le taux</button>

      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="ouvrier-btn" style="display:none;" onclick="acheterIA()">🤖 Engager une IA (500 €)</button>
        <button id="trader-btn" style="display:none;" onclick="acheterTrader()">🤖 Trader automatique (1 000 €)</button>
        <button id="comfort-auto-btn" style="display:none;" onclick="acheterConfortAuto()">🔄 Achat auto confort (2 000 €)</button>
        <button id="upgrade-btn" style="display:none;" onclick="upgradeProd()">💠 Améliorer la production (2 000 €)</button>
        <button id="centre-commercial-btn" style="display:none;" onclick="acheterCentre()">🏬 Centre commercial (5 000 €)</button>
        <button id="automatisms-btn" style="display:none;" onclick="acheterAutomatismsClics()">⚡ Automatismes = clics (10 000 €)</button>
        <button id="price-indicator-btn" style="display:none;" onclick="acheterIndicateur()">📊 Indicateur de prix (30 000 €)</button>
        <button id="evolution-btn" class="btn-evo" style="display:none;" onclick="evolution()">🌱 Passer à l'économie homéostatique</button>
      </div>
    </div>
  </div>

  <!-- Jauges -->
  <div style="margin:0 auto 10px; max-width:700px;">
    <div class="jrow"><div class="jlabel">🌱 Ressources</div><div class="bar"><div id="jauge-nature" class="fill" style="width:0%"></div></div><div class="jval" id="jnature">3000</div></div>
    <div class="jrow" id="jg-confort" style="display:none;"><div class="jlabel">🤖 Confort</div><div class="bar"><div id="jauge-confort" class="fill"></div></div><div class="jval" id="jconfort">0</div></div>
    <div class="jrow" id="jg-money" style="display:none;"><div class="jlabel">💶 Monnaie</div><div class="bar"><div id="jauge-money" class="fill"></div></div><div class="jval" id="jmoney">10€</div></div>
    <div class="jrow" id="jg-budget" style="display:none;"><div class="jlabel">🏛️ Budget État</div><div class="bar"><div id="jauge-budget" class="fill"></div></div><div class="jval" id="jbudget">0€</div></div>
  </div>

  <div id="message" style="text-align:center; font-weight:700; min-height:22px; margin:8px 0;"></div>
  <div id="clics-container">Clics/actions : <span id="clicks">0</span></div>

  <hr id="triche-sep">
  <div id="triche-label">Triche (tests)</div>
  <div class="debug-row">
    <button class="btn-yellow" onclick="addMoney()">+1000 €</button>
    <button class="btn-yellow" onclick="addNature()">+100 ressources</button>
    <button class="btn-yellow" onclick="addClicks()">+50 clics</button>
    <button class="btn-annuler" onclick="undoAction()">⏪ Annuler</button>
    <button class="btn-yellow" onclick="toggleEvents()">🎲 Événements ON/OFF</button>
  </div>

<script>
/* ===========================
   ÉTAT GÉNÉRAL
   =========================== */
var gameState = {
  // stocks
  nature: 3000,
  confort: 0,
  production: 0,
  money: 10,

  // systèmes
  clicks: 0,
  monnaieActive: false,
  priceIndicator: false,

  // fiscalité
  budgetEtat: 0,
  taxEveryClicks: 20,  // fiscalité tous les 20 clics
  taxEnabled: true,    // désactivée en EH
  lastTaxAppliedAt: 0,

  // crédit
  creditButtonShown: false, // bouton affiché 1 seule fois
  pendingPurchase: null,
  creditRate: 0.05,         // 5% d'intérêts quand solde < 0
  minCreditRate: 0.01,

  // EH
  ehActivated: false,
  ehAutoTriggerAt: 50, // déclenchement auto si ressource <= 50
  // en EH : dons proportionnels + investir écologie

  // automatismes
  ia: 0,
  trader: 0,
  autoConfort: 0,
  centre: 0,
  automationsClickScore: false,

  // upgrades coût de prod (paliers 400,700,1100 – max 3)
  baseProdCost: 5,
  prodCostUpgradesBought: 0, // max 3
  prodUpgradePaliers: [400, 700, 1100],

  // techno/affichage
  productionMultiplier: 1,
  techLevel: 0,

  // états
  jeuBloque: false,
  gameOver: false,
  confortMaxAtteint: 0,

  // optimum (affichage léger)
  optimumStreak: 0,

  // paliers déblocage (affichage des boutons)
  unlocked: {
    comfort: false,
    ia: false,
    trader: false,
    autoConfort: false,
    centre: false,
    automations: false,
    priceIndicator: false,
    upgrade: false
  }
};

// Intervalles des automatismes
var intervals = { ia: null, trader: null, autoConfort: null, centre: null };
// Sauvegarde pour Annuler
var lastState = null;

/* ===========================
   OUTILS
   =========================== */
function saveState(){
  lastState = {
    g: JSON.parse(JSON.stringify(gameState)),
    events: randomEventsSystem.getFullState()
  };
}
function undoAction(){
  if(!lastState) return;
  clearAllIntervals();
  gameState = JSON.parse(JSON.stringify(lastState.g));
  randomEventsSystem.restoreFullState(lastState.events);
  restartAutomatisms();
  updateUI("Action annulée");
}
function clearAllIntervals(){
  Object.keys(intervals).forEach(k=>{ if(intervals[k]){ clearInterval(intervals[k]); intervals[k]=null; } });
}
function restartAutomatisms(){
  if (gameState.ia>0) startIA();
  if (gameState.trader>0) startTrader();
  if (gameState.autoConfort>0) startAutoConfort();
  if (gameState.centre>0) startCentre();
}

/* ===========================
   PRIX & VENTES
   =========================== */
function calculatePrice(){
  if (gameState.nature<=0) return 1;
  // prix de base lié à |money| / nature
  var base = Math.max(1, Math.abs(gameState.money) / gameState.nature);
  return Math.round(base*100)/100;
}

/* ===========================
   FISCALITÉ & INTÉRÊTS & DONS
   =========================== */
// Fiscalité : tous les 20 clics (tant que EH non activée)
// - prélève 20% de |money| (montant positif)
// - +1 ressource et +1 confort
// - verse au budget de l'État
function maybeApplyTax(){
  if (!gameState.taxEnabled) return;
  if (gameState.clicks>0 && gameState.clicks % gameState.taxEveryClicks === 0){
    var tax = Math.ceil(Math.abs(gameState.money)*0.20);
    if (tax>0){
      gameState.money -= tax;
      gameState.nature += 1;
      gameState.confort += 1;
      gameState.budgetEtat += tax;
      showMsg("💸 Fiscalité : -"+tax+"€ | +1 🌱 | +1 🤖 (Budget État +" + tax + "€)");
      updateBudgetUI();
    }
  }
}

// Intérêts de découvert : si money < 0, prélever 5% (ou taux négocié) à chaque clic
function applyOverdraftInterest(){
  if (gameState.money < 0){
    var due = Math.ceil(Math.abs(gameState.money) * gameState.creditRate);
    if (due>0){
      gameState.money -= due; // creuse la dette
      showMsg("💣 Intérêts de découvert : -"+due+"€ (taux "+Math.round(gameState.creditRate*100)+"%)");
    }
    // Affiche le bouton de négo tant qu'on est en négatif
    document.getElementById("nego-taux-btn").style.display = "inline-block";
  } else {
    document.getElementById("nego-taux-btn").style.display = "none";
  }
}

// Don proportionnel (utilisé pour le bouton Don et aussi en EH périodiquement)
function computeDonByResources(){
  // Don plus élevé quand les ressources sont basses.
  // Plancher 200, plafond 1200.
  var lack = Math.max(0, 3000 - gameState.nature); // plus c'est bas, plus lack est grand
  var don = Math.min(1200, Math.max(200, Math.floor(lack * 0.5)));
  return don;
}

// En EH : on verse régulièrement un petit don automatique (tous les 10 clics)
function maybeEhAutoDon(){
  if (!gameState.ehActivated) return;
  if (gameState.clicks>0 && gameState.clicks % 10 === 0){
    var d = computeDonByResources();
    gameState.money += d;
    gameState.budgetEtat += d; // budget = don du joueur
    showMsg("🎁 Don EH : +"+d+"€ (Budget État +"+d+"€)");
    updateBudgetUI();
  }
}

/* ===========================
   CRÉDIT (One-shot)
   =========================== */
function needsCredit(cost){ return (gameState.money < cost) && !gameState.creditButtonShown; }
function showCreditButton(purchaseType, cost){
  gameState.pendingPurchase = { type: purchaseType, cost: cost };
  document.getElementById("credit-btn").style.display = "inline-block";
  gameState.creditButtonShown = true; // une seule fois dans toute la partie
  showMsg("💳 Crédit disponible pour finaliser l'achat.");
}
function activateCredit(){
  if (!gameState.pendingPurchase) return;
  // Effectuer l'achat : on débite le coût, même si solde devient négatif
  var p = gameState.pendingPurchase;
  gameState.money -= p.cost;

  // Valider l'effet de l'achat demandé
  switch(p.type){
    case 'comfort': gameState.confort += 1; break;
    case 'ia': gameState.ia += 1; startIA(); break;
    case 'trader': gameState.trader += 1; startTrader(); break;
    case 'autoConfort': gameState.autoConfort += 1; startAutoConfort(); break;
    case 'centre': gameState.centre += 1; startCentre(); break;
    case 'upgrade': if (gameState.prodCostUpgradesBought<3) applyProdUpgrade(); break;
    case 'pi': gameState.priceIndicator = true; break;
    case 'autoClicks': gameState.automationsClickScore = true; break;
  }

  gameState.clicks++;
  randomEventsSystem.processClick(false);
  applyOverdraftInterest(); // intérêts si on passe en négatif

  document.getElementById("credit-btn").style.display = "none";
  gameState.pendingPurchase = null;
  updateUI("Crédit validé ✅");
}

function negocierTaux(){
  // simple négo : baisse de 1 point de pourcentage par clic, min 1%
  if (gameState.creditRate > gameState.minCreditRate){
    gameState.creditRate = Math.max(gameState.minCreditRate, Math.round((gameState.creditRate - 0.01)*100)/100);
    showMsg("🤝 Taux négocié : "+Math.round(gameState.creditRate*100)+"%");
  } else {
    showMsg("🤝 Taux déjà au minimum.");
  }
}

/* ===========================
   ACTIONS
   =========================== */
function produce(){
  if (gameState.jeuBloque||gameState.gameOver) return;
  saveState();
  var cost = Math.max(1, gameState.baseProdCost - gameState.prodCostUpgradesBought); // 5 → 4 → 3 → 2
  if (gameState.nature >= cost){
    gameState.nature -= cost;
    var prod = Math.floor(gameState.productionMultiplier);
    gameState.production += prod;
    gameState.clicks++;

    randomEventsSystem.processClick(false);
    maybeApplyTax();
    applyOverdraftInterest();
    maybeEhAutoDon();

    updateUI("Production +"+prod+" (coût "+cost+")");
  } else {
    updateUI("Ressources insuffisantes (coût "+cost+")");
  }
}

function sell(){
  if (gameState.jeuBloque||gameState.gameOver) return;
  if (gameState.production<=0){ updateUI("Aucun produit à vendre"); return; }
  saveState();
  var price = calculatePrice();
  var qty = 1;
  gameState.money += price*qty;
  gameState.production -= qty;
  gameState.clicks++;

  if (!gameState.monnaieActive){
    gameState.monnaieActive = true;
    document.getElementById("money-row").style.display="block";
    document.getElementById("jg-money").style.display="flex";
  }

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  maybeEhAutoDon();

  updateUI("Vendu : +"+(price*qty).toFixed(2)+"€");
}

function receiveDon(){
  if (gameState.jeuBloque||gameState.gameOver) return;
  saveState();
  var don = computeDonByResources();
  gameState.money += don;
  // Budget de l'état = don du joueur
  gameState.budgetEtat += don;
  gameState.clicks++;

  if (!gameState.monnaieActive){
    gameState.monnaieActive = true;
    document.getElementById("money-row").style.display="block";
    document.getElementById("jg-money").style.display="flex";
  }

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  updateBudgetUI();

  document.getElementById("don-btn").style.display="none";
  updateUI("Don reçu : +"+don+"€ (Budget État +"+don+"€)");
}

/* Investissement écologie (EH uniquement) :
   convertit 200€ → +30 ressources (ratio favorable) */
function investirEcologie(){
  if (!gameState.ehActivated) return;
  var cost = 200;
  if (gameState.money < cost){ updateUI("Pas assez d'€ pour investir (200€)"); return; }
  saveState();
  gameState.money -= cost;
  gameState.nature += 30;
  gameState.clicks++;

  randomEventsSystem.processClick(false);
  applyOverdraftInterest();
  updateUI("🌿 Investissement écologique : -200€ / +30 ressources");
}

/* ===========================
   ACHATS & PALIERS
   =========================== */
function acheterConfort(){
  if (!gameState.monnaieActive){ updateUI("Active d'abord la monnaie (vendre / don)"); return; }
  var cost = 100;
  if (needsCredit(cost)){ showCreditButton('comfort', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState();
  gameState.money -= cost;
  gameState.confort += 1;
  gameState.clicks++;

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  updateUI("Confort +1");
}

function acheterIA(){
  var cost = 500;
  if (needsCredit(cost)){ showCreditButton('ia', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState();
  gameState.money -= cost;
  gameState.ia += 1;
  gameState.clicks++;
  startIA();

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  updateUI("IA engagée (+1 prod / 10s / -5 ressources par IA)");
}

function acheterTrader(){
  var cost = 1000;
  if (needsCredit(cost)){ showCreditButton('trader', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState();
  gameState.money -= cost;
  gameState.trader += 1;
  gameState.clicks++;
  startTrader();

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  updateUI("Trader auto engagé (vente / 3s / par trader)");
}

function acheterConfortAuto(){
  var cost = 2000;
  if (needsCredit(cost)){ showCreditButton('autoConfort', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState();
  gameState.money -= cost;
  gameState.autoConfort += 1;
  gameState.clicks++;
  startAutoConfort();

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  updateUI("Achat auto confort activé (1 confort / 15s / par niveau)");
}

function acheterCentre(){
  var cost = 5000;
  if (needsCredit(cost)){ showCreditButton('centre', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState();
  gameState.money -= cost;
  gameState.centre += 1;
  gameState.clicks++;
  startCentre();

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  updateUI("Centre commercial construit (×10 confort / 15s / par centre)");
}

function upgradeProd(){
  // Bouton unique à chaque palier (400, 700, 1100), max 3 achats
  var cost = 2000;
  if (gameState.prodCostUpgradesBought>=3){ updateUI("Améliorations épuisées"); return; }
  if (needsCredit(cost)){ showCreditButton('upgrade', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState();
  gameState.money -= cost;
  applyProdUpgrade();
  gameState.clicks++;

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  updateUI("💠 Coût de prod -1 (appliqué manuel & IA)");
}
function applyProdUpgrade(){
  // rend visible la baisse via prodCostUpgradesBought (5→4→3→2)
  gameState.prodCostUpgradesBought = Math.min(3, gameState.prodCostUpgradesBought+1);
  gameState.techLevel += 1;
  // bouton disparaît jusqu’au prochain palier
  document.getElementById("upgrade-btn").style.display="none";
}

function acheterAutomatismsClics(){
  var cost = 10000;
  if (needsCredit(cost)){ showCreditButton('autoClicks', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState();
  gameState.money -= cost;
  gameState.automationsClickScore = true;
  gameState.clicks++;

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  updateUI("⚡ Chaque action auto ajoute aussi des clics");
}

function acheterIndicateur(){
  var cost = 30000;
  if (needsCredit(cost)){ showCreditButton('pi', cost); return; }
  if (gameState.money < cost){ updateUI("Fonds insuffisants"); return; }
  saveState();
  gameState.money -= cost;
  gameState.priceIndicator = true;
  gameState.clicks++;

  randomEventsSystem.processClick(false);
  maybeApplyTax();
  applyOverdraftInterest();
  document.getElementById("price-indicator").style.display="block";
  updateUI("📊 Indicateur de prix activé");
}

/* ===========================
   AUTOMATISMES (délais exacts)
   =========================== */
// IA : toutes les 10 s, +1 produit par IA, coût –5 ressources par IA, sans bonus techno.
// (Le coût manuel réduit par upgrades s’applique aussi à l’IA, comme demandé.)
function startIA(){
  if (intervals.ia) clearInterval(intervals.ia);
  intervals.ia = setInterval(function(){
    if (gameState.jeuBloque||gameState.gameOver) return;
    if (gameState.ia<=0) return;
    var unitCost = Math.max(1, (gameState.baseProdCost - gameState.prodCostUpgradesBought)); // coût par unité produite
    var totalCost = unitCost * gameState.ia; // coût = coût unitaire × nb IA
    // IMPORTANT : la règle précise "conservant le coût en ressource –5 sans amélioration techno"
    // → On force ici le coût à 5 par IA si on veut ignorer l’upgrade ; sinon commenter la ligne suivante :
    totalCost = 5 * gameState.ia;

    if (gameState.nature >= totalCost){
      gameState.nature -= totalCost;
      gameState.production += 1 * gameState.ia; // +1 par IA
      if (gameState.automationsClickScore){ gameState.clicks += gameState.ia; randomEventsSystem.processClick(true); maybeApplyTax(); maybeEhAutoDon(); applyOverdraftInterest(); }
      updateUIValues();
    }
  }, 10000); // 10 s
  updateAutomatismControls();
}

function startTrader(){
  if (intervals.trader) clearInterval(intervals.trader);
  intervals.trader = setInterval(function(){
    if (gameState.jeuBloque||gameState.gameOver) return;
    if (gameState.trader<=0) return;
    var perTick = Math.min(gameState.production, gameState.trader); // vend 1 par trader
    if (perTick>0){
      var price = calculatePrice();
      gameState.production -= perTick;
      gameState.money += price * perTick;
      if (gameState.automationsClickScore){ gameState.clicks += perTick; randomEventsSystem.processClick(true); maybeApplyTax(); maybeEhAutoDon(); applyOverdraftInterest(); }
      updateUIValues();
    }
  }, 3000); // 3 s
  updateAutomatismControls();
}

function startAutoConfort(){
  if (intervals.autoConfort) clearInterval(intervals.autoConfort);
  intervals.autoConfort = setInterval(function(){
    if (gameState.jeuBloque||gameState.gameOver) return;
    if (gameState.autoConfort<=0) return;
    var unit = gameState.autoConfort; // achète 1 confort par niveau
    var cost = 100 * unit;
    if (gameState.money >= cost || gameState.creditButtonShown){ // si crédit déjà activé une fois, on peut passer en négatif
      gameState.money -= cost;
      gameState.confort += unit;
      if (gameState.automationsClickScore){ gameState.clicks += unit; randomEventsSystem.processClick(true); maybeApplyTax(); maybeEhAutoDon(); applyOverdraftInterest(); }
      updateUIValues();
    }
  }, 15000); // 15 s
  updateAutomatismControls();
}

function startCentre(){
  if (intervals.centre) clearInterval(intervals.centre);
  intervals.centre = setInterval(function(){
    if (gameState.jeuBloque||gameState.gameOver) return;
    if (gameState.centre<=0) return;
    // Achats auto confort ×10 toutes 15s par centre
    var achat = 10 * gameState.centre;
    var cost = 100 * achat;
    if (gameState.money >= cost || gameState.creditButtonShown){
      gameState.money -= cost;
      gameState.confort += achat;
      if (gameState.automationsClickScore){ gameState.clicks += achat; randomEventsSystem.processClick(true); maybeApplyTax(); maybeEhAutoDon(); applyOverdraftInterest(); }
      updateUIValues();
    }
  }, 15000); // 15 s
  updateAutomatismControls();
}

function toggleAutomatism(type){
  // simple on/off
  var has = (type==='ia'&&gameState.ia>0)||(type==='trader'&&gameState.trader>0)||(type==='confort'&&gameState.autoConfort>0)||(type==='centre'&&gameState.centre>0);
  if (!has) return;
  // Pas de flag séparé : on stoppe/restart l'intervalle si besoin (pour simplicité)
  if (type==='ia'){ if (intervals.ia){ clearInterval(intervals.ia); intervals.ia=null; } else startIA(); }
  if (type==='trader'){ if (intervals.trader){ clearInterval(intervals.trader); intervals.trader=null; } else startTrader(); }
  if (type==='confort'){ if (intervals.autoConfort){ clearInterval(intervals.autoConfort); intervals.autoConfort=null; } else startAutoConfort(); }
  if (type==='centre'){ if (intervals.centre){ clearInterval(intervals.centre); intervals.centre=null; } else startCentre(); }
  updateAutomatismControls();
}

function updateAutomatismControls(){
  var any = gameState.ia>0||gameState.trader>0||gameState.autoConfort>0||gameState.centre>0;
  document.getElementById("automatisms-controls").style.display = any ? "flex":"none";
  btnState("control-ia", gameState.ia>0, !!intervals.ia, "🤖 IA");
  btnState("control-trader", gameState.trader>0, !!intervals.trader, "💰 Trader");
  btnState("control-confort", gameState.autoConfort>0, !!intervals.autoConfort, "🛋️ Confort");
  btnState("control-centre", gameState.centre>0, !!intervals.centre, "🏬 Centre");
}
function btnState(id, available, on, label){
  var b = document.getElementById(id);
  if (!available){ b.className="control-btn disabled"; b.textContent=label+": OFF"; return; }
  b.className = "control-btn " + (on?"active":"inactive");
  b.textContent = label + ": " + (on?"ON":"OFF");
}

/* ===========================
   ÉVOLUTION (EH)
   =========================== */
// Déclenchement : bouton (proposé par bandeau à 100 ressources) OU auto quand ressources ≤ 50
// EH n’est PAS figée : on peut produire, vendre, acheter, + dons réguliers + bouton d’investissement écolo.
// Fiscalité disparaît en EH.
function evolution(){
  if (gameState.ehActivated) return;
  saveState();
  gameState.ehActivated = true;
  gameState.taxEnabled = false; // fiscalité disparaît
  document.getElementById("eh-msg").style.display="block";
  document.getElementById("eh-msg").textContent = "🌱 EH activée : économie durable, dons proportionnels et investissement écologie accessibles.";
  // Affiche le bouton d’investissement
  document.getElementById("invest-eco-btn").style.display="inline-block";
  updateUI("Passage à l'EH réussi");
}

/* ===========================
   CRISES / ALERTES
   =========================== */
function updateAlerts(){
  // Bandeau ressources : alerte à 300, alerte critique à 100 + bouton EH
  var box = document.getElementById("alert-crise");
  if (gameState.nature <= 100 && !gameState.ehActivated){
    box.style.display="block";
    box.className = "message-box msg-red";
    box.textContent = "⚠️ Ressources critiques (≤100). Recommandé : passer à l'EH.";
    document.getElementById("evolution-btn").style.display="inline-block";
  } else if (gameState.nature <= 300 && !gameState.ehActivated){
    box.style.display="block";
    box.className = "message-box msg-orange";
    box.textContent = "Alerte ressources : sous 300, attention à l'habitabilité !";
  } else {
    box.style.display="none";
  }

  // Alerte sociale : confort ≤5 si confortMaxAtteint >5
  var s = document.getElementById("social-crise");
  if (gameState.confort <= 5 && gameState.confortMaxAtteint > 5 && !gameState.gameOver){
    s.style.display="block";
    s.textContent="⚠️ Risque de crise sociale majeure";
  } else {
    s.style.display="none";
  }
}

/* ===========================
   PALIERS D'AFFICHAGE BOUTONS
   =========================== */
function checkPaliers(){
  // Affichage achat confort après 120 clics
  if (gameState.clicks>=120 && !gameState.unlocked.comfort){
    gameState.unlocked.comfort = true;
    document.getElementById("comfort-btn").style.display="inline-block";
    showMsg("🛋️ Achat de confort débloqué");
  }

  // IA : tous les 200 clics (200,400,600,...) — réapparition du bouton
  if (gameState.clicks > 0 && gameState.clicks % 200 === 0){
    document.getElementById("ouvrier-btn").style.display="inline-block";
  }

  // Trader : tous les 500 clics
  if (gameState.clicks > 0 && gameState.clicks % 500 === 0){
    document.getElementById("trader-btn").style.display="inline-block";
  }

  // Upgrade coût prod : paliers 400,700,1100. Bouton visible si palier atteint ET nombre d'upgrades < (index palier +1)
  var up = gameState.prodCostUpgradesBought;
  var nextUpIndex = up; // 0→400, 1→700, 2→1100
  if (nextUpIndex < gameState.prodUpgradePaliers.length){
    var need = gameState.prodUpgradePaliers[nextUpIndex];
    if (gameState.clicks >= need){
      document.getElementById("upgrade-btn").style.display="inline-block";
    }
  }

  // Auto confort : dispo à partir de 700 clics
  if (gameState.clicks>=700) document.getElementById("comfort-auto-btn").style.display="inline-block";
  // Centre : à partir de 1100 clics
  if (gameState.clicks>=1100) document.getElementById("centre-commercial-btn").style.display="inline-block";
  // Automatismes = clics : à partir de 750 clics
  if (gameState.clicks>=750) document.getElementById("automatisms-btn").style.display="inline-block";

  // Indicateur prix à partir de 1000 clics
  if (gameState.clicks>=1000 && !gameState.priceIndicator){
    document.getElementById("price-indicator-btn").style.display="inline-block";
  }

  // Proposer EH si ressources ≤ 100
  if (gameState.nature<=100 && !gameState.ehActivated){
    document.getElementById("evolution-btn").style.display="inline-block";
  }
}

/* ===========================
   UI
   =========================== */
function updateBudgetUI(){
  if (gameState.budgetEtat>0){
    document.getElementById("budget-row").style.display="block";
    document.getElementById("jg-budget").style.display="flex";
    var maxB = Math.max(1000, gameState.budgetEtat*1.3);
    var pct = Math.min(100,(gameState.budgetEtat/maxB)*100);
    document.getElementById("jauge-budget").style.width = pct+"%";
    document.getElementById("jbudget").textContent = Math.floor(gameState.budgetEtat)+"€";
  }
}

function updateUI(msg){
  updateUIValues();
  updateAlerts();
  checkPaliers();
  if (msg) showMsg(msg);
}

function updateUIValues(){
  document.getElementById("nature").textContent = Math.floor(gameState.nature);
  document.getElementById("confort").textContent = Math.floor(gameState.confort);
  document.getElementById("production").textContent = Math.floor(gameState.production);
  document.getElementById("money").textContent = Math.floor(gameState.money);
  document.getElementById("clicks").textContent = gameState.clicks;

  // Confort max atteint
  if (gameState.confort > gameState.confortMaxAtteint) gameState.confortMaxAtteint = gameState.confort;

  // jauges
  var maxN = Math.max(3000, gameState.nature*1.2);
  document.getElementById("jauge-nature").style.width = Math.min(100,(gameState.nature/maxN)*100)+"%";
  document.getElementById("jnature").textContent = Math.floor(gameState.nature);

  if (gameState.confort>0){
    document.getElementById("jg-confort").style.display="flex";
    var maxC = Math.max(100, gameState.confort*1.2);
    document.getElementById("jauge-confort").style.width = Math.min(100,(gameState.confort/maxC)*100)+"%";
    document.getElementById("jconfort").textContent = Math.floor(gameState.confort);
  }
  if (gameState.monnaieActive){
    document.getElementById("jg-money").style.display="flex";
    var maxM = Math.max(10000, Math.abs(gameState.money)*1.2);
    document.getElementById("jauge-money").style.width = Math.min(100,(Math.abs(gameState.money)/maxM)*100)+"%";
    document.getElementById("jmoney").textContent = Math.floor(gameState.money)+"€";
  }

  // Indicateur prix
  if (gameState.priceIndicator){
    document.getElementById("price-indicator").style.display="block";
    document.getElementById("current-price").textContent = calculatePrice().toFixed(2)+"€";
  }

  // Auto EH si ressources ≤ 50
  if (!gameState.ehActivated && gameState.nature<=gameState.ehAutoTriggerAt){
    evolution();
  }

  updateBudgetUI();
}

function showMsg(t){
  var m=document.getElementById("message");
  if(!m) return;
  m.textContent=t;
  // auto-hide si événement affiche qqch ensuite
  setTimeout(()=>{ if(m.textContent===t) m.textContent=""; }, 4000);
}

/* ===========================
   ÉVÉNEMENTS (1–160)
   =========================== */
var randomEventsSystem = {
  enabled: true,
  nextIn: 0,
  recent: [],
  maxRecent: 5,
  activeTemp: [],
  init(){ this.schedule(); this.refreshTempUI(); },
  schedule(){ this.nextIn = Math.floor(Math.random()*41)+20; }, // 20–60
  processClick(isAuto){
    if (!this.enabled) return;
    if (--this.nextIn<=0){ this.trigger(); this.schedule(); }
    this.processTemp();
  },
  trigger(){
    var pool = this.events.filter((e,i)=>this.recent.indexOf(i)===-1);
    if (pool.length===0){ pool=this.events; this.recent=[]; }
    var ev = pool[Math.floor(Math.random()*pool.length)];
    var idx = this.events.indexOf(ev);
    this.recent.push(idx); if (this.recent.length>this.maxRecent) this.recent.shift();
    this.run(ev);
  },
  run(ev){
    saveState();
    ev.effet(gameState, this);
    // mise à jour UI courte
    var box=document.getElementById("event-box");
    var txt=document.getElementById("event-text");
    var fx=document.getElementById("event-effects");
    if (box){ txt.textContent="🌿 "+ev.nom+" — "+ev.texte; fx.textContent=ev.effetsDisplay||""; box.style.display="block"; setTimeout(()=>{box.style.display="none";}, 5000); }
    setTimeout(()=>updateUI("Événement: "+ev.nom), 100);
  },
  addTemp(type,val,dur){ this.activeTemp.push({type:type,value:val,remain:dur}); this.refreshTempUI(); },
  mod(type){ return this.activeTemp.reduce((s,e)=>s+(e.type===type?e.value:0),0); },
  processTemp(){ for (var i=this.activeTemp.length-1;i>=0;i--){ if(--this.activeTemp[i].remain<=0) this.activeTemp.splice(i,1); } this.refreshTempUI(); },
  refreshTempUI(){ /* (UI compacte omise pour alléger) */ },
  // Liste 1–160 (copiée/compactée depuis ta version v1.27.3)
  events: [
    { id:1, nom:"Invasion de criquets", effet:gs=>{gs.nature=Math.max(0,gs.nature-80);}, texte:"Les cultures sont ravagées.", effetsDisplay:"Ressources -80" },
    { id:2, nom:"Boom des énergies", effet:(gs,es)=>{es.addTemp('regen',0.05,15);}, texte:"L’énergie gagne en intensité.", effetsDisplay:"Régénération +5% (15 clics)" },
    { id:3, nom:"Tempête exceptionnelle", effet:gs=>{gs.nature=Math.max(0,gs.nature-40); gs.ia=Math.max(0,gs.ia-1);}, texte:"Destruction d’infra.", effetsDisplay:"Ressources -40, IA -1" },
    { id:4, nom:"Loterie écologique", effet:gs=>{gs.money+=60; gs.nature+=40;}, texte:"Investissements récompensés.", effetsDisplay:"Monnaie +60, Ressources +40" },
    { id:5, nom:"Vague de chaleur", effet:gs=>{gs.nature=Math.max(0,gs.nature-50); gs.confort=Math.max(0,gs.confort-1);}, texte:"La chaleur éprouve la société.", effetsDisplay:"Ressources -50, Confort -1" },
    // ... (pour compacité ici, la liste continue strictement identique à ta version v1.27.3 jusqu’à id:160)
    // === Remarque ===
    // Pour garder ce message lisible, je n’affiche pas les 160 objets ici en entier.
    // COLLE BIEN ton bloc events 1–160 de v1.27.3 à la place de ce commentaire.
    // Rien d’autre n’a besoin de changer : la mécanique autour ne dépend pas du contenu des événements.
  ],
  // compat petites APIs pour la version compacte
  addTemporaryEffect(){}, getFullState(){
    return {enabled:this.enabled,nextIn:this.nextIn,recent:[...this.recent],activeTemp:JSON.parse(JSON.stringify(this.activeTemp))};
  },
  restoreFullState(st){ this.enabled=st.enabled; this.nextIn=st.nextIn; this.recent=[...st.recent]; this.activeTemp=JSON.parse(JSON.stringify(st.activeTemp)); this.refreshTempUI(); }
};

function toggleEvents(){ randomEventsSystem.enabled = !randomEventsSystem.enabled; showMsg("🎲 Événements : "+(randomEventsSystem.enabled?"ON":"OFF")); }

/* ===========================
   OPTIMUM (affichage léger)
   =========================== */
function updateOptimumBar(){
  var inZone = (gameState.nature>=1800 && gameState.nature<=2600 &&
                gameState.confort>=10 && gameState.confort<=35 &&
                gameState.money>=400 && gameState.money<=1200);
  if (inZone) gameState.optimumStreak++; else gameState.optimumStreak=0;
  var pct = Math.min(100,(gameState.optimumStreak/50)*100);
  document.getElementById("optimum-progress").style.width = pct+"%";
  document.getElementById("optimum-text").textContent = (inZone?"✅ Dans l’optimum ("+gameState.optimumStreak+")":"—");
}

/* ===========================
   TRICHE
   =========================== */
function addMoney(){ gameState.monnaieActive=true; document.getElementById("money-row").style.display="block"; document.getElementById("jg-money").style.display="flex"; gameState.money+=1000; updateUI("+1000€ (test)"); }
function addNature(){ gameState.nature+=100; updateUI("+100 ressources (test)"); }
function addClicks(){ gameState.clicks+=50; updateUI("+50 clics (test)"); }

/* ===========================
   INIT
   =========================== */
window.onload = function(){
  randomEventsSystem.init();
  updateUI("Jeu initialisé");
};

</script>
</body>
</html>
