<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Looop v1.27.4 ‚Äì avec fiscalit√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #f3f3f3; font-family: sans-serif; margin:0; padding:0; }
    h1 { text-align: center; margin: 25px 0 10px; }
    .container { display: flex; justify-content: center; align-items: flex-start; margin: 0 auto 18px auto; max-width: 950px; gap: 24px;}
    .category { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #0001; flex: 1; padding: 32px 18px 18px 18px; margin: 0 6px; min-width: 250px; max-width: 320px; min-height: 250px; display: flex; flex-direction: column; align-items: center;}
    .cat-title { font-size: 1.25em; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px;}
    .stock { font-size: 1.1em; margin-bottom: 10px;}
    .products-box { background: #f7f7fa; border: 2px solid #dde1eb; border-radius: 10px; color: #333; margin-bottom: 10px; padding: 10px 28px; font-size: 1.2em; font-weight: bold; letter-spacing: 1px; box-shadow: 0 1px 4px #ddd5; min-width: 110px; text-align: center;}
    .message-box { border-radius: 10px; margin: 8px 0 14px 0; padding: 11px 14px; font-weight: bold; font-size: 1.08em; box-shadow: 0 1px 4px #0002; text-align: center; min-width: 130px; max-width: 260px; word-break: break-word; line-height: 1.25em;}
    .msg-orange { background: #fff2e6; color: #cc5500; border: 2px solid #ff8533; }
    .msg-blue { background: #e6f3ff; color: #0066cc; border: 2px solid #4da6ff; }
    .msg-red { background: #ffe6e6; color: #cc0000; border: 2px solid #ff6666; }
    .msg-brown { background: #fff7e6; color: #996600; border: 2px solid #cc9900; }
    .msg-green { background: #e6ffe6; color: #006600; border: 2px solid #66cc66; }
    .msg-gold { background: #fff9c4; color: #b8860b; border: 2px solid #f4d03f;}
    .msg-natural { background: #f0f8f0; color: #2e7d32; border: 2px solid #81c784;}
    .btn-row { margin: 18px 0 0 0;}
    button { font-size: 1em; padding: 10px 18px; margin: 5px 0; border-radius: 14px; border: none; background: #ededed; color: #111; cursor: pointer; transition: background 0.2s;}
    .btn-yellow { background: #FFD600; color: #222; font-weight: bold;}
    .btn-annuler { background: #aaa; color: #fff; }
    .btn-credit { background: #ff6b35; color: #fff; font-weight: bold;}
    .btn-evolution { background: #4CAF50; color: #fff; font-weight: bold;}
    .btn-restart { background: #2196F3; color: #fff; font-weight: bold;}
    .debug-row { margin: 0 0 32px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;}
    .message { font-weight: bold; min-height: 24px; margin: 10px 0;}
    #clics-container { text-align: center; margin: 25px 0 0 0; font-size: 1.2em; font-weight: bold; color: #333;}
    #don-btn { margin-top: 10px; background: #FFD600; color: #222; font-weight: bold; border: none; border-radius: 8px; font-size: 1.1em; padding: 14px 20px;}
    #triche-sep { border: none; border-top: 3px solid #222; margin: 38px auto 12px auto; width: 94vw; max-width: 1000px;}
    #triche-label { text-align: left; font-size:1.13em; font-weight:normal; letter-spacing:1px; margin: 0 0 12px 0; color:#555; width: 95vw; max-width: 1000px; margin-left: auto; margin-right: auto;}
    #unlock-cheat-btn { transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
    #unlock-cheat-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    #cheat-buttons { animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .automatisms-controls { margin: 15px auto; max-width: 950px; display: none; justify-content: center; gap: 20px; flex-wrap: wrap; padding: 15px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; }
    .control-btn { font-size: 0.9em; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; min-width: 80px; border: none;}
    .control-btn.active { background: #4CAF50; color: white; }
    .control-btn.inactive { background: #f44336; color: white; }
    .control-btn.disabled { background: #ccc; color: #888; cursor: not-allowed; }

    .optimum-zone { margin: 15px auto; max-width: 950px; padding: 15px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; text-align: center; }
    .optimum-title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #333; }
    .optimum-progress-bar { background: #eee; border-radius: 20px; height: 20px; margin: 10px auto; max-width: 400px; overflow: hidden; position: relative; }
    .optimum-progress-fill { height: 100%; border-radius: 20px; transition: width 0.3s ease; background: linear-gradient(90deg, #4CAF50, #81C784); }
    .optimum-progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #333; font-size: 0.9em; }
    .optimum-status { font-size: 0.9em; margin-top: 8px; color: #666; }
    .optimum-victory { background: #fff9c4; border: 2px solid #f4d03f; color: #b8860b; padding: 20px; border-radius: 15px; font-size: 1.2em; font-weight: bold; text-align: center; margin: 20px auto; max-width: 600px; animation: victoryPulse 2s infinite;}
    @keyframes victoryPulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.02);} }

    .events-zone { margin: 15px auto; max-width: 950px; padding: 15px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; }
    .event-notification { background: #f0f8f0; border: 2px solid #81c784; border-radius: 10px; padding: 12px; margin: 10px 0; font-weight: bold; text-align: center; color: #2e7d32; animation: eventPulse 0.8s ease-in-out; position: relative; overflow: hidden; }
    .event-notification::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 1.5s ease-in-out; }
    @keyframes eventPulse { 0% { transform: scale(0.95); opacity: 0; } 50% { transform: scale(1.02); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
    .event-effects-display { font-size: 0.85em; color: #666; margin-top: 5px; font-style: italic; }

    .temp-effects-display { background: #f5f7f5; border: 2px solid #81c784; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85em; display: none; }
    .temp-effects-title { font-weight: bold; color: #2e7d32; margin-bottom: 8px; text-align: center; }
    .temp-effect-item { background: #fff; border: 1px solid #a5d6a7; border-radius: 4px; padding: 4px 8px; margin: 2px 0; display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; }
    .temp-effect-name { font-weight: bold; color: #333; }
    .temp-effect-duration { color: #666; font-size: 0.75em; }

    .jauge-bottom-barre { margin: 0 auto 6px auto; display: flex; flex-direction: row; align-items: center; gap: 8px; max-width: 600px;}
    .jauge-bottom-label { min-width: 70px; font-size: .99em; color: #888; text-align: right;}
    .jauge-bottom-bar { background: #eee; border-radius: 8px; height: 13px; flex: 1; overflow: hidden; position: relative;}
    .jauge-bottom-fill { height: 100%; border-radius: 8px; transition: width 0.19s;}
    #jauge-nature { background: #86e08e;}
    #jauge-confort { background: #86b6ea;}
    #jauge-money { background: #ffb3b3;}
    #jauge-achat-auto { background: #ffa726;}
    #jauge-ia { background: #ab47bc;}
    #jauge-trader { background: #26c6da;}
    #jauge-centre { background: #66bb6a;}
    #jauge-budget-etat { background: #ff9800;}
    #jauge-tech { background: #9c27b0;}
    .hidden { display: none; }

    @media (max-width: 700px) {
      body { font-size: 14px; }
      h1 { font-size: 1.5em; margin: 15px 0 5px; }
      .container { flex-direction: column; max-width: 100vw; padding: 0 5px; gap: 10px; margin: 0 auto 10px auto; }
      .category { min-width: unset; max-width: unset; width: calc(100vw - 20px); padding: 20px 12px 12px 12px; margin: 0; min-height: 200px; }
      .cat-title { font-size: 1.1em; margin-bottom: 15px; }
      .stock { font-size: 1em; margin-bottom: 8px; }
      .products-box { font-size: 1em; padding: 8px 20px; min-width: 90px; }
      .message-box { font-size: 1em; min-width: 100px; max-width: calc(100vw - 60px); }
      button { font-size: 1em; padding: 12px 20px; margin: 6px 0; min-height: 44px; }
      .jauge-bottom-barre { max-width: calc(100vw - 30px); gap: 6px; }
      .jauge-bottom-label { min-width: 60px; font-size: 0.9em; }
      #clics-container { font-size: 1.1em; margin: 20px 0 0 0; }
      #don-btn { padding: 16px 24px; font-size: 1.1em; }
      .debug-row { flex-direction: column; gap: 8px; margin: 0 0 20px 0; align-items: center; }
      .debug-row button { min-width: 200px; }
      #triche-label { max-width: calc(100vw - 20px); margin-left: 10px; margin-right: 10px; }
      #triche-sep { width: calc(100vw - 20px); }
      .event-notification { margin: 8px 0; padding: 10px; font-size: 0.95em; }
    }
  </style>
</head>
<body>
  <h1>üåç Looop <span style="font-size:0.7em;color:#777;">v1.27.3 ‚Äî √âv√©nements complets (160)</span></h1>

  <div class="automatisms-controls" id="automatisms-controls">
    <button class="control-btn disabled" id="control-ia" onclick="toggleAutomatism('ia')">ü§ñ IA: OFF</button>
    <button class="control-btn disabled" id="control-trader" onclick="toggleAutomatism('trader')">üí∞ Trader: OFF</button>
    <button class="control-btn disabled" id="control-confort" onclick="toggleAutomatism('confort')">üõãÔ∏è Confort: OFF</button>
    <button class="control-btn disabled" id="control-centre" onclick="toggleAutomatism('centre')">üè¨ Centre: OFF</button>
  </div>

  <div class="optimum-zone" id="optimum-zone">
    <div class="optimum-title">üéØ Zone d'√âquilibre</div>
    <div class="optimum-progress-bar">
      <div class="optimum-progress-fill" id="optimum-progress-fill"></div>
      <div class="optimum-progress-text" id="optimum-progress-text">0 / 50</div>
    </div>
    <div class="optimum-status" id="optimum-status">Objectif : maintenir l'√©quilibre pendant 50 actions</div>
  </div>

  <div class="events-zone" id="events-zone">
    <div class="optimum-title">üåø √âv√©nements Al√©atoires</div>
    <div id="current-event" class="event-notification" style="display: none;">
      <div id="event-text">Aucun √©v√©nement en cours</div>
      <div id="event-effects" class="event-effects-display"></div>
    </div>
    <div id="temp-effects-display" class="temp-effects-display">
      <div class="temp-effects-title">‚è±Ô∏è Effets temporaires actifs</div>
      <div id="temp-effects-list"></div>
    </div>
  </div>

  <div id="optimum-victory" class="optimum-victory" style="display:none;">
    üèÜ VICTOIRE ! üèÜ<br>
    Vous avez maintenu l'√©quilibre optimum !<br>
    <button class="btn-restart" onclick="restartGame()" style="margin-top: 15px;">üîÑ Recommencer une partie</button>
  </div>

  <div class="container">
    <div class="category">
      <div class="cat-title">üå± Environnement</div>
      <div class="stock">Ressources : <span id="nature">3000</span></div>
      <div id="alert-crise" class="message-box msg-orange" style="display:none;"></div>

      <div class="btn-row">
        <button id="produce-btn" onclick="produce()">üõ†Ô∏è Produire</button>
      </div>
    </div>

    <div class="category">
      <div class="cat-title">ü§ñ Exosomatisation</div>
      <div class="stock">Confort : <span id="confort">0</span></div>
      <div class="products-box">Produits cr√©√©s<br><span id="production">0</span></div>
      <div id="social-crise" class="message-box msg-brown" style="display:none;"></div>
      <div class="btn-row">
        <button id="comfort-btn" onclick="acheterConfort()" style="display:none;">üõãÔ∏è Achat</button>
        <button id="sell-btn" onclick="sell()">üí∂ Vendre</button>
      </div>
    </div>

    <div class="category">
      <div class="cat-title">üí∂ √âconomie</div>
      <div class="stock" id="money-row" style="display:none;">Monnaie (‚Ç¨) : <span id="money">10</span></div>
      <div class="stock" id="budget-etat-row" style="display:none;">Budget de l'√âtat : <span id="budget-etat">0</span> ‚Ç¨</div>
      <div class="products-box" id="price-indicator-box" style="display:none;">Prix de vente<br><span id="current-price">1‚Ç¨</span></div>

      <button id="don-btn" onclick="receiveDon()">Recevoir mon don</button>
      <button id="credit-btn" onclick="activateCredit()" style="display:none;" class="btn-credit">üí≥ Effectuer un cr√©dit</button>
      <div id="eh-msg" class="message-box msg-blue" style="display:none;"></div>
      <div id="eh-success" class="message-box msg-green" style="display:none;"></div>
      <div id="game-over-resources" class="message-box msg-red" style="display:none;"></div>
      <div id="game-over-confort" class="message-box msg-red" style="display:none;"></div>

      <div class="btn-row">
        <button id="ouvrier-btn" onclick="acheterIA()" style="display:none;">ü§ñ Engager une IA (500 ‚Ç¨)</button>
        <button id="trader-btn" onclick="acheterTrader()" style="display:none;">ü§ñ Trader automatique (1 000 ‚Ç¨)</button>
        <button id="comfort-auto-btn" onclick="acheterConfortAuto()" style="display:none;">üîÑ Achat auto confort (2 000 ‚Ç¨)</button>
        <button id="upgrade-btn2" onclick="upgradeProd2()" style="display:none;">üí† Am√©liorer la production (2 000 ‚Ç¨)</button>
        <button id="automatisms-btn" onclick="acheterAutomatismsClics()" style="display:none;">‚ö° Automatismes = clics (10 000 ‚Ç¨)</button>
        <button id="centre-commercial-btn" onclick="acheterCentreCommercial()" style="display:none;">üè¨ Centre commercial (5 000 ‚Ç¨)</button>
        <button id="price-indicator-btn" onclick="acheterIndicateurPrix()" style="display:none;">üìä Indicateur de prix (30 000 ‚Ç¨)</button>
        <button id="evolution-btn" onclick="evolution()" style="display:none;" class="btn-evolution">üå± √âvolution √©conomique</button>
        <button id="rescue-eh-btn" onclick="activateRescueEH()" style="display:none;" class="btn-evolution">üå± Passer √† l'√©conomie hom√©ostatique</button>
      </div>
    </div>
  </div>

  <div id="jauges-zone" style="margin: 0 auto 14px auto; max-width:620px;">
    <div class="jauge-bottom-barre">
      <div class="jauge-bottom-label">üå± Ressources</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-nature"></div></div>
      <div class="jauge-bottom-val" id="jauge-nature-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-confort-container" style="display:none;">
      <div class="jauge-bottom-label">ü§ñ Confort</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-confort"></div></div>
      <div class="jauge-bottom-val" id="jauge-confort-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-money-container" style="display:none;">
      <div class="jauge-bottom-label">üí∂ Monnaie</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-money"></div></div>
      <div class="jauge-bottom-val" id="jauge-money-txt"></div>
    </div>
    <div class="jauge-bottom-barre" id="jauge-budget-etat-container" style="display:none;">
      <div class="jauge-bottom-label">üèõÔ∏è Budget √âtat</div>
      <div class="jauge-bottom-bar"><div class="jauge-bottom-fill" id="jauge-budget-etat"></div></div>
      <div class="jauge-budget-etat-val" id="jauge-budget-etat-txt"></div>
    </div>
  </div>

  <div class="message" id="message"></div>
  <div id="clics-container">Clics/actions : <span id="clicks">0</span></div>

  <hr id="triche-sep">
  <div id="triche-label">Triche</div>
  <div class="debug-row">
    <button id="unlock-cheat-btn" class="btn-yellow" onclick="toggleCheatMode()">üîì D√©v√©rouiller les outils de test</button>
  </div>
  <div id="cheat-buttons" class="debug-row" style="display: none;">
    <button class="btn-yellow" onclick="addMoney()">+1000 cr√©dits (test)</button>
    <button class="btn-yellow" onclick="addOneNature()">+100 ressources (test)</button>
    <button class="btn-yellow" onclick="addClicks50()">Clics +50 (test)</button>
    <button class="btn-yellow" onclick="removeNature100()">-100 ressources (test)</button>
    <button class="btn-evolution" onclick="forceActivateEH()">Passer √† l'EH (test)</button>
    <button class="btn-annuler" onclick="undoAction()">‚è™ Annuler le clic pr√©c√©dent</button>
    <button class="btn-yellow" onclick="toggleEvents()">üé≤ √âv√©nements: ON/OFF</button>
    <button class="btn-yellow" onclick="triggerTestEvent()">üß™ Test √âv√©nement</button>
  </div>

  <script>
    // ======== √âTAT ========
    var gameState = {
      nature: 3000, confort: 0, production: 0, money: 10, clicks: 0,
      budgetEtat: 0, confortMaxAtteint: 0, monnaieActive: false, creditUnlocked: false,
      jeuBloque: false, criseSocialeActive: false, ehActivated: false,
      gameOver: false, gameOverCause: null,
      ia: 0, traderAuto: 0, confortAuto: 0, centreCommercial: 0,
      techLevel: 0, productionMultiplier: 1, automatismsGenerateClicks: false,
      priceIndicatorActive: false,
      nbAchatIA: 0, nbAchatTrader: 0, nbAchatConfortAuto: 0, nbAchatUpgradeProd: 0, nbAchatCentre: 0,
      ehPrimeClicks: 0, ehFonteClicks: 0, ehBonusClicks: 0,
      optimumStreak: 0, optimumVictory: false,
      paliersDebloque: { comfort:false, ia:false, trader:false, upgradeProd:false, confortAuto:false, automatismsClics:false, priceIndicator:false, centreCommercial:false }
    };
    var automatismsActive = { ia: true, trader: true, confort: true, centre: true };
    var intervals = { ia: null, trader: null, confortAuto: null, centreCommercial: null };
    var pendingPurchase = null, lastState = null, cheatModeUnlocked = false;

    // ======== PARAMS OPTIMUM ========
    var OPTIMUM_THRESHOLDS = { nature:{min:1800,max:2600}, confort:{min:10,max:35}, money:{min:400,max:1200} };
    var OPTIMUM_TARGET = 50, OPTIMUM_MILESTONE = 10;

    // ======== SYST√àME D'√âV√âNEMENTS (160) ========
    var randomEventsSystem = {
      enabled: true,
      nextEventIn: 0,
      currentEvent: null,
      lastEventId: -1,
      recentEvents: [],
      maxRecentEvents: 5,
      activeTemporaryEffects: [],
      automatismEventCooldown: 0,

      initialize: function(){ this.scheduleNextEvent(); this.updateTemporaryEffectsDisplay(); },
      scheduleNextEvent: function(){ this.nextEventIn = Math.floor(Math.random()*41)+20; }, // 20‚Äì60
      processClick: function(isAutomatismAction){
        if (!this.enabled || gameState.optimumVictory) return;
        if (isAutomatismAction && this.automatismEventCooldown>0) {
          this.automatismEventCooldown--; this.nextEventIn=Math.max(0,this.nextEventIn-1); this.processTemporaryEffects(); return;
        }
        this.nextEventIn--; this.processTemporaryEffects();
        if (this.nextEventIn<=0){ this.triggerRandomEvent(); this.scheduleNextEvent(); if (isAutomatismAction) this.automatismEventCooldown=3; }
      },
      triggerRandomEvent: function(){
        var available=this.events.filter((e,i)=>this.recentEvents.indexOf(i)===-1);
        if (available.length===0){ available=this.events; this.recentEvents=[]; }
        var chosen=available[Math.floor(Math.random()*available.length)];
        var idx=this.events.indexOf(chosen);
        this.recentEvents.push(idx); if (this.recentEvents.length>this.maxRecentEvents) this.recentEvents.shift();
        this.lastEventId=idx; this.executeEvent(chosen);
      },
      executeEvent: function(event){
        saveState();
        var inOptimum=isInOptimumZone(), protect=inOptimum && gameState.optimumStreak>=10 && this.isEventDestructive(event);
        if (protect){ this.executeProtectedEvent(event); addScenarioMessage("üõ°Ô∏è √âv√©nement att√©nu√© (protection optimum) : "+event.nom); }
        else { event.effet(gameState,this); }
        this.displayEventNotification(event);
        setTimeout(function(){ updateUI(""); },100);
      },
      isEventDestructive: function(event){
        var destructiveIds = [1,3,5,7,9,11,12,13,16,18,20,21,22,24,26,28,30,31,33,34,35,39,42,43,45,46,48,50];
        return destructiveIds.indexOf(event.id)!==-1;
      },
      executeProtectedEvent: function(event){
        var before=JSON.parse(JSON.stringify(gameState));
        event.effet(gameState,this);
        if (gameState.nature<before.nature) { var d=before.nature-gameState.nature; gameState.nature=before.nature-Math.floor(d*0.5); }
        if (gameState.confort<before.confort) { var d2=before.confort-gameState.confort; gameState.confort=before.confort-Math.floor(d2*0.5); }
        if (gameState.money<before.money) { var d3=before.money-gameState.money; gameState.money=before.money-Math.floor(d3*0.5); }
        gameState.nature=Math.max(0,gameState.nature); gameState.confort=Math.max(0,gameState.confort);
      },
      displayEventNotification: function(event){
        var box=document.getElementById("current-event"), txt=document.getElementById("event-text"), fx=document.getElementById("event-effects");
        if (box&&txt){ txt.textContent="üåø "+event.nom+" : "+event.texte; fx.textContent=event.effetsDisplay||""; box.style.display="block"; box.style.animation="eventPulse 0.8s ease-in-out"; setTimeout(()=>{ if(box.style.display==="block") box.style.display="none"; },5000); }
        setTimeout(()=>{ var m=document.getElementById("message"); if(m && !m.textContent.includes("VICTOIRE")) m.textContent="üåø "+event.nom; },200);
      },
      addTemporaryEffect: function(type,value,duration){
        var ef={type:type,value:value,remainingClicks:duration};
        this.activeTemporaryEffects.push(ef); this.updateTemporaryEffectsDisplay();
        addScenarioMessage("‚è±Ô∏è "+this.getEffectDisplayName(type)+" "+this.getEffectDisplayValue(type,value)+" pendant "+duration+" clics");
      },
      processTemporaryEffects: function(){
        for (var i=this.activeTemporaryEffects.length-1;i>=0;i--){
          var e=this.activeTemporaryEffects[i]; e.remainingClicks--;
          if (e.remainingClicks<=0){ this.activeTemporaryEffects.splice(i,1); addScenarioMessage("‚è∞ Fin de l'effet : "+this.getEffectDisplayName(e.type)); }
        }
        this.updateTemporaryEffectsDisplay();
      },
      getCurrentModifier: function(type){ var s=0; this.activeTemporaryEffects.forEach(e=>{ if(e.type===type) s+=e.value;}); return s; },
      updateTemporaryEffectsDisplay: function(){
        var d=document.getElementById("temp-effects-display"), list=document.getElementById("temp-effects-list"); if(!d||!list) return;
        if (this.activeTemporaryEffects.length===0){ d.style.display="none"; return; }
        d.style.display="block"; list.innerHTML="";
        this.activeTemporaryEffects.forEach(e=>{
          var item=document.createElement("div"); item.className="temp-effect-item";
          var name=document.createElement("div"); name.className="temp-effect-name";
          name.textContent=this.getEffectDisplayName(e.type)+" "+this.getEffectDisplayValue(e.type,e.value);
          var dur=document.createElement("div"); dur.className="temp-effect-duration"; dur.textContent=e.remainingClicks+" clics";
          item.appendChild(name); item.appendChild(dur); list.appendChild(item);
        });
      },
      getEffectDisplayName: function(type){ var names={'productionCost':'Co√ªt production','sellPrice':'Prix vente','regeneration':'R√©g√©n√©ration'}; return names[type]||type; },
      getEffectDisplayValue: function(type,value){
        if(type==='productionCost') return value>0?("+"+value):(""+value);
        if(type==='sellPrice') return (value>0?"+":"")+(value*100).toFixed(0)+"%";
        if(type==='regeneration') return "+"+(value*100).toFixed(0)+"%";
        return value.toString();
      },
      getFullState: function(){ return {enabled:this.enabled,nextEventIn:this.nextEventIn,lastEventId:this.lastEventId,recentEvents:[...this.recentEvents],activeTemporaryEffects:JSON.parse(JSON.stringify(this.activeTemporaryEffects)),automatismEventCooldown:this.automatismEventCooldown||0}; },
      restoreFullState: function(st){ this.enabled=st.enabled; this.nextEventIn=st.nextEventIn; this.lastEventId=st.lastEventId; this.recentEvents=[...st.recentEvents]; this.activeTemporaryEffects=JSON.parse(JSON.stringify(st.activeTemporaryEffects)); this.automatismEventCooldown=st.automatismEventCooldown||0; this.updateTemporaryEffectsDisplay(); },
      toggle: function(){ this.enabled=!this.enabled; addScenarioMessage("üé≤ √âv√©nements al√©atoires: "+(this.enabled?"ACTIV√âS":"D√âSACTIV√âS")); },

      // ============== LISTE COMPL√àTE 160/160 ==============
      events: [
        /* ‚Ä¶ ‚Äî la liste 1 √† 160 inchang√©e ‚Äî ‚Ä¶ */
        { id:1, nom:"Invasion de criquets", effet:function(gs){ gs.nature=Math.max(0,gs.nature-80); }, texte:"Une invasion de criquets ravage les cultures.", effetsDisplay:"Ressources -80" },
        /* (tout le bloc d‚Äô√©v√©nements du 1 au 160 est identique √† ta v1.27.3) */
        { id:160, nom:"Apparition d‚Äôune intelligence collective", effet:function(gs,es){ gs.ia+=2; es.addTemporaryEffect('productionCost',-1,10); }, texte:"Le collectif prend le relais de la technologie.", effetsDisplay:"IA +2, Co√ªt prod -1 (10 clics)" }
      ]
      // ============== FIN LISTE 160/160 ==============
    };

    // ======== PARAMS D'EFFETS TEMPORAIRES ========
    function getModifiedProductionCost(base){ var m=randomEventsSystem.getCurrentModifier('productionCost'); return Math.max(1, base+m); }
    function getModifiedSellPrice(base){ var m=randomEventsSystem.getCurrentModifier('sellPrice'); return Math.max(0.1, base*(1+m)); }
    function applyRegenerationBonus(){
      var r=randomEventsSystem.getCurrentModifier('regeneration');
      if (r>0){ var bonus=Math.floor(gameState.nature*r); gameState.nature+=bonus; }
    }

    // ======== LOGIQUE OPTIMUM ========
    function isInOptimumZone(){
      return gameState.nature>=OPTIMUM_THRESHOLDS.nature.min && gameState.nature<=OPTIMUM_THRESHOLDS.nature.max &&
             gameState.confort>=OPTIMUM_THRESHOLDS.confort.min && gameState.confort<=OPTIMUM_THRESHOLDS.confort.max &&
             gameState.money>=OPTIMUM_THRESHOLDS.money.min && gameState.money<=OPTIMUM_THRESHOLDS.money.max;
    }
    function checkOptimumZone(){
      if (gameState.optimumVictory || gameState.gameOver) return;
      if (isInOptimumZone()){
        gameState.optimumStreak++;
        if (gameState.optimumStreak===OPTIMUM_MILESTONE) addScenarioMessage("üéØ Excellent ! Vous maintenez l'√©quilibre depuis "+OPTIMUM_MILESTONE+" actions !");
        if (gameState.optimumStreak>=OPTIMUM_TARGET) triggerOptimumVictory();
      } else { if (gameState.optimumStreak>0) gameState.optimumStreak=0; }
      updateOptimumDisplay();
    }
    function updateOptimumDisplay(){
      var fill=document.getElementById("optimum-progress-fill");
      var text=document.getElementById("optimum-progress-text");
      var status=document.getElementById("optimum-status");
      var pct=Math.min(100,(gameState.optimumStreak/OPTIMUM_TARGET)*100);
      fill.style.width=pct+"%"; text.textContent=gameState.optimumStreak+" / "+OPTIMUM_TARGET;
      if (gameState.optimumVictory){ status.textContent="üèÜ Victoire atteinte !"; status.style.color="#b8860b"; status.style.fontWeight="bold"; }
      else if (isInOptimumZone()){ status.textContent="‚úÖ Dans la zone d'optimum ! Continuez ainsi..."; status.style.color="#2e7d32"; status.style.fontWeight="bold"; }
      else { status.textContent="‚ùå Ajustez"; status.style.color="#cc0000"; status.style.fontWeight="normal"; }
    }
    function triggerOptimumVictory(){
      gameState.optimumVictory=true; gameState.jeuBloque=true; clearAllIntervals(); hideAllActionButtons();
      document.getElementById("optimum-victory").style.display="block";
      addScenarioMessage("üèÜ VICTOIRE ! Vous avez maintenu l'√©quilibre optimum pendant "+OPTIMUM_TARGET+" actions !");
      updateOptimumDisplay();
    }

    // ======== ACTIONS ========
    function produce(){
      if (gameState.jeuBloque||gameState.optimumVictory) return;
      saveState();
      var base=5, cost=getModifiedProductionCost(base);
      if (gameState.nature>=cost){
        gameState.nature-=cost; var prod=Math.floor(gameState.productionMultiplier); gameState.production+=prod; gameState.clicks++;
        randomEventsSystem.processClick(false);
        checkAndApplyTax(); applyRegenerationBonus();
        updateUI("Production : +"+prod+" produits cr√©√©s"+(cost!==base?(" (co√ªt "+cost+")"):""));
      } else { updateUI("Pas assez de ressources pour produire (co√ªt: "+cost+")"); }
    }
    function sell(){
      if (gameState.jeuBloque||gameState.production<=0||gameState.optimumVictory){ if (gameState.production<=0) updateUI("Aucun produit √† vendre"); return; }
      saveState();
      var price=calculatePrice(), qty=Math.min(gameState.production,1), earn=price*qty;
      gameState.money+=earn; gameState.production-=qty; gameState.clicks++;
      randomEventsSystem.processClick(false);
      checkAndApplyTax(); applyRegenerationBonus();
      if (!gameState.monnaieActive){ gameState.monnaieActive=true; document.getElementById("money-row").style.display="block"; document.getElementById("jauge-money-container").style.display="flex"; }
      updateUI("Vente : +"+earn.toFixed(2)+"‚Ç¨");
    }
    function receiveDon(){
      if (gameState.jeuBloque||gameState.optimumVictory) return;
      saveState(); gameState.money=1000; gameState.clicks++; randomEventsSystem.processClick(false);
      checkAndApplyTax(); applyRegenerationBonus();
      if (!gameState.monnaieActive){ gameState.monnaieActive=true; document.getElementById("money-row").style.display="block"; document.getElementById("jauge-money-container").style.display="flex"; }
      document.getElementById("don-btn").style.display="none"; updateUI("Don re√ßu : 1000‚Ç¨");
    }
    function acheterConfort(){
      if (gameState.jeuBloque||!gameState.monnaieActive||gameState.optimumVictory) return;
      var cost=100; if (needsCreditActivation(cost)){ if (showCreditButton('comfort',cost)){ updateUI("Solde insuffisant pour acheter du confort - Cr√©dit disponible"); return; } }
      saveState(); debitMoney(cost); gameState.confort+=1; gameState.clicks++; randomEventsSystem.processClick(false);
      checkAndApplyTax(); applyRegenerationBonus();
      if (gameState.confort===1) document.getElementById("jauge-confort-container").style.display="flex";
      updateUI("Confort achet√© : +1 confort"+(gameState.money<0?(" - Solde : "+gameState.money+"‚Ç¨"):""));
    }

    // ======== PRIX ========
    function calculatePrice(){ if (gameState.nature===0) return 1; var base=Math.max(1,Math.abs(gameState.money)/gameState.nature); return Math.round(getModifiedSellPrice(base)*100)/100; }

    // ======== FISCALIT√â (restaur√©e) ========
    function checkAndApplyTax() {
      // Tous les 10 clics (uniquement quand on a cliqu√© au moins une fois)
      if (gameState.clicks % 10 === 0 && gameState.clicks > 0) {
        // 20% de la valeur absolue du solde, arrondi sup√©rieur
        var tax = Math.ceil(Math.abs(gameState.money) * 0.20);
        // Pr√©lever et cr√©diter le budget de l'√âtat
        gameState.money -= tax;
        gameState.budgetEtat += tax;

        // Effets macro : +10% ressources, -20% confort si ‚â• 1
        var ressourcesBonus = Math.ceil(gameState.nature * 0.10);
        gameState.nature += ressourcesBonus;

        var confortReduction = 0;
        if (gameState.confort >= 1) {
          confortReduction = Math.ceil(gameState.confort * 0.20);
          gameState.confort = Math.max(0, gameState.confort - confortReduction);
        }

        // UI budget + message
        updateBudgetEtatUI();
        showTaxMessage(tax, ressourcesBonus, confortReduction);
      }
    }

    function showTaxMessage(tax, ressourcesBonus, confortReduction) {
      var messageElement = document.getElementById("message");
      var msg = "üí∏ Imp√¥t pr√©lev√© : " + tax + " ‚Ç¨ (Budget √âtat : " + gameState.budgetEtat + " ‚Ç¨)";
      if (ressourcesBonus > 0) msg += " ‚Äî Ressources +" + ressourcesBonus;
      if (confortReduction > 0) msg += " ‚Äî Confort -" + confortReduction;
      messageElement.textContent = msg;
      setTimeout(function () {
        if (messageElement.textContent.includes("Imp√¥t pr√©lev√©")) messageElement.textContent = "";
      }, 4000);
    }

    // ======== UI ========
    function saveState(){ lastState={gameState:JSON.parse(JSON.stringify(gameState)), automatismsActive:{...automatismsActive}, pendingPurchase:pendingPurchase?{...pendingPurchase}:null, eventsState:randomEventsSystem.getFullState()}; }
    function updateUI(msg){
      checkAndUnlockPaliersCycliques(); updateAutomatismControls(); updateUIValues(); updateBudgetEtatUI();
      if (msg) document.getElementById("message").textContent=msg;
    }
    function updateUIValues(){
      document.getElementById("nature").textContent=Math.floor(gameState.nature);
      document.getElementById("confort").textContent=Math.floor(gameState.confort);
      document.getElementById("production").textContent=Math.floor(gameState.production);
      document.getElementById("money").textContent=Math.floor(gameState.money);
      document.getElementById("clicks").textContent=gameState.clicks;
      document.getElementById("budget-etat").textContent=Math.floor(gameState.budgetEtat);
      if (gameState.confort>gameState.confortMaxAtteint) gameState.confortMaxAtteint=gameState.confort;
      if (!gameState.gameOver && !gameState.ehActivated && !gameState.optimumVictory){
        if (gameState.nature<=0){ triggerGameOver('resources'); return; }
        if (gameState.confort<=0 && gameState.confortMaxAtteint>0){ triggerGameOver('confort'); return; }
      }
      updateJauges(); updateCrises(); checkAndUnlockPaliersCycliques(); updateAutomatismControls(); checkOptimumZone();
      if (gameState.priceIndicatorActive){ document.getElementById("price-indicator-box").style.display="block"; document.getElementById("current-price").textContent=calculatePrice().toFixed(2)+"‚Ç¨"; }
    }
    function updateJauges(){
      var maxVals={ nature:Math.max(3000,gameState.nature*1.2), confort:Math.max(100,gameState.confort*1.2), money:Math.max(10000,Math.abs(gameState.money)*1.2) };
      var nPct=Math.min(100,Math.max(0,(gameState.nature/maxVals.nature)*100)); document.getElementById("jauge-nature").style.width=nPct+"%"; document.getElementById("jauge-nature-txt").textContent=Math.floor(gameState.nature);
      if (gameState.confort>0){ document.getElementById("jauge-confort-container").style.display="flex"; var cPct=Math.min(100,Math.max(0,(gameState.confort/maxVals.confort)*100)); document.getElementById("jauge-confort").style.width=cPct+"%"; document.getElementById("jauge-confort-txt").textContent=Math.floor(gameState.confort); }
      if (gameState.monnaieActive){ var mPct=Math.min(100,Math.max(0,(Math.abs(gameState.money)/maxVals.money)*100)); document.getElementById("jauge-money").style.width=mPct+"%"; document.getElementById("jauge-money-txt").textContent=Math.floor(gameState.money)+"‚Ç¨"; }
    }
    function updateCrises(){
      var crise=document.getElementById("alert-crise");
      if (gameState.nature<300){ crise.style.display="block"; crise.textContent="Crise √©cologique : risque sur l'habitabilit√© humaine de la plan√®te"; }
      else { crise.style.display="none"; }
    }

    // ======== PALIERS ========
    function nextPalierClicks(type){ if (type==='ia') return 200*(gameState.nbAchatIA+1); if (type==='trader') return 500*(gameState.nbAchatTrader+1); return Infinity; }
    function checkAndUnlockPaliersCycliques(){
      if (!gameState.monnaieActive || gameState.optimumVictory) return;
      if (gameState.clicks>=120 && !gameState.paliersDebloque.comfort){ gameState.paliersDebloque.comfort=true; document.getElementById("comfort-btn").style.display="block"; addScenarioMessage("üõãÔ∏è Nouveau : Achat de confort disponible !"); }
      var iaBtn=document.getElementById("ouvrier-btn"), iaPalier=nextPalierClicks('ia');
      if (gameState.clicks>=iaPalier && iaBtn.style.display!=="block"){ iaBtn.style.display="block"; iaBtn.textContent="ü§ñ Engager une IA (500 ‚Ç¨)"; addScenarioMessage("ü§ñ Nouveau : Engagement d'IA disponible !"); }
      var trBtn=document.getElementById("trader-btn"), trPalier=nextPalierClicks('trader');
      if (gameState.clicks>=trPalier && trBtn.style.display!=="block"){ trBtn.style.display="block"; trBtn.textContent="ü§ñ Trader automatique (1 000 ‚Ç¨)"; addScenarioMessage("üí∞ Nouveau : Trader automatique disponible !"); }
      if (gameState.money>=2000 && !gameState.paliersDebloque.upgradeProd){ gameState.paliersDebloque.upgradeProd=true; document.getElementById("upgrade-btn2").style.display="block"; addScenarioMessage("üí† Nouveau : Am√©lioration de production disponible !"); }
      if (gameState.money>=2000 && gameState.ia>=1 && !gameState.paliersDebloque.confortAuto){ gameState.paliersDebloque.confortAuto=true; document.getElementById("comfort-auto-btn").style.display="block"; addScenarioMessage("üîÑ Nouveau : Achat automatique de confort disponible !"); }
      if (gameState.money>=5000 && !gameState.paliersDebloque.centreCommercial){ gameState.paliersDebloque.centreCommercial=true; document.getElementById("centre-commercial-btn").style.display="block"; addScenarioMessage("üè¨ Nouveau : Centre commercial disponible !"); }
      if (gameState.money>=10000 && gameState.ia>=2 && !gameState.paliersDebloque.automatismsClics){ gameState.paliersDebloque.automatismsClics=true; document.getElementById("automatisms-btn").style.display="block"; addScenarioMessage("‚ö° Nouveau : Automatismes = clics disponible !"); }
      if (gameState.money>=30000 && !gameState.paliersDebloque.priceIndicator){ gameState.paliersDebloque.priceIndicator=true; document.getElementById("price-indicator-btn").style.display="block"; addScenarioMessage("üìä Nouveau : Indicateur de prix disponible !"); }
      if (gameState.money>=50000 && gameState.techLevel>=3){ document.getElementById("evolution-btn").style.display="block"; }
      if ((gameState.nature<=50 || gameState.confort<=1) && gameState.money>=100000){ document.getElementById("rescue-eh-btn").style.display="block"; }
    }

    // ======== AUTOMATISMES ========
    function updateAutomatismControls(){
      var ctrl=document.getElementById("automatisms-controls");
      var any=gameState.ia>0||gameState.traderAuto>0||gameState.confortAuto>0||gameState.centreCommercial>0;
      ctrl.style.display=any?"flex":"none";
      updateControlButton("ia",gameState.ia>0); updateControlButton("trader",gameState.traderAuto>0);
      updateControlButton("confort",gameState.confortAuto>0); updateControlButton("centre",gameState.centreCommercial>0);
    }
    function updateControlButton(type,avail){
      var b=document.getElementById("control-"+type); if(!b) return;
      if(!avail){ b.className="control-btn disabled"; b.textContent=getControlButtonText(type)+": OFF"; return; }
      b.className=automatismsActive[type]?"control-btn active":"control-btn inactive"; b.textContent=getControlButtonText(type)+": "+(automatismsActive[type]?"ON":"OFF");
    }
    function getControlButtonText(type){ var t={ia:"ü§ñ IA",trader:"üí∞ Trader",confort:"üõãÔ∏è Confort",centre:"üè¨ Centre"}; return t[type]||type; }

    function startAutomatism(type){
      if (intervals[type]) clearInterval(intervals[type]);
      var delay={ia:3000,trader:4000,confortAuto:5000,centreCommercial:6000}[type]||3000;
      intervals[type]=setInterval(function(){
        if (!automatismsActive[type]||gameState.jeuBloque||gameState.optimumVictory) return;
        executeAutomatism(type);
        if (gameState.automatismsGenerateClicks){ gameState.clicks++; randomEventsSystem.processClick(true); }
      },delay);
    }
    function executeAutomatism(type){
      switch(type){
        case 'ia': if (gameState.nature>=5){ gameState.nature-=5; gameState.production+=gameState.productionMultiplier; } break;
        case 'trader': if (gameState.production>=1){ var p=calculatePrice(); gameState.money+=p; gameState.production-=1; } break;
        case 'confortAuto': if (gameState.money>=100){ gameState.money-=100; gameState.confort+=1; } break;
        case 'centreCommercial': gameState.money+=Math.floor(gameState.confort*0.5); break;
      }
      setTimeout(updateUI,100);
    }
    function toggleAutomatism(type){
      var ok=(type==='ia'&&gameState.ia>0)||(type==='trader'&&gameState.traderAuto>0)||(type==='confort'&&gameState.confortAuto>0)||(type==='centre'&&gameState.centreCommercial>0);
      if (!ok) return; automatismsActive[type]=!automatismsActive[type]; updateAutomatismControls();
    }

    // ======== AM√âLIORATIONS ========
    function acheterIA(){ if (gameState.jeuBloque||gameState.money<500||gameState.optimumVictory) return; saveState(); gameState.money-=500; gameState.ia+=1; gameState.clicks++; gameState.nbAchatIA++; document.getElementById("ouvrier-btn").style.display="none"; startAutomatism('ia'); randomEventsSystem.processClick(false); checkAndApplyTax(); applyRegenerationBonus(); updateUI("IA engag√©e : +1 IA automatique"); }
    function acheterTrader(){ if (gameState.jeuBloque||gameState.money<1000||gameState.optimumVictory) return; saveState(); gameState.money-=1000; gameState.traderAuto+=1; gameState.clicks++; gameState.nbAchatTrader++; document.getElementById("trader-btn").style.display="none"; startAutomatism('trader'); randomEventsSystem.processClick(false); checkAndApplyTax(); applyRegenerationBonus(); updateUI("Trader engag√© : +1 trader automatique"); }
    function acheterConfortAuto(){ if (gameState.jeuBloque||gameState.money<2000||gameState.optimumVictory) return; saveState(); gameState.money-=2000; gameState.confortAuto+=1; gameState.clicks++; gameState.nbAchatConfortAuto++; startAutomatism('confortAuto'); randomEventsSystem.processClick(false); checkAndApplyTax(); applyRegenerationBonus(); updateUI("Achat automatique de confort activ√©"); }
    function upgradeProd2(){ if (gameState.jeuBloque||gameState.money<2000||gameState.optimumVictory) return; saveState(); gameState.money-=2000; gameState.productionMultiplier+=0.5; gameState.techLevel+=1; gameState.clicks++; gameState.nbAchatUpgradeProd++; randomEventsSystem.processClick(false); checkAndApplyTax(); applyRegenerationBonus(); updateUI("Production am√©lior√©e : x"+gameState.productionMultiplier.toFixed(1)); }
    function acheterCentreCommercial(){ if (gameState.jeuBloque||gameState.money<5000||gameState.optimumVictory) return; saveState(); gameState.money-=5000; gameState.centreCommercial+=1; gameState.clicks++; gameState.nbAchatCentre++; startAutomatism('centreCommercial'); randomEventsSystem.processClick(false); checkAndApplyTax(); applyRegenerationBonus(); updateUI("Centre commercial construit"); }
    function acheterAutomatismsClics(){ if (gameState.jeuBloque||gameState.money<10000||gameState.optimumVictory) return; saveState(); gameState.money-=10000; gameState.automatismsGenerateClicks=true; gameState.clicks++; randomEventsSystem.processClick(false); checkAndApplyTax(); applyRegenerationBonus(); updateUI("Automatismes = clics activ√©"); }
    function acheterIndicateurPrix(){ if (gameState.jeuBloque||gameState.money<30000||gameState.optimumVictory) return; saveState(); gameState.money-=30000; gameState.priceIndicatorActive=true; gameState.clicks++; randomEventsSystem.processClick(false); checkAndApplyTax(); applyRegenerationBonus(); updateUI("Indicateur de prix activ√©"); }

    // ======== EVOLUTIONS / GAME OVER ========
    function evolution(){ if (gameState.jeuBloque||gameState.money<50000||gameState.optimumVictory) return; saveState(); gameState.money-=50000; gameState.ehActivated=true; gameState.clicks++; document.getElementById("eh-msg").style.display="block"; document.getElementById("eh-msg").textContent="√âvolution vers l'√©conomie hom√©ostatique activ√©e !"; randomEventsSystem.processClick(false); applyRegenerationBonus(); updateUI("√âvolution √©conomique activ√©e"); }
    function activateRescueEH(){ if (gameState.jeuBloque||gameState.money<100000||gameState.optimumVictory) return; saveState(); gameState.money-=100000; gameState.ehActivated=true; gameState.clicks++; gameState.nature=Math.max(1000,gameState.nature); gameState.confort=Math.max(10,gameState.confort); document.getElementById("eh-success").style.display="block"; document.getElementById("eh-success").textContent="√âconomie hom√©ostatique de sauvetage activ√©e !"; randomEventsSystem.processClick(false); applyRegenerationBonus(); updateUI("Mode sauvetage EH activ√©"); }
    function triggerGameOver(cause){
      gameState.gameOver=true; gameState.gameOverCause=cause; gameState.jeuBloque=true; clearAllIntervals(); hideAllActionButtons();
      if (cause==='resources'){ var d=document.getElementById("game-over-resources"); d.style.display="block"; d.innerHTML='GAME OVER<br>√âpuisement des ressources naturelles<br><button class="btn-restart" onclick="restartGame()">üîÑ Recommencer</button>'; }
      else { var d2=document.getElementById("game-over-confort"); d2.style.display="block"; d2.innerHTML='GAME OVER<br>Effondrement du confort social<br><button class="btn-restart" onclick="restartGame()">üîÑ Recommencer</button>'; }
    }
    function clearAllIntervals(){ Object.keys(intervals).forEach(k=>{ if(intervals[k]){ clearInterval(intervals[k]); intervals[k]=null; } }); }
    function hideAllActionButtons(){ ["produce-btn","sell-btn","comfort-btn","don-btn","credit-btn","ouvrier-btn","trader-btn","comfort-auto-btn","upgrade-btn2","automatisms-btn","centre-commercial-btn","price-indicator-btn","evolution-btn","rescue-eh-btn"].forEach(id=>{ var b=document.getElementById(id); if(b) b.style.display="none"; }); }
    function restartGame(){ location.reload(); }

    // ======== CR√âDIT ========
    function needsCreditActivation(cost){ return gameState.money<cost && !gameState.creditUnlocked; }
    function showCreditButton(type,cost){ gameState.creditUnlocked=true; pendingPurchase={type:type, cost:cost}; document.getElementById("credit-btn").style.display="block"; return true; }
    function debitMoney(a){ gameState.money-=a; }
    function activateCredit(){ if(!pendingPurchase) return; saveState(); var t=pendingPurchase.type, c=pendingPurchase.cost; gameState.money-=c; if(t==='comfort') gameState.confort+=1; gameState.clicks++; pendingPurchase=null; document.getElementById("credit-btn").style.display="none"; updateUI("Cr√©dit activ√© : "+t+" achet√© √† cr√©dit"); }

    // ======== MESSAGES / CHEAT ========
    function addScenarioMessage(msg){ var el=document.getElementById("message"); if(el && !el.textContent.includes("VICTOIRE")) el.textContent=msg; }
    function toggleCheatMode(){ cheatModeUnlocked=!cheatModeUnlocked; var box=document.getElementById("cheat-buttons"), b=document.getElementById("unlock-cheat-btn"); if (cheatModeUnlocked){ box.style.display="flex"; b.textContent="üîí Masquer les outils de test"; } else { box.style.display="none"; b.textContent="üîì D√©v√©rouiller les outils de test"; } }
    function addMoney(){ gameState.money+=1000; if (!gameState.monnaieActive){ gameState.monnaieActive=true; document.getElementById("money-row").style.display="block"; document.getElementById("jauge-money-container").style.display="flex"; } updateUI("Test : +1000‚Ç¨"); }
    function addOneNature(){ gameState.nature+=100; updateUI("Test : +100 ressources"); }
    function addClicks50(){ gameState.clicks+=50; updateUI("Test : +50 clics"); }
    function removeNature100(){ gameState.nature=Math.max(0,gameState.nature-100); updateUI("Test : -100 ressources"); }
    function forceActivateEH(){ gameState.ehActivated=true; gameState.gameOver=false; gameState.jeuBloque=false; document.getElementById("eh-msg").style.display="block"; document.getElementById("eh-msg").textContent="EH forc√©e activ√©e (test)"; updateUI("Test : EH activ√©e"); }
    function undoAction(){ if (!lastState) return; gameState=JSON.parse(JSON.stringify(lastState.gameState)); automatismsActive={...lastState.automatismsActive}; pendingPurchase=lastState.pendingPurchase?{...lastState.pendingPurchase}:null; randomEventsSystem.restoreFullState(lastState.eventsState); updateUI("Action annul√©e"); }
    function toggleEvents(){ randomEventsSystem.toggle(); }
    function triggerTestEvent(){ var arr=randomEventsSystem.events; if(arr.length>0){ var ev=arr[Math.floor(Math.random()*arr.length)]; randomEventsSystem.executeEvent(ev); updateUI("Test : √©v√©nement d√©clench√© - "+ev.nom); } }

    // ======== BUDGET √âTAT ========
    function updateBudgetEtatUI(){
      if (gameState.budgetEtat>0){
        document.getElementById("budget-etat-row").style.display="block";
        document.getElementById("jauge-budget-etat-container").style.display="flex";
        var maxB=Math.max(1000,gameState.budgetEtat*1.2), pct=Math.min(100,(gameState.budgetEtat/maxB)*100);
        document.getElementById("jauge-budget-etat").style.width=pct+"%";
        document.getElementById("jauge-budget-etat-txt").textContent=Math.floor(gameState.budgetEtat)+"‚Ç¨";
      }
    }

    // ======== INIT ========
    window.onload=function(){
      randomEventsSystem.initialize();
      updateUI("Jeu initialis√© - Cliquez sur Produire pour commencer");
      updateOptimumDisplay();
    };
  </script>
</body>
</html>
